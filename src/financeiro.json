[{"id":"93303209.ee2b","type":"http in","z":"e6097cee.8df04","name":"","url":"/financeiro","method":"get","swaggerDoc":"","x":120,"y":80,"wires":[["cbe0256d.84add8"]]},{"id":"aa083202.1416","type":"http response","z":"e6097cee.8df04","name":"","x":890,"y":80,"wires":[]},{"id":"c0d031d2.07759","type":"comment","z":"e6097cee.8df04","name":"Financeiro","info":"Nova vers√£o usando ReactJS e Material-UI","x":100,"y":40,"wires":[]},{"id":"ce2f823.01df08","type":"http in","z":"e6097cee.8df04","name":"","url":"/financeiro/static/:folder/:file","method":"get","swaggerDoc":"","x":170,"y":160,"wires":[["bef6192b.b4f178"]]},{"id":"a1ebd125.4ca94","type":"http response","z":"e6097cee.8df04","name":"","x":890,"y":160,"wires":[]},{"id":"bef6192b.b4f178","type":"function","z":"e6097cee.8df04","name":"","func":"msg.filename = 'C:\\\\inetpub\\\\wwwroot\\\\financeiro\\\\static\\\\'  + msg.req.params.folder + '\\\\' + msg.req.params.file;\n\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":160,"wires":[["d4e2f328.e10bb"]]},{"id":"cbe0256d.84add8","type":"file in","z":"e6097cee.8df04","name":"","filename":"C:\\inetpub\\wwwroot\\financeiro\\index.html","format":"utf8","x":460,"y":80,"wires":[["aa083202.1416"]]},{"id":"d4e2f328.e10bb","type":"file in","z":"e6097cee.8df04","name":"","filename":"","format":"","x":570,"y":160,"wires":[["baa56b64.2fc918"]]},{"id":"baa56b64.2fc918","type":"function","z":"e6097cee.8df04","name":"text/css","func":"var ext = msg.filename.split('.').pop();\n\nswitch (ext) {\n    case 'css':\n        msg.headers = { \"Content-type\" : \"text/css\" }\n        break;\n    case 'ico':\n        msg.headers = { \"Content-type\" : \"image/x-icon; charset=utf-8\" }\n        break;\n    default:\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":160,"wires":[["a1ebd125.4ca94"]]},{"id":"6f7c6eea.ba148","type":"http in","z":"e6097cee.8df04","name":"","url":"/financeiro/favicon.ico","method":"get","swaggerDoc":"","x":150,"y":120,"wires":[["84dd209e.93c37"]]},{"id":"84dd209e.93c37","type":"file in","z":"e6097cee.8df04","name":"","filename":"C:\\inetpub\\wwwroot\\financeiro\\favicon.ico","format":"utf8","x":460,"y":120,"wires":[["890fd83a.72e8b8"]]},{"id":"eecd704d.87544","type":"http response","z":"e6097cee.8df04","name":"","x":890,"y":120,"wires":[]},{"id":"890fd83a.72e8b8","type":"function","z":"e6097cee.8df04","name":"image/x-icon","func":"msg.headers = { \"Content-type\" : \"image/x-icon\" }\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":120,"wires":[["eecd704d.87544"]]},{"id":"69bba89a.20d418","type":"http in","z":"e6097cee.8df04","name":"","url":"/static/:folder/:file","method":"get","swaggerDoc":"","x":140,"y":200,"wires":[["cc7794e5.262878"]]},{"id":"cc7794e5.262878","type":"function","z":"e6097cee.8df04","name":"","func":"msg.filename = 'C:\\\\inetpub\\\\wwwroot\\\\financeiro\\\\static\\\\'  + msg.req.params.folder + '\\\\' + msg.req.params.file;\n\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":200,"wires":[["f30b2f16.a55de"]]},{"id":"f30b2f16.a55de","type":"file in","z":"e6097cee.8df04","name":"","filename":"","format":"","x":570,"y":200,"wires":[["b04bff27.eb89f"]]},{"id":"2b5aa957.08bd26","type":"http response","z":"e6097cee.8df04","name":"","x":890,"y":200,"wires":[]},{"id":"b04bff27.eb89f","type":"function","z":"e6097cee.8df04","name":"text/css","func":"var ext = msg.filename.split('.').pop();\n\nswitch (ext) {\n    case 'css':\n        msg.headers = { \"Content-type\" : \"text/css\" }\n        break;\n    case 'ico':\n        msg.headers = { \"Content-type\" : \"image/x-icon; charset=utf-8\" }\n        break;\n    case 'svg':\n        msg.headers = { \"Content-type\" : \"image/svg; charset=utf-8\" }\n        break;\n    default:\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":200,"wires":[["2b5aa957.08bd26"]]},{"id":"2a41badf.bd5766","type":"http in","z":"e6097cee.8df04","name":"","url":"/api/financeiro/duplicata/conferencia/busca","method":"get","swaggerDoc":"","x":210,"y":280,"wires":[["532ac17e.8f755"]]},{"id":"532ac17e.8f755","type":"function","z":"e6097cee.8df04","name":"SQL","func":"msg.payload = \n\"DECLARE @PEDIDO INT\\n\" +\n\"DECLARE @CNPJ NVARCHAR(14)\\n\" +\n\"DECLARE @NOME NVARCHAR(100)\\n\" +\n\"SET @PEDIDO = \" + (msg.req.query.pedido || 'NULL') + \"\\n\" +\n\"SET @CNPJ = \" + (\"'\" + msg.req.query.cnpj + \"'\" || 'NULL') + \"\\n\" +\n\"SET @NOME = \" + (\"'\" + msg.req.query.nome + \"'\" || 'NULL') + \"\\n\" +\n\"SELECT top 10 \" +\n\"\tLTRIM(RTRIM(LPV.LPEMP)) AS empresa, \\n\" +\n\"\tCAST(LPV.LPPED AS INT) AS pedido, \\n\" +\n\"\tCAST(LPV.LPENT AS DATE) AS emissao, \\n\" +\n\"\tLPV.Lp0SaiRed AS entrega, \\n\" +\n\"\tLTRIM(RTRIM(CACLI.CCCGC)) AS cnpj, \\n\" +\n\"\tLTRIM(RTRIM(CACLI.CCFAN)) AS fantasia, \\n\" +\n\"\tLTRIM(RTRIM(CACLI.CCNOM)) AS nome \\n\" +\n\"FROM \\n\" +\n\"\tGPIMAC_Altamira.dbo.LPV AS LPV INNER JOIN \\n\" +\n\"   GPIMAC_Altamira.dbo.CACLI ON LPV.CCCGC = GPIMAC_Altamira.dbo.CACLI.CCCGC \\n\" +\n\"WHERE \\n\" +\n\"   (@PEDIDO IS NULL OR LPV.LPPED LIKE '%' + CAST(@PEDIDO AS NVARCHAR(10)) + '%') AND \\n\" +\n\"   (@CNPJ IS NULL OR CACLI.CCCGC LIKE '%' + @CNPJ + '%') AND \\n\" +\n\"   (@NOME IS NULL OR CACLI.CCFAN LIKE '%' + @NOME + '%') AND \\n\" +\n\"   (@NOME IS NULL OR CACLI.CCNOM LIKE '%' + @NOME + '%') \\n\" +\n\"ORDER BY \\n\" +\n\"   LPV.LPPED DESC\"\n\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":280,"wires":[["2dbd701f.2aa36"]]},{"id":"6ef6407e.f5c61","type":"http response","z":"e6097cee.8df04","name":"","x":890,"y":280,"wires":[]},{"id":"2dbd701f.2aa36","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"162ddda.4a21522","name":"","query":"","outField":"payload","x":740,"y":280,"wires":[["6ef6407e.f5c61"]]},{"id":"60be9a9e.e5c164","type":"http in","z":"e6097cee.8df04","name":"","url":"/api/financeiro/duplicata/conferencia/concluir/:task","method":"post","swaggerDoc":"","x":240,"y":340,"wires":[["26c5aa62.411ce6","f4e90c40.671c9"]]},{"id":"c5a538e4.1b9148","type":"function","z":"e6097cee.8df04","name":"TASK","func":"msg.task = { id: parseInt(msg.req.params.task) }\nmsg.payload = \n\"DECLARE @ID INT \" +\n\"SET @ID = \" + (msg.req.params.task || 'NULL') + \" \" +\n\"UPDATE TASK SET \" +\n\"\tDONE_DATE = GETDATE() \" +\n\"WHERE \" +\n\"   TASK.ID = @ID; \"\n\nif (msg.pedido.cliente.desconto) {\n    msg.payload = msg.payload + \n    \"SET @ID = NEXT VALUE FOR TASK_SEQUENCE \" +\n    \"INSERT INTO TASK \" +\n    \"   (ID, \" +\n    \"   NAME, \" +\n    \"   TITLE, \" +\n    \"   DETAIL, \" +\n    \"   PAYLOAD, \" +\n    \"   ASSIGN_TO, \" +\n    \"   LINK, \" +\n    \"   DUE_DATE, \" +\n    \"   CREATE_DATE, \" +\n    \"   DONE_DATE) \" +\n    \"VALUES \" +\n    \"   (@ID, \" +\n    \"   'Ordem de Desconto', \" +\n    \"   'Pedido \" + msg.pedido.numero + \"', \" +\n    \"   '\" + msg.pedido.cliente.nome + \"', \" +\n    \"   '\" + JSON.stringify(msg.pedido) + \"', \" + \n    \"   NULL, \" +\n    \"   '/duplicata/desconto/' + CAST(@ID AS NVARCHAR), \" +\n    \"   NULL, \" +\n    \"   GETDATE(), \" +\n    \"   NULL)\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":130,"y":880,"wires":[["3ade18d9.ee6148"]]},{"id":"96930c9e.56a0e","type":"http response","z":"e6097cee.8df04","name":"","x":290,"y":940,"wires":[]},{"id":"3ade18d9.ee6148","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"2c209f4e.630ba","name":"","query":"","outField":"payload","x":140,"y":940,"wires":[["96930c9e.56a0e","e448b582.25d148"]]},{"id":"df136072.2d4a6","type":"mqtt out","z":"e6097cee.8df04","name":"","topic":"","qos":"","retain":"","broker":"86aaad3e.7a45","x":290,"y":1040,"wires":[]},{"id":"e448b582.25d148","type":"function","z":"e6097cee.8df04","name":"NOTIFY","func":"msg.topic = '/tarefas/concluida/' // + msg.task.id\nmsg.payload = msg.task;\nreturn msg;","outputs":1,"noerr":0,"x":140,"y":1000,"wires":[["df136072.2d4a6","d7080bec.aa9658"]]},{"id":"d7080bec.aa9658","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"topic","x":300,"y":1000,"wires":[]},{"id":"26c5aa62.411ce6","type":"debug","z":"e6097cee.8df04","name":"","active":true,"console":"false","complete":"payload","x":150,"y":400,"wires":[]},{"id":"f4e90c40.671c9","type":"function","z":"e6097cee.8df04","name":"PEDIDO","func":"msg.pedido = msg.payload;\nmsg.payload = \n//\"DECLARE @EMPRESA INT \" +\n\"DECLARE @NUMERO INT \" +\n\"DECLARE @EMISSAO DATE \" +\n\"DECLARE @ENTREGA DATE \" +\n\"DECLARE @CONDICAO VARCHAR(3) \" +\n\"DECLARE @COMISSAO DECIMAL(18, 3) \" +\n\n//\"SET @EMPRESA = CAST(\" + (msg.pedido.empresa || 'NULL') + \" AS INT) \" +\n\"SET @NUMERO = CAST(\" + (msg.pedido.numero || 'NULL') + \" AS INT) \" +\n\"SET @EMISSAO = CAST('\" + (msg.pedido.emissao || 'NULL') + \"' AS DATE) \" +\n\"SET @ENTREGA = CAST('\" + (msg.pedido.entrega || 'NULL') + \"' AS DATE) \" +\n\"SET @CONDICAO = CAST('\" + (msg.pedido.condicao || 'NULL') + \"' AS VARCHAR(3)) \" +\n\"SET @COMISSAO = CAST(\" + (msg.pedido.comissao || 'NULL') + \" AS DECIMAL(18, 3)) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED] AS target \" +\n\"    USING (SELECT @NUMERO, @EMISSAO, @ENTREGA, @CONDICAO, @COMISSAO) AS source (NUMERO, EMISSAO, ENTREGA, CONDICAO, COMISSAO) \" +\n\"    ON (target.NUMERO = source.NUMERO) \" +\n\"WHEN MATCHED THEN \" +\n\"    UPDATE SET EMISSAO = source.EMISSAO, ENTREGA = source.ENTREGA, CONDICAO = source.CONDICAO, COMISSAO = source.COMISSAO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (NUMERO, EMISSAO, ENTREGA, CONDICAO, COMISSAO) \" +\n\"\tVALUES (source.NUMERO, source.EMISSAO, source.ENTREGA, source.CONDICAO, source.COMISSAO); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":140,"y":440,"wires":[["e7becb0.a66e238","44d0e170.a2aba"]]},{"id":"e7becb0.a66e238","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"f8d04a38.3d9938","name":"","query":"","outField":"payload","x":140,"y":500,"wires":[["222bbf4c.afc67"]]},{"id":"44d0e170.a2aba","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"payload","x":310,"y":440,"wires":[]},{"id":"222bbf4c.afc67","type":"function","z":"e6097cee.8df04","name":"CLIENTE","func":"msg.payload = \n\"DECLARE @CNPJ VARCHAR(20) \" +\n\"DECLARE @INSCRICAO VARCHAR(12) \" +\n\"DECLARE @FANTASIA VARCHAR(30) \" +\n\"DECLARE @NOME VARCHAR(100) \" +\n\"DECLARE @LOGRADOURO VARCHAR(5) \" +\n\"DECLARE @ENDERECO VARCHAR(50) \" +\n\"DECLARE @NUMERO VARCHAR(10) \" +\n\"DECLARE @COMPLEMENTO VARCHAR(20) \" +\n\"DECLARE @BAIRRO VARCHAR(30) \" +\n\"DECLARE @MUNICIPIO INT \" +\n\"DECLARE @CIDADE VARCHAR(20) \" +\n\"DECLARE @CEP CHAR(9) \" +\n\"DECLARE @UF CHAR(2)\" +\n\"DECLARE @DDD VARCHAR(3) \" +\n\"DECLARE @TELEFONE VARCHAR(15) \" +\n\"DECLARE @CONTATO VARCHAR(20) \" +\n\"DECLARE @DESCONTO BIT \" +\n\n\"SET @CNPJ = CAST(\" +           (\"'\" + msg.pedido.cliente.cnpj + \"'\"            || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @INSCRICAO = CAST(\" +      (\"'\" + msg.pedido.cliente.inscricao + \"'\"       || \"NULL\") + \" AS VARCHAR(14)) \" +\n\"SET @FANTASIA = CAST(\" +       (\"'\" + msg.pedido.cliente.fantasia + \"'\"        || \"NULL\") + \" AS VARCHAR(30)) \" +\n\"SET @NOME = CAST(\" +           (\"'\" + msg.pedido.cliente.nome + \"'\"            || \"NULL\") + \" AS VARCHAR(100)) \" +\n\"SET @LOGRADOURO = CAST(\" +     (\"'\" + msg.pedido.cliente.logradouro + \"'\"      || \"NULL\") + \" AS VARCHAR(5)) \" +\n\"SET @ENDERECO = CAST(\" +       (\"'\" + msg.pedido.cliente.endereco + \"'\"        || \"NULL\") + \" AS VARCHAR(50)) \" +\n\"SET @NUMERO = CAST(\" +         (\"'\" + msg.pedido.cliente.numero + \"'\"          || \"NULL\") + \" AS VARCHAR(10)) \" +\n\"SET @COMPLEMENTO = CAST(\" +    (\"'\" + msg.pedido.cliente.complemento + \"'\"     || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @BAIRRO = CAST(\" +         (\"'\" + msg.pedido.cliente.bairro + \"'\"          || \"NULL\") + \" AS VARCHAR(30)) \" +\n\"SET @MUNICIPIO = CAST(\" +      (msg.pedido.cliente.municipio                   || \"NULL\") + \" AS INT) \" +\n\"SET @CIDADE = CAST(\" +         (\"'\" + msg.pedido.cliente.cidade + \"'\"          || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @CEP = CAST(\" +            (\"'\" + msg.pedido.cliente.CEP + \"'\"             || \"NULL\") + \" AS CHAR(9)) \" +\n\"SET @UF = CAST(\" +             (\"'\" + msg.pedido.cliente.UF + \"'\"              || \"NULL\") + \" AS CHAR(2)) \" +\n\"SET @DDD = CAST(\" +            (\"'\" + msg.pedido.cliente.ddd + \"'\"             || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @TELEFONE = CAST(\" +       (\"'\" + msg.pedido.cliente.telefone + \"'\"        || \"NULL\") + \" AS VARCHAR(15)) \" +\n\"SET @CONTATO = CAST(\" +        (\"'\" + msg.pedido.cliente.contato + \"'\"         || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @DESCONTO = CAST(\" +        (\"'\" + msg.pedido.cliente.desconto + \"'\"         || \"NULL\") + \" AS BIT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[CLI] AS target \" +\n\"   USING (SELECT @CNPJ, @INSCRICAO, @FANTASIA, @NOME, @LOGRADOURO, @ENDERECO, @NUMERO, @COMPLEMENTO, @BAIRRO, @MUNICIPIO, @CIDADE, @CEP, @UF, @DDD, @TELEFONE, @CONTATO, @DESCONTO) AS source \" +\n\"   (CNPJ, INSCRICAO, FANTASIA, NOME, LOGRADOURO, ENDERECO, NUMERO, COMPLEMENTO, BAIRRO, MUNICIPIO, CIDADE, CEP, UF, DDD, TELEFONE, CONTATO, DESCONTO) \" +\n\"   ON (target.CNPJ = source.CNPJ) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET INSCRICAO = source.INSCRICAO, FANTASIA = source.FANTASIA, NOME = source.NOME, \" +\n\"   LOGRADOURO = source.LOGRADOURO, ENDERECO = source.ENDERECO, NUMERO = source.NUMERO, COMPLEMENTO = source.COMPLEMENTO, \" +\n\"   BAIRRO = source.BAIRRO, MUNICIPIO = source.MUNICIPIO, CIDADE = source.CIDADE, CEP = source.CEP, UF = source.UF, DDD = source.DDD, TELEFONE = source.TELEFONE, CONTATO = source.CONTATO, DESCONTO = source.DESCONTO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (CNPJ, INSCRICAO, FANTASIA, NOME, LOGRADOURO, ENDERECO, NUMERO, COMPLEMENTO, BAIRRO, MUNICIPIO, CIDADE, CEP, UF, DDD, TELEFONE, CONTATO, DESCONTO) \" +\n\"\tVALUES (source.CNPJ, source.INSCRICAO, source.FANTASIA, source.NOME, source.LOGRADOURO, source.ENDERECO, source.NUMERO, source.COMPLEMENTO, source.BAIRRO, source.MUNICIPIO, source.CIDADE, source.CEP, source.UF, source.DDD, source.TELEFONE, source.CONTATO, source.DESCONTO); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_CLI] AS target \" +\n\"   USING (SELECT @PEDIDO, @CNPJ) AS source \" +\n\"   (PED_NUMERO, CLI_CNPJ) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.CLI_CNPJ = source.CLI_CNPJ) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET CLI_CNPJ = source.CLI_CNPJ \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, CLI_CNPJ) \" +\n\"\tVALUES (source.PED_NUMERO, source.CLI_CNPJ); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":140,"y":560,"wires":[["9da0c674.e072d8","8211c3fd.47875"]]},{"id":"9da0c674.e072d8","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"f8d04a38.3d9938","name":"","query":"","outField":"payload","x":140,"y":620,"wires":[["bd546452.838ea8"]]},{"id":"8211c3fd.47875","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"payload","x":310,"y":560,"wires":[]},{"id":"bd546452.838ea8","type":"function","z":"e6097cee.8df04","name":"REPR.","func":"msg.payload = \n\"DECLARE @CODIGO VARCHAR(3) \" +\n\"DECLARE @NOME VARCHAR(50) \" +\n\n\"SET @CODIGO = CAST(\" +           (\"'\" + msg.pedido.representante.codigo + \"'\"            || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @NOME = CAST(\" +      (\"'\" + msg.pedido.representante.nome + \"'\"       || \"NULL\") + \" AS VARCHAR(50)) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[REP] AS target \" +\n\"   USING (SELECT @CODIGO, @NOME) AS source \" +\n\"   (CODIGO, NOME) \" +\n\"   ON (target.CODIGO = source.CODIGO) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET NOME = source.NOME \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (CODIGO, NOME) \" +\n\"\tVALUES (source.CODIGO, source.NOME); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_REP] AS target \" +\n\"   USING (SELECT @PEDIDO, @CODIGO) AS source \" +\n\"   (PED_NUMERO, REP_CODIGO) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.REP_CODIGO = source.REP_CODIGO) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET REP_CODIGO = source.REP_CODIGO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, REP_CODIGO) \" +\n\"\tVALUES (source.PED_NUMERO, source.REP_CODIGO); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":130,"y":680,"wires":[["3ccd4b59.ff3564","619271d9.c54ba"]]},{"id":"619271d9.c54ba","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"payload","x":310,"y":680,"wires":[]},{"id":"3ccd4b59.ff3564","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"f8d04a38.3d9938","name":"","query":"","outField":"payload","x":140,"y":740,"wires":[["91ea893f.02afe8"]]},{"id":"54c2cf15.e655f","type":"function","z":"e6097cee.8df04","name":"DUPL","func":"msg.payload = \n\"DECLARE @NOSSO_NUMERO INT \" +\n\"DECLARE @PARCELA INT \" +\n\"DECLARE @TIPO VARCHAR(3) \" +\n\"DECLARE @VENCTO DATE \" +\n\"DECLARE @PRAZO INT \" +\n\"DECLARE @PORCENTAGEM DECIMAL(18, 3) \" +\n\"DECLARE @VALOR MONEY \" +\n\"DECLARE @DESCRICAO VARCHAR(50) \" +\n\"DECLARE @ORIGEM VARCHAR(10) \" +\n\n\"SET @NOSSO_NUMERO = CAST(\" +   (\"'\" + msg.payload.nosso_numero + \"'\"   || \"NULL\") + \" AS INT) \" +\n\"SET @PARCELA = CAST(\" +        (\"'\" + msg.payload.parcela + \"'\"        || \"NULL\") + \" AS INT) \" +\n\"SET @TIPO = CAST(\" +           (\"'\" + msg.payload.tipo + \"'\"           || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @VENCTO = CAST(\" +         (\"'\" + msg.payload.vencto + \"'\"         || \"NULL\") + \" AS DATE) \" +\n\"SET @PRAZO = CAST(\" +          (\"'\" + msg.payload.prazo + \"'\"          || \"NULL\") + \" AS INT) \" +\n\"SET @PORCENTAGEM = CAST(\" +    (\"'\" + msg.payload.porcentagem + \"'\"    || \"NULL\") + \" AS DECIMAL(18, 3)) \" +\n\"SET @VALOR = CAST(\" +          (\"'\" + msg.payload.valor + \"'\"          || \"NULL\") + \" AS MONEY) \" +\n\"SET @DESCRICAO = CAST(\" +      (\"'\" + msg.payload.descricao + \"'\"      || \"NULL\") + \" AS VARCHAR(50)) \" +\n\"SET @ORIGEM = 'PEDIDO' \" +\n\n\"MERGE [FINANCEIRO].[dbo].[DUP] AS target \" +\n\"   USING (SELECT @NOSSO_NUMERO, @PARCELA, @TIPO, @VENCTO, @PRAZO, @PORCENTAGEM, @VALOR, @DESCRICAO, @ORIGEM) AS source \" +\n\"   (NOSSO_NUMERO, PARCELA, TIPO, VENCTO, PRAZO, PORCENTAGEM, VALOR, DESCRICAO, ORIGEM) \" +\n\"   ON (target.NOSSO_NUMERO = source.NOSSO_NUMERO AND target.PARCELA = source.PARCELA) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET NOSSO_NUMERO = source.NOSSO_NUMERO, PARCELA = source.PARCELA, TIPO = source.TIPO, VENCTO = source.VENCTO, PRAZO = source.PRAZO, PORCENTAGEM = source.PORCENTAGEM, VALOR = source.VALOR, DESCRICAO = source.DESCRICAO, ORIGEM = source.ORIGEM \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (NOSSO_NUMERO, PARCELA, TIPO, VENCTO, PRAZO, PORCENTAGEM, VALOR, DESCRICAO, ORIGEM) \" +\n\"\tVALUES (source.NOSSO_NUMERO, source.PARCELA, source.TIPO, source.VENCTO, source.PRAZO, source.PORCENTAGEM, source.VALOR, source.DESCRICAO, source.ORIGEM); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_DUP] AS target \" +\n\"   USING (SELECT @PEDIDO, @NOSSO_NUMERO, @PARCELA) AS source \" +\n\"   (PED_NUMERO, DUP_NOSSO_NUMERO, DUP_PARCELA) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.DUP_NOSSO_NUMERO = source.DUP_NOSSO_NUMERO AND target.DUP_PARCELA = source.DUP_PARCELA) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET DUP_NOSSO_NUMERO = source.DUP_NOSSO_NUMERO, DUP_PARCELA = source.DUP_PARCELA \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, DUP_NOSSO_NUMERO, DUP_PARCELA) \" +\n\"\tVALUES (source.PED_NUMERO, source.DUP_NOSSO_NUMERO, source.DUP_PARCELA); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":780,"wires":[["312c4278.681bee","a19da9b4.6dff18"]]},{"id":"312c4278.681bee","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"f8d04a38.3d9938","name":"","query":"","outField":"payload","x":440,"y":840,"wires":[["91ea893f.02afe8"]]},{"id":"a19da9b4.6dff18","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"payload","x":450,"y":780,"wires":[]},{"id":"91ea893f.02afe8","type":"function","z":"e6097cee.8df04","name":"LOOP","func":"if (msg.parcela === undefined) {\n    msg.parcela = 0;\n    msg.payload = msg.pedido.parcelas[0]\n    return [msg, null];\n} else {\n    msg.parcela++\n    if (msg.parcela < msg.pedido.parcelas.length) {\n        msg.payload = msg.pedido.parcelas[msg.parcela];\n        return [msg, null];\n    } else {\n        return [null, msg];\n    }\n}","outputs":"2","noerr":0,"x":130,"y":820,"wires":[["54c2cf15.e655f"],["c5a538e4.1b9148"]]},{"id":"4951732f.f9bd4c","type":"http in","z":"e6097cee.8df04","name":"","url":"/api/financeiro/duplicata/desconto/concluir/:task","method":"post","swaggerDoc":"","x":790,"y":340,"wires":[["fdc27142.869bd","9b4a7cff.aa6af"]]},{"id":"88652451.f1d378","type":"function","z":"e6097cee.8df04","name":"TASK","func":"msg.payload = \n\"DECLARE @ID INT \" +\n\"SET @ID = \" + (parseInt(msg.req.params.task) || 'NULL') + \" \" +\n\"UPDATE TASK SET \" +\n\"\tDONE_DATE = GETDATE() \" +\n\"WHERE \" +\n\"   TASK.ID = @ID; \" +\n\"SELECT * FROM TASK WHERE ID = @ID;\"\n\nif (msg.pedido.cliente.desconto) {\n    msg.newTask = \n            \"DECLARE @ID INT \" +\n            \"SET @ID = NEXT VALUE FOR TASK_SEQUENCE \" +\n            \"INSERT INTO TASK \" +\n            \"   (ID, \" +\n            \"   NAME, \" +\n            \"   TITLE, \" +\n            \"   DETAIL, \" +\n            \"   PAYLOAD, \" +\n            \"   ASSIGN_TO, \" +\n            \"   LINK, \" +\n            \"   DUE_DATE, \" +\n            \"   CREATE_DATE, \" +\n            \"   DONE_DATE) \" +\n            \"VALUES \" +\n            \"   (@ID, \" +\n            \"   'Ordem de Desconto', \" +\n            \"   'Pedido \" + msg.pedido.numero + \"', \" +\n            \"   '\" + msg.pedido.cliente.nome + \"', \" +\n            \"   '\" + JSON.stringify(msg.pedido) + \"', \" + \n            \"   NULL, \" +\n            \"   '/duplicata/desconto/' + CAST(@ID AS NVARCHAR), \" +\n            \"   NULL, \" +\n            \"   GETDATE(), \" +\n            \"   NULL); \" +\n            \"SELECT * FROM TASK WHERE ID = @ID;\"\n\n}\n\nreturn msg;","outputs":"1","noerr":0,"x":690,"y":880,"wires":[["23b93b70.079bb4"]]},{"id":"718dde73.1dee5","type":"http response","z":"e6097cee.8df04","name":"","x":1010,"y":880,"wires":[]},{"id":"23b93b70.079bb4","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"2c209f4e.630ba","name":"","query":"","outField":"payload","x":840,"y":880,"wires":[["718dde73.1dee5","7b84f1cc.f8562","dbad036.fc1b9"]]},{"id":"8b7b69bc.f07fd8","type":"mqtt out","z":"e6097cee.8df04","name":"","topic":"","qos":"","retain":"","broker":"86aaad3e.7a45","x":1110,"y":980,"wires":[]},{"id":"7b84f1cc.f8562","type":"function","z":"e6097cee.8df04","name":"NOTIFY","func":"msg.topic = '/tarefas/concluida/' // + msg.task.id\nmsg.payload = msg.payload[0]\nreturn msg;","outputs":1,"noerr":0,"x":960,"y":940,"wires":[["8b7b69bc.f07fd8","e06c6225.2ef94"]]},{"id":"e06c6225.2ef94","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"topic","x":1120,"y":940,"wires":[]},{"id":"fdc27142.869bd","type":"debug","z":"e6097cee.8df04","name":"","active":true,"console":"false","complete":"payload","x":710,"y":400,"wires":[]},{"id":"9b4a7cff.aa6af","type":"function","z":"e6097cee.8df04","name":"PEDIDO","func":"msg.pedido = msg.payload;\nmsg.payload = \n//\"DECLARE @EMPRESA INT \" +\n\"DECLARE @NUMERO INT \" +\n\"DECLARE @EMISSAO DATE \" +\n\"DECLARE @ENTREGA DATE \" +\n\"DECLARE @CONDICAO VARCHAR(3) \" +\n\"DECLARE @COMISSAO DECIMAL(18, 3) \" +\n\n//\"SET @EMPRESA = CAST(\" + (msg.pedido.empresa || 'NULL') + \" AS INT) \" +\n\"SET @NUMERO = CAST(\" + (msg.pedido.numero || 'NULL') + \" AS INT) \" +\n\"SET @EMISSAO = CAST('\" + (msg.pedido.emissao || 'NULL') + \"' AS DATE) \" +\n\"SET @ENTREGA = CAST('\" + (msg.pedido.entrega || 'NULL') + \"' AS DATE) \" +\n\"SET @CONDICAO = CAST('\" + (msg.pedido.condicao || 'NULL') + \"' AS VARCHAR(3)) \" +\n\"SET @COMISSAO = CAST(\" + (msg.pedido.comissao || 'NULL') + \" AS DECIMAL(18, 3)) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED] AS target \" +\n\"    USING (SELECT @NUMERO, @EMISSAO, @ENTREGA, @CONDICAO, @COMISSAO) AS source (NUMERO, EMISSAO, ENTREGA, CONDICAO, COMISSAO) \" +\n\"    ON (target.NUMERO = source.NUMERO) \" +\n\"WHEN MATCHED THEN \" +\n\"    UPDATE SET EMISSAO = source.EMISSAO, ENTREGA = source.ENTREGA, CONDICAO = source.CONDICAO, COMISSAO = source.COMISSAO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (NUMERO, EMISSAO, ENTREGA, CONDICAO, COMISSAO) \" +\n\"\tVALUES (source.NUMERO, source.EMISSAO, source.ENTREGA, source.CONDICAO, source.COMISSAO); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":700,"y":440,"wires":[["bc7dca3b.883f88","879a5f29.696a5"]]},{"id":"bc7dca3b.883f88","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"f8d04a38.3d9938","name":"","query":"","outField":"payload","x":700,"y":500,"wires":[["6ffa983.6cb4568"]]},{"id":"879a5f29.696a5","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"payload","x":870,"y":440,"wires":[]},{"id":"6ffa983.6cb4568","type":"function","z":"e6097cee.8df04","name":"CLIENTE","func":"msg.payload = \n\"DECLARE @CNPJ VARCHAR(20) \" +\n\"DECLARE @INSCRICAO VARCHAR(12) \" +\n\"DECLARE @FANTASIA VARCHAR(30) \" +\n\"DECLARE @NOME VARCHAR(100) \" +\n\"DECLARE @LOGRADOURO VARCHAR(5) \" +\n\"DECLARE @ENDERECO VARCHAR(50) \" +\n\"DECLARE @NUMERO VARCHAR(10) \" +\n\"DECLARE @COMPLEMENTO VARCHAR(20) \" +\n\"DECLARE @BAIRRO VARCHAR(30) \" +\n\"DECLARE @MUNICIPIO INT \" +\n\"DECLARE @CIDADE VARCHAR(20) \" +\n\"DECLARE @CEP CHAR(9) \" +\n\"DECLARE @UF CHAR(2)\" +\n\"DECLARE @DDD VARCHAR(3) \" +\n\"DECLARE @TELEFONE VARCHAR(15) \" +\n\"DECLARE @CONTATO VARCHAR(20) \" +\n\"DECLARE @DESCONTO BIT \" +\n\n\"SET @CNPJ = CAST(\" +           (\"'\" + msg.pedido.cliente.cnpj + \"'\"            || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @INSCRICAO = CAST(\" +      (\"'\" + msg.pedido.cliente.inscricao + \"'\"       || \"NULL\") + \" AS VARCHAR(14)) \" +\n\"SET @FANTASIA = CAST(\" +       (\"'\" + msg.pedido.cliente.fantasia + \"'\"        || \"NULL\") + \" AS VARCHAR(30)) \" +\n\"SET @NOME = CAST(\" +           (\"'\" + msg.pedido.cliente.nome + \"'\"            || \"NULL\") + \" AS VARCHAR(100)) \" +\n\"SET @LOGRADOURO = CAST(\" +     (\"'\" + msg.pedido.cliente.logradouro + \"'\"      || \"NULL\") + \" AS VARCHAR(5)) \" +\n\"SET @ENDERECO = CAST(\" +       (\"'\" + msg.pedido.cliente.endereco + \"'\"        || \"NULL\") + \" AS VARCHAR(50)) \" +\n\"SET @NUMERO = CAST(\" +         (\"'\" + msg.pedido.cliente.numero + \"'\"          || \"NULL\") + \" AS VARCHAR(10)) \" +\n\"SET @COMPLEMENTO = CAST(\" +    (\"'\" + msg.pedido.cliente.complemento + \"'\"     || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @BAIRRO = CAST(\" +         (\"'\" + msg.pedido.cliente.bairro + \"'\"          || \"NULL\") + \" AS VARCHAR(30)) \" +\n\"SET @MUNICIPIO = CAST(\" +      (msg.pedido.cliente.municipio                   || \"NULL\") + \" AS INT) \" +\n\"SET @CIDADE = CAST(\" +         (\"'\" + msg.pedido.cliente.cidade + \"'\"          || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @CEP = CAST(\" +            (\"'\" + msg.pedido.cliente.CEP + \"'\"             || \"NULL\") + \" AS CHAR(9)) \" +\n\"SET @UF = CAST(\" +             (\"'\" + msg.pedido.cliente.UF + \"'\"              || \"NULL\") + \" AS CHAR(2)) \" +\n\"SET @DDD = CAST(\" +            (\"'\" + msg.pedido.cliente.ddd + \"'\"             || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @TELEFONE = CAST(\" +       (\"'\" + msg.pedido.cliente.telefone + \"'\"        || \"NULL\") + \" AS VARCHAR(15)) \" +\n\"SET @CONTATO = CAST(\" +        (\"'\" + msg.pedido.cliente.contato + \"'\"         || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @DESCONTO = CAST(\" +        (\"'\" + msg.pedido.cliente.desconto + \"'\"         || \"NULL\") + \" AS BIT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[CLI] AS target \" +\n\"   USING (SELECT @CNPJ, @INSCRICAO, @FANTASIA, @NOME, @LOGRADOURO, @ENDERECO, @NUMERO, @COMPLEMENTO, @BAIRRO, @MUNICIPIO, @CIDADE, @CEP, @UF, @DDD, @TELEFONE, @CONTATO, @DESCONTO) AS source \" +\n\"   (CNPJ, INSCRICAO, FANTASIA, NOME, LOGRADOURO, ENDERECO, NUMERO, COMPLEMENTO, BAIRRO, MUNICIPIO, CIDADE, CEP, UF, DDD, TELEFONE, CONTATO, DESCONTO) \" +\n\"   ON (target.CNPJ = source.CNPJ) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET INSCRICAO = source.INSCRICAO, FANTASIA = source.FANTASIA, NOME = source.NOME, \" +\n\"   LOGRADOURO = source.LOGRADOURO, ENDERECO = source.ENDERECO, NUMERO = source.NUMERO, COMPLEMENTO = source.COMPLEMENTO, \" +\n\"   BAIRRO = source.BAIRRO, MUNICIPIO = source.MUNICIPIO, CIDADE = source.CIDADE, CEP = source.CEP, UF = source.UF, DDD = source.DDD, TELEFONE = source.TELEFONE, CONTATO = source.CONTATO, DESCONTO = source.DESCONTO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (CNPJ, INSCRICAO, FANTASIA, NOME, LOGRADOURO, ENDERECO, NUMERO, COMPLEMENTO, BAIRRO, MUNICIPIO, CIDADE, CEP, UF, DDD, TELEFONE, CONTATO, DESCONTO) \" +\n\"\tVALUES (source.CNPJ, source.INSCRICAO, source.FANTASIA, source.NOME, source.LOGRADOURO, source.ENDERECO, source.NUMERO, source.COMPLEMENTO, source.BAIRRO, source.MUNICIPIO, source.CIDADE, source.CEP, source.UF, source.DDD, source.TELEFONE, source.CONTATO, source.DESCONTO); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_CLI] AS target \" +\n\"   USING (SELECT @PEDIDO, @CNPJ) AS source \" +\n\"   (PED_NUMERO, CLI_CNPJ) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.CLI_CNPJ = source.CLI_CNPJ) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET CLI_CNPJ = source.CLI_CNPJ \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, CLI_CNPJ) \" +\n\"\tVALUES (source.PED_NUMERO, source.CLI_CNPJ); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":700,"y":560,"wires":[["15717d30.5e63f3","65d9bfb1.39189"]]},{"id":"15717d30.5e63f3","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"f8d04a38.3d9938","name":"","query":"","outField":"payload","x":700,"y":620,"wires":[["2d01577.480a1a8"]]},{"id":"65d9bfb1.39189","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"payload","x":870,"y":560,"wires":[]},{"id":"2d01577.480a1a8","type":"function","z":"e6097cee.8df04","name":"REPR.","func":"msg.payload = \n\"DECLARE @CODIGO VARCHAR(3) \" +\n\"DECLARE @NOME VARCHAR(50) \" +\n\n\"SET @CODIGO = CAST(\" +           (\"'\" + msg.pedido.representante.codigo + \"'\"            || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @NOME = CAST(\" +      (\"'\" + msg.pedido.representante.nome + \"'\"       || \"NULL\") + \" AS VARCHAR(50)) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[REP] AS target \" +\n\"   USING (SELECT @CODIGO, @NOME) AS source \" +\n\"   (CODIGO, NOME) \" +\n\"   ON (target.CODIGO = source.CODIGO) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET NOME = source.NOME \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (CODIGO, NOME) \" +\n\"\tVALUES (source.CODIGO, source.NOME); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_REP] AS target \" +\n\"   USING (SELECT @PEDIDO, @CODIGO) AS source \" +\n\"   (PED_NUMERO, REP_CODIGO) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.REP_CODIGO = source.REP_CODIGO) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET REP_CODIGO = source.REP_CODIGO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, REP_CODIGO) \" +\n\"\tVALUES (source.PED_NUMERO, source.REP_CODIGO); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":680,"wires":[["44419bf5.1e8a14","4c4b42de.673cdc"]]},{"id":"4c4b42de.673cdc","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"payload","x":870,"y":680,"wires":[]},{"id":"44419bf5.1e8a14","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"f8d04a38.3d9938","name":"","query":"","outField":"payload","x":700,"y":740,"wires":[["3ff06943.ae7856"]]},{"id":"d31a6438.c60be8","type":"function","z":"e6097cee.8df04","name":"DUPL","func":"msg.payload = \n\"DECLARE @NOSSO_NUMERO INT \" +\n\"DECLARE @PARCELA INT \" +\n\"DECLARE @TIPO VARCHAR(3) \" +\n\"DECLARE @VENCTO DATE \" +\n\"DECLARE @PRAZO INT \" +\n\"DECLARE @PORCENTAGEM DECIMAL(18, 3) \" +\n\"DECLARE @VALOR MONEY \" +\n\"DECLARE @DESCRICAO VARCHAR(50) \" +\n\"DECLARE @ORIGEM VARCHAR(10) \" +\n\n\"SET @NOSSO_NUMERO = CAST(\" +   (\"'\" + msg.payload.nosso_numero + \"'\"   || \"NULL\") + \" AS INT) \" +\n\"SET @PARCELA = CAST(\" +        (\"'\" + msg.payload.parcela + \"'\"        || \"NULL\") + \" AS INT) \" +\n\"SET @TIPO = CAST(\" +           (\"'\" + msg.payload.tipo + \"'\"           || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @VENCTO = CAST(\" +         (\"'\" + msg.payload.vencto + \"'\"         || \"NULL\") + \" AS DATE) \" +\n\"SET @PRAZO = CAST(\" +          (\"'\" + msg.payload.prazo + \"'\"          || \"NULL\") + \" AS INT) \" +\n\"SET @PORCENTAGEM = CAST(\" +    (\"'\" + msg.payload.porcentagem + \"'\"    || \"NULL\") + \" AS DECIMAL(18, 3)) \" +\n\"SET @VALOR = CAST(\" +          (\"'\" + msg.payload.valor + \"'\"          || \"NULL\") + \" AS MONEY) \" +\n\"SET @DESCRICAO = CAST(\" +      (\"'\" + msg.payload.descricao + \"'\"      || \"NULL\") + \" AS VARCHAR(50)) \" +\n\"SET @ORIGEM = 'PEDIDO' \" +\n\n\"MERGE [FINANCEIRO].[dbo].[DUP] AS target \" +\n\"   USING (SELECT @NOSSO_NUMERO, @PARCELA, @TIPO, @VENCTO, @PRAZO, @PORCENTAGEM, @VALOR, @DESCRICAO, @ORIGEM) AS source \" +\n\"   (NOSSO_NUMERO, PARCELA, TIPO, VENCTO, PRAZO, PORCENTAGEM, VALOR, DESCRICAO, ORIGEM) \" +\n\"   ON (target.NOSSO_NUMERO = source.NOSSO_NUMERO AND target.PARCELA = source.PARCELA) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET NOSSO_NUMERO = source.NOSSO_NUMERO, PARCELA = source.PARCELA, TIPO = source.TIPO, VENCTO = source.VENCTO, PRAZO = source.PRAZO, PORCENTAGEM = source.PORCENTAGEM, VALOR = source.VALOR, DESCRICAO = source.DESCRICAO, ORIGEM = source.ORIGEM \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (NOSSO_NUMERO, PARCELA, TIPO, VENCTO, PRAZO, PORCENTAGEM, VALOR, DESCRICAO, ORIGEM) \" +\n\"\tVALUES (source.NOSSO_NUMERO, source.PARCELA, source.TIPO, source.VENCTO, source.PRAZO, source.PORCENTAGEM, source.VALOR, source.DESCRICAO, source.ORIGEM); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_DUP] AS target \" +\n\"   USING (SELECT @PEDIDO, @NOSSO_NUMERO, @PARCELA) AS source \" +\n\"   (PED_NUMERO, DUP_NOSSO_NUMERO, DUP_PARCELA) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.DUP_NOSSO_NUMERO = source.DUP_NOSSO_NUMERO AND target.DUP_PARCELA = source.DUP_PARCELA) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET DUP_NOSSO_NUMERO = source.DUP_NOSSO_NUMERO, DUP_PARCELA = source.DUP_PARCELA \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, DUP_NOSSO_NUMERO, DUP_PARCELA) \" +\n\"\tVALUES (source.PED_NUMERO, source.DUP_NOSSO_NUMERO, source.DUP_PARCELA); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":780,"wires":[["9eff8fd.f76ff7","ec36ad4e.e58de"]]},{"id":"9eff8fd.f76ff7","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"f8d04a38.3d9938","name":"","query":"","outField":"payload","x":1000,"y":840,"wires":[["3ff06943.ae7856"]]},{"id":"ec36ad4e.e58de","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"payload","x":1010,"y":780,"wires":[]},{"id":"3ff06943.ae7856","type":"function","z":"e6097cee.8df04","name":"LOOP","func":"if (msg.parcela === undefined) {\n    msg.parcela = 0;\n    msg.payload = msg.pedido.parcelas[0]\n    return [msg, null];\n} else {\n    msg.parcela++\n    if (msg.parcela < msg.pedido.parcelas.length) {\n        msg.payload = msg.pedido.parcelas[msg.parcela];\n        return [msg, null];\n    } else {\n        return [null, msg];\n    }\n}","outputs":"2","noerr":0,"x":690,"y":820,"wires":[["d31a6438.c60be8"],["88652451.f1d378"]]},{"id":"1d789a13.578126","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"2c209f4e.630ba","name":"","query":"","outField":"payload","x":840,"y":1040,"wires":[["26fa6812.1647b8","ea4a04e8.b79a88"]]},{"id":"ea4a04e8.b79a88","type":"mqtt out","z":"e6097cee.8df04","name":"","topic":"","qos":"","retain":"","broker":"86aaad3e.7a45","x":1070,"y":1100,"wires":[]},{"id":"dbad036.fc1b9","type":"function","z":"e6097cee.8df04","name":"NOTIFY","func":"if (msg.newTask) {\n    msg.topic = '/tarefas/nova/' // + msg.payload.id\n    msg.payload = msg.newTask;\n    return msg;\n}","outputs":1,"noerr":0,"x":840,"y":1000,"wires":[["1d789a13.578126"]]},{"id":"26fa6812.1647b8","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"topic","x":1060,"y":1040,"wires":[]},{"id":"162ddda.4a21522","type":"MSSQL-CN","z":"","name":"gpimac","server":"127.0.0.1","encyption":true,"database":"GPIMAC_Altamira"},{"id":"2c209f4e.630ba","type":"MSSQL-CN","z":"","name":"BPM","server":"192.168.0.1","encyption":false,"database":"BPM"},{"id":"86aaad3e.7a45","type":"mqtt-broker","z":"","broker":"192.168.0.1","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willPayload":"","birthTopic":"","birthQos":"0","birthPayload":""},{"id":"f8d04a38.3d9938","type":"MSSQL-CN","z":"","name":"FINANCEIRO","server":"192.168.0.1","encyption":false,"database":"FINANCEIRO"}]