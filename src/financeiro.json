[{"id":"7d98d2a2.e7b81c","type":"http in","z":"e6097cee.8df04","name":"busca","url":"/api/financeiro/duplicata/emissao/busca","method":"get","swaggerDoc":"","x":88.19999694824219,"y":668,"wires":[["4a08a3e6.a0c01c"]]},{"id":"4a08a3e6.a0c01c","type":"function","z":"e6097cee.8df04","name":"SQL","func":"msg.payload = \n    \"DECLARE @PEDIDO INT\\n\" +\n    \"DECLARE @CNPJ NVARCHAR(14)\\n\" +\n    \"DECLARE @NOME NVARCHAR(100)\\n\" +\n    \"SET @PEDIDO = \" + (msg.req.query.pedido || 'NULL') + \"\\n\" +\n    \"SET @CNPJ = \" + (\"'\" + msg.req.query.cnpj + \"'\" || 'NULL') + \"\\n\" +\n    \"SET @NOME = \" + (\"'\" + msg.req.query.nome + \"'\" || 'NULL') + \"\\n\" +\n    \"SELECT top 10 \" +\n    \"\tLTRIM(RTRIM(LPV.LPEMP)) AS empresa, \\n\" +\n    \"\tCAST(LPV.LPPED AS INT) AS pedido, \\n\" +\n    \"\tCAST(LPV.LPENT AS DATE) AS emissao, \\n\" +\n    \"\tLPV.Lp0SaiRed AS entrega, \\n\" +\n    \"\tLTRIM(RTRIM(CACLI.CCCGC)) AS cnpj, \\n\" +\n    \"\tLTRIM(RTRIM(CACLI.CCFAN)) AS fantasia, \\n\" +\n    \"\tLTRIM(RTRIM(CACLI.CCNOM)) AS nome \\n\" +\n    \"FROM \\n\" +\n    \"\tGPIMAC_Altamira.dbo.LPV AS LPV INNER JOIN \\n\" +\n    \"   GPIMAC_Altamira.dbo.CACLI ON LPV.CCCGC = GPIMAC_Altamira.dbo.CACLI.CCCGC \\n\" +\n    \"WHERE \\n\" +\n    \"   (@PEDIDO IS NULL OR LPV.LPPED LIKE '%' + CAST(@PEDIDO AS NVARCHAR(10)) + '%') AND \\n\" +\n    \"   (@CNPJ IS NULL OR CACLI.CCCGC LIKE '%' + @CNPJ + '%') AND \\n\" +\n    \"   (@NOME IS NULL OR CACLI.CCFAN LIKE '%' + @NOME + '%') AND \\n\" +\n    \"   (@NOME IS NULL OR CACLI.CCNOM LIKE '%' + @NOME + '%') \\n\" +\n    \"ORDER BY \\n\" +\n    \"   LPV.LPPED DESC\"\n\nreturn msg;","outputs":1,"noerr":0,"x":328.1999969482422,"y":668,"wires":[["2201eb15.682df4"]]},{"id":"a877fdc4.10b9","type":"http response","z":"e6097cee.8df04","name":"","x":888.1999969482422,"y":668,"wires":[]},{"id":"2201eb15.682df4","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"fe2eccea.fe5bf","name":"","query":"","outField":"payload","x":738.1999969482422,"y":668,"wires":[["a877fdc4.10b9"]]},{"id":"ce114619.47ce18","type":"http in","z":"e6097cee.8df04","name":"lancamento","url":"/api/financeiro/recebiveis/lancamento/tarefa/:tarefa","method":"post","swaggerDoc":"","x":108.19999694824219,"y":868,"wires":[["491daf37.ba6e"]]},{"id":"491daf37.ba6e","type":"function","z":"e6097cee.8df04","name":"SQL","func":"var tarefa_cobranca = \n{\n    nome: 'Cobrança Bancária',\n    titulo: 'Gerar Remessa de Cobrança',\n    descricao: 'Saldo R$ ' + msg.payload.documento.parcelas.reduce( (total, parcela) => total + parcela.valor, 0).toFixed(2).replace('.', ','), \n    documento: JSON.stringify(\n        {\n            nosso_numero: msg.payload.documento.nosso_numero,\n            pedido: msg.payload.documento.numero,\n            cliente: msg.payload.documento.cliente,\n            parcelas: msg.payload.documento.parcelas\n        }),\n    atribuir: 'financeiro',\n    form: '/recebiveis/cobranca/'\n}\n\nmsg.payload = \n    \"SET NOCOUNT ON\" + '\\n' + '\\n' +\n    \n    \"------------------------------------- DECLARACAO DE VARIAVEIS ----------------------------------------------\" + '\\n' +\n    \"DECLARE @NOSSO_NUMERO INT\" + '\\n' +\n    \"DECLARE @CONTA_CONTABIL VARCHAR(20)\" + '\\n' +\n    \"DECLARE @CNPJ VARCHAR(20)\" + '\\n' +\n    \"DECLARE @INSCRICAO VARCHAR(12)\" + '\\n' +\n    \"DECLARE @FANTASIA VARCHAR(30)\" + '\\n' +\n    \"DECLARE @NOME VARCHAR(100)\" + '\\n' +\n    \"DECLARE @LOGRADOURO VARCHAR(5)\" + '\\n' +\n    \"DECLARE @ENDERECO VARCHAR(50)\" + '\\n' +\n    \"DECLARE @NUMERO VARCHAR(10)\" + '\\n' +\n    \"DECLARE @COMPLEMENTO VARCHAR(20)\" + '\\n' +\n    \"DECLARE @BAIRRO VARCHAR(30)\" + '\\n' +\n    \"DECLARE @MUNICIPIO INT\" + '\\n' +\n    \"DECLARE @CIDADE VARCHAR(20)\" + '\\n' +\n    \"DECLARE @CEP CHAR(9)\" + '\\n' +\n    \"DECLARE @UF CHAR(2)\" + '\\n' +\n    \"DECLARE @DDD VARCHAR(3)\" + '\\n' +\n    \"DECLARE @TELEFONE VARCHAR(15)\" + '\\n' +\n    \"DECLARE @CONTATO VARCHAR(20)\" + '\\n' +\n    \n    \"DECLARE @PARCELA INT\" + '\\n' +\n    \"DECLARE @FORMA_PAGTO VARCHAR(10)\" + '\\n' +\n    \"DECLARE @TIPO_VENCTO VARCHAR(3)\" + '\\n' +\n    \"DECLARE @VENCTO DATE\" + '\\n' +\n    \"DECLARE @PRAZO INT\" + '\\n' +\n    \"DECLARE @PORCENTAGEM DECIMAL(18, 3)\" + '\\n' +\n    \"DECLARE @VALOR MONEY\" + '\\n' +\n    \"DECLARE @DESCRICAO VARCHAR(50)\" + '\\n' +\n    \"DECLARE @ORIGEM VARCHAR(10)\" + '\\n' +\n\n    \"DECLARE @TAREFA_ATUAL INT\" + '\\n' +\n    \"DECLARE @VERSAO INT\" + '\\n' + '\\n' +\n\n    \"DECLARE @ULTIMA_VERSAO INT\" + '\\n' +\n    \"DECLARE @CONCLUIDO DATETIME\" + '\\n' + '\\n' +\n\n    \"DECLARE @PROX_TAREFA INT\" + '\\n' +\n    \"DECLARE @PROX_TAREFA_VERSAO INT\" + '\\n' + '\\n' +\n    \n    \"DECLARE @NOVA_NAV INT\" + '\\n' + '\\n' +\n    \n    \"DECLARE @tarefas TABLE (\" + '\\n' +\n\t\"\t[id] [int] NOT NULL,\" + '\\n' +\n\t\"\t[nome] [nvarchar](100) NOT NULL,\" + '\\n' +\n\t\"\t[titulo] [nvarchar](50) NULL,\" + '\\n' +\n\t\"\t[descricao] [nvarchar](50) NULL,\" + '\\n' +\n\t\"\t[atribuir] [nvarchar](50) NULL,\" + '\\n' +\n\t\"\t[form] [nvarchar](100) NOT NULL,\" + '\\n' +\n\t\"\t[parametros] [nvarchar](max) NULL,\" + '\\n' +\n\t\"\t[prazo] [datetime] NULL,\" + '\\n' +\n\t\"\t[criado] [datetime] NOT NULL,\" + '\\n' +\n\t\"\t[concluido] [datetime] NULL,\" + '\\n' +\n\t\"\t[versao] [int],\" + '\\n' +\n\t\"\t[topico] [nvarchar](100) NOT NULL)\" + '\\n' + '\\n' +\n\n    \"BEGIN TRY\" + '\\n' +\n    \"   BEGIN TRANSACTION\" + '\\n' + '\\n' +\n\n    \"   -------------------------------------- ATUALIZACAO DAS TAREFAS ----------------------------------------------\" + '\\n' +\n    \"   SET @TAREFA_ATUAL = \" + (parseInt(msg.req.params.tarefa) || 'NULL') + \"\" + '\\n' +\n    \"   SET @VERSAO = CAST('\" + (msg.payload.versao || 'NULL') + \"' AS INT)\" + '\\n' + '\\n' +\n\n    \"   UPDATE tarefas SET\" + '\\n' +\n    \"\t    concluido = GETDATE()\" + '\\n' +\n    \"   WHERE\" + '\\n' +\n    \"       id = @TAREFA_ATUAL\" + '\\n' +\n    \"       AND concluido IS NULL\" + '\\n' + '\\n' +\n    \"       AND versao = @VERSAO\" + '\\n' + '\\n' +\n    \n    \"   IF @@ROWCOUNT != 1\" + '\\n' +\n    \"   BEGIN\" + '\\n' +\n    \n    \"       ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"       SELECT TOP 1 @ULTIMA_VERSAO = versao, @CONCLUIDO = concluido FROM tarefas WHERE id = @TAREFA_ATUAL\" + '\\n' + '\\n' +\n    \n    \"       IF (NOT @CONCLUIDO IS NULL)\" + '\\n' +\n    \"       BEGIN\" + '\\n' +\n    \"           INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7010\" + '\\n' +\n    \"           SELECT * FROM ERR WHERE erro = 7010\" + '\\n' +\n    \"       END\" + '\\n' +\n    \"       ELSE IF (@ULTIMA_VERSAO <> @VERSAO)\" + '\\n' +\n    \"       BEGIN\" + '\\n' +\n    \"           INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7450\" + '\\n' +\n    \"           SELECT * FROM ERR WHERE erro = 7450\" + '\\n' + '\\n' +\n    \"       END\" + '\\n' + '\\n' +\n    \n    \"       RETURN\" + '\\n' +\n    \"   END\" + '\\n' + '\\n' +\n    \n    \"   INSERT INTO @tarefas SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/concluida/' + LTRIM(RTRIM(atribuir)) AS topico FROM tarefas WHERE id = @TAREFA_ATUAL\" + '\\n' + '\\n' +\n\n    (msg.payload.documento.parcelas.find( p => p.forma_pagto === 'COBRANCA') ?\n\n    \"   SELECT TOP 1 @PROX_TAREFA = id, @PROX_TAREFA_VERSAO = versao FROM tarefas WHERE nome = '\" + tarefa_cobranca.nome + \"' AND concluido IS NULL\" + '\\n' + '\\n' +\n   \n    \"   IF @PROX_TAREFA IS NULL\" + '\\n' +\n    \"   BEGIN\" + '\\n' + '\\n' +\n    \n    \"       SET @PROX_TAREFA = NEXT VALUE FOR tarefa_seq\" + '\\n' + '\\n' +\n    \n    \"       INSERT INTO tarefas\" + '\\n' +\n    \"           (id,\" + '\\n' +\n    \"           nome,\" + '\\n' +\n    \"           titulo,\" + '\\n' +\n    \"           descricao,\" + '\\n' +\n    \"           documento,\" + '\\n' +\n    \"           atribuir,\" + '\\n' +\n    \"           form,\" + '\\n' +\n    \"           parametros,\" + '\\n' +\n    \"           prazo,\" + '\\n' +\n    \"           criado,\" + '\\n' +\n    \"           concluido)\" + '\\n' +\n    \"       VALUES\" + '\\n' +\n    \"           (@PROX_TAREFA,\" + '\\n' +\n    \"           '\" + tarefa_cobranca.nome + \"',\" + '\\n' +\n    \"           '\" + tarefa_cobranca.titulo + \"',\" + '\\n' +\n    \"           '\" + tarefa_cobranca.descricao + \"',\" + '\\n' +\n    \"           '[\" + tarefa_cobranca.documento + \"]', \" +  '\\n' +\n    \"           '\" + tarefa_cobranca.atribuir + \"',\" + '\\n' +\n    \"           '\" + tarefa_cobranca.form + \"',\" + '\\n' +\n    \"           NULL,\" + '\\n' +\n    \"           NULL,\" + '\\n' +\n    \"           GETDATE(),\" + '\\n' +\n    \"           NULL)\" + '\\n' + '\\n' +\n    \n    \"       INSERT INTO @tarefas SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/nova/' + LTRIM(RTRIM(atribuir)) AS topico FROM tarefas WHERE id = @PROX_TAREFA\" + '\\n' + '\\n' +\n\n    \"       SET @NOVA_NAV = NEXT VALUE FOR tarefa_nav_seq\" + '\\n' + '\\n' +\n    \n    \"       INSERT TAREFA_NAV (transacao, tarefa_origem, tarefa_destino) VALUES (NEXT VALUE FOR tarefa_nav_seq, @TAREFA_ATUAL, @PROX_TAREFA)\" + '\\n' + '\\n' +\n\n    \"   END\" + '\\n' +\n    \"   ELSE\" + '\\n' +\n    \"   BEGIN\" + '\\n' + '\\n' +\n    \n    \"       UPDATE tarefas SET\" + '\\n' +\n    \"           descricao = 'Saldo R$ \" + msg.payload.documento.parcelas.reduce( (total, parcela) => total + parcela.valor, 0).toFixed(2).replace('.', ',') + \"', \"  + '\\n' +\n    \"           documento = STUFF(documento, LEN(documento), 1, ',\" + tarefa_cobranca.documento + \"' + ']')\" + '\\n' +\n    \"       WHERE\" + '\\n' +\n    \"          id = @PROX_TAREFA\" + '\\n' +\n    \"          AND versao = @PROX_TAREFA_VERSAO\" +  '\\n' + '\\n' +\n\n    \"       IF @@ROWCOUNT != 1\" + '\\n' +\n    \"       BEGIN\" + '\\n' +\n\n    \"           ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"           SELECT TOP 1 @ULTIMA_VERSAO = versao, @CONCLUIDO = concluido FROM tarefas WHERE id = @TAREFA_ATUAL\" + '\\n' + '\\n' +\n    \n    \"           IF (NOT @CONCLUIDO IS NULL)\" + '\\n' +\n    \"           BEGIN\" + '\\n' +\n    \"               INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7010\" + '\\n' +\n    \"               SELECT * FROM ERR WHERE erro = 7010\" + '\\n' +\n    \"           END\" + '\\n' +\n    \"           ELSE IF (@ULTIMA_VERSAO <> @VERSAO)\" + '\\n' +\n    \"           BEGIN\" + '\\n' +\n    \"               INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7450\" + '\\n' +\n    \"               SELECT * FROM ERR WHERE erro = 7450\" + '\\n' + '\\n' +\n    \"           END\" + '\\n' + '\\n' +\n    \n    \"           RETURN\" + '\\n' +\n    \"       END\" + '\\n' + '\\n' +\n    \n    \"       INSERT INTO @tarefas SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/atualizada/' + LTRIM(RTRIM(atribuir)) AS topico FROM tarefas WHERE id = @PROX_TAREFA\" + '\\n' + '\\n' +\n\n    \"   END\" + '\\n' + '\\n'\n    \n    :\n    \n    \"   --- nenhuma tarefa nova será criada porque em nenhuma parcela a forma de pagto é COBRANCA.\" + '\\n'\n    \n    ) + '\\n' +\n    \n    \"   ------------------------------------ VALIDACAO DE DADOS ----------------------------------------------\" + '\\n' +\n\n    \"   SET @NOSSO_NUMERO = CAST(\" +   (\"'\" + msg.payload.documento.nosso_numero + \"'\"   || \"NULL\") + \" AS INT)\" + '\\n' + '\\n' +\n    \n    \"   IF EXISTS(SELECT NOSSO_NUMERO FROM RCB WHERE nosso_numero = @NOSSO_NUMERO)\" + '\\n' +\n    \"   BEGIN\" + '\\n' + '\\n' +\n    \n    \"       ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"       INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 1234\" + '\\n' +\n    \"       SELECT * FROM ERR WHERE erro = 1234\" + '\\n' + '\\n' +\n    \n    \"       RETURN\" + '\\n' + '\\n' +\n    \"   END\" + '\\n' + '\\n' +\n\n    \"   ----------------------------------------- ATRIBUICAO DE VALORES DE PARAMETROS --------------------------------------------\" + '\\n' +\n    \"   SET @CONTA_CONTABIL = CAST('\" + msg.payload.documento.cliente.conta_contabil + \"' AS VARCHAR(20))\" + '\\n' +\n    \"   SET @CNPJ = CAST(\" +           (\"'\" + msg.payload.documento.cliente.cnpj + \"'\"            || \"NULL\") + \" AS VARCHAR(20))\" + '\\n' +\n    \"   SET @INSCRICAO = CAST(\" +      (\"'\" + msg.payload.documento.cliente.inscricao + \"'\"       || \"NULL\") + \" AS VARCHAR(14))\" + '\\n' +\n    \"   SET @FANTASIA = CAST(\" +       (\"'\" + msg.payload.documento.cliente.fantasia + \"'\"        || \"NULL\") + \" AS VARCHAR(30))\" + '\\n' +\n    \"   SET @NOME = CAST(\" +           (\"'\" + msg.payload.documento.cliente.nome + \"'\"            || \"NULL\") + \" AS VARCHAR(100))\" + '\\n' +\n    \"   SET @LOGRADOURO = CAST(\" +     (\"'\" + msg.payload.documento.cliente.logradouro + \"'\"      || \"NULL\") + \" AS VARCHAR(5))\" + '\\n' +\n    \"   SET @ENDERECO = CAST(\" +       (\"'\" + msg.payload.documento.cliente.endereco + \"'\"        || \"NULL\") + \" AS VARCHAR(50))\" + '\\n' +\n    \"   SET @NUMERO = CAST(\" +         (\"'\" + msg.payload.documento.cliente.numero + \"'\"          || \"NULL\") + \" AS VARCHAR(10))\" + '\\n' +\n    \"   SET @COMPLEMENTO = CAST(\" +    (\"'\" + msg.payload.documento.cliente.complemento + \"'\"     || \"NULL\") + \" AS VARCHAR(20))\" + '\\n' +\n    \"   SET @BAIRRO = CAST(\" +         (\"'\" + msg.payload.documento.cliente.bairro + \"'\"          || \"NULL\") + \" AS VARCHAR(30))\" + '\\n' +\n    \"   SET @MUNICIPIO = CAST(\" +      (msg.payload.documento.cliente.municipio                   || \"NULL\") + \" AS INT)\" + '\\n' +\n    \"   SET @CIDADE = CAST(\" +         (\"'\" + msg.payload.documento.cliente.cidade + \"'\"          || \"NULL\") + \" AS VARCHAR(20))\" + '\\n' +\n    \"   SET @CEP = CAST(\" +            (\"'\" + msg.payload.documento.cliente.CEP + \"'\"             || \"NULL\") + \" AS CHAR(9))\" + '\\n' +\n    \"   SET @UF = CAST(\" +             (\"'\" + msg.payload.documento.cliente.UF + \"'\"              || \"NULL\") + \" AS CHAR(2))\" + '\\n' +\n    \"   SET @DDD = CAST(\" +            (\"'\" + msg.payload.documento.cliente.ddd + \"'\"             || \"NULL\") + \" AS VARCHAR(3))\" + '\\n' +\n    \"   SET @TELEFONE = CAST(\" +       (\"'\" + msg.payload.documento.cliente.telefone + \"'\"        || \"NULL\") + \" AS VARCHAR(15))\" + '\\n' +\n    \"   SET @CONTATO = CAST(\" +        (\"'\" + msg.payload.documento.cliente.contato + \"'\"         || \"NULL\") + \" AS VARCHAR(20))\" + '\\n' + '\\n' +\n\n\n    \"   INSERT INTO RCB (nosso_numero, conta_contabil, cnpj, inscricao, fantasia, nome, logradouro, endereco, numero, complemento, bairro, municipio, cidade, cep, uf, ddd, telefone, contato)\" + '\\n' +\n    \"   VALUES (@NOSSO_NUMERO, @CONTA_CONTABIL, @CNPJ, @INSCRICAO, @FANTASIA, @NOME, @LOGRADOURO, @ENDERECO, @NUMERO, @COMPLEMENTO, @BAIRRO, @MUNICIPIO, @CIDADE, @CEP, @UF, @DDD, @TELEFONE, @CONTATO)\" + '\\n' + '\\n' +\n\n    \"   DECLARE @PEDIDO_NUMERO INT\" + '\\n' + '\\n' +\n    \n    \"   SET @PEDIDO_NUMERO = CAST(\" +   (\"'\" + msg.payload.documento.numero + \"'\"   || \"NULL\") + \" AS INT)\" + '\\n' + '\\n' +\n    \n    \"   INSERT INTO RCB_PED (nosso_numero, numero) VALUES (@NOSSO_NUMERO, @PEDIDO_NUMERO)\" + '\\n' + '\\n' +\n    \n    msg.payload.documento.parcelas.reduce ( (sql, parcela) =>\n        \n        sql + \n        \"   SET @PARCELA = CAST(\" +        (\"'\" + parcela.parcela + \"'\"        || \"NULL\") + \" AS INT)\" + '\\n' +\n        \"   SET @FORMA_PAGTO = CAST(\" +    (\"'\" + parcela.forma_pagto + \"'\"    || \"NULL\") + \" AS VARCHAR(10))\" + '\\n' +\n        \"   SET @TIPO_VENCTO = CAST(\" +    (\"'\" + parcela.tipo_vencto + \"'\"    || \"NULL\") + \" AS VARCHAR(3))\" + '\\n' +\n        \"   SET @VENCTO = CAST(\" +         (\"'\" + parcela.vencto + \"'\"         || \"NULL\") + \" AS DATE)\" + '\\n' +\n        \"   SET @PRAZO = CAST(\" +          (\"'\" + parcela.prazo + \"'\"          || \"NULL\") + \" AS INT)\" + '\\n' +\n        \"   SET @VALOR = CAST(\" +          (\"'\" + parcela.valor + \"'\"          || \"NULL\") + \" AS MONEY)\" + '\\n' +\n        \"   SET @ORIGEM = CAST(\" +         (\"'\" + parcela.origem + \"'\"          || \"NULL\") + \" AS VARCHAR(10))\" + '\\n' + '\\n' +\n        \n        \"   INSERT INTO RCBD (NOSSO_NUMERO, PARCELA, FORMA_PAGTO, TIPO_VENCTO, VENCTO, PRAZO, VALOR, ORIGEM)\" + '\\n' +\n        \"   VALUES (@NOSSO_NUMERO, @PARCELA, @FORMA_PAGTO, @TIPO_VENCTO, @VENCTO, @PRAZO, @VALOR, @ORIGEM)\" + '\\n', '') + '\\n' +\n\n    \"   COMMIT TRANSACTION\" + '\\n' + '\\n' +\n\n    \"END TRY\" + '\\n' +\n    \"BEGIN CATCH\" + '\\n' + '\\n' +\n    \n    \"   DECLARE @ERR_ID INT\" + '\\n' +\n    \"   DECLARE @ERROR_NUMBER INT\" + '\\n' +\n    \"   DECLARE @ERROR_SEVERITY INT\" + '\\n' +\n    \"   DECLARE @ERROR_STATE INT\" + '\\n' +\n    \"   DECLARE @ERROR_PROCEDURE INT\" + '\\n' +\n    \"   DECLARE @ERROR_LINE INT\" + '\\n' +\n    \"   DECLARE @ERROR_MESSAGE INT\" + '\\n' + '\\n' +\n    \n    \"   SET @ERROR_NUMBER = ERROR_NUMBER()\" + '\\n' + '\\n' +\n    \"   SET @ERROR_SEVERITY = ERROR_SEVERITY()\" + '\\n' + '\\n' +\n    \"   SET @ERROR_STATE = ERROR_STATE()\" + '\\n' + '\\n' +\n    \"   SET @ERROR_PROCEDURE = ERROR_PROCEDURE()\" + '\\n' + '\\n' +\n    \"   SET @ERROR_LINE = ERROR_LINE()\" + '\\n' + '\\n' +\n    \"   SET @ERROR_MESSAGE = ERROR_MESSAGE()\" + '\\n' + '\\n' +\n    \n    \"   IF @@TRANCOUNT > 0\" + '\\n' +\n    \"       ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"   SET @ERR_ID = NEXT VALUE FOR err_log_seq\" + '\\n' + '\\n' +\n    \"   INSERT INTO err_log SELECT @ERR_ID AS id, @ERROR_NUMBER AS erro, @ERROR_SEVERITY AS nivel, @ERROR_STATE AS situacao, @ERROR_PROCEDURE AS procedimento, @ERROR_LINE AS linha, @ERROR_MESSAGE AS mensagem\" + '\\n' + '\\n' +\n    \n    \"   SELECT * FROM err_log WHERE id = @ERR_ID\" + '\\n' + '\\n' +\n    \n    \"   RETURN\" + '\\n' +\n    \"END CATCH\" + '\\n' + '\\n' +\n\n    \"SELECT * FROM @tarefas\" + '\\n'\n\nreturn msg;","outputs":"1","noerr":0,"x":328.1999969482422,"y":868,"wires":[["4600fd5c.d5dab4"]]},{"id":"4600fd5c.d5dab4","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"MSSQL","query":"","outField":"payload","x":558.1999969482422,"y":868,"wires":[["e892296c.3b10a8"]]},{"id":"233cc9d0.bd6ef6","type":"http in","z":"e6097cee.8df04","name":"","url":"/api/financeiro/duplicata/cobranca/concluir/:tarefa","method":"post","swaggerDoc":"","x":278.1999969482422,"y":2868,"wires":[["bb68453d.159d68","c763ca6b.5bfbd8"]]},{"id":"9c4af1e.2e94d1","type":"function","z":"e6097cee.8df04","name":"TAREFA","func":"msg.payload = \n\"DECLARE @ID INT \" +\n\"SET @ID = \" + (parseInt(msg.req.params.tarefa) || 'NULL') + \" \" +\n\"UPDATE tarefas SET \" +\n\"\tconcluido = GETDATE() \" +\n\"WHERE \" +\n\"   id = @ID; \" +\n\"SELECT * FROM tarefas WHERE id = @ID;\"\n\nvar remessas = msg.pedido.cobrancas.filter( cobranca => !cobranca.carteira && cobranca.selected ).map( cobranca => {\n    cobranca.carteira = msg.pedido.carteira;\n    cobranca.envio = new Date().toISOString();\n    return cobranca;\n}); // deep clone\n\nmsg.pedido.remessas = JSON.parse(JSON.stringify(remessas)).map( remessa => {\n    remessa.envio = null;\n    remessa.selected = false;\n    return remessa;\n});\n\nif (msg.pedido.cobrancas.find( cob => !cob.selected)) {\n\n    msg.retryTask = \n            \"DECLARE @ID INT \" +\n            \"SET @ID = NEXT VALUE FOR tarefa_sequencia \" +\n            \"INSERT INTO BPM.dbo.tarefas \" +\n            \"   (id, \" +\n            \"   nome, \" +\n            \"   titulo, \" +\n            \"   descricao, \" +\n            \"   conteudo, \" +\n            \"   atribuir, \" +\n            \"   form, \" +\n            \"   parametros, \" +\n            \"   prazo, \" +\n            \"   criado, \" +\n            \"   concluido) \" +\n            \"VALUES \" +\n            \"   (@ID, \" +\n            \"   'Envio de Cobrança', \" +\n            \"   'Pedido \" + msg.pedido.numero + \"', \" +\n            \"   '\" + msg.pedido.cliente.nome + \"', \" +\n            \"   '\" + JSON.stringify(msg.pedido) + \"', \" + \n            \"   'rita', \" +\n            \"   '/duplicata/cobranca/' + CAST(@ID AS NVARCHAR(10)), \" +\n            \"   NULL, \" +\n            \"   NULL, \" +\n            \"   GETDATE(), \" +\n            \"   NULL); \" +\n            \"SELECT * FROM tarefas WHERE id = @ID;\"\n\n}\n\nmsg.nextTask = \n    \"DECLARE @ID INT \" +\n    \"SET @ID = NEXT VALUE FOR tarefa_sequencia \" +\n    \"INSERT INTO BPM.dbo.tarefas \" +\n    \"   (id, \" +\n    \"   nome, \" +\n    \"   titulo, \" +\n    \"   descricao, \" +\n    \"   conteudo, \" +\n    \"   atribuir, \" +\n    \"   form, \" +\n    \"   parametros, \" +\n    \"   prazo, \" +\n    \"   criado, \" +\n    \"   concluido) \" +\n    \"VALUES \" +\n    \"   (@ID, \" +\n    \"   'Remessa de Cobrança', \" +\n    \"   'Pedido \" + msg.pedido.numero + \"', \" +\n    \"   '\" + msg.pedido.cliente.nome + \"', \" +\n    \"   '\" + JSON.stringify(msg.pedido) + \"', \" + \n    \"   'marisa', \" +\n    \"   '/duplicata/remessa/' + CAST(@ID AS NVARCHAR(10)), \" +\n    \"   NULL, \" +\n    \"   NULL, \" +\n    \"   GETDATE(), \" +\n    \"   NULL); \" +\n    \"SELECT * FROM tarefas WHERE id = @ID;\"  \n\nreturn msg;","outputs":"1","noerr":0,"x":188.1999969482422,"y":3408,"wires":[["5976d787.60af28"]]},{"id":"a7f1aa81.1835a8","type":"http response","z":"e6097cee.8df04","name":"","x":498.1999969482422,"y":3408,"wires":[]},{"id":"5976d787.60af28","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"f5e250ce.bf20e","name":"","query":"","outField":"payload","x":328.1999969482422,"y":3408,"wires":[["a7f1aa81.1835a8","115084be.a3730b","3a70686d.cef378"]]},{"id":"98fb8ae.9cd6678","type":"mqtt out","z":"e6097cee.8df04","name":"","topic":"","qos":"","retain":"","broker":"42731854.d5b6a8","x":598.1999969482422,"y":3508,"wires":[]},{"id":"115084be.a3730b","type":"function","z":"e6097cee.8df04","name":"CONCLUIDA","func":"msg.payload = msg.payload[0]\nmsg.topic = '/tarefas/concluida/' + msg.payload.atribuir\nreturn msg;","outputs":1,"noerr":0,"x":458.1999969482422,"y":3468,"wires":[["98fb8ae.9cd6678","29f9423d.fb516e"]]},{"id":"29f9423d.fb516e","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"topic","x":608.1999969482422,"y":3468,"wires":[]},{"id":"bb68453d.159d68","type":"debug","z":"e6097cee.8df04","name":"","active":true,"console":"false","complete":"payload","x":188.1999969482422,"y":2908,"wires":[]},{"id":"c763ca6b.5bfbd8","type":"function","z":"e6097cee.8df04","name":"PEDIDO","func":"msg.pedido = msg.payload;\nmsg.payload = \n//\"DECLARE @EMPRESA INT \" +\n\"DECLARE @NUMERO INT \" +\n\"DECLARE @EMISSAO DATE \" +\n\"DECLARE @ENTREGA DATE \" +\n\"DECLARE @CONDICAO VARCHAR(3) \" +\n\"DECLARE @COMISSAO DECIMAL(18, 3) \" +\n\n//\"SET @EMPRESA = CAST(\" + (msg.pedido.empresa || 'NULL') + \" AS INT) \" +\n\"SET @NUMERO = CAST(\" + (msg.pedido.numero || 'NULL') + \" AS INT) \" +\n\"SET @EMISSAO = CAST('\" + (msg.pedido.emissao || 'NULL') + \"' AS DATE) \" +\n\"SET @ENTREGA = CAST('\" + (msg.pedido.entrega || 'NULL') + \"' AS DATE) \" +\n\"SET @CONDICAO = CAST('\" + (msg.pedido.condicao || 'NULL') + \"' AS VARCHAR(3)) \" +\n\"SET @COMISSAO = CAST(\" + (msg.pedido.comissao || 'NULL') + \" AS DECIMAL(18, 3)) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED] AS target \" +\n\"    USING (SELECT @NUMERO, @EMISSAO, @ENTREGA, @CONDICAO, @COMISSAO) AS source (NUMERO, EMISSAO, ENTREGA, CONDICAO, COMISSAO) \" +\n\"    ON (target.NUMERO = source.NUMERO) \" +\n\"WHEN MATCHED THEN \" +\n\"    UPDATE SET EMISSAO = source.EMISSAO, ENTREGA = source.ENTREGA, CONDICAO = source.CONDICAO, COMISSAO = source.COMISSAO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (NUMERO, EMISSAO, ENTREGA, CONDICAO, COMISSAO) \" +\n\"\tVALUES (source.NUMERO, source.EMISSAO, source.ENTREGA, source.CONDICAO, source.COMISSAO); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":188.1999969482422,"y":2968,"wires":[["42c89e9f.18b7a","288dade3.7a7802"]]},{"id":"42c89e9f.18b7a","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"payload","x":358.1999969482422,"y":2968,"wires":[]},{"id":"59256a3d.332c64","type":"function","z":"e6097cee.8df04","name":"DUPL","func":"msg.payload = \n\"DECLARE @NOSSO_NUMERO INT \" +\n\"DECLARE @PARCELA INT \" +\n\"DECLARE @TIPO VARCHAR(3) \" +\n\"DECLARE @VENCTO DATE \" +\n\"DECLARE @PRAZO INT \" +\n\"DECLARE @PORCENTAGEM DECIMAL(18, 3) \" +\n\"DECLARE @VALOR MONEY \" +\n\"DECLARE @DESCRICAO VARCHAR(50) \" +\n\"DECLARE @ORIGEM VARCHAR(10) \" +\n\n\"SET @NOSSO_NUMERO = CAST(\" +   (\"'\" + (msg.payload.nosso_numero || msg.pedido.numero) + \"'\"   || \"NULL\") + \" AS INT) \" +\n\"SET @PARCELA = CAST(\" +        (\"'\" + msg.payload.parcela + \"'\"        || \"NULL\") + \" AS INT) \" +\n\"SET @TIPO = CAST(\" +           (\"'\" + msg.payload.tipo + \"'\"           || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @VENCTO = CAST(\" +         (\"'\" + msg.payload.vencto + \"'\"         || \"NULL\") + \" AS DATE) \" +\n\"SET @PRAZO = CAST(\" +          (\"'\" + msg.payload.prazo + \"'\"          || \"NULL\") + \" AS INT) \" +\n\"SET @PORCENTAGEM = CAST(\" +    (\"'\" + msg.payload.porcentagem + \"'\"    || \"NULL\") + \" AS DECIMAL(18, 3)) \" +\n\"SET @VALOR = CAST(\" +          (\"'\" + msg.payload.valor + \"'\"          || \"NULL\") + \" AS MONEY) \" +\n\"SET @DESCRICAO = CAST(\" +      (\"'\" + msg.payload.descricao + \"'\"      || \"NULL\") + \" AS VARCHAR(50)) \" +\n\"SET @ORIGEM = 'PEDIDO' \" +\n\n\"MERGE [FINANCEIRO].[dbo].[DUP] AS target \" +\n\"   USING (SELECT @NOSSO_NUMERO, @PARCELA, @TIPO, @VENCTO, @PRAZO, @PORCENTAGEM, @VALOR, @DESCRICAO, @ORIGEM) AS source \" +\n\"   (NOSSO_NUMERO, PARCELA, TIPO, VENCTO, PRAZO, PORCENTAGEM, VALOR, DESCRICAO, ORIGEM) \" +\n\"   ON (target.NOSSO_NUMERO = source.NOSSO_NUMERO AND target.PARCELA = source.PARCELA) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET NOSSO_NUMERO = source.NOSSO_NUMERO, PARCELA = source.PARCELA, TIPO = source.TIPO, VENCTO = source.VENCTO, PRAZO = source.PRAZO, PORCENTAGEM = source.PORCENTAGEM, VALOR = source.VALOR, DESCRICAO = source.DESCRICAO, ORIGEM = source.ORIGEM \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (NOSSO_NUMERO, PARCELA, TIPO, VENCTO, PRAZO, PORCENTAGEM, VALOR, DESCRICAO, ORIGEM) \" +\n\"\tVALUES (source.NOSSO_NUMERO, source.PARCELA, source.TIPO, source.VENCTO, source.PRAZO, source.PORCENTAGEM, source.VALOR, source.DESCRICAO, source.ORIGEM); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_DUP] AS target \" +\n\"   USING (SELECT @PEDIDO, @NOSSO_NUMERO, @PARCELA) AS source \" +\n\"   (PED_NUMERO, DUP_NOSSO_NUMERO, DUP_PARCELA) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.DUP_NOSSO_NUMERO = source.DUP_NOSSO_NUMERO AND target.DUP_PARCELA = source.DUP_PARCELA) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET DUP_NOSSO_NUMERO = source.DUP_NOSSO_NUMERO, DUP_PARCELA = source.DUP_PARCELA \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, DUP_NOSSO_NUMERO, DUP_PARCELA) \" +\n\"\tVALUES (source.PED_NUMERO, source.DUP_NOSSO_NUMERO, source.DUP_PARCELA); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":338.1999969482422,"y":3308,"wires":[["af8a936b.daecd","59ae5603.e09aa8"]]},{"id":"af8a936b.daecd","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":488.1999969482422,"y":3368,"wires":[["7b0c2fa2.be37b"]]},{"id":"59ae5603.e09aa8","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"payload","x":498.1999969482422,"y":3308,"wires":[]},{"id":"7b0c2fa2.be37b","type":"function","z":"e6097cee.8df04","name":"LOOP","func":"if (msg.parcela === undefined) {\n    msg.parcela = 0;\n    msg.payload = msg.pedido.parcelas[0]\n    return [msg, null];\n} else {\n    msg.parcela++\n    if (msg.parcela < msg.pedido.parcelas.length) {\n        msg.payload = msg.pedido.parcelas[msg.parcela];\n        return [msg, null];\n    } else {\n        return [null, msg];\n    }\n}","outputs":"2","noerr":0,"x":178.1999969482422,"y":3348,"wires":[["59256a3d.332c64"],["9c4af1e.2e94d1"]]},{"id":"ac43ed17.ceb24","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"f5e250ce.bf20e","name":"","query":"","outField":"payload","x":328.1999969482422,"y":3628,"wires":[["b58334ce.3f8e78","5334c1eb.d2e5"]]},{"id":"7d6a3f9.2cd8ec","type":"mqtt out","z":"e6097cee.8df04","name":"","topic":"","qos":"","retain":"","broker":"42731854.d5b6a8","x":558.1999969482422,"y":3688,"wires":[]},{"id":"3a70686d.cef378","type":"function","z":"e6097cee.8df04","name":"NOVA","func":"msg.payload = msg.nextTask;\nreturn msg;\n","outputs":1,"noerr":0,"x":298.1999969482422,"y":3568,"wires":[["ac43ed17.ceb24"]]},{"id":"94ed7b42.0cd298","type":"debug","z":"e6097cee.8df04","name":"","active":true,"console":"false","complete":"topic","x":548.1999969482422,"y":3628,"wires":[]},{"id":"b58334ce.3f8e78","type":"function","z":"e6097cee.8df04","name":"NOTIFY","func":"msg.payload = msg.payload[0]\nmsg.topic = '/tarefas/nova/' + msg.payload.atribuir\nreturn msg;","outputs":1,"noerr":0,"x":408.1999969482422,"y":3688,"wires":[["94ed7b42.0cd298","7d6a3f9.2cd8ec"]]},{"id":"632e0c86.84c7b4","type":"http in","z":"e6097cee.8df04","name":"carteira","url":"/api/financeiro/carteira","method":"get","swaggerDoc":"","x":88.19999694824219,"y":268,"wires":[["6c87c3b.0cd9d3c"]]},{"id":"ddd5c662.482a78","type":"http response","z":"e6097cee.8df04","name":"","x":888.1999969482422,"y":268,"wires":[]},{"id":"34f94e3.27ae9b2","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":738.1999969482422,"y":268,"wires":[["ddd5c662.482a78"]]},{"id":"6c87c3b.0cd9d3c","type":"function","z":"e6097cee.8df04","name":"SQL","func":"\nmsg.payload = \"SELECT * FROM CRT\"; \n\nreturn msg;","outputs":1,"noerr":0,"x":328.1999969482422,"y":268,"wires":[["1e19ce6b.921cc2"]]},{"id":"fc946c2a.8cf66","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"f5e250ce.bf20e","name":"","query":"","outField":"payload","x":298.1999969482422,"y":3908,"wires":[["a3b25c3f.1f2b7"]]},{"id":"4118fda5.0f0974","type":"mqtt out","z":"e6097cee.8df04","name":"","topic":"","qos":"","retain":"","broker":"42731854.d5b6a8","x":528.1999969482422,"y":3968,"wires":[]},{"id":"5334c1eb.d2e5","type":"function","z":"e6097cee.8df04","name":"NOVA","func":"if (msg.retryTask) {\n    msg.payload = msg.retryTask;\n    return msg;\n}","outputs":1,"noerr":0,"x":288.1999969482422,"y":3848,"wires":[["fc946c2a.8cf66"]]},{"id":"d4c0bb87.35db78","type":"debug","z":"e6097cee.8df04","name":"","active":true,"console":"false","complete":"topic","x":518.1999969482422,"y":3908,"wires":[]},{"id":"a3b25c3f.1f2b7","type":"function","z":"e6097cee.8df04","name":"NOTIFY","func":"msg.payload = msg.payload[0]\nmsg.topic = '/tarefas/nova/' + msg.payload.atribuir\nreturn msg;","outputs":1,"noerr":0,"x":378.1999969482422,"y":3968,"wires":[["d4c0bb87.35db78","4118fda5.0f0974"]]},{"id":"7ca0d899.ec8ec8","type":"http in","z":"e6097cee.8df04","name":"","url":"/api/financeiro/duplicata/remessa/concluir/:tarefa","method":"post","swaggerDoc":"","x":918.1999969482422,"y":2868,"wires":[["8fad82ab.8782f","55bb051c.7190ec"]]},{"id":"f853cdb7.08dc2","type":"function","z":"e6097cee.8df04","name":"TAREFA","func":"msg.payload = \n\"DECLARE @ID INT \" +\n\"SET @ID = \" + (parseInt(msg.req.params.tarefa) || 'NULL') + \" \" +\n\"UPDATE tarefas SET \" +\n\"\tconcluido = GETDATE() \" +\n\"WHERE \" +\n\"   id = @ID; \" +\n\"SELECT * FROM tarefas WHERE id = @ID;\"\n\nvar retornos = JSON.parse(JSON.stringify(msg.pedido.remessas.filter( remessa => !remessa.carteira && remessa.selected ).map( remessa => {\n    remessa.envio = new Date().toISOString();\n}))); // deep clone\n\nmsg.pedido.retornos = retornos.map( ret => {\n    ret.retorno = null;\n    ret.selected = false;\n    return ret;\n})\n\nif (msg.pedido.remessas.find( r => !r.selected)) {\n\n    msg.retryTask = \n            \"DECLARE @ID INT \" +\n            \"SET @ID = NEXT VALUE FOR tarefa_sequencia \" +\n            \"INSERT INTO BPM.dbo.tarefas \" +\n            \"   (id, \" +\n            \"   nome, \" +\n            \"   titulo, \" +\n            \"   descricao, \" +\n            \"   conteudo, \" +\n            \"   atribuir, \" +\n            \"   form, \" +\n            \"   parametros, \" +\n            \"   prazo, \" +\n            \"   criado, \" +\n            \"   concluido) \" +\n            \"VALUES \" +\n            \"   (@ID, \" +\n            \"   'Remessa de Cobrança', \" +\n            \"   'Pedido \" + msg.pedido.numero + \"', \" +\n            \"   '\" + msg.pedido.cliente.nome + \"', \" +\n            \"   '\" + JSON.stringify(msg.pedido) + \"', \" + \n            \"   'marisa', \" +\n            \"   '/duplicata/remessa/' + CAST(@ID AS NVARCHAR(10)), \" +\n            \"   NULL, \" +\n            \"   NULL, \" +\n            \"   GETDATE(), \" +\n            \"   NULL); \" +\n            \"SELECT * FROM tarefas WHERE id = @ID;\"\n\n}\n\nmsg.nextTask = \n    \"DECLARE @ID INT \" +\n    \"SET @ID = NEXT VALUE FOR tarefa_sequencia \" +\n    \"INSERT INTO BPM.dbo.tarefas \" +\n    \"   (id, \" +\n    \"   nome, \" +\n    \"   titulo, \" +\n    \"   descricao, \" +\n    \"   conteudo, \" +\n    \"   atribuir, \" +\n    \"   form, \" +\n    \"   parametros, \" +\n    \"   prazo, \" +\n    \"   criado, \" +\n    \"   concluido) \" +\n    \"VALUES \" +\n    \"   (@ID, \" +\n    \"   'Retorno de Cobrança', \" +\n    \"   'Pedido \" + msg.pedido.numero + \"', \" +\n    \"   '\" + msg.pedido.cliente.nome + \"', \" +\n    \"   '\" + JSON.stringify(msg.pedido) + \"', \" + \n    \"   'marisa', \" +\n    \"   '/duplicata/retorno/' + CAST(@ID AS NVARCHAR(10)), \" +\n    \"   NULL, \" +\n    \"   NULL, \" +\n    \"   GETDATE(), \" +\n    \"   NULL); \" +\n    \"SELECT * FROM tarefas WHERE ID = @ID;\"\n\n\nreturn msg;","outputs":"1","noerr":0,"x":828.1999969482422,"y":3408,"wires":[["ec7e545c.1dfa88"]]},{"id":"b56a0567.6cce08","type":"http response","z":"e6097cee.8df04","name":"","x":1138.1999969482422,"y":3408,"wires":[]},{"id":"ec7e545c.1dfa88","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"f5e250ce.bf20e","name":"","query":"","outField":"payload","x":988.1999969482422,"y":3408,"wires":[["b56a0567.6cce08","8d952752.ea49b8","2f294884.62f808"]]},{"id":"d40b0ec7.3cb72","type":"mqtt out","z":"e6097cee.8df04","name":"","topic":"","qos":"","retain":"","broker":"42731854.d5b6a8","x":1238.1999969482422,"y":3508,"wires":[]},{"id":"8d952752.ea49b8","type":"function","z":"e6097cee.8df04","name":"CONCLUIDA","func":"msg.payload = msg.payload[0]\nmsg.topic = '/tarefas/concluida/' + msg.payload.atribuir\nreturn msg;","outputs":1,"noerr":0,"x":1098.1999969482422,"y":3468,"wires":[["d40b0ec7.3cb72","d00845d0.08e7c8"]]},{"id":"d00845d0.08e7c8","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"topic","x":1248.1999969482422,"y":3468,"wires":[]},{"id":"8fad82ab.8782f","type":"debug","z":"e6097cee.8df04","name":"","active":true,"console":"false","complete":"payload.conta","x":858.1999969482422,"y":2908,"wires":[]},{"id":"55bb051c.7190ec","type":"function","z":"e6097cee.8df04","name":"PEDIDO","func":"msg.pedido = msg.payload;\nmsg.payload = \n//\"DECLARE @EMPRESA INT \" +\n\"DECLARE @NUMERO INT \" +\n\"DECLARE @EMISSAO DATE \" +\n\"DECLARE @ENTREGA DATE \" +\n\"DECLARE @CONDICAO VARCHAR(3) \" +\n\"DECLARE @COMISSAO DECIMAL(18, 3) \" +\n\n//\"SET @EMPRESA = CAST(\" + (msg.pedido.empresa || 'NULL') + \" AS INT) \" +\n\"SET @NUMERO = CAST(\" + (msg.pedido.numero || 'NULL') + \" AS INT) \" +\n\"SET @EMISSAO = CAST('\" + (msg.pedido.emissao || 'NULL') + \"' AS DATE) \" +\n\"SET @ENTREGA = CAST('\" + (msg.pedido.entrega || 'NULL') + \"' AS DATE) \" +\n\"SET @CONDICAO = CAST('\" + (msg.pedido.condicao || 'NULL') + \"' AS VARCHAR(3)) \" +\n\"SET @COMISSAO = CAST(\" + (msg.pedido.comissao || 'NULL') + \" AS DECIMAL(18, 3)) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED] AS target \" +\n\"    USING (SELECT @NUMERO, @EMISSAO, @ENTREGA, @CONDICAO, @COMISSAO) AS source (NUMERO, EMISSAO, ENTREGA, CONDICAO, COMISSAO) \" +\n\"    ON (target.NUMERO = source.NUMERO) \" +\n\"WHEN MATCHED THEN \" +\n\"    UPDATE SET EMISSAO = source.EMISSAO, ENTREGA = source.ENTREGA, CONDICAO = source.CONDICAO, COMISSAO = source.COMISSAO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (NUMERO, EMISSAO, ENTREGA, CONDICAO, COMISSAO) \" +\n\"\tVALUES (source.NUMERO, source.EMISSAO, source.ENTREGA, source.CONDICAO, source.COMISSAO); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":828.1999969482422,"y":2968,"wires":[["a6f67f44.21953","dca904e4.a04468"]]},{"id":"a6f67f44.21953","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":828.1999969482422,"y":3028,"wires":[["92d38cbe.8bcee"]]},{"id":"dca904e4.a04468","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"payload","x":998.1999969482422,"y":2968,"wires":[]},{"id":"92d38cbe.8bcee","type":"function","z":"e6097cee.8df04","name":"CLIENTE","func":"msg.payload = \n\"DECLARE @CNPJ VARCHAR(20) \" +\n\"DECLARE @INSCRICAO VARCHAR(12) \" +\n\"DECLARE @FANTASIA VARCHAR(30) \" +\n\"DECLARE @NOME VARCHAR(100) \" +\n\"DECLARE @LOGRADOURO VARCHAR(5) \" +\n\"DECLARE @ENDERECO VARCHAR(50) \" +\n\"DECLARE @NUMERO VARCHAR(10) \" +\n\"DECLARE @COMPLEMENTO VARCHAR(20) \" +\n\"DECLARE @BAIRRO VARCHAR(30) \" +\n\"DECLARE @MUNICIPIO INT \" +\n\"DECLARE @CIDADE VARCHAR(20) \" +\n\"DECLARE @CEP CHAR(9) \" +\n\"DECLARE @UF CHAR(2)\" +\n\"DECLARE @DDD VARCHAR(3) \" +\n\"DECLARE @TELEFONE VARCHAR(15) \" +\n\"DECLARE @CONTATO VARCHAR(20) \" +\n\"DECLARE @DESCONTO BIT \" +\n\n\"SET @CNPJ = CAST(\" +           (\"'\" + msg.pedido.cliente.cnpj + \"'\"            || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @INSCRICAO = CAST(\" +      (\"'\" + msg.pedido.cliente.inscricao + \"'\"       || \"NULL\") + \" AS VARCHAR(14)) \" +\n\"SET @FANTASIA = CAST(\" +       (\"'\" + msg.pedido.cliente.fantasia + \"'\"        || \"NULL\") + \" AS VARCHAR(30)) \" +\n\"SET @NOME = CAST(\" +           (\"'\" + msg.pedido.cliente.nome + \"'\"            || \"NULL\") + \" AS VARCHAR(100)) \" +\n\"SET @LOGRADOURO = CAST(\" +     (\"'\" + msg.pedido.cliente.logradouro + \"'\"      || \"NULL\") + \" AS VARCHAR(5)) \" +\n\"SET @ENDERECO = CAST(\" +       (\"'\" + msg.pedido.cliente.endereco + \"'\"        || \"NULL\") + \" AS VARCHAR(50)) \" +\n\"SET @NUMERO = CAST(\" +         (\"'\" + msg.pedido.cliente.numero + \"'\"          || \"NULL\") + \" AS VARCHAR(10)) \" +\n\"SET @COMPLEMENTO = CAST(\" +    (\"'\" + msg.pedido.cliente.complemento + \"'\"     || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @BAIRRO = CAST(\" +         (\"'\" + msg.pedido.cliente.bairro + \"'\"          || \"NULL\") + \" AS VARCHAR(30)) \" +\n\"SET @MUNICIPIO = CAST(\" +      (msg.pedido.cliente.municipio                   || \"NULL\") + \" AS INT) \" +\n\"SET @CIDADE = CAST(\" +         (\"'\" + msg.pedido.cliente.cidade + \"'\"          || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @CEP = CAST(\" +            (\"'\" + msg.pedido.cliente.CEP + \"'\"             || \"NULL\") + \" AS CHAR(9)) \" +\n\"SET @UF = CAST(\" +             (\"'\" + msg.pedido.cliente.UF + \"'\"              || \"NULL\") + \" AS CHAR(2)) \" +\n\"SET @DDD = CAST(\" +            (\"'\" + msg.pedido.cliente.ddd + \"'\"             || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @TELEFONE = CAST(\" +       (\"'\" + msg.pedido.cliente.telefone + \"'\"        || \"NULL\") + \" AS VARCHAR(15)) \" +\n\"SET @CONTATO = CAST(\" +        (\"'\" + msg.pedido.cliente.contato + \"'\"         || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @DESCONTO = CAST(\" +        (\"'\" + msg.pedido.cliente.desconto + \"'\"         || \"NULL\") + \" AS BIT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[CLI] AS target \" +\n\"   USING (SELECT @CNPJ, @INSCRICAO, @FANTASIA, @NOME, @LOGRADOURO, @ENDERECO, @NUMERO, @COMPLEMENTO, @BAIRRO, @MUNICIPIO, @CIDADE, @CEP, @UF, @DDD, @TELEFONE, @CONTATO, @DESCONTO) AS source \" +\n\"   (CNPJ, INSCRICAO, FANTASIA, NOME, LOGRADOURO, ENDERECO, NUMERO, COMPLEMENTO, BAIRRO, MUNICIPIO, CIDADE, CEP, UF, DDD, TELEFONE, CONTATO, DESCONTO) \" +\n\"   ON (target.CNPJ = source.CNPJ) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET INSCRICAO = source.INSCRICAO, FANTASIA = source.FANTASIA, NOME = source.NOME, \" +\n\"   LOGRADOURO = source.LOGRADOURO, ENDERECO = source.ENDERECO, NUMERO = source.NUMERO, COMPLEMENTO = source.COMPLEMENTO, \" +\n\"   BAIRRO = source.BAIRRO, MUNICIPIO = source.MUNICIPIO, CIDADE = source.CIDADE, CEP = source.CEP, UF = source.UF, DDD = source.DDD, TELEFONE = source.TELEFONE, CONTATO = source.CONTATO, DESCONTO = source.DESCONTO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (CNPJ, INSCRICAO, FANTASIA, NOME, LOGRADOURO, ENDERECO, NUMERO, COMPLEMENTO, BAIRRO, MUNICIPIO, CIDADE, CEP, UF, DDD, TELEFONE, CONTATO, DESCONTO) \" +\n\"\tVALUES (source.CNPJ, source.INSCRICAO, source.FANTASIA, source.NOME, source.LOGRADOURO, source.ENDERECO, source.NUMERO, source.COMPLEMENTO, source.BAIRRO, source.MUNICIPIO, source.CIDADE, source.CEP, source.UF, source.DDD, source.TELEFONE, source.CONTATO, source.DESCONTO); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_CLI] AS target \" +\n\"   USING (SELECT @PEDIDO, @CNPJ) AS source \" +\n\"   (PED_NUMERO, CLI_CNPJ) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.CLI_CNPJ = source.CLI_CNPJ) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET CLI_CNPJ = source.CLI_CNPJ \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, CLI_CNPJ) \" +\n\"\tVALUES (source.PED_NUMERO, source.CLI_CNPJ); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":828.1999969482422,"y":3088,"wires":[["e8538996.a1e978","436e245b.fd754c"]]},{"id":"e8538996.a1e978","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":828.1999969482422,"y":3148,"wires":[["856f5ea7.2cc9b"]]},{"id":"436e245b.fd754c","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"payload","x":998.1999969482422,"y":3088,"wires":[]},{"id":"856f5ea7.2cc9b","type":"function","z":"e6097cee.8df04","name":"REPR.","func":"msg.payload = \n\"DECLARE @CODIGO VARCHAR(3) \" +\n\"DECLARE @NOME VARCHAR(50) \" +\n\n\"SET @CODIGO = CAST(\" +           (\"'\" + msg.pedido.representante.codigo + \"'\"            || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @NOME = CAST(\" +      (\"'\" + msg.pedido.representante.nome + \"'\"       || \"NULL\") + \" AS VARCHAR(50)) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[REP] AS target \" +\n\"   USING (SELECT @CODIGO, @NOME) AS source \" +\n\"   (CODIGO, NOME) \" +\n\"   ON (target.CODIGO = source.CODIGO) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET NOME = source.NOME \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (CODIGO, NOME) \" +\n\"\tVALUES (source.CODIGO, source.NOME); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_REP] AS target \" +\n\"   USING (SELECT @PEDIDO, @CODIGO) AS source \" +\n\"   (PED_NUMERO, REP_CODIGO) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.REP_CODIGO = source.REP_CODIGO) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET REP_CODIGO = source.REP_CODIGO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, REP_CODIGO) \" +\n\"\tVALUES (source.PED_NUMERO, source.REP_CODIGO); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":818.1999969482422,"y":3208,"wires":[["ecb09239.658a5","53c859d7.c9ab38"]]},{"id":"53c859d7.c9ab38","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"payload","x":998.1999969482422,"y":3208,"wires":[]},{"id":"ecb09239.658a5","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":828.1999969482422,"y":3268,"wires":[["c5ed9f09.a8849"]]},{"id":"e255d723.e2cda8","type":"function","z":"e6097cee.8df04","name":"DUPL","func":"msg.payload = \n\"DECLARE @NOSSO_NUMERO INT \" +\n\"DECLARE @PARCELA INT \" +\n\"DECLARE @TIPO VARCHAR(3) \" +\n\"DECLARE @VENCTO DATE \" +\n\"DECLARE @PRAZO INT \" +\n\"DECLARE @PORCENTAGEM DECIMAL(18, 3) \" +\n\"DECLARE @VALOR MONEY \" +\n\"DECLARE @DESCRICAO VARCHAR(50) \" +\n\"DECLARE @ORIGEM VARCHAR(10) \" +\n\n\"SET @NOSSO_NUMERO = CAST(\" +   (\"'\" + (msg.payload.nosso_numero || msg.pedido.numero) + \"'\"   || \"NULL\") + \" AS INT) \" +\n\"SET @PARCELA = CAST(\" +        (\"'\" + msg.payload.parcela + \"'\"        || \"NULL\") + \" AS INT) \" +\n\"SET @TIPO = CAST(\" +           (\"'\" + msg.payload.tipo + \"'\"           || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @VENCTO = CAST(\" +         (\"'\" + msg.payload.vencto + \"'\"         || \"NULL\") + \" AS DATE) \" +\n\"SET @PRAZO = CAST(\" +          (\"'\" + msg.payload.prazo + \"'\"          || \"NULL\") + \" AS INT) \" +\n\"SET @PORCENTAGEM = CAST(\" +    (\"'\" + msg.payload.porcentagem + \"'\"    || \"NULL\") + \" AS DECIMAL(18, 3)) \" +\n\"SET @VALOR = CAST(\" +          (\"'\" + msg.payload.valor + \"'\"          || \"NULL\") + \" AS MONEY) \" +\n\"SET @DESCRICAO = CAST(\" +      (\"'\" + msg.payload.descricao + \"'\"      || \"NULL\") + \" AS VARCHAR(50)) \" +\n\"SET @ORIGEM = 'PEDIDO' \" +\n\n\"MERGE [FINANCEIRO].[dbo].[DUP] AS target \" +\n\"   USING (SELECT @NOSSO_NUMERO, @PARCELA, @TIPO, @VENCTO, @PRAZO, @PORCENTAGEM, @VALOR, @DESCRICAO, @ORIGEM) AS source \" +\n\"   (NOSSO_NUMERO, PARCELA, TIPO, VENCTO, PRAZO, PORCENTAGEM, VALOR, DESCRICAO, ORIGEM) \" +\n\"   ON (target.NOSSO_NUMERO = source.NOSSO_NUMERO AND target.PARCELA = source.PARCELA) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET NOSSO_NUMERO = source.NOSSO_NUMERO, PARCELA = source.PARCELA, TIPO = source.TIPO, VENCTO = source.VENCTO, PRAZO = source.PRAZO, PORCENTAGEM = source.PORCENTAGEM, VALOR = source.VALOR, DESCRICAO = source.DESCRICAO, ORIGEM = source.ORIGEM \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (NOSSO_NUMERO, PARCELA, TIPO, VENCTO, PRAZO, PORCENTAGEM, VALOR, DESCRICAO, ORIGEM) \" +\n\"\tVALUES (source.NOSSO_NUMERO, source.PARCELA, source.TIPO, source.VENCTO, source.PRAZO, source.PORCENTAGEM, source.VALOR, source.DESCRICAO, source.ORIGEM); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_DUP] AS target \" +\n\"   USING (SELECT @PEDIDO, @NOSSO_NUMERO, @PARCELA) AS source \" +\n\"   (PED_NUMERO, DUP_NOSSO_NUMERO, DUP_PARCELA) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.DUP_NOSSO_NUMERO = source.DUP_NOSSO_NUMERO AND target.DUP_PARCELA = source.DUP_PARCELA) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET DUP_NOSSO_NUMERO = source.DUP_NOSSO_NUMERO, DUP_PARCELA = source.DUP_PARCELA \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, DUP_NOSSO_NUMERO, DUP_PARCELA) \" +\n\"\tVALUES (source.PED_NUMERO, source.DUP_NOSSO_NUMERO, source.DUP_PARCELA); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":978.1999969482422,"y":3308,"wires":[["4de41922.bb75d8","9ad0bac1.aac438"]]},{"id":"4de41922.bb75d8","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":1128.1999969482422,"y":3368,"wires":[["c5ed9f09.a8849"]]},{"id":"9ad0bac1.aac438","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"payload","x":1138.1999969482422,"y":3308,"wires":[]},{"id":"c5ed9f09.a8849","type":"function","z":"e6097cee.8df04","name":"LOOP","func":"if (msg.parcela === undefined) {\n    msg.parcela = 0;\n    msg.payload = msg.pedido.parcelas[0]\n    return [msg, null];\n} else {\n    msg.parcela++\n    if (msg.parcela < msg.pedido.parcelas.length) {\n        msg.payload = msg.pedido.parcelas[msg.parcela];\n        return [msg, null];\n    } else {\n        return [null, msg];\n    }\n}","outputs":"2","noerr":0,"x":818.1999969482422,"y":3348,"wires":[["e255d723.e2cda8"],["f853cdb7.08dc2"]]},{"id":"e7f82185.ed347","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"f5e250ce.bf20e","name":"","query":"","outField":"payload","x":968.1999969482422,"y":3628,"wires":[["8f693476.2adb38","1365464a.856cea"]]},{"id":"5401fb62.e74dc4","type":"mqtt out","z":"e6097cee.8df04","name":"","topic":"","qos":"","retain":"","broker":"42731854.d5b6a8","x":1198.1999969482422,"y":3688,"wires":[]},{"id":"2f294884.62f808","type":"function","z":"e6097cee.8df04","name":"NOVA","func":"msg.payload = msg.nextTask;\nreturn msg;\n","outputs":1,"noerr":0,"x":958.1999969482422,"y":3568,"wires":[["e7f82185.ed347"]]},{"id":"3f74eb.4f6bbb16","type":"debug","z":"e6097cee.8df04","name":"","active":true,"console":"false","complete":"topic","x":1188.1999969482422,"y":3628,"wires":[]},{"id":"8f693476.2adb38","type":"function","z":"e6097cee.8df04","name":"NOTIFY","func":"msg.payload = msg.payload[0]\nmsg.topic = '/tarefas/nova/' + msg.payload.atribuir\nreturn msg;","outputs":1,"noerr":0,"x":1048.1999969482422,"y":3688,"wires":[["3f74eb.4f6bbb16","5401fb62.e74dc4"]]},{"id":"44a66451.b69ffc","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"f5e250ce.bf20e","name":"","query":"","outField":"payload","x":968.1999969482422,"y":3808,"wires":[["4f6b07f2.506648"]]},{"id":"7ccd295b.2e1538","type":"mqtt out","z":"e6097cee.8df04","name":"","topic":"","qos":"","retain":"","broker":"42731854.d5b6a8","x":1198.1999969482422,"y":3868,"wires":[]},{"id":"1365464a.856cea","type":"function","z":"e6097cee.8df04","name":"NOVA","func":"if (msg.retryTask) {\n    msg.payload = msg.retryTask;\n    return msg;\n}","outputs":1,"noerr":0,"x":958.1999969482422,"y":3748,"wires":[["44a66451.b69ffc"]]},{"id":"5b608e9b.ed938","type":"debug","z":"e6097cee.8df04","name":"","active":true,"console":"false","complete":"topic","x":1188.1999969482422,"y":3808,"wires":[]},{"id":"4f6b07f2.506648","type":"function","z":"e6097cee.8df04","name":"NOTIFY","func":"msg.payload = msg.payload[0]\nmsg.topic = '/tarefas/nova/' + msg.payload.atribuir\nreturn msg;","outputs":1,"noerr":0,"x":1048.1999969482422,"y":3868,"wires":[["5b608e9b.ed938","7ccd295b.2e1538"]]},{"id":"a5cc5b8b.a5dea8","type":"http in","z":"e6097cee.8df04","name":"","url":"/api/financeiro/duplicata/retorno/concluir/:tarefa","method":"post","swaggerDoc":"","x":1558.1999969482422,"y":2868,"wires":[["84721332.bcd3e","1ea1df2d.7b25e1"]]},{"id":"3b3b69cb.4c7526","type":"function","z":"e6097cee.8df04","name":"TAREFA","func":"msg.payload = \n\"DECLARE @ID INT \" +\n\"SET @ID = \" + (parseInt(msg.req.params.tarefa) || 'NULL') + \" \" +\n\"UPDATE tarefas SET \" +\n\"\tconcluido = GETDATE() \" +\n\"WHERE \" +\n\"   id = @ID; \" +\n\"SELECT * FROM tarefas WHERE id = @ID;\"\n\nreturn msg;","outputs":"1","noerr":0,"x":1468.1999969482422,"y":3408,"wires":[["a26f8674.5db7f8"]]},{"id":"2763bee1.3ff632","type":"http response","z":"e6097cee.8df04","name":"","x":1778.1999969482422,"y":3408,"wires":[]},{"id":"a26f8674.5db7f8","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"f5e250ce.bf20e","name":"","query":"","outField":"payload","x":1628.1999969482422,"y":3408,"wires":[["2763bee1.3ff632","98c332a0.ca343"]]},{"id":"6d2d960a.100358","type":"mqtt out","z":"e6097cee.8df04","name":"","topic":"","qos":"","retain":"","broker":"42731854.d5b6a8","x":1878.1999969482422,"y":3508,"wires":[]},{"id":"98c332a0.ca343","type":"function","z":"e6097cee.8df04","name":"CONCLUIDA","func":"msg.payload = msg.payload[0]\nmsg.topic = '/tarefas/concluida/' + msg.payload.atribuir\nreturn msg;","outputs":1,"noerr":0,"x":1738.1999969482422,"y":3468,"wires":[["6d2d960a.100358","ba620d6b.7d464"]]},{"id":"ba620d6b.7d464","type":"debug","z":"e6097cee.8df04","name":"","active":true,"console":"false","complete":"topic","x":1888.1999969482422,"y":3468,"wires":[]},{"id":"84721332.bcd3e","type":"debug","z":"e6097cee.8df04","name":"","active":true,"console":"false","complete":"payload.conta","x":1498.1999969482422,"y":2928,"wires":[]},{"id":"1ea1df2d.7b25e1","type":"function","z":"e6097cee.8df04","name":"PEDIDO","func":"msg.pedido = msg.payload;\nmsg.payload = \n//\"DECLARE @EMPRESA INT \" +\n\"DECLARE @NUMERO INT \" +\n\"DECLARE @EMISSAO DATE \" +\n\"DECLARE @ENTREGA DATE \" +\n\"DECLARE @CONDICAO VARCHAR(3) \" +\n\"DECLARE @COMISSAO DECIMAL(18, 3) \" +\n\n//\"SET @EMPRESA = CAST(\" + (msg.pedido.empresa || 'NULL') + \" AS INT) \" +\n\"SET @NUMERO = CAST(\" + (msg.pedido.numero || 'NULL') + \" AS INT) \" +\n\"SET @EMISSAO = CAST('\" + (msg.pedido.emissao || 'NULL') + \"' AS DATE) \" +\n\"SET @ENTREGA = CAST('\" + (msg.pedido.entrega || 'NULL') + \"' AS DATE) \" +\n\"SET @CONDICAO = CAST('\" + (msg.pedido.condicao || 'NULL') + \"' AS VARCHAR(3)) \" +\n\"SET @COMISSAO = CAST(\" + (msg.pedido.comissao || 'NULL') + \" AS DECIMAL(18, 3)) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED] AS target \" +\n\"    USING (SELECT @NUMERO, @EMISSAO, @ENTREGA, @CONDICAO, @COMISSAO) AS source (NUMERO, EMISSAO, ENTREGA, CONDICAO, COMISSAO) \" +\n\"    ON (target.NUMERO = source.NUMERO) \" +\n\"WHEN MATCHED THEN \" +\n\"    UPDATE SET EMISSAO = source.EMISSAO, ENTREGA = source.ENTREGA, CONDICAO = source.CONDICAO, COMISSAO = source.COMISSAO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (NUMERO, EMISSAO, ENTREGA, CONDICAO, COMISSAO) \" +\n\"\tVALUES (source.NUMERO, source.EMISSAO, source.ENTREGA, source.CONDICAO, source.COMISSAO); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":1468.1999969482422,"y":2968,"wires":[["84b18c20.9c834","1f53ed6d.3909f3"]]},{"id":"84b18c20.9c834","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":1468.1999969482422,"y":3028,"wires":[["b91aaa36.b7f5d8"]]},{"id":"1f53ed6d.3909f3","type":"debug","z":"e6097cee.8df04","name":"","active":true,"console":"false","complete":"payload","x":1638.1999969482422,"y":2968,"wires":[]},{"id":"b91aaa36.b7f5d8","type":"function","z":"e6097cee.8df04","name":"CLIENTE","func":"msg.payload = \n\"DECLARE @CNPJ VARCHAR(20) \" +\n\"DECLARE @INSCRICAO VARCHAR(12) \" +\n\"DECLARE @FANTASIA VARCHAR(30) \" +\n\"DECLARE @NOME VARCHAR(100) \" +\n\"DECLARE @LOGRADOURO VARCHAR(5) \" +\n\"DECLARE @ENDERECO VARCHAR(50) \" +\n\"DECLARE @NUMERO VARCHAR(10) \" +\n\"DECLARE @COMPLEMENTO VARCHAR(20) \" +\n\"DECLARE @BAIRRO VARCHAR(30) \" +\n\"DECLARE @MUNICIPIO INT \" +\n\"DECLARE @CIDADE VARCHAR(20) \" +\n\"DECLARE @CEP CHAR(9) \" +\n\"DECLARE @UF CHAR(2)\" +\n\"DECLARE @DDD VARCHAR(3) \" +\n\"DECLARE @TELEFONE VARCHAR(15) \" +\n\"DECLARE @CONTATO VARCHAR(20) \" +\n\"DECLARE @DESCONTO BIT \" +\n\n\"SET @CNPJ = CAST(\" +           (\"'\" + msg.pedido.cliente.cnpj + \"'\"            || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @INSCRICAO = CAST(\" +      (\"'\" + msg.pedido.cliente.inscricao + \"'\"       || \"NULL\") + \" AS VARCHAR(14)) \" +\n\"SET @FANTASIA = CAST(\" +       (\"'\" + msg.pedido.cliente.fantasia + \"'\"        || \"NULL\") + \" AS VARCHAR(30)) \" +\n\"SET @NOME = CAST(\" +           (\"'\" + msg.pedido.cliente.nome + \"'\"            || \"NULL\") + \" AS VARCHAR(100)) \" +\n\"SET @LOGRADOURO = CAST(\" +     (\"'\" + msg.pedido.cliente.logradouro + \"'\"      || \"NULL\") + \" AS VARCHAR(5)) \" +\n\"SET @ENDERECO = CAST(\" +       (\"'\" + msg.pedido.cliente.endereco + \"'\"        || \"NULL\") + \" AS VARCHAR(50)) \" +\n\"SET @NUMERO = CAST(\" +         (\"'\" + msg.pedido.cliente.numero + \"'\"          || \"NULL\") + \" AS VARCHAR(10)) \" +\n\"SET @COMPLEMENTO = CAST(\" +    (\"'\" + msg.pedido.cliente.complemento + \"'\"     || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @BAIRRO = CAST(\" +         (\"'\" + msg.pedido.cliente.bairro + \"'\"          || \"NULL\") + \" AS VARCHAR(30)) \" +\n\"SET @MUNICIPIO = CAST(\" +      (msg.pedido.cliente.municipio                   || \"NULL\") + \" AS INT) \" +\n\"SET @CIDADE = CAST(\" +         (\"'\" + msg.pedido.cliente.cidade + \"'\"          || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @CEP = CAST(\" +            (\"'\" + msg.pedido.cliente.CEP + \"'\"             || \"NULL\") + \" AS CHAR(9)) \" +\n\"SET @UF = CAST(\" +             (\"'\" + msg.pedido.cliente.UF + \"'\"              || \"NULL\") + \" AS CHAR(2)) \" +\n\"SET @DDD = CAST(\" +            (\"'\" + msg.pedido.cliente.ddd + \"'\"             || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @TELEFONE = CAST(\" +       (\"'\" + msg.pedido.cliente.telefone + \"'\"        || \"NULL\") + \" AS VARCHAR(15)) \" +\n\"SET @CONTATO = CAST(\" +        (\"'\" + msg.pedido.cliente.contato + \"'\"         || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @DESCONTO = CAST(\" +        (\"'\" + msg.pedido.cliente.desconto + \"'\"         || \"NULL\") + \" AS BIT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[CLI] AS target \" +\n\"   USING (SELECT @CNPJ, @INSCRICAO, @FANTASIA, @NOME, @LOGRADOURO, @ENDERECO, @NUMERO, @COMPLEMENTO, @BAIRRO, @MUNICIPIO, @CIDADE, @CEP, @UF, @DDD, @TELEFONE, @CONTATO, @DESCONTO) AS source \" +\n\"   (CNPJ, INSCRICAO, FANTASIA, NOME, LOGRADOURO, ENDERECO, NUMERO, COMPLEMENTO, BAIRRO, MUNICIPIO, CIDADE, CEP, UF, DDD, TELEFONE, CONTATO, DESCONTO) \" +\n\"   ON (target.CNPJ = source.CNPJ) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET INSCRICAO = source.INSCRICAO, FANTASIA = source.FANTASIA, NOME = source.NOME, \" +\n\"   LOGRADOURO = source.LOGRADOURO, ENDERECO = source.ENDERECO, NUMERO = source.NUMERO, COMPLEMENTO = source.COMPLEMENTO, \" +\n\"   BAIRRO = source.BAIRRO, MUNICIPIO = source.MUNICIPIO, CIDADE = source.CIDADE, CEP = source.CEP, UF = source.UF, DDD = source.DDD, TELEFONE = source.TELEFONE, CONTATO = source.CONTATO, DESCONTO = source.DESCONTO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (CNPJ, INSCRICAO, FANTASIA, NOME, LOGRADOURO, ENDERECO, NUMERO, COMPLEMENTO, BAIRRO, MUNICIPIO, CIDADE, CEP, UF, DDD, TELEFONE, CONTATO, DESCONTO) \" +\n\"\tVALUES (source.CNPJ, source.INSCRICAO, source.FANTASIA, source.NOME, source.LOGRADOURO, source.ENDERECO, source.NUMERO, source.COMPLEMENTO, source.BAIRRO, source.MUNICIPIO, source.CIDADE, source.CEP, source.UF, source.DDD, source.TELEFONE, source.CONTATO, source.DESCONTO); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_CLI] AS target \" +\n\"   USING (SELECT @PEDIDO, @CNPJ) AS source \" +\n\"   (PED_NUMERO, CLI_CNPJ) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.CLI_CNPJ = source.CLI_CNPJ) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET CLI_CNPJ = source.CLI_CNPJ \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, CLI_CNPJ) \" +\n\"\tVALUES (source.PED_NUMERO, source.CLI_CNPJ); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":1468.1999969482422,"y":3088,"wires":[["b776ee37.fa184","df863dba.68154"]]},{"id":"b776ee37.fa184","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":1468.1999969482422,"y":3148,"wires":[["8761f8b7.d31f98"]]},{"id":"df863dba.68154","type":"debug","z":"e6097cee.8df04","name":"","active":true,"console":"false","complete":"payload","x":1638.1999969482422,"y":3088,"wires":[]},{"id":"8761f8b7.d31f98","type":"function","z":"e6097cee.8df04","name":"REPR.","func":"msg.payload = \n\"DECLARE @CODIGO VARCHAR(3) \" +\n\"DECLARE @NOME VARCHAR(50) \" +\n\n\"SET @CODIGO = CAST(\" +           (\"'\" + msg.pedido.representante.codigo + \"'\"            || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @NOME = CAST(\" +      (\"'\" + msg.pedido.representante.nome + \"'\"       || \"NULL\") + \" AS VARCHAR(50)) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[REP] AS target \" +\n\"   USING (SELECT @CODIGO, @NOME) AS source \" +\n\"   (CODIGO, NOME) \" +\n\"   ON (target.CODIGO = source.CODIGO) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET NOME = source.NOME \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (CODIGO, NOME) \" +\n\"\tVALUES (source.CODIGO, source.NOME); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_REP] AS target \" +\n\"   USING (SELECT @PEDIDO, @CODIGO) AS source \" +\n\"   (PED_NUMERO, REP_CODIGO) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.REP_CODIGO = source.REP_CODIGO) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET REP_CODIGO = source.REP_CODIGO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, REP_CODIGO) \" +\n\"\tVALUES (source.PED_NUMERO, source.REP_CODIGO); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":1458.1999969482422,"y":3208,"wires":[["15aa6a03.1165d6","9e2539ef.7d8d18"]]},{"id":"9e2539ef.7d8d18","type":"debug","z":"e6097cee.8df04","name":"","active":true,"console":"false","complete":"payload","x":1638.1999969482422,"y":3208,"wires":[]},{"id":"15aa6a03.1165d6","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":1468.1999969482422,"y":3268,"wires":[["812eef52.238bd"]]},{"id":"b80bcb81.1f7698","type":"function","z":"e6097cee.8df04","name":"DUPL","func":"msg.payload = \n\"DECLARE @NOSSO_NUMERO INT \" +\n\"DECLARE @PARCELA INT \" +\n\"DECLARE @TIPO VARCHAR(3) \" +\n\"DECLARE @VENCTO DATE \" +\n\"DECLARE @PRAZO INT \" +\n\"DECLARE @PORCENTAGEM DECIMAL(18, 3) \" +\n\"DECLARE @VALOR MONEY \" +\n\"DECLARE @DESCRICAO VARCHAR(50) \" +\n\"DECLARE @ORIGEM VARCHAR(10) \" +\n\n\"SET @NOSSO_NUMERO = CAST(\" +   (\"'\" + msg.payload.nosso_numero + \"'\"   || \"NULL\") + \" AS INT) \" +\n\"SET @PARCELA = CAST(\" +        (\"'\" + msg.payload.parcela + \"'\"        || \"NULL\") + \" AS INT) \" +\n\"SET @TIPO = CAST(\" +           (\"'\" + msg.payload.tipo + \"'\"           || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @VENCTO = CAST(\" +         (\"'\" + msg.payload.vencto + \"'\"         || \"NULL\") + \" AS DATE) \" +\n\"SET @PRAZO = CAST(\" +          (\"'\" + msg.payload.prazo + \"'\"          || \"NULL\") + \" AS INT) \" +\n\"SET @PORCENTAGEM = CAST(\" +    (\"'\" + msg.payload.porcentagem + \"'\"    || \"NULL\") + \" AS DECIMAL(18, 3)) \" +\n\"SET @VALOR = CAST(\" +          (\"'\" + msg.payload.valor + \"'\"          || \"NULL\") + \" AS MONEY) \" +\n\"SET @DESCRICAO = CAST(\" +      (\"'\" + msg.payload.descricao + \"'\"      || \"NULL\") + \" AS VARCHAR(50)) \" +\n\"SET @ORIGEM = 'PEDIDO' \" +\n\n\"MERGE [FINANCEIRO].[dbo].[DUP] AS target \" +\n\"   USING (SELECT @NOSSO_NUMERO, @PARCELA, @TIPO, @VENCTO, @PRAZO, @PORCENTAGEM, @VALOR, @DESCRICAO, @ORIGEM) AS source \" +\n\"   (NOSSO_NUMERO, PARCELA, TIPO, VENCTO, PRAZO, PORCENTAGEM, VALOR, DESCRICAO, ORIGEM) \" +\n\"   ON (target.NOSSO_NUMERO = source.NOSSO_NUMERO AND target.PARCELA = source.PARCELA) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET NOSSO_NUMERO = source.NOSSO_NUMERO, PARCELA = source.PARCELA, TIPO = source.TIPO, VENCTO = source.VENCTO, PRAZO = source.PRAZO, PORCENTAGEM = source.PORCENTAGEM, VALOR = source.VALOR, DESCRICAO = source.DESCRICAO, ORIGEM = source.ORIGEM \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (NOSSO_NUMERO, PARCELA, TIPO, VENCTO, PRAZO, PORCENTAGEM, VALOR, DESCRICAO, ORIGEM) \" +\n\"\tVALUES (source.NOSSO_NUMERO, source.PARCELA, source.TIPO, source.VENCTO, source.PRAZO, source.PORCENTAGEM, source.VALOR, source.DESCRICAO, source.ORIGEM); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_DUP] AS target \" +\n\"   USING (SELECT @PEDIDO, @NOSSO_NUMERO, @PARCELA) AS source \" +\n\"   (PED_NUMERO, DUP_NOSSO_NUMERO, DUP_PARCELA) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.DUP_NOSSO_NUMERO = source.DUP_NOSSO_NUMERO AND target.DUP_PARCELA = source.DUP_PARCELA) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET DUP_NOSSO_NUMERO = source.DUP_NOSSO_NUMERO, DUP_PARCELA = source.DUP_PARCELA \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, DUP_NOSSO_NUMERO, DUP_PARCELA) \" +\n\"\tVALUES (source.PED_NUMERO, source.DUP_NOSSO_NUMERO, source.DUP_PARCELA); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":1618.1999969482422,"y":3308,"wires":[["cfee2b5c.757978","fd577f2b.41f35"]]},{"id":"cfee2b5c.757978","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":1768.1999969482422,"y":3368,"wires":[["812eef52.238bd"]]},{"id":"fd577f2b.41f35","type":"debug","z":"e6097cee.8df04","name":"","active":true,"console":"false","complete":"payload","x":1778.1999969482422,"y":3308,"wires":[]},{"id":"812eef52.238bd","type":"function","z":"e6097cee.8df04","name":"LOOP","func":"if (msg.parcela === undefined) {\n    msg.parcela = 0;\n    msg.payload = msg.pedido.parcelas[0]\n    return [msg, null];\n} else {\n    msg.parcela++\n    if (msg.parcela < msg.pedido.parcelas.length) {\n        msg.payload = msg.pedido.parcelas[msg.parcela];\n        return [msg, null];\n    } else {\n        return [null, msg];\n    }\n}","outputs":"2","noerr":0,"x":1458.1999969482422,"y":3348,"wires":[["b80bcb81.1f7698"],["3b3b69cb.4c7526"]]},{"id":"2d46d893.46d0f8","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":188.1999969482422,"y":3268,"wires":[["7b0c2fa2.be37b"]]},{"id":"fa506c9a.9dd6e","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"payload","x":358.1999969482422,"y":3208,"wires":[]},{"id":"2c42e53b.89beea","type":"function","z":"e6097cee.8df04","name":"REPR.","func":"msg.payload = \n\"DECLARE @CODIGO VARCHAR(3) \" +\n\"DECLARE @NOME VARCHAR(50) \" +\n\n\"SET @CODIGO = CAST(\" +           (\"'\" + msg.pedido.representante.codigo + \"'\"            || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @NOME = CAST(\" +      (\"'\" + msg.pedido.representante.nome + \"'\"       || \"NULL\") + \" AS VARCHAR(50)) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[REP] AS target \" +\n\"   USING (SELECT @CODIGO, @NOME) AS source \" +\n\"   (CODIGO, NOME) \" +\n\"   ON (target.CODIGO = source.CODIGO) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET NOME = source.NOME \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (CODIGO, NOME) \" +\n\"\tVALUES (source.CODIGO, source.NOME); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_REP] AS target \" +\n\"   USING (SELECT @PEDIDO, @CODIGO) AS source \" +\n\"   (PED_NUMERO, REP_CODIGO) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.REP_CODIGO = source.REP_CODIGO) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET REP_CODIGO = source.REP_CODIGO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, REP_CODIGO) \" +\n\"\tVALUES (source.PED_NUMERO, source.REP_CODIGO); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":178.1999969482422,"y":3208,"wires":[["2d46d893.46d0f8","fa506c9a.9dd6e"]]},{"id":"70617687.ea64c8","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"payload","x":358.1999969482422,"y":3088,"wires":[]},{"id":"8455ab89.d6afb8","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":188.1999969482422,"y":3148,"wires":[["2c42e53b.89beea"]]},{"id":"5d0e4b5a.43f8a4","type":"function","z":"e6097cee.8df04","name":"CLIENTE","func":"msg.payload = \n\"DECLARE @CNPJ VARCHAR(20) \" +\n\"DECLARE @INSCRICAO VARCHAR(12) \" +\n\"DECLARE @FANTASIA VARCHAR(30) \" +\n\"DECLARE @NOME VARCHAR(100) \" +\n\"DECLARE @LOGRADOURO VARCHAR(5) \" +\n\"DECLARE @ENDERECO VARCHAR(50) \" +\n\"DECLARE @NUMERO VARCHAR(10) \" +\n\"DECLARE @COMPLEMENTO VARCHAR(20) \" +\n\"DECLARE @BAIRRO VARCHAR(30) \" +\n\"DECLARE @MUNICIPIO INT \" +\n\"DECLARE @CIDADE VARCHAR(20) \" +\n\"DECLARE @CEP CHAR(9) \" +\n\"DECLARE @UF CHAR(2)\" +\n\"DECLARE @DDD VARCHAR(3) \" +\n\"DECLARE @TELEFONE VARCHAR(15) \" +\n\"DECLARE @CONTATO VARCHAR(20) \" +\n\"DECLARE @DESCONTO BIT \" +\n\n\"SET @CNPJ = CAST(\" +           (\"'\" + msg.pedido.cliente.cnpj + \"'\"            || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @INSCRICAO = CAST(\" +      (\"'\" + msg.pedido.cliente.inscricao + \"'\"       || \"NULL\") + \" AS VARCHAR(14)) \" +\n\"SET @FANTASIA = CAST(\" +       (\"'\" + msg.pedido.cliente.fantasia + \"'\"        || \"NULL\") + \" AS VARCHAR(30)) \" +\n\"SET @NOME = CAST(\" +           (\"'\" + msg.pedido.cliente.nome + \"'\"            || \"NULL\") + \" AS VARCHAR(100)) \" +\n\"SET @LOGRADOURO = CAST(\" +     (\"'\" + msg.pedido.cliente.logradouro + \"'\"      || \"NULL\") + \" AS VARCHAR(5)) \" +\n\"SET @ENDERECO = CAST(\" +       (\"'\" + msg.pedido.cliente.endereco + \"'\"        || \"NULL\") + \" AS VARCHAR(50)) \" +\n\"SET @NUMERO = CAST(\" +         (\"'\" + msg.pedido.cliente.numero + \"'\"          || \"NULL\") + \" AS VARCHAR(10)) \" +\n\"SET @COMPLEMENTO = CAST(\" +    (\"'\" + msg.pedido.cliente.complemento + \"'\"     || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @BAIRRO = CAST(\" +         (\"'\" + msg.pedido.cliente.bairro + \"'\"          || \"NULL\") + \" AS VARCHAR(30)) \" +\n\"SET @MUNICIPIO = CAST(\" +      (msg.pedido.cliente.municipio                   || \"NULL\") + \" AS INT) \" +\n\"SET @CIDADE = CAST(\" +         (\"'\" + msg.pedido.cliente.cidade + \"'\"          || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @CEP = CAST(\" +            (\"'\" + msg.pedido.cliente.CEP + \"'\"             || \"NULL\") + \" AS CHAR(9)) \" +\n\"SET @UF = CAST(\" +             (\"'\" + msg.pedido.cliente.UF + \"'\"              || \"NULL\") + \" AS CHAR(2)) \" +\n\"SET @DDD = CAST(\" +            (\"'\" + msg.pedido.cliente.ddd + \"'\"             || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @TELEFONE = CAST(\" +       (\"'\" + msg.pedido.cliente.telefone + \"'\"        || \"NULL\") + \" AS VARCHAR(15)) \" +\n\"SET @CONTATO = CAST(\" +        (\"'\" + msg.pedido.cliente.contato + \"'\"         || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @DESCONTO = CAST(\" +        (\"'\" + msg.pedido.cliente.desconto + \"'\"         || \"NULL\") + \" AS BIT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[CLI] AS target \" +\n\"   USING (SELECT @CNPJ, @INSCRICAO, @FANTASIA, @NOME, @LOGRADOURO, @ENDERECO, @NUMERO, @COMPLEMENTO, @BAIRRO, @MUNICIPIO, @CIDADE, @CEP, @UF, @DDD, @TELEFONE, @CONTATO, @DESCONTO) AS source \" +\n\"   (CNPJ, INSCRICAO, FANTASIA, NOME, LOGRADOURO, ENDERECO, NUMERO, COMPLEMENTO, BAIRRO, MUNICIPIO, CIDADE, CEP, UF, DDD, TELEFONE, CONTATO, DESCONTO) \" +\n\"   ON (target.CNPJ = source.CNPJ) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET INSCRICAO = source.INSCRICAO, FANTASIA = source.FANTASIA, NOME = source.NOME, \" +\n\"   LOGRADOURO = source.LOGRADOURO, ENDERECO = source.ENDERECO, NUMERO = source.NUMERO, COMPLEMENTO = source.COMPLEMENTO, \" +\n\"   BAIRRO = source.BAIRRO, MUNICIPIO = source.MUNICIPIO, CIDADE = source.CIDADE, CEP = source.CEP, UF = source.UF, DDD = source.DDD, TELEFONE = source.TELEFONE, CONTATO = source.CONTATO, DESCONTO = source.DESCONTO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (CNPJ, INSCRICAO, FANTASIA, NOME, LOGRADOURO, ENDERECO, NUMERO, COMPLEMENTO, BAIRRO, MUNICIPIO, CIDADE, CEP, UF, DDD, TELEFONE, CONTATO, DESCONTO) \" +\n\"\tVALUES (source.CNPJ, source.INSCRICAO, source.FANTASIA, source.NOME, source.LOGRADOURO, source.ENDERECO, source.NUMERO, source.COMPLEMENTO, source.BAIRRO, source.MUNICIPIO, source.CIDADE, source.CEP, source.UF, source.DDD, source.TELEFONE, source.CONTATO, source.DESCONTO); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_CLI] AS target \" +\n\"   USING (SELECT @PEDIDO, @CNPJ) AS source \" +\n\"   (PED_NUMERO, CLI_CNPJ) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.CLI_CNPJ = source.CLI_CNPJ) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET CLI_CNPJ = source.CLI_CNPJ \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, CLI_CNPJ) \" +\n\"\tVALUES (source.PED_NUMERO, source.CLI_CNPJ); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":188.1999969482422,"y":3088,"wires":[["8455ab89.d6afb8","70617687.ea64c8"]]},{"id":"288dade3.7a7802","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":188.1999969482422,"y":3028,"wires":[["5d0e4b5a.43f8a4"]]},{"id":"59a06d1f.a77c04","type":"http response","z":"e6097cee.8df04","name":"","x":908.1999969482422,"y":908,"wires":[]},{"id":"e892296c.3b10a8","type":"function","z":"e6097cee.8df04","name":"NOTIFY","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0 && !msg.payload[0].erro) {\n    return [msg, msg, null];\n} else {\n    return [null, null, msg];\n}\n","outputs":"3","noerr":0,"x":758.1999969482422,"y":948,"wires":[["59a06d1f.a77c04","1e391bab.98fb04"],["4b48949a.26bc8c"],["2c822aa2.f03816"]]},{"id":"a5468418.45de68","type":"mqtt out","z":"e6097cee.8df04","name":"","topic":"","qos":"","retain":"","broker":"42731854.d5b6a8","x":1228.1999969482422,"y":948,"wires":[]},{"id":"e110fe2f.321b7","type":"http in","z":"e6097cee.8df04","name":"nosso_numero 1","url":"/api/financeiro/recebiveis/lancamento/nosso_numero1","method":"get","swaggerDoc":"","x":118.19999694824219,"y":728,"wires":[["769b1e91.693c2"]]},{"id":"769b1e91.693c2","type":"function","z":"e6097cee.8df04","name":"SQL","func":"msg.payload = \n    \"BEGIN TRY\" + '\\n' + '\\n' +\n    \n    \"   SELECT ISNULL(MAX(RCB.nosso_numero), 0) AS nosso_numero FROM RCB INNER JOIN RCB_PED ON RCB.nosso_numero = RCB_PED.nosso_numero;\" + '\\n' + '\\n' +\n    \n    \"END TRY\" + '\\n' +\n    \"BEGIN CATCH\" + '\\n' + '\\n' +\n    \n    \"   DECLARE @ERR_ID INT\" + '\\n' +\n    \"   SET @ERR_ID = NEXT VALUE FOR err_log_seq\" + '\\n' +\n    \"   INSERT INTO err_log SELECT @ERR_ID AS id, ERROR_NUMBER() AS erro, ERROR_SEVERITY() AS nivel, ERROR_STATE() AS situacao, ERROR_PROCEDURE() AS procedimento, ERROR_LINE() AS linha, ERROR_MESSAGE() AS mensagem\" + '\\n' + '\\n' +\n    \n    \"   IF @@TRANCOUNT > 0\" + '\\n' +\n    \"       ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"END CATCH\" + '\\n'\n\nreturn msg;","outputs":"1","noerr":0,"x":328.1999969482422,"y":728,"wires":[["85fe621a.9318"]]},{"id":"85fe621a.9318","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"MSSQL","query":"","outField":"payload","x":558.1999969482422,"y":728,"wires":[["9e63811a.cd64b"]]},{"id":"9e63811a.cd64b","type":"function","z":"e6097cee.8df04","name":"NOTIFY","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0 && msg.payload[0].erro === undefined) {\n    \n    msg.payload = msg.payload[0];\n    return msg;\n    \n} else {\n    msg.statusCode = 500;\n    msg.payload = msg.payload[0];\n    return msg\n}\n","outputs":"1","noerr":0,"x":738.1999969482422,"y":728,"wires":[["ec6a55e6.ab68e8"]]},{"id":"ec6a55e6.ab68e8","type":"http response","z":"e6097cee.8df04","name":"","x":888.1999969482422,"y":728,"wires":[]},{"id":"db49d26a.10acd","type":"http in","z":"e6097cee.8df04","name":"nosso_numero 2","url":"/api/financeiro/recebiveis/lancamento/nosso_numero2","method":"get","swaggerDoc":"","x":118.19999694824219,"y":768,"wires":[["9d092069.36862"]]},{"id":"9d092069.36862","type":"function","z":"e6097cee.8df04","name":"SQL","func":"msg.payload = \n    \"BEGIN TRY\" + '\\n' + '\\n' +\n\n    \"   SELECT ISNULL(MAX(RCB.nosso_numero), 0) AS nosso_numero FROM RCB WHERE NOT EXISTS(SELECT * FROM RCB_PED WHERE RCB.nosso_numero = RCB_PED.nosso_numero); \" + '\\n' + '\\n' +\n\n    \"END TRY\" + '\\n' +\n    \"BEGIN CATCH\" + '\\n' + '\\n' +\n    \n    \"   DECLARE @ERR_ID INT\" + '\\n' +\n    \"   SET @ERR_ID = NEXT VALUE FOR err_log_seq\" + '\\n' +\n    \"   INSERT INTO err_log SELECT @ERR_ID AS id, ERROR_NUMBER() AS erro, ERROR_SEVERITY() AS nivel, ERROR_STATE() AS situacao, ERROR_PROCEDURE() AS procedimento, ERROR_LINE() AS linha, ERROR_MESSAGE() AS mensagem\" + '\\n' + '\\n' +\n    \n    \"   IF @@TRANCOUNT > 0\" + '\\n' +\n    \"       ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"END CATCH\"\n\nreturn msg;","outputs":"1","noerr":0,"x":328.1999969482422,"y":768,"wires":[["7529c1a7.2c602"]]},{"id":"7529c1a7.2c602","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"MSSQL","query":"","outField":"payload","x":558.1999969482422,"y":768,"wires":[["da3983ff.e841c"]]},{"id":"da3983ff.e841c","type":"function","z":"e6097cee.8df04","name":"NOTIFY","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0 && msg.payload[0].erro === undefined) {\n    \n    msg.payload = msg.payload[0];\n    return msg;\n    \n} else {\n    msg.statusCode = 500;\n    msg.payload = msg.payload[0];\n    return msg\n}\n","outputs":"1","noerr":0,"x":738.1999969482422,"y":768,"wires":[["8b125e0e.ae4b"]]},{"id":"8b125e0e.ae4b","type":"http response","z":"e6097cee.8df04","name":"","x":888.1999969482422,"y":768,"wires":[]},{"id":"37fbda91.768dc6","type":"comment","z":"e6097cee.8df04","name":"IMPORTAR PEDIDOS LIBERADOS","info":"GERA TAREFAS DE TESTE PARA CONFERIR DUPLICATA","x":218.1999969482422,"y":2808,"wires":[]},{"id":"e576c474.510ad8","type":"inject","z":"e6097cee.8df04","name":"","topic":"","payload":"","payloadType":"num","repeat":"","crontab":"","once":false,"x":128.1999969482422,"y":3028,"wires":[[]]},{"id":"79c6a68e.b46a48","type":"function","z":"e6097cee.8df04","name":"EVENTO","func":"msg.message = 'Importar Pedidos Liberados começou.'\nmsg.payload = \n\"SELECT * \" +\n\"FROM \" +\n\"\tGPIMAC_Altamira.dbo.INTEGRACAO_EVENTO WITH (NOLOCK) \" +\n\"WHERE \" +\n\"   evento = 'PEDIDO_LIBERADO' AND reconhecido = 0 AND antes = 'N' AND depois = 'S'\"\n\nreturn msg;","outputs":1,"noerr":0,"x":298.1999969482422,"y":3028,"wires":[[]]},{"id":"aceb71a3.bff0b","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"fe2eccea.fe5bf","name":"","query":"","outField":"payload","x":138.1999969482422,"y":3088,"wires":[[]]},{"id":"40f5f91c.07a2e8","type":"function","z":"e6097cee.8df04","name":"LOOP","func":"if (msg.evento === undefined) {\n    msg.evento = 0;\n    msg.eventos = msg.payload\n    msg.payload = msg.payload[0].id\n    return [null, msg];\n} else {\n    msg.evento++\n    if (msg.evento < msg.eventos.length) {\n        msg.payload = msg.eventos[msg.evento].id;\n        return [null, msg];\n    } else {\n        msg.payload = 'Importar Pedidos Liberados terminou. ' + msg.evento + ' Pedidos encontrados.';\n        return [msg, null];\n    }\n}\n","outputs":"2","noerr":0,"x":308.1999969482422,"y":3148,"wires":[[],[]]},{"id":"27df94dd.88e6ec","type":"function","z":"e6097cee.8df04","name":"EXISTE ?","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0) {\n    return [null, msg];\n} else {\n    msg.payload = 'Importar Pedidos Liberados terminou.';\n    return [msg, null];\n}","outputs":"2","noerr":0,"x":318.1999969482422,"y":3088,"wires":[[],[]]},{"id":"8ff9610c.6f848","type":"function","z":"e6097cee.8df04","name":"EVENTO","func":"\nmsg.payload = \n\"DECLARE @ID INT \" +\n\"SET @ID = \" + (msg.eventos[msg.evento].sequencial || 'NULL') + \" \" +\n\"UPDATE GPIMAC_Altamira.dbo.INTEGRACAO_EVENTO \" +\n\"   SET reconhecido = 1 \" +\n\"WHERE sequencial = @ID\"\nreturn msg;","outputs":1,"noerr":0,"x":318.1999969482422,"y":3388,"wires":[[]]},{"id":"90b12db0.5372c","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"fe2eccea.fe5bf","name":"","query":"","outField":"payload","x":318.1999969482422,"y":3448,"wires":[[]]},{"id":"398219d6.2d6226","type":"comment","z":"e6097cee.8df04","name":"IMPORTAR PEDIDOS LIBERADOS","info":"GERA TAREFAS DE TESTE PARA CONFERIR DUPLICATA","x":1158.1999969482422,"y":48,"wires":[]},{"id":"a83bc2d2.9457e","type":"inject","z":"e6097cee.8df04","name":"","topic":"","payload":"","payloadType":"num","repeat":"","crontab":"","once":false,"x":1128.1999969482422,"y":108,"wires":[["2d4dc619.96be3a"]]},{"id":"2d4dc619.96be3a","type":"function","z":"e6097cee.8df04","name":"EVENTO","func":"msg.message = 'Importar Pedidos Liberados começou.'\nmsg.payload = \n\"SELECT * \" +\n\"FROM \" +\n\"\tGPIMAC_Altamira.dbo.INTEGRACAO_EVENTO WITH (NOLOCK) \" +\n\"WHERE \" +\n\"   evento = 'PEDIDO_LIBERADO' AND reconhecido = 0 AND antes = 'N' AND depois = 'S'\"\n\nreturn msg;","outputs":1,"noerr":0,"x":1298.1999969482422,"y":108,"wires":[["d732ff94.f9ae5"]]},{"id":"d732ff94.f9ae5","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"fe2eccea.fe5bf","name":"","query":"","outField":"payload","x":1478.1999969482422,"y":108,"wires":[["95922293.64fa6"]]},{"id":"274dfafb.8f47f6","type":"function","z":"e6097cee.8df04","name":"LOOP","func":"if (msg.evento === undefined) {\n    msg.evento = 0;\n    msg.eventos = msg.payload\n    msg.payload = msg.payload[0].id\n    return [null, msg];\n} else {\n    msg.evento++\n    if (msg.evento < msg.eventos.length) {\n        msg.payload = msg.eventos[msg.evento].id;\n        return [null, msg];\n    } else {\n        msg.payload = 'Importar Pedidos Liberados terminou. ' + msg.evento + ' Pedidos encontrados.';\n        return [msg, null];\n    }\n}\n","outputs":"2","noerr":0,"x":1848.1999969482422,"y":108,"wires":[["afab86c0.6aa988"],["9761c85e.17c2f8"]]},{"id":"95922293.64fa6","type":"function","z":"e6097cee.8df04","name":"EXISTE ?","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0) {\n    return [null, msg];\n} else {\n    msg.payload = 'Importar Pedidos Liberados terminou.';\n    return [msg, null];\n}","outputs":"2","noerr":0,"x":1658.1999969482422,"y":108,"wires":[["afab86c0.6aa988"],["274dfafb.8f47f6"]]},{"id":"62f569f1.70f7b8","type":"function","z":"e6097cee.8df04","name":"EVENTO","func":"\nmsg.payload = \n\"DECLARE @ID INT \" +\n\"SET @ID = \" + (msg.eventos[msg.evento].sequencial || 'NULL') + \" \" +\n\"UPDATE GPIMAC_Altamira.dbo.INTEGRACAO_EVENTO \" +\n\"   SET reconhecido = 1 \" +\n\"WHERE sequencial = @ID\"\nreturn msg;","outputs":1,"noerr":0,"x":2038.1999969482422,"y":1028,"wires":[["f3b26b50.914058"]]},{"id":"f3b26b50.914058","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"fe2eccea.fe5bf","name":"","query":"","outField":"payload","x":1678.1999969482422,"y":828,"wires":[["274dfafb.8f47f6"]]},{"id":"f035aac4.2704b8","type":"function","z":"e6097cee.8df04","name":"TAREFA++","func":"msg.payload = {\n    nome: 'Lançamentos a Receber',\n    titulo: 'Pedido ' + msg.payload.numero,\n    descricao: msg.payload.cliente.nome,\n    documento: JSON.stringify(msg.payload),\n    atribuir: 'faturamento',\n    form: '/recebiveis/lancamento/',\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2048.199996948242,"y":828,"wires":[["2b66beed.b079f2"]]},{"id":"42aca178.a5ae","type":"http in","z":"e6097cee.8df04","name":"tarefas","url":"/api/tarefas/","method":"get","swaggerDoc":"","x":88.19999694824219,"y":48,"wires":[["d349447e.a87e58"]]},{"id":"b0ae0b4c.f004e8","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":558.1999969482422,"y":48,"wires":[["c7c91557.7c8da8"]]},{"id":"c7c91557.7c8da8","type":"http response","z":"e6097cee.8df04","name":"","x":888.1999969482422,"y":48,"wires":[]},{"id":"d349447e.a87e58","type":"function","z":"e6097cee.8df04","name":"SQL","func":"msg.payload = \n    \"DECLARE @PERFIL NVARCHAR(50)\" + '\\n' +\n    \n    \"SET @PERFIL = \" + (msg.req.query.perfil ? \"'\" + msg.req.query.perfil + \"'\" : 'NULL') + '\\n' + '\\n' +\n    \n    \"SELECT\" + '\\n' +\n    \"   id,\" + '\\n' +\n    \"   nome,\" + '\\n' +\n    \"   titulo,\" + '\\n' +\n    \"   descricao,\" + '\\n' +\n    \"   atribuir,\" + '\\n' +\n    \"   form,\" + '\\n' +\n    \"   parametros,\" + '\\n' +\n    \"   prazo,\" + '\\n' +\n    \"   criado,\" + '\\n' +\n    \"   CAST(versao AS INT) AS versao\" + '\\n' +\n    \"FROM\" + '\\n' +\n    \"\ttarefas\" + '\\n' +\n    \"WHERE\" + '\\n' +\n    \"   concluido IS NULL AND\" + '\\n' +\n    \"   (atribuir IS NULL OR atribuir IN (@PERFIL))\" + '\\n' +\n    \"ORDER BY\" + '\\n' +\n    \"   criado\"\n\nreturn msg;","outputs":1,"noerr":0,"x":328.1999969482422,"y":48,"wires":[["b0ae0b4c.f004e8"]]},{"id":"b7f52a91.cea628","type":"http in","z":"e6097cee.8df04","name":"tarefa/:id","url":"/api/tarefa/:id","method":"get","swaggerDoc":"","x":98.19999694824219,"y":88,"wires":[["54384a19.946364"]]},{"id":"403e3b49.b36794","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":558.1999969482422,"y":88,"wires":[["c901a022.4fb4d"]]},{"id":"a2c512c5.3878f","type":"http response","z":"e6097cee.8df04","name":"","x":888.1999969482422,"y":88,"wires":[]},{"id":"54384a19.946364","type":"function","z":"e6097cee.8df04","name":"SQL","func":"msg.payload = \n    \"DECLARE @ID INT\" + '\\n' + '\\n' +\n    \n    \"SET @ID = \" + (msg.req.params.id || 'NULL') + '\\n' + '\\n' +\n    \n    \"SELECT\" + '\\n' +\n    \"   id,\" + '\\n' +\n    \"   nome,\" + '\\n' +\n    \"   titulo,\" + '\\n' +\n    \"   descricao,\" + '\\n' +\n    \"   documento,\" + '\\n' +\n    \"   atribuir,\" + '\\n' +\n    \"   form,\" + '\\n' +\n    \"   parametros,\" + '\\n' +\n    \"   prazo,\" + '\\n' +\n    \"   criado,\" + '\\n' +\n    \"   concluido,\" + '\\n' +\n    \"   CAST(versao AS INT) AS versao\" + '\\n' +  \n    \"FROM\" + '\\n' +\n    \"\ttarefas\" + '\\n' +\n    \"WHERE\" + '\\n' +\n    \"   id = @ID;\" + '\\n'\n\nreturn msg;","outputs":1,"noerr":0,"x":328.1999969482422,"y":88,"wires":[["403e3b49.b36794"]]},{"id":"c901a022.4fb4d","type":"function","z":"e6097cee.8df04","name":"PARSE","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0) {\n    msg.payload = msg.payload[0]\n    msg.payload.documento = JSON.parse(msg.payload.documento);\n} else {\n    msg.payload = '';\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":738.1999969482422,"y":88,"wires":[["a2c512c5.3878f"]]},{"id":"5795484f.c40ec8","type":"http in","z":"e6097cee.8df04","name":"login","url":"/api/usuario/login","method":"post","swaggerDoc":"","x":88.19999694824219,"y":208,"wires":[["8b95642.e9a8598"]]},{"id":"a8172eb0.818ae","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":558.1999969482422,"y":208,"wires":[["829df015.2c727"]]},{"id":"9584ae7e.735b","type":"http response","z":"e6097cee.8df04","name":"","x":888.1999969482422,"y":208,"wires":[]},{"id":"8b95642.e9a8598","type":"function","z":"e6097cee.8df04","name":"SQL","func":"msg.payload = \n    \"DECLARE @LOGIN NVARCHAR(50)\" + '\\n' +\n    \"DECLARE @SENHA NVARCHAR(50)\" + '\\n' + '\\n' +\n\n    \"SET @LOGIN = \" + (msg.payload.login ? \"'\" + msg.payload.login + \"'\" : 'NULL') + \"\" + '\\n' +\n    \"SET @SENHA = \" + (msg.payload.senha ? \"'\" + msg.payload.senha + \"'\" : 'NULL') + \"\" + '\\n' + '\\n' +\n    \n    \"SELECT * \" +\n    \"FROM\" + '\\n' +\n    \"\tusuarios\" + '\\n' +\n    \"WHERE\" + '\\n' +\n    \"   LOGIN = @LOGIN AND\" + '\\n' +\n    \"   SENHA = @SENHA\" \n\nreturn msg;","outputs":1,"noerr":0,"x":328.1999969482422,"y":208,"wires":[["a8172eb0.818ae"]]},{"id":"829df015.2c727","type":"function","z":"e6097cee.8df04","name":"PARSE","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0) {\n    msg.payload = msg.payload[0];\n} else {\n    msg.payload = {};\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":738.1999969482422,"y":208,"wires":[["9584ae7e.735b"]]},{"id":"9612bbd0.31ed38","type":"debug","z":"e6097cee.8df04","name":"NAO ENCONTROU","active":true,"console":"false","complete":"payload","x":2288.199996948242,"y":228,"wires":[]},{"id":"afab86c0.6aa988","type":"debug","z":"e6097cee.8df04","name":"TERMINOU","active":true,"console":"false","complete":"payload","x":1868.1999969482422,"y":48,"wires":[]},{"id":"bffc5942.9d78e8","type":"http in","z":"e6097cee.8df04","name":"cobranca","url":"/api/financeiro/cobranca","method":"get","swaggerDoc":"","x":98.19999694824219,"y":328,"wires":[["e6b24041.78a6"]]},{"id":"dc6ec04.7d6e14","type":"http response","z":"e6097cee.8df04","name":"","x":1068.1999969482422,"y":368,"wires":[]},{"id":"c72c64f1.dc2268","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":558.1999969482422,"y":328,"wires":[["7849ac55.b82334"]]},{"id":"e6b24041.78a6","type":"function","z":"e6097cee.8df04","name":"SQL","func":"\nmsg.payload = \"SELECT RCB.*, RCB_PED.numero AS pedido FROM RCB LEFT OUTER JOIN RCB_PED ON RCB.nosso_numero = RCB_PED.nosso_numero\"; \n\nreturn msg;","outputs":1,"noerr":0,"x":328.1999969482422,"y":328,"wires":[["c72c64f1.dc2268"]]},{"id":"f85b2e2a.f0715","type":"function","z":"e6097cee.8df04","name":"SQL","func":"\nmsg.payload = \n\n\"SELECT * FROM RCBD WHERE nosso_numero = \" + msg.payload.nosso_numero; \n\nreturn msg;","outputs":1,"noerr":0,"x":1068.1999969482422,"y":328,"wires":[["4292f175.04692"]]},{"id":"4292f175.04692","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":1238.1999969482422,"y":328,"wires":[["d0f8194a.6a3208"]]},{"id":"7849ac55.b82334","type":"function","z":"e6097cee.8df04","name":"PARSE","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0) {\n    msg.cobranca = msg.payload;\n    return [msg, null];\n} else {\n    return [null, msg];    \n}","outputs":"2","noerr":0,"x":738.1999969482422,"y":328,"wires":[["f50c7680.f9d488"],[]]},{"id":"f50c7680.f9d488","type":"function","z":"e6097cee.8df04","name":"SQL","func":"if (msg.index === undefined) {\n    msg.index = 0;\n    msg.payload = msg.cobranca[msg.index];\n    return [msg, null];\n} else {\n    msg.index++;\n    if (msg.index < msg.cobranca.length) {\n        msg.payload = msg.cobranca[msg.index];    \n        return [msg, null]\n    }\n    msg.payload = msg.cobranca;\n    return [null, msg];\n}\n","outputs":"2","noerr":0,"x":888.1999969482422,"y":328,"wires":[["f85b2e2a.f0715"],["dc6ec04.7d6e14"]]},{"id":"d0f8194a.6a3208","type":"function","z":"e6097cee.8df04","name":"SQL","func":"msg.cobranca[msg.index].parcelas = msg.payload;\n\nreturn msg;","outputs":1,"noerr":0,"x":1068.1999969482422,"y":448,"wires":[["f50c7680.f9d488"]]},{"id":"72e5bb24.e34f84","type":"http in","z":"e6097cee.8df04","name":"tarefa/:id","url":"/api/tarefa/:id","method":"post","swaggerDoc":"","x":98.19999694824219,"y":128,"wires":[["c25f24a9.720938"]]},{"id":"985dadd0.6852c","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":558.1999969482422,"y":128,"wires":[["5a3e402.8ba01c"]]},{"id":"afa25a09.28c0a8","type":"http response","z":"e6097cee.8df04","name":"","x":888.1999969482422,"y":128,"wires":[]},{"id":"c25f24a9.720938","type":"function","z":"e6097cee.8df04","name":"SQL","func":"msg.payload = \n    \"BEGIN TRY\" + '\\n' +\n    \"   BEGIN TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"   DECLARE @TAREFA INT\" + '\\n' +\n    \"   DECLARE @VERSAO INT\" + '\\n' + '\\n' +\n\n    \"   -------------------------------------- ATUALIZACAO DAS TAREFAS ----------------------------------------------\" + '\\n' +\n    \"   SET @TAREFA = \" + (msg.req.params.id || 'NULL') + '\\n' +\n    \"   SET @VERSAO = CAST('\" + (msg.payload.versao || 'NULL') + \"' AS INT)\" + '\\n' + '\\n' +\n\n    \"   UPDATE tarefas SET\" + '\\n' +\n    \"       documento = '\" + JSON.stringify(msg.payload.documento) + \"'\" + '\\n' +\n    \"   WHERE\" + '\\n' +\n    \"       id = @TAREFA\" + '\\n' +\n    \"       AND concluido IS NULL\" + '\\n' +\n    \"       AND versao = @VERSAO\" + '\\n' + '\\n' +\n    \n    \"   IF @@ROWCOUNT != 1\" + '\\n' +\n    \"   BEGIN\" + '\\n' + '\\n' +\n    \n    \"       DECLARE @ULTIMA_VERSAO INT\" + '\\n' +\n    \"       DECLARE @CONCLUIDO DATETIME\" + '\\n' + '\\n' +\n    \n    \"       SELECT TOP 1 @ULTIMA_VERSAO = versao, @CONCLUIDO = concluido FROM tarefas WHERE id = @TAREFA\" + '\\n' + '\\n' +\n    \n    \"       IF (NOT @CONCLUIDO IS NULL)\" + '\\n' +\n    \"           SELECT * FROM ERR WHERE erro = 7010\" + '\\n' +\n    \"       ELSE IF (@ULTIMA_VERSAO <> @VERSAO)\" + '\\n' +\n    \"           SELECT * FROM ERR WHERE erro = 7451\" + '\\n' + '\\n' +\n    \n    \"       ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"       RETURN;\" + '\\n' +\n    \"   END\" + '\\n' + '\\n' +\n\n    \"   SELECT\" + '\\n' +\n    \"       id,\" + '\\n' +\n    \"       nome,\" + '\\n' +\n    \"       titulo,\" + '\\n' +\n    \"       descricao,\" + '\\n' +\n    //\"     documento,\" + '\\n' +\n    \"       atribuir,\" + '\\n' +\n    \"       form,\" + '\\n' +\n    \"       parametros,\" + '\\n' +\n    \"       prazo,\" + '\\n' +\n    \"       criado,\" + '\\n' +\n    \"       CAST(versao AS INT) AS versao\" + '\\n' +  \n    \"   FROM\" + '\\n' +\n    \"\t    tarefas\" + '\\n' +\n    \"   WHERE\" + '\\n' +\n    \"       id = @TAREFA;\" + '\\n' + '\\n' +\n    \n    \"   COMMIT TRANSACTION;\" + '\\n' + '\\n' +\n\n    \"END TRY\" + '\\n' +\n    \"BEGIN CATCH\" + '\\n' + '\\n' +\n    \n    \"   DECLARE @ERR_ID INT\" + '\\n' +\n    \"   SET @ERR_ID = NEXT VALUE FOR err_log_seq\" + '\\n' +\n    \"   INSERT INTO err_log SELECT @ERR_ID AS id, ERROR_NUMBER() AS erro, ERROR_SEVERITY() AS nivel, ERROR_STATE() AS situacao, ERROR_PROCEDURE() AS procedimento, ERROR_LINE() AS linha, ERROR_MESSAGE() AS mensagem\" + '\\n' + '\\n' +\n    \n    \"   IF @@TRANCOUNT > 0\" + '\\n' +\n    \"       ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"END CATCH\" + '\\n'\n\nreturn msg;","outputs":1,"noerr":0,"x":328.1999969482422,"y":128,"wires":[["985dadd0.6852c"]]},{"id":"5a3e402.8ba01c","type":"function","z":"e6097cee.8df04","name":"PARSE","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0) {\n    msg.payload = msg.payload[0];    \n} else {\n    msg.payload = {erro: 9999, mensagem: 'Ocorreu um erro ao executar a sua solicitação.'}\n}\n\nif (msg.payload.erro) {\n    msg.statusCode = 500;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":738.1999969482422,"y":128,"wires":[["afa25a09.28c0a8"]]},{"id":"15141e5f.03a152","type":"http in","z":"e6097cee.8df04","name":"cobranca","url":"/api/financeiro/recebiveis/cobranca/tarefa/:tarefa","method":"post","swaggerDoc":"","x":98.19999694824219,"y":928,"wires":[["6bbe04be.ffafec"]]},{"id":"6bbe04be.ffafec","type":"function","z":"e6097cee.8df04","name":"SQL","func":"var tarefa_atual = \n{\n    nome: 'Cobrança Bancária',\n    titulo: 'Gerar Remessa de Cobrança',\n    descricao: 'Saldo R$ ' + msg.payload.documento.cobranca.reduce( (total, c) => total + c.parcelas.filter( (p) => !p.selected && !p.carteira).reduce( (soma, p) => soma + p.valor, 0.0), 0.0).toFixed(2).replace('.', ','), \n    documento: JSON.stringify(\n        msg.payload.documento.cobranca.map( c => {\n            \n            var cobranca = {\n                nosso_numero: c.nosso_numero,\n                pedido: c.pedido,\n                cliente: c.cliente,\n                parcelas: c.parcelas.map( (p) => {\n                \n                    var parcela = {\n                        vencto: p.vencto,\n                        origem: p.origem,\n                        forma_pagto: p.forma_pagto,\n                        tipo_vencto: p.tipo_vencto,\n                        parcela: p.parcela,\n                        prazo: p.prazo,\n                        valor: p.valor\n                    }\n                    \n                    if (p.carteira) {\n                        parcela.carteira = p.carteira;\n                        parcela.remessa = p.remessa;\n                    } else if (p.selected) {\n                        parcela.carteira = msg.payload.documento.carteira.nome;\n                        parcela.remessa = new Date().toISOString();\n                    }\n                    \n                    return parcela;\n                    \n                })\n            };\n            \n            return cobranca;\n        })\n    ),\n    atribuir: 'financeiro',\n    form: '/recebiveis/cobranca/'\n}\n\nvar tarefa_remessa = \n{\n    nome: 'Remessa de Cobrança',\n    titulo: msg.payload.documento.carteira.nome,\n    descricao: 'Total R$ ' + msg.payload.documento.cobranca.reduce( (total, c) => total + c.parcelas.filter( (p) => p.selected && !p.carteira).reduce( (soma, p) => soma + p.valor, 0.0), 0.0).toFixed(2).replace('.', ','), \n    documento: JSON.stringify({ \n        \n        carteira: msg.payload.documento.carteira,\n        data: new Date().toISOString(),\n        \n        remessa: msg.payload.documento.cobranca.filter( c => c.parcelas.find( p => p.selected)).map( c => {\n            var cobranca = {\n                nosso_numero: c.nosso_numero,\n                pedido: c.pedido,\n                cliente: c.cliente,\n                parcelas: c.parcelas.filter( p => p.selected).map( (p) => {\n                \n                    var parcela = {\n                        vencto: p.vencto,\n                        origem: p.origem,\n                        forma_pagto: p.forma_pagto,\n                        tipo_vencto: p.tipo_vencto,\n                        parcela: p.parcela,\n                        prazo: p.prazo,\n                        valor: p.valor\n                    }\n                    \n                    parcela.carteira = msg.payload.documento.carteira.nome;\n                    parcela.remessa = new Date().toISOString();\n\n                    return parcela;\n                    \n                })\n            };\n            \n            return cobranca;\n        }),\n        \n        bordero: msg.payload.documento.bordero\n        \n    }),\n    atribuir: 'cobranca',\n    form: '/recebiveis/remessa/'\n}\n\nmsg.payload = \n    \"SET NOCOUNT ON\" + '\\n' + '\\n' +\n    \n    \"DECLARE @NOSSO_NUMERO INT\" + '\\n' +\n    \"DECLARE @PARCELA INT\" + '\\n' +\n    \"DECLARE @CARTEIRA INT\" + '\\n' + '\\n' +\n\n    \"DECLARE @CONTA_CONTABIL VARCHAR(20)\" + '\\n' +\n    \"DECLARE @CNPJ VARCHAR(20)\" + '\\n' +\n    \"DECLARE @INSCRICAO VARCHAR(12)\" + '\\n' +\n    \"DECLARE @FANTASIA VARCHAR(30)\" + '\\n' +\n    \"DECLARE @NOME VARCHAR(100)\" + '\\n' +\n    \"DECLARE @LOGRADOURO VARCHAR(5)\" + '\\n' +\n    \"DECLARE @ENDERECO VARCHAR(50)\" + '\\n' +\n    \"DECLARE @NUMERO VARCHAR(10)\" + '\\n' +\n    \"DECLARE @COMPLEMENTO VARCHAR(20)\" + '\\n' +\n    \"DECLARE @BAIRRO VARCHAR(30)\" + '\\n' +\n    \"DECLARE @MUNICIPIO INT\" + '\\n' +\n    \"DECLARE @CIDADE VARCHAR(20)\" + '\\n' +\n    \"DECLARE @CEP CHAR(9)\" + '\\n' +\n    \"DECLARE @UF CHAR(2)\" + '\\n' +\n    \"DECLARE @DDD VARCHAR(3)\" + '\\n' +\n    \"DECLARE @TELEFONE VARCHAR(15)\" + '\\n' +\n    \"DECLARE @CONTATO VARCHAR(20)\" + '\\n' + '\\n' +\n\n    \"DECLARE @FORMA_PAGTO VARCHAR(10)\" + '\\n' +\n    \"DECLARE @TIPO_VENCTO VARCHAR(3)\" + '\\n' +\n    \"DECLARE @VENCTO DATE\" + '\\n' +\n    \"DECLARE @PRAZO INT\" + '\\n' +\n    \"DECLARE @PORCENTAGEM DECIMAL(18, 3)\" + '\\n' +\n    \"DECLARE @VALOR MONEY\" + '\\n' +\n    \"DECLARE @DESCRICAO VARCHAR(50)\" + '\\n' +\n    \"DECLARE @ORIGEM VARCHAR(10)\" + '\\n' + '\\n' +\n\n    \"DECLARE @TAREFA_ATUAL INT\" + '\\n' +\n    \"DECLARE @VERSAO INT\" + '\\n' + '\\n' +\n\n    \"DECLARE @NOVA_TAREFA INT\" + '\\n' +\n\n    \"DECLARE @ULTIMA_VERSAO INT\" + '\\n' +\n    \"DECLARE @CONCLUIDO DATETIME\" + '\\n' + '\\n' +\n\n    \"DECLARE @PROX_TAREFA INT\" + '\\n' +\n    \"DECLARE @PROX_TAREFA_VERSAO INT\" + '\\n' + '\\n' +\n\n    \"DECLARE @NOVA_NAV INT\" + '\\n' + '\\n' +\n    \n    \"DECLARE @tarefas TABLE (\" + '\\n' +\n\t\"\t[id] [int] NOT NULL,\" + '\\n' +\n\t\"\t[nome] [nvarchar](100) NOT NULL,\" + '\\n' +\n\t\"\t[titulo] [nvarchar](50) NULL,\" + '\\n' +\n\t\"\t[descricao] [nvarchar](50) NULL,\" + '\\n' +\n\t\"\t[atribuir] [nvarchar](50) NULL,\" + '\\n' +\n\t\"\t[form] [nvarchar](100) NOT NULL,\" + '\\n' +\n\t\"\t[parametros] [nvarchar](max) NULL,\" + '\\n' +\n\t\"\t[prazo] [datetime] NULL,\" + '\\n' +\n\t\"\t[criado] [datetime] NOT NULL,\" + '\\n' +\n\t\"\t[concluido] [datetime] NULL,\" + '\\n' +\n\t\"\t[versao] [int],\" + '\\n' +\n\t\"\t[topico] [nvarchar](100) NOT NULL)\" + '\\n' + '\\n' +\n\t\t\n    \"BEGIN TRY\" + '\\n' +\n    \"   BEGIN TRANSACTION\" + '\\n' + '\\n' +\n\n    \"   -------------------------------------- ATUALIZACAO DAS TAREFAS ----------------------------------------------\" + '\\n' +\n    \"   SET @TAREFA_ATUAL = \" + (parseInt(msg.req.params.tarefa) || 'NULL') + \"\" + '\\n' +\n    \"   SET @VERSAO = CAST('\" + (msg.payload.versao || 'NULL') + \"' AS INT)\" + '\\n' + '\\n' +\n\n    \"   UPDATE tarefas SET\" + '\\n' +\n    \"\t    concluido = GETDATE()\" + '\\n' +\n    \"   WHERE\" + '\\n' +\n    \"       id = @TAREFA_ATUAL\" + '\\n' +\n    \"       AND concluido IS NULL\" + '\\n' + '\\n' +\n    \"       AND versao = @VERSAO\" + '\\n' + '\\n' +\n    \n    \"   IF @@ROWCOUNT != 1\" + '\\n' +\n    \"   BEGIN\" + '\\n' +\n    \n    \"       ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"       SELECT TOP 1 @ULTIMA_VERSAO = versao, @CONCLUIDO = concluido FROM tarefas WHERE id = @TAREFA_ATUAL\" + '\\n' + '\\n' +\n    \n    \"       IF (NOT @CONCLUIDO IS NULL)\" + '\\n' +\n    \"       BEGIN\" + '\\n' +\n    \"           INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7010\" + '\\n' +\n    \"           SELECT * FROM ERR WHERE erro = 7010\" + '\\n' +\n    \"       END\" + '\\n' +\n    \"       ELSE IF (@ULTIMA_VERSAO <> @VERSAO)\" + '\\n' +\n    \"       BEGIN\" + '\\n' +\n    \"           INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7450\" + '\\n' +\n    \"           SELECT * FROM ERR WHERE erro = 7450\" + '\\n' + '\\n' +\n    \"       END\" + '\\n' + '\\n' +\n    \n    \"       RETURN\" + '\\n' +\n    \"   END\" + '\\n' + '\\n' +\n\n    \"   INSERT INTO @tarefas SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/concluida/' + LTRIM(RTRIM(atribuir)) AS topico FROM tarefas WHERE id = @TAREFA_ATUAL\" + '\\n' + '\\n' +\n\n    //---------------------------------------------------- grava as parcelas ----------------------------------------------------\n    msg.payload.documento.cobranca.reduce( (sql, c) => \n    \n        sql + c.parcelas.filter( p => p.selected).reduce( (sql, p) => \n        \n            sql + \n            \"   ----------------------------------------------------------------------------------------------------------\" + '\\n' +\n            \"   -- insere nova parcela => nosso_numero: \" + c.nosso_numero + ', parcela: ' + p.parcela + ', carteira: ' + msg.payload.documento.carteira.id + '\\n' +\n            \"   ----------------------------------------------------------------------------------------------------------\" + '\\n' +\n            \"   SET @NOSSO_NUMERO = CAST(\" +   (\"'\" + c.nosso_numero + \"'\" || \"NULL\") + \" AS INT)\" + '\\n' +\n            \"   SET @PARCELA = CAST(\" +        (\"'\" + p.parcela + \"'\"      || \"NULL\") + \" AS INT)\" + '\\n' +\n            \"   SET @CARTEIRA = CAST(\" +       (\"'\" + msg.payload.documento.carteira.id + \"'\"        || \"NULL\") + \" AS INT)\" + '\\n' + '\\n' +\n        \n            \"   IF EXISTS(SELECT NOSSO_NUMERO FROM COB WHERE nosso_numero = @NOSSO_NUMERO AND parcela = @PARCELA AND carteira = @CARTEIRA)\" + '\\n' +\n            \"   BEGIN\" + '\\n' + '\\n' +\n            \n            \"       ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n            \n            \"       INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 1123\" + '\\n' +\n            \"       SELECT * FROM ERR WHERE erro = 1123\" + '\\n' + '\\n' +\n            \n            \"       RETURN\" + '\\n' +\n            \"   END\" + '\\n' + '\\n' +\n    \n            \"   SET @NOSSO_NUMERO = CAST(\" +   (\"'\" + c.nosso_numero + \"'\" || \"NULL\") + \" AS INT)\" + '\\n' +\n            \"   SET @PARCELA = CAST(\" +        (\"'\" + p.parcela + \"'\"      || \"NULL\") + \" AS INT)\" + '\\n' +\n            \"   SET @CARTEIRA = CAST(\" +       (\"'\" + msg.payload.documento.carteira.id + \"'\"        || \"NULL\") + \" AS INT)\" + '\\n' + '\\n' +\n    \n            \"   SET @CONTA_CONTABIL = CAST('\" + c.cliente.conta_contabil + \"' AS VARCHAR(20))\" + '\\n' + \n            \"   SET @CNPJ = CAST(\" +           (\"'\" + c.cliente.cnpj + \"'\"        || \"NULL\") + \" AS VARCHAR(20))\" + '\\n' +\n            \"   SET @INSCRICAO = CAST(\" +      (\"'\" + c.cliente.inscricao + \"'\"   || \"NULL\") + \" AS VARCHAR(14))\" + '\\n' +\n            \"   SET @FANTASIA = CAST(\" +       (\"'\" + c.cliente.fantasia + \"'\"    || \"NULL\") + \" AS VARCHAR(30))\" + '\\n' +\n            \"   SET @NOME = CAST(\" +           (\"'\" + c.cliente.nome + \"'\"        || \"NULL\") + \" AS VARCHAR(100))\" + '\\n' +\n            \"   SET @LOGRADOURO = CAST(\" +     (\"'\" + c.cliente.logradouro + \"'\"      || \"NULL\") + \" AS VARCHAR(5))\" + '\\n' +\n            \"   SET @ENDERECO = CAST(\" +       (\"'\" + c.cliente.endereco + \"'\"    || \"NULL\") + \" AS VARCHAR(50))\" + '\\n' +\n            \"   SET @NUMERO = CAST(\" +         (\"'\" + c.cliente.numero + \"'\"      || \"NULL\") + \" AS VARCHAR(10))\" + '\\n' +\n            \"   SET @COMPLEMENTO = CAST(\" +    (\"'\" + c.cliente.complemento + \"'\"     || \"NULL\") + \" AS VARCHAR(20))\" + '\\n' +\n            \"   SET @BAIRRO = CAST(\" +         (\"'\" + c.cliente.bairro + \"'\"      || \"NULL\") + \" AS VARCHAR(30))\" + '\\n' +\n            \"   SET @MUNICIPIO = CAST(\" +      (c.cliente.municipio                   || \"NULL\") + \" AS INT)\" + '\\n' +\n            \"   SET @CIDADE = CAST(\" +         (\"'\" + c.cliente.cidade + \"'\"      || \"NULL\") + \" AS VARCHAR(20))\" + '\\n' +\n            \"   SET @CEP = CAST(\" +            (\"'\" + c.cliente.CEP + \"'\"         || \"NULL\") + \" AS CHAR(9))\" + '\\n' +\n            \"   SET @UF = CAST(\" +             (\"'\" + c.cliente.UF + \"'\"          || \"NULL\") + \" AS CHAR(2))\" + '\\n' +\n            \"   SET @DDD = CAST(\" +            (\"'\" + c.cliente.ddd + \"'\"         || \"NULL\") + \" AS VARCHAR(3))\" + '\\n' +\n            \"   SET @TELEFONE = CAST(\" +       (\"'\" + c.cliente.telefone + \"'\"    || \"NULL\") + \" AS VARCHAR(15))\" + '\\n' +\n            \"   SET @CONTATO = CAST(\" +        (\"'\" + c.cliente.contato + \"'\"     || \"NULL\") + \" AS VARCHAR(20))\" + '\\n' + '\\n' +\n        \n            \"   SET @PARCELA = CAST(\" +        (\"'\" + p.parcela + \"'\"        || \"NULL\") + \" AS INT)\" + '\\n' +\n            \"   SET @FORMA_PAGTO = CAST(\" +    (\"'\" + p.forma_pagto + \"'\"    || \"NULL\") + \" AS VARCHAR(10))\" + '\\n' +\n            \"   SET @TIPO_VENCTO = CAST(\" +    (\"'\" + p.tipo_vencto + \"'\"    || \"NULL\") + \" AS VARCHAR(3))\" + '\\n' +\n            \"   SET @VENCTO = CAST(\" +         (\"'\" + p.vencto + \"'\"         || \"NULL\") + \" AS DATE)\" + '\\n' +\n            \"   SET @PRAZO = CAST(\" +          (\"'\" + p.prazo + \"'\"          || \"NULL\") + \" AS INT)\" + '\\n' +\n            \"   SET @VALOR = CAST(\" +          (\"'\" + p.valor + \"'\"          || \"NULL\") + \" AS MONEY)\" + '\\n' +\n            \"   SET @ORIGEM = CAST(\" +         (\"'\" + p.origem + \"'\"          || \"NULL\") + \" AS VARCHAR(10))\" + '\\n' + '\\n' +\n            \n            \"   INSERT INTO COB (nosso_numero, parcela, carteira, remessa, retorno, situacao, conta_contabil, forma_pagto, tipo_vencto, vencto, prazo, valor, origem, cnpj, inscricao, fantasia, nome, logradouro, endereco, numero, complemento, bairro, municipio, cidade, cep, uf, ddd, telefone, contato)\" + '\\n' +\n            \"   VALUES (@NOSSO_NUMERO, @PARCELA, @CARTEIRA, GETDATE(), NULL, NULL, @CONTA_CONTABIL, @FORMA_PAGTO, @TIPO_VENCTO, @VENCTO, @PRAZO, @VALOR, @ORIGEM, @CNPJ, @INSCRICAO, @FANTASIA, @NOME, @LOGRADOURO, @ENDERECO, @NUMERO, @COMPLEMENTO, @BAIRRO, @MUNICIPIO, @CIDADE, @CEP, @UF, @DDD, @TELEFONE, @CONTATO)\" + '\\n' + '\\n' +\n\n            \"   UPDATE CRT SET\" + '\\n' +\n            \"       remessa = remessa + @VALOR\" + '\\n' +\n            \"   WHERE id = @CARTEIRA\" + '\\n' + '\\n'\n\n        , '')\n    \n    , '') +\n\n    (msg.payload.documento.cobranca.find( (c) => c.parcelas.find( (p) => !p.selected && !p.carteira) ) ?\n\n    \"   ----------------------- TAREFA AINDA PENDENTE, RECRIA A TAREFA -----------------------\" + '\\n' +\n    \"   SELECT TOP 1 @PROX_TAREFA = id, @PROX_TAREFA_VERSAO = versao FROM tarefas WHERE nome = '\" + tarefa_atual.nome + \"' AND concluido IS NULL\" + '\\n' + '\\n' +\n   \n    \"   IF @PROX_TAREFA IS NULL\" + '\\n' +\n    \"   BEGIN\" + '\\n' + '\\n' +\n    \n    \"       SET @PROX_TAREFA = NEXT VALUE FOR tarefa_seq\" + '\\n' + '\\n' +\n    \n    \"       INSERT INTO tarefas\" + '\\n' +\n    \"           (id,\" + '\\n' +\n    \"           nome,\" + '\\n' +\n    \"           titulo,\" + '\\n' +\n    \"           descricao,\" + '\\n' +\n    \"           detalhes,\" + '\\n' +\n    \"           documento,\" + '\\n' +\n    \"           atribuir,\" + '\\n' +\n    \"           form,\" + '\\n' +\n    \"           parametros,\" + '\\n' +\n    \"           prazo,\" + '\\n' +\n    \"           criado,\" + '\\n' +\n    \"           concluido)\" + '\\n' +\n    \"       VALUES\" + '\\n' +\n    \"           (@PROX_TAREFA,\" + '\\n' +\n    \"           '\" + tarefa_atual.nome + \"',\" + '\\n' +\n    \"           '\" + tarefa_atual.titulo + \"',\" + '\\n' +\n    \"           'Saldo R$ \" + msg.payload.documento.cobranca.reduce( (total, c) => total + c.parcelas.filter( (p) => !p.selected && !p.carteira).reduce( (soma, p) => soma + p.valor, 0.0), 0.0).toFixed(2).replace('.', ',') + \"',\" + '\\n' +\n    \"           '',\" + '\\n' +\n    \"           '\" + tarefa_atual.documento + \"',\" + '\\n' +\n    \"           '\" + tarefa_atual.atribuir + \"',\" + '\\n' +\n    \"           '\" + tarefa_atual.form + \"',\" + '\\n' +\n    \"           NULL,\" + '\\n' +\n    \"           NULL,\" + '\\n' +\n    \"           GETDATE(),\" + '\\n' +\n    \"           NULL)\" + '\\n' + '\\n' +\n    \n    \"       SET @NOVA_NAV = NEXT VALUE FOR tarefa_nav_seq\" + '\\n' + '\\n' +\n    \n    \"       INSERT TAREFA_NAV (transacao, tarefa_origem, tarefa_destino) VALUES (NEXT VALUE FOR tarefa_nav_seq, @TAREFA_ATUAL, @PROX_TAREFA)\" + '\\n' + '\\n' +\n\n    \"       INSERT INTO @tarefas SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/nova/' + LTRIM(RTRIM(atribuir)) AS topico FROM tarefas WHERE id = @PROX_TAREFA\" + '\\n' + '\\n' +\n\n    \"   END\" + '\\n' +\n    \"   ELSE\" + '\\n' +\n    \"   BEGIN\" + '\\n' + '\\n' +\n    \n    \"       UPDATE tarefas SET\" + '\\n' +\n    \"           descricao = 'Saldo R$ \" + msg.payload.documento.cobranca.reduce( (total, c) => total + c.parcelas.filter( (p) => !p.selected && !p.carteira).reduce( (soma, p) => soma + p.valor, 0.0), 0.0).toFixed(2).replace('.', ',') + \"',\" + '\\n' +\n    \"           documento = '\" + tarefa_atual.documento + \"'\" + '\\n' +\n    \"       WHERE\" + '\\n' +\n    \"          id = @PROX_TAREFA\" + '\\n' +\n    \"          AND versao = @PROX_TAREFA_VERSAO\" +  '\\n' + '\\n' +\n\n    \"       IF @@ROWCOUNT != 1\" + '\\n' +\n    \"       BEGIN\" + '\\n' +\n\n    \"           ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"           SELECT TOP 1 @ULTIMA_VERSAO = versao, @CONCLUIDO = concluido FROM tarefas WHERE id = @TAREFA_ATUAL\" + '\\n' + '\\n' +\n    \n    \"           IF (NOT @CONCLUIDO IS NULL)\" + '\\n' +\n    \"           BEGIN\" + '\\n' +\n    \"               INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7010\" + '\\n' +\n    \"               SELECT * FROM ERR WHERE erro = 7010\" + '\\n' +\n    \"           END\" + '\\n' +\n    \"           ELSE IF (@ULTIMA_VERSAO <> @VERSAO)\" + '\\n' +\n    \"           BEGIN\" + '\\n' +\n    \"               INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7450\" + '\\n' +\n    \"               SELECT * FROM ERR WHERE erro = 7450\" + '\\n' + '\\n' +\n    \"           END\" + '\\n' + '\\n' +\n    \n    \"           RETURN\" + '\\n' +\n    \"       END\" + '\\n' + '\\n' +\n    \n    \"       INSERT INTO @tarefas SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/atualizada/' + LTRIM(RTRIM(atribuir)) AS topico FROM tarefas WHERE id = @PROX_TAREFA\" + '\\n' + '\\n' +\n\n    \"   END\" + '\\n' + '\\n'\n\n    :\n    \n    \"   -- tarefa finalizada e nenhuma tarefa nova criada --\" + '\\n'\n    \n    ) + '\\n' +\n\n    (msg.payload.documento.cobranca.find( (c) => c.parcelas.find( (p) => p.selected && !p.carteira) ) ?\n\n    \"   -------------------------- PROXIMA TAREFA - REMESSA -----------------------\" + '\\n' +\n\n    \"       SET @PROX_TAREFA = NEXT VALUE FOR tarefa_seq\" + '\\n' + '\\n' +\n    \n    \"       INSERT INTO tarefas\" + '\\n' +\n    \"           (id,\" + '\\n' +\n    \"           nome,\" + '\\n' +\n    \"           titulo,\" + '\\n' +\n    \"           descricao,\" + '\\n' +\n    \"           detalhes,\" + '\\n' +\n    \"           documento,\" + '\\n' +\n    \"           atribuir,\" + '\\n' +\n    \"           form,\" + '\\n' +\n    \"           parametros,\" + '\\n' +\n    \"           prazo,\" + '\\n' +\n    \"           criado,\" + '\\n' +\n    \"           concluido)\" + '\\n' +\n    \"       VALUES\" + '\\n' +\n    \"           (@PROX_TAREFA,\" + '\\n' +\n    \"           '\" + tarefa_remessa.nome + \"',\" + '\\n' +\n    \"           '\" + tarefa_remessa.titulo + \"',\" + '\\n' +\n    \"           '\" + tarefa_remessa.descricao + \"',\" + '\\n' +\n    \"           '',\" + '\\n' +\n    \"           '\" + tarefa_remessa.documento + \"',\" + '\\n' +\n    \"           '\" + tarefa_remessa.atribuir + \"',\" + '\\n' +\n    \"           '\" + tarefa_remessa.form + \"',\" + '\\n' +\n    \"           NULL,\" + '\\n' +\n    \"           NULL,\" + '\\n' +\n    \"           GETDATE(),\" + '\\n' +\n    \"           NULL)\" + '\\n' + '\\n' +\n    \n    \"       SET @NOVA_NAV = NEXT VALUE FOR tarefa_nav_seq\" + '\\n' + '\\n' +\n    \n    \"       INSERT TAREFA_NAV (transacao, tarefa_origem, tarefa_destino) VALUES (NEXT VALUE FOR tarefa_nav_seq, @TAREFA_ATUAL, @PROX_TAREFA)\" + '\\n' + '\\n' +\n\n    \"       INSERT INTO @tarefas SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/nova/' + LTRIM(RTRIM(atribuir)) AS topico FROM tarefas WHERE id = @PROX_TAREFA\" + '\\n' + '\\n'\n\n    :\n    \n    \"-- tarefa finalizada e nenhuma tarefa nova criada --\" + '\\n'\n    \n    ) + '\\n' +\n\n    \"   COMMIT TRANSACTION\" + '\\n' + '\\n' +\n\n    \"END TRY\" + '\\n' +\n    \"BEGIN CATCH\" + '\\n' + '\\n' +\n    \n    \"   DECLARE @ERR_ID INT\" + '\\n' +\n    \"   DECLARE @ERROR_NUMBER INT\" + '\\n' +\n    \"   DECLARE @ERROR_SEVERITY INT\" + '\\n' +\n    \"   DECLARE @ERROR_STATE INT\" + '\\n' +\n    \"   DECLARE @ERROR_PROCEDURE INT\" + '\\n' +\n    \"   DECLARE @ERROR_LINE INT\" + '\\n' +\n    \"   DECLARE @ERROR_MESSAGE INT\" + '\\n' + '\\n' +\n    \n    \"   SET @ERROR_NUMBER = ERROR_NUMBER()\" + '\\n' + '\\n' +\n    \"   SET @ERROR_SEVERITY = ERROR_SEVERITY()\" + '\\n' + '\\n' +\n    \"   SET @ERROR_STATE = ERROR_STATE()\" + '\\n' + '\\n' +\n    \"   SET @ERROR_PROCEDURE = ERROR_PROCEDURE()\" + '\\n' + '\\n' +\n    \"   SET @ERROR_LINE = ERROR_LINE()\" + '\\n' + '\\n' +\n    \"   SET @ERROR_MESSAGE = ERROR_MESSAGE()\" + '\\n' + '\\n' +\n    \n    \"   IF @@TRANCOUNT > 0\" + '\\n' +\n    \"       ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"   SET @ERR_ID = NEXT VALUE FOR err_log_seq\" + '\\n' + '\\n' +\n    \"   INSERT INTO err_log SELECT @ERR_ID AS id, @ERROR_NUMBER AS erro, @ERROR_SEVERITY AS nivel, @ERROR_STATE AS situacao, @ERROR_PROCEDURE AS procedimento, @ERROR_LINE AS linha, @ERROR_MESSAGE AS mensagem\" + '\\n' + '\\n' +\n    \n    \"   SELECT * FROM err_log WHERE id = @ERR_ID\" + '\\n' + '\\n' +\n    \n    \"   RETURN\" + '\\n' +\n    \"END CATCH\" + '\\n' + '\\n' +\n\n    \"SELECT * FROM @tarefas\" + '\\n'\n    \n\nreturn msg;","outputs":"1","noerr":0,"x":328.1999969482422,"y":928,"wires":[["3049e60c.ffcada"]]},{"id":"3049e60c.ffcada","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"MSSQL","query":"","outField":"payload","x":558.1999969482422,"y":928,"wires":[["e892296c.3b10a8"]]},{"id":"f92a5e59.89d9","type":"function","z":"e6097cee.8df04","name":"","func":"msg.payload = [ { \"id\": 1339, \"nome\": \"Lançamentos a Receber\", \"titulo\": \"Pedido 74782\", \"descricao\": \"CERAMICA VELAS DE IGNICAO NGK BRASIL LTDA\", \"atribuir\": \"faturamento\", \"form\": \"/recebiveis/lancamento/\", \"parametros\": null, \"prazo\": null, \"criado\": \"2016-12-09T09:38:59.156Z\", \"concluido\": \"2016-12-09T09:39:21.036Z\" }, { \"id\": 1340, \"nome\": \"Cobrança Bancária\", \"titulo\": \"Gerar Remessa de Cobrança\", \"descricao\": \"\", \"atribuir\": \"financeiro\", \"form\": \"/recebiveis/cobranca/\", \"parametros\": null, \"prazo\": null, \"criado\": \"2016-12-09T09:39:21.036Z\", \"concluido\": null } ]\nif (Array.isArray(msg.payload) && msg.payload.length > 0 && msg.payload[0].erro === undefined) {\n    \n    var payload = msg.payload;\n    msg.payload = {erro: 0, mensagem: 'Tarefa concluida com sucesso !'};\n    \n    var msgs = []\n    \n    msgs.push(msg);\n    \n    msgs.push({\n        topic: '/tarefas/concluida/' + payload[0].atribuir,\n        payload: payload[0]\n    });\n\n    if (msg.payload.length > 1) {\n        msgs.push({\n            topic: '/tarefas/nova/' + payload[1].atribuir,\n            payload: payload[1]\n        })\n    }\n    \n    return msgs;\n    \n} else {\n    msg.statusCode = 500;\n    msg.payload = msg.payload[0];\n    return [msg, null, null]\n}\n","outputs":"3","noerr":0,"x":348.1999969482422,"y":1588,"wires":[["12ffa12a.d2b4ef"],["c4d90ad4.a46138"],["71bcdd52.fae754"]]},{"id":"12ffa12a.d2b4ef","type":"debug","z":"e6097cee.8df04","name":"","active":true,"console":"false","complete":"payload","x":548.1999969482422,"y":1548,"wires":[]},{"id":"3521db3b.7c6af4","type":"inject","z":"e6097cee.8df04","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":138.1999969482422,"y":1588,"wires":[["f92a5e59.89d9"]]},{"id":"c4d90ad4.a46138","type":"debug","z":"e6097cee.8df04","name":"","active":true,"console":"false","complete":"payload","x":548.1999969482422,"y":1588,"wires":[]},{"id":"71bcdd52.fae754","type":"debug","z":"e6097cee.8df04","name":"","active":true,"console":"false","complete":"payload","x":548.1999969482422,"y":1628,"wires":[]},{"id":"6dd72b80.afa164","type":"function","z":"e6097cee.8df04","name":"tarefa","func":"msg.topic = msg.payload.topico;\n\nreturn msg;","outputs":1,"noerr":0,"x":1068.1999969482422,"y":948,"wires":[["a5468418.45de68","50b0fc9d.1644e4"]]},{"id":"4b48949a.26bc8c","type":"split","z":"e6097cee.8df04","name":"","splt":"\\n","x":908.1999969482422,"y":948,"wires":[["6dd72b80.afa164"]]},{"id":"2c822aa2.f03816","type":"function","z":"e6097cee.8df04","name":"erro","func":"msg.statusCode = 500;\n\nif (Array.isArray(msg.payload) && msg.payload.length > 0) {\n    msg.payload = msg.payload[0];    \n} else {\n    msg.payload = {erro: 9999, mensagem: 'Ocorreu um erro ao executar a sua solicitação.'}\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":908.1999969482422,"y":988,"wires":[["2bf38691.7a6d0a","30782cc8.018584"]]},{"id":"2bf38691.7a6d0a","type":"http response","z":"e6097cee.8df04","name":"","x":1068.1999969482422,"y":988,"wires":[]},{"id":"50b0fc9d.1644e4","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"payload","x":1248.1999969482422,"y":1008,"wires":[]},{"id":"1edaca0d.215866","type":"function","z":"e6097cee.8df04","name":"","func":"msg.payload = {\n  \"id\": 1307,\n  \"nome\": \"Lançamentos a Receber\",\n  \"titulo\": \"Pedido 74749\",\n  \"concluido\": null,\n  \"versao\": {\n    \"type\": \"Buffer\",\n    \"data\": [\n      0,\n      0,\n      0,\n      0,\n      0,\n      0,\n      8,\n      10\n    ]\n  }\n}\nvar str = String.fromCharCode.apply(null, msg.payload.versao.data);\n    \nmsg.payload.buffer = str;\n\nreturn msg;\n","outputs":"1","noerr":0,"x":968.1999969482422,"y":1588,"wires":[["bb25d62f.e45108"]]},{"id":"efa6ab42.4a3808","type":"inject","z":"e6097cee.8df04","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":778.1999969482422,"y":1588,"wires":[["1edaca0d.215866"]]},{"id":"bb25d62f.e45108","type":"debug","z":"e6097cee.8df04","name":"","active":true,"console":"false","complete":"payload","x":1188.1999969482422,"y":1588,"wires":[]},{"id":"30782cc8.018584","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"payload","x":1088.1999969482422,"y":1048,"wires":[]},{"id":"1e391bab.98fb04","type":"debug","z":"e6097cee.8df04","name":"","active":false,"console":"false","complete":"payload","x":928.1999969482422,"y":868,"wires":[]},{"id":"19397e36.bcd682","type":"http response","z":"e6097cee.8df04","name":"","x":628.1999969482422,"y":1388,"wires":[]},{"id":"71613ab.6513ec4","type":"catch","z":"e6097cee.8df04","name":"","scope":null,"x":238.1999969482422,"y":1408,"wires":[["a0858e9b.b8c67","75cfc99.c2b5838"]]},{"id":"a0858e9b.b8c67","type":"debug","z":"e6097cee.8df04","name":"","active":true,"console":"false","complete":"payload.documento.cobranca","x":538.1999969482422,"y":1428,"wires":[]},{"id":"75cfc99.c2b5838","type":"function","z":"e6097cee.8df04","name":"erro","func":"msg.statusCode = 500;\n\nreturn msg;","outputs":1,"noerr":0,"x":448.1999969482422,"y":1388,"wires":[["19397e36.bcd682"]]},{"id":"1e19ce6b.921cc2","type":"delay","z":"e6097cee.8df04","name":"delay","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":548.1999969482422,"y":268,"wires":[["34f94e3.27ae9b2"]]},{"id":"58f67d79.7e52e4","type":"mqtt out","z":"e6097cee.8df04","name":"","topic":"","qos":"","retain":"","broker":"42731854.d5b6a8","x":2788.199996948242,"y":828,"wires":[]},{"id":"e6e56919.4ebee8","type":"function","z":"e6097cee.8df04","name":"NOTIFY","func":"msg.payload = msg.payload[0]\nmsg.topic = '/tarefas/nova/' + msg.payload.atribuir\nreturn msg;","outputs":1,"noerr":0,"x":2598.199996948242,"y":828,"wires":[["58f67d79.7e52e4","62f569f1.70f7b8"]]},{"id":"97dbf964.84f7a8","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":2418.199996948242,"y":828,"wires":[["e6e56919.4ebee8"]]},{"id":"2b66beed.b079f2","type":"function","z":"e6097cee.8df04","name":"TAREFA","func":"\nmsg.payload = \n\"DECLARE @ID INT \"+\n\"SET @ID = NEXT VALUE FOR tarefa_seq \" +\n\"INSERT INTO tarefas \" +\n\"   (id, \" +\n\"   nome, \" +\n\"   titulo, \" +\n\"   descricao, \" +\n\"   documento, \" +\n\"   atribuir, \" +\n\"   form, \" +\n\"   parametros, \" +\n\"   prazo, \" +\n\"   criado, \" +\n\"   concluido) \" +\n\"VALUES \" +\n\"   (@ID, \" +\n\"   '\" + msg.payload.nome + \"', \" +\n\"   '\" + msg.payload.titulo + \"', \" +\n\"   '\" + msg.payload.descricao + \"', \" +\n\"   '\" + msg.payload.documento + \"', \" + \n\"   '\" + msg.payload.atribuir + \"', \" +\n\"   '\" + msg.payload.form + \"', \" +\n\"   NULL, \" +\n\"   NULL, \" +\n\"   GETDATE(), \" +\n\"   NULL);\" +\n\n\"SELECT \" +\n\"   id, \" +\n\"   nome, \" +\n\"   titulo, \" +\n\"   descricao, \" +\n//\"   conteudo, \" +\n\"   atribuir, \" +\n\"   form, \" +\n\"   parametros, \" +\n\"   prazo, \" +\n\"   criado, \" +\n\"   concluido \" +\n\"FROM tarefas \" + \n\"WHERE id = @ID;\"\n\nreturn msg;","outputs":1,"noerr":0,"x":2238.199996948242,"y":828,"wires":[["97dbf964.84f7a8"]]},{"id":"8a131ff5.e6106","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"fe2eccea.fe5bf","name":"","query":"","outField":"payload","x":2038.1999969482422,"y":708,"wires":[["ce10e5dc.3d2858"]]},{"id":"c0911cbd.14c4a","type":"function","z":"e6097cee.8df04","name":"PARCELAS","func":"msg.local.representante = msg.payload[0];\nmsg.payload = \n\"SELECT \" +\n//\"   LPV.LPPED AS nosso_numero, \" +\n\"   DATEADD(d, CACPG1.CCPg1Dia, CASE WHEN CACPG1.CCPg1DiaTip = 'DDP' THEN CAST(LPV.LPENT AS DATE) ELSE CAST(LPV.Lp0SaiRed AS DATE) END) AS vencto, \" +\n\"   'VENDA' AS origem, \" +\n\"   'COBRANCA' AS forma_pagto, \" +\n\"   CACPG1.CCPg1DiaTip AS tipo_vencto, \" +\n\"   CACPG1.CCPg1Seq AS parcela, \" +\n\"   CACPG1.CCPg1Dia AS prazo, \" +\n//\"   CACPG1.CCPg1Por AS porcentagem, \" +\n//\"   CACPG1.CCPg1Cod AS descricao, \" +\n\"   CAST(LPV1.total * (CACPG1.CCPg1Por / 100) AS money) AS valor \" +\n\"FROM \" +\n\"   GPIMAC_Altamira.dbo.LPV AS LPV INNER JOIN GPIMAC_Altamira.dbo.CACPG1 ON LPV.LPPAG = GPIMAC_Altamira.dbo.CACPG1.CPCOD \" +\n\"   LEFT OUTER JOIN \" +\n\"   (SELECT \" +\n\"       LPPED,  \" +\n\"       CAST(SUM(LPQUA * LPPRE) AS MONEY) AS total_produtos, \" +\n\"       CAST(SUM((LPQUA * LPPRE) * (LPIPI / 100)) AS MONEY) AS total_ipi, \" +\n\"       CAST(SUM(LPQUA * LPPRE + (LPQUA * LPPRE) * (LPIPI / 100)) AS MONEY) AS total \" +\n\"   FROM \" +\n\"       GPIMAC_Altamira.dbo.LPV1 AS LPV1_1 \" +\n\"   GROUP BY \" +\n\"       LPPED) AS LPV1 ON LPV.LPPED = LPV1.LPPED \" +\n\"WHERE \" +\n\"   LPV.LPPED = \" + msg.local.numero + \" \" +\n\"ORDER BY CACPG1.CCPg1Seq\"\n\nreturn msg;","outputs":1,"noerr":0,"x":2048.199996948242,"y":648,"wires":[["8a131ff5.e6106"]]},{"id":"89fe945b.18abd8","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"fe2eccea.fe5bf","name":"","query":"","outField":"payload","x":2038.1999969482422,"y":168,"wires":[["61f65f9e.dd115"]]},{"id":"9761c85e.17c2f8","type":"function","z":"e6097cee.8df04","name":"PEDIDO","func":"msg.params = msg.payload;\nmsg.payload = \n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = \" + (msg.params || 'NULL') + \" \" +\n\"SELECT \" +\n\"\tLTRIM(RTRIM(LPV.LPEMP))     AS empresa, \" +\n\"\tCAST(LPV.LPPED AS INT)      AS numero, \" +\n\"   LPV.LPENT                   AS emissao, \" +\n\"\tLPV.Lp0SaiRed               AS entrega, \" +\n\"   LTRIM(RTRIM(LPV.CCCGC))\t    AS cliente, \" +\n\"\tLPV.LPPAG\t                AS condicao, \" + \n\"\tLPV.LPVEN\t\t\t\t    AS representante, \" + \n\"\tLPV.LpCom / 100\t\t\t\tAS comissao \" +\n\"FROM \" +\n\"\tGPIMAC_Altamira.dbo.LPV WITH (NOLOCK) \" +\n\"   LEFT OUTER JOIN \" +\n\"   (SELECT \" +\n\"    \tLPPED, \" + \n\"\t\tCAST(SUM(LPQUA * LPPRE) AS MONEY) AS valor_produtos,  \" +\n\"\t\tCAST(SUM((LPQUA * LPPRE) * (LPIPI / 100)) AS MONEY) AS valor_ipi,  \" +\n\"\t\tCAST(SUM(LPQUA * LPPRE + (LPQUA * LPPRE) * (LPIPI / 100)) AS MONEY) AS valor_pedido \" +\n\"\tFROM \" +\n\"\t\tGPIMAC_Altamira.dbo.LPV1 AS LPV1_1 \" +\n\"\tGROUP BY \" +\n\"\t\tLPPED) AS LPV1 ON LPV.LPPED = LPV1.LPPED \" +\n\"WHERE \" +\n\"   LPV.LPPED = @PEDIDO\"\n\nreturn msg;","outputs":1,"noerr":0,"x":2038.1999969482422,"y":108,"wires":[["89fe945b.18abd8"]]},{"id":"49e6f36a.b7d64c","type":"function","z":"e6097cee.8df04","name":"CLIENTE","func":"msg.local.totais = msg.payload[0];\nmsg.payload = \n\"DECLARE @CLIENTE NVARCHAR(20) \" +\n\"SET @CLIENTE = \" + (\"'\" + msg.local.cliente + \"'\" || 'NULL') + \" \" +\n\"SELECT \" +\n\"\tLTRIM(RTRIM(CACLI.CCCGC))                               AS cnpj, \" +\n\"   LTRIM(RTRIM(CACLI.CCINS))                               AS inscricao, \" +\n\"\tREPLACE(LTRIM(RTRIM(CACLI.CCFAN)), '''', '')            AS fantasia, \" +\n\"\tREPLACE(LTRIM(RTRIM(CACLI.CCNOM)), '''', '')            AS nome, \" +\n\"   REPLACE(LTRIM(RTRIM(CACLI.CCLogTip0CodC)), '''', '')    AS logradouro, \" +\n\"   REPLACE(LTRIM(RTRIM(CACLI.CCCEN)), '''', '')            AS endereco, \" +\n\"   LTRIM(RTRIM(CACLI.CCCENNum))                            AS numero, \" +\n\"   REPLACE(LTRIM(RTRIM(CACLI.CCCENCpl)), '''', '')         AS complemento, \" +\n\"   LTRIM(RTRIM(CACLI.CCCBA))                               AS bairro, \" +\n\"   CACLI.CCCCIIBGECOD                                      AS municipio, \" +\n\"   LTRIM(RTRIM(CACLI.CCCCI))                               AS cidade, \" +\n\"   LTRIM(RTRIM(CACLI.CCCcEP))                              AS CEP, \" +\n\"   LTRIM(RTRIM(CACLI.CCCES))                               AS UF, \" +\n\"   LTRIM(RTRIM(CACLI.CCDD5))                               AS ddd, \" +\n\"   LTRIM(RTRIM(CACLI.CCtFO3))                              AS telefone, \" +\n\"   REPLACE(LTRIM(RTRIM(CACLI.CCCO1)), '''', '')            AS contato, \" +\n\"   LTRIM(RTRIM(CACLI.CCCL))                                AS conta_contabil \" +\n\"FROM \" +\n\"   GPIMAC_Altamira.dbo.CACLI WITH (NOLOCK) \" +\n\"WHERE \" +\n\"   CACLI.CCCGC = @CLIENTE;\"\n\nreturn msg;","outputs":1,"noerr":0,"x":2038.1999969482422,"y":408,"wires":[["9b74a66.d54a558"]]},{"id":"9b74a66.d54a558","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"fe2eccea.fe5bf","name":"","query":"","outField":"payload","x":2038.1999969482422,"y":468,"wires":[["398deb30.97a754"]]},{"id":"398deb30.97a754","type":"function","z":"e6097cee.8df04","name":"REPRESENTANTE","func":"msg.local.cliente = msg.payload[0];\nmsg.payload = \n\"DECLARE @REPRESENTANTE NVARCHAR(20) \" +\n\"SET @REPRESENTANTE = \" + (\"'\" + msg.local.representante + \"'\" || 'NULL') + \" \" +\n\"SELECT \" +\n\"   LTRIM(RTRIM(CAREP.CVCOD)) AS codigo, \" +\n\"   LTRIM(RTRIM(CAREP.CVNOM)) AS nome \" +\n\"FROM \" +\n\"   GPIMAC_Altamira.dbo.CAREP WITH (NOLOCK) \" +\n\"WHERE \" +\n\"   CAREP.CVCOD = @REPRESENTANTE\"\n\nreturn msg;","outputs":1,"noerr":0,"x":2068.199996948242,"y":528,"wires":[["956b9147.533d5"]]},{"id":"956b9147.533d5","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"fe2eccea.fe5bf","name":"","query":"","outField":"payload","x":2038.1999969482422,"y":588,"wires":[["c0911cbd.14c4a"]]},{"id":"832bc029.e50e3","type":"function","z":"e6097cee.8df04","name":"TOTAIS","func":"msg.local = msg.payload;\nmsg.payload = \n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = \" + (msg.local.numero || 'NULL') + \" \" +\n\"SELECT \" +\n\"\tLPV1.produtos, \" + \n\"\tLPV1.ipi, \" +\n\"\tLPV1.total \" +\n\"FROM \" +\n\"\tGPIMAC_Altamira.dbo.LPV WITH (NOLOCK) \" +\n\"   LEFT OUTER JOIN \" +\n\"   (SELECT \" +\n\"    \tLPPED, \" + \n\"\t\tCAST(SUM(LPQUA * LPPRE) AS MONEY) AS produtos,  \" +\n\"\t\tCAST(SUM((LPQUA * LPPRE) * (LPIPI / 100)) AS MONEY) AS ipi,  \" +\n\"\t\tCAST(SUM(LPQUA * LPPRE + (LPQUA * LPPRE) * (LPIPI / 100)) AS MONEY) AS total \" +\n\"\tFROM \" +\n\"\t\tGPIMAC_Altamira.dbo.LPV1 AS LPV1_1 \" +\n\"\tGROUP BY \" +\n\"\t\tLPPED) AS LPV1 ON LPV.LPPED = LPV1.LPPED \" +\n\"WHERE \" +\n\"   LPV.LPPED = @PEDIDO\"\n\nreturn msg;\n","outputs":1,"noerr":0,"x":2038.1999969482422,"y":288,"wires":[["be50e45d.c484b8"]]},{"id":"be50e45d.c484b8","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"fe2eccea.fe5bf","name":"","query":"","outField":"payload","x":2038.1999969482422,"y":348,"wires":[["49e6f36a.b7d64c"]]},{"id":"ce10e5dc.3d2858","type":"function","z":"e6097cee.8df04","name":"RETURN","func":"msg.local.parcelas = msg.payload;\n\nmsg.payload = msg.local;\n\n//delete msg.local;\n\nreturn msg;","outputs":1,"noerr":0,"x":2038.1999969482422,"y":768,"wires":[["f035aac4.2704b8"]]},{"id":"61f65f9e.dd115","type":"function","z":"e6097cee.8df04","name":"EXISTE ?","func":"if (!Array.isArray(msg.payload) || msg.payload.length === 0) {\n    msg.payload = 'PEDIDO NÃO ENCONTRADO: ' + msg.params;\n    return [msg, null]; // NAO EXISTE\n} else {\n    msg.payload = msg.payload[0];\n    return [null, msg]; // ENCONTRADO\n} ","outputs":"2","noerr":0,"x":2038.1999969482422,"y":228,"wires":[["9612bbd0.31ed38"],["832bc029.e50e3"]]},{"id":"f7750533.6c5d78","type":"http in","z":"e6097cee.8df04","name":"remessa","url":"/api/financeiro/recebiveis/remessa/tarefa/:tarefa","method":"post","swaggerDoc":"","x":98.19999694824219,"y":988,"wires":[["b096b3e7.a2a35"]]},{"id":"b096b3e7.a2a35","type":"function","z":"e6097cee.8df04","name":"SQL","func":"var tarefa_retorno = \n{\n    nome: 'Retorno de Cobrança',\n    titulo: msg.payload.documento.carteira.nome,\n    descricao: 'Total R$ ' + msg.payload.documento.remessa.reduce( (total, c) => total + c.parcelas.reduce( (soma, p) => soma + p.valor, 0), 0).toFixed(2).replace('.', ','), \n    documento: JSON.stringify({ \n        \n        carteira: msg.payload.documento.carteira,\n        data: new Date().toISOString(),\n        \n        retorno: msg.payload.documento.remessa.map( c => {\n            var cobranca = {\n                nosso_numero: c.nosso_numero,\n                pedido: c.pedido,\n                cliente: c.cliente,\n                parcelas: c.parcelas.map( (p) => {\n                \n                    var parcela = {\n                        vencto: p.vencto,\n                        origem: p.origem,\n                        forma_pagto: p.forma_pagto,\n                        tipo_vencto: p.tipo_vencto,\n                        parcela: p.parcela,\n                        prazo: p.prazo,\n                        valor: p.valor\n                    }\n                    \n                    parcela.carteira = p.carteira;\n                    parcela.data = p.data;\n\n                    return parcela;\n                    \n                })\n            };\n            \n            return cobranca;\n        })\n        \n    }),\n    atribuir: 'cobranca',\n    form: '/recebiveis/retorno/'\n}\n\nmsg.payload = \n    \"SET NOCOUNT ON\" + '\\n' + '\\n' +\n    \n    \"DECLARE @REMESSA INT\" + '\\n' +\n    \"DECLARE @NOSSO_NUMERO INT\" + '\\n' +\n    \"DECLARE @PARCELA INT\" + '\\n' +\n    \"DECLARE @CARTEIRA INT\" + '\\n' + '\\n' +\n\n    \"DECLARE @VALOR_TITULOS MONEY\" + '\\n' +\n    \"DECLARE @VALOR_LIQUIDO MONEY\" + '\\n' +\n    \"DECLARE @VALOR_OPERACAO MONEY\" + '\\n' +\n    \"DECLARE @VALOR_TARIFA MONEY\" + '\\n' +\n    \"DECLARE @VALOR_JUROS MONEY\" + '\\n' +\n    \"DECLARE @VALOR_IOF MONEY\" + '\\n' +\n    \"DECLARE @TAXA_JUROS DECIMAL(18,2)\" + '\\n' + '\\n' +\n\n    \"DECLARE @FORMA_PAGTO VARCHAR(10)\" + '\\n' +\n    \"DECLARE @TIPO_VENCTO VARCHAR(3)\" + '\\n' +\n    \"DECLARE @VENCTO DATE\" + '\\n' +\n    \"DECLARE @PRAZO INT\" + '\\n' +\n    \"DECLARE @VALOR MONEY\" + '\\n' +\n\n    \"DECLARE @TAREFA_ATUAL INT\" + '\\n' +\n    \"DECLARE @VERSAO INT\" + '\\n' + '\\n' +\n\n    \"DECLARE @NOVA_TAREFA INT\" + '\\n' +\n\n    \"DECLARE @ULTIMA_VERSAO INT\" + '\\n' +\n    \"DECLARE @CONCLUIDO DATETIME\" + '\\n' + '\\n' +\n\n    \"DECLARE @PROX_TAREFA INT\" + '\\n' +\n    \"DECLARE @PROX_TAREFA_VERSAO INT\" + '\\n' + '\\n' +\n\n    \"DECLARE @NOVA_NAV INT\" + '\\n' + '\\n' +\n    \n    \"DECLARE @tarefas TABLE (\" + '\\n' +\n\t\"\t[id] [int] NOT NULL,\" + '\\n' +\n\t\"\t[nome] [nvarchar](100) NOT NULL,\" + '\\n' +\n\t\"\t[titulo] [nvarchar](50) NULL,\" + '\\n' +\n\t\"\t[descricao] [nvarchar](50) NULL,\" + '\\n' +\n\t\"\t[atribuir] [nvarchar](50) NULL,\" + '\\n' +\n\t\"\t[form] [nvarchar](100) NOT NULL,\" + '\\n' +\n\t\"\t[parametros] [nvarchar](max) NULL,\" + '\\n' +\n\t\"\t[prazo] [datetime] NULL,\" + '\\n' +\n\t\"\t[criado] [datetime] NOT NULL,\" + '\\n' +\n\t\"\t[concluido] [datetime] NULL,\" + '\\n' +\n\t\"\t[versao] [int],\" + '\\n' +\n\t\"\t[topico] [nvarchar](100) NOT NULL)\" + '\\n' + '\\n' +\n\t\t\n    \"BEGIN TRY\" + '\\n' +\n    \"   BEGIN TRANSACTION\" + '\\n' + '\\n' +\n\n    \"   -------------------------------------- ATUALIZACAO DAS TAREFAS ----------------------------------------------\" + '\\n' +\n    \"   SET @TAREFA_ATUAL = \" + (parseInt(msg.req.params.tarefa) || 'NULL') + \"\" + '\\n' +\n    \"   SET @VERSAO = CAST('\" + (msg.payload.versao || 'NULL') + \"' AS INT)\" + '\\n' + '\\n' +\n\n    \"   UPDATE tarefas SET\" + '\\n' +\n    \"\t    concluido = GETDATE()\" + '\\n' +\n    \"   WHERE\" + '\\n' +\n    \"       id = @TAREFA_ATUAL\" + '\\n' +\n    \"       AND concluido IS NULL\" + '\\n' + '\\n' +\n    \"       AND versao = @VERSAO\" + '\\n' + '\\n' +\n    \n    \"   IF @@ROWCOUNT != 1\" + '\\n' +\n    \"   BEGIN\" + '\\n' +\n    \n    \"       ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"       SELECT TOP 1 @ULTIMA_VERSAO = versao, @CONCLUIDO = concluido FROM tarefas WHERE id = @TAREFA_ATUAL\" + '\\n' + '\\n' +\n    \n    \"       IF (NOT @CONCLUIDO IS NULL)\" + '\\n' +\n    \"       BEGIN\" + '\\n' +\n    \"           INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7010\" + '\\n' +\n    \"           SELECT * FROM ERR WHERE erro = 7010\" + '\\n' +\n    \"       END\" + '\\n' +\n    \"       ELSE IF (@ULTIMA_VERSAO <> @VERSAO)\" + '\\n' +\n    \"       BEGIN\" + '\\n' +\n    \"           INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7450\" + '\\n' +\n    \"           SELECT * FROM ERR WHERE erro = 7450\" + '\\n' + '\\n' +\n    \"       END\" + '\\n' + '\\n' +\n    \n    \"       RETURN\" + '\\n' +\n    \"   END\" + '\\n' + '\\n' +\n\n    \"   INSERT INTO @tarefas SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/concluida/' + LTRIM(RTRIM(atribuir)) AS topico FROM tarefas WHERE id = @TAREFA_ATUAL\" + '\\n' + '\\n' +\n\n    //---------------------------------------------------- cabecalho da remessa ----------------------------------------------------\n    \"   SET @VALOR_TITULOS = CAST(\" +   (\"'\" + msg.payload.documento.bordero.valor_titulos + \"'\"    || \"NULL\") + \" AS MONEY)\" + '\\n' + \n    \"   SET @VALOR_LIQUIDO = CAST(\" +   (\"'\" + msg.payload.documento.bordero.valor_liquido + \"'\"    || \"NULL\") + \" AS MONEY)\" + '\\n' +\n    \"   SET @VALOR_OPERACAO = CAST(\" +  (\"'\" + msg.payload.documento.bordero.valor_operacao + \"'\"   || \"NULL\") + \" AS MONEY)\" + '\\n' +\n    \"   SET @VALOR_TARIFA = CAST(\" +    (\"'\" + msg.payload.documento.bordero.valor_tarifa + \"'\"     || \"NULL\") + \" AS MONEY)\" + '\\n' +\n    \"   SET @VALOR_JUROS = CAST(\" +     (\"'\" + msg.payload.documento.bordero.valor_juros + \"'\"      || \"NULL\") + \" AS MONEY)\" + '\\n' +\n    \"   SET @VALOR_IOF = CAST(\" +       (\"'\" + msg.payload.documento.bordero.valor_iof + \"'\"        || \"NULL\") + \" AS MONEY)\" + '\\n' +\n    \"   SET @TAXA_JUROS = CAST(\" +      (\"'\" + msg.payload.documento.bordero.taxa_juros + \"'\"       || \"NULL\") + \" AS DECIMAL(18,2))\" + '\\n' + '\\n' +\n    \n    \"   SET @REMESSA = NEXT VALUE FOR remessa_seq\" + '\\n' + '\\n' +\n    \n    \"   INSERT INTO REM (\" + '\\n' +\n    \"       remessa,\" + '\\n' +\n    \"       valor_titulos,\" + '\\n' +\n    \"       valor_liquido,\" + '\\n' +\n    \"       valor_operacao,\" + '\\n' +\n    \"       valor_tarifa,\" + '\\n' +\n    \"       valor_iof,\" + '\\n' +\n    \"       valor_juros,\" + '\\n' +\n    \"       taxa_juros)\" + '\\n' +\n    \"   VALUES (\" + '\\n' +\n    \"       @REMESSA,\" + '\\n' +\n    \"       @VALOR_TITULOS,\" + '\\n' +\n    \"       @VALOR_LIQUIDO,\" + '\\n' +\n    \"       @VALOR_OPERACAO,\" + '\\n' +\n    \"       @VALOR_TARIFA,\" + '\\n' +\n    \"       @VALOR_IOF,\" + '\\n' +\n    \"       @VALOR_JUROS,\" + '\\n' +\n    \"       @TAXA_JUROS)\" + '\\n' + '\\n' +\n\n    \"   SET @CARTEIRA = CAST(\" +       (\"'\" + msg.payload.documento.carteira.id + \"'\"        || \"NULL\") + \" AS INT)\" + '\\n' + '\\n' +\n\n    \"   UPDATE CRT SET\" + '\\n' +\n    \"       utilizado = utilizado + @VALOR_TITULOS,\" + '\\n' +\n    \"       remessa = remessa - @VALOR_TITULOS,\" + '\\n' +\n    \"       retorno = retorno + @VALOR_TITULOS\" + '\\n' +\n    \"   WHERE id = @CARTEIRA\" + '\\n' + '\\n' +\n\n    //---------------------------------------------------- grava as parcelas ----------------------------------------------------\n    msg.payload.documento.remessa.reduce( (sql, r) => \n    \n        sql + r.parcelas.reduce( (sql, p) => \n        \n            sql + \n            \"   ----------------------------------------------------------------------------------------------------------\" + '\\n' +\n            \"   -- insere nova parcela => nosso_numero: \" + r.nosso_numero + ', parcela: ' + p.parcela + ', carteira: ' + msg.payload.documento.carteira.id + '\\n' +\n            \"   ----------------------------------------------------------------------------------------------------------\" + '\\n' +\n            \"   SET @NOSSO_NUMERO = CAST(\" +   (\"'\" + r.nosso_numero + \"'\" || \"NULL\") + \" AS INT)\" + '\\n' +\n            \"   SET @PARCELA = CAST(\" +        (\"'\" + p.parcela + \"'\"      || \"NULL\") + \" AS INT)\" + '\\n' +\n            \"   SET @CARTEIRA = CAST(\" +       (\"'\" + msg.payload.documento.carteira.id + \"'\"        || \"NULL\") + \" AS INT)\" + '\\n' + '\\n' +\n        \n            \"   IF EXISTS(SELECT NOSSO_NUMERO FROM REMD WHERE nosso_numero = @NOSSO_NUMERO AND parcela = @PARCELA AND carteira = @CARTEIRA)\" + '\\n' +\n            \"   BEGIN\" + '\\n' + '\\n' +\n            \n            \"       ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n            \n            \"       INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 1123\" + '\\n' +\n            \"       SELECT * FROM ERR WHERE erro = 1123\" + '\\n' + '\\n' +\n            \n            \"       RETURN\" + '\\n' +\n            \"   END\" + '\\n' + '\\n' +\n    \n            \"   SET @NOSSO_NUMERO = CAST(\" +    (\"'\" + r.nosso_numero + \"'\" || \"NULL\") + \" AS INT)\" + '\\n' +\n            \"   SET @PARCELA = CAST(\" +         (\"'\" + p.parcela + \"'\"      || \"NULL\") + \" AS INT)\" + '\\n' +\n            \"   SET @CARTEIRA = CAST(\" +        (\"'\" + msg.payload.documento.carteira.id + \"'\"        || \"NULL\") + \" AS INT)\" + '\\n' + '\\n' +\n\n            \"   SET @FORMA_PAGTO = CAST(\" +     (\"'\" + p.forma_pagto + \"'\"    || \"NULL\") + \" AS VARCHAR(10))\" + '\\n' +\n            \"   SET @TIPO_VENCTO = CAST(\" +     (\"'\" + p.tipo_vencto + \"'\"    || \"NULL\") + \" AS VARCHAR(3))\" + '\\n' +\n            \"   SET @VENCTO = CAST(\" +          (\"'\" + p.vencto + \"'\"         || \"NULL\") + \" AS DATE)\" + '\\n' +\n            \"   SET @PRAZO = CAST(\" +           (\"'\" + p.prazo + \"'\"          || \"NULL\") + \" AS INT)\" + '\\n' +\n            \"   SET @VALOR = CAST(\" +           (\"'\" + p.valor + \"'\"          || \"NULL\") + \" AS MONEY)\" + '\\n' +\n\n            \"   INSERT INTO REMD (remessa, nosso_numero, parcela, carteira, forma_pagto, tipo_vencto, vencto, prazo, valor)\" + '\\n' +\n            \"   VALUES (@REMESSA, @NOSSO_NUMERO, @PARCELA, @CARTEIRA, @FORMA_PAGTO, @TIPO_VENCTO, @VENCTO, @PRAZO, @VALOR)\" + '\\n' + '\\n'\n        \n        , '')\n    \n    , '') +\n\n\n    \"   -------------------------- PROXIMA TAREFA - RETORNO -----------------------\" + '\\n' +\n\n    \"   SET @PROX_TAREFA = NEXT VALUE FOR tarefa_seq\" + '\\n' + '\\n' +\n    \n    \"   INSERT INTO tarefas\" + '\\n' +\n    \"       (id,\" + '\\n' +\n    \"       nome,\" + '\\n' +\n    \"       titulo,\" + '\\n' +\n    \"       descricao,\" + '\\n' +\n    \"       detalhes,\" + '\\n' +\n    \"       documento,\" + '\\n' +\n    \"       atribuir,\" + '\\n' +\n    \"       form,\" + '\\n' +\n    \"       parametros,\" + '\\n' +\n    \"       prazo,\" + '\\n' +\n    \"       criado,\" + '\\n' +\n    \"       concluido)\" + '\\n' +\n    \"   VALUES\" + '\\n' +\n    \"       (@PROX_TAREFA,\" + '\\n' +\n    \"       '\" + tarefa_retorno.nome + \"',\" + '\\n' +\n    \"       '\" + tarefa_retorno.titulo + \"',\" + '\\n' +\n    \"       '\" + tarefa_retorno.descricao + \"',\" + '\\n' +\n    \"       '',\" + '\\n' +\n    \"       '\" + tarefa_retorno.documento + \"',\" + '\\n' +\n    \"       '\" + tarefa_retorno.atribuir + \"',\" + '\\n' +\n    \"       '\" + tarefa_retorno.form + \"',\" + '\\n' +\n    \"       NULL,\" + '\\n' +\n    \"       NULL,\" + '\\n' +\n    \"       GETDATE(),\" + '\\n' +\n    \"       NULL)\" + '\\n' + '\\n' +\n    \n    \"   SET @NOVA_NAV = NEXT VALUE FOR tarefa_nav_seq\" + '\\n' + '\\n' +\n    \n    \"   INSERT TAREFA_NAV (transacao, tarefa_origem, tarefa_destino) VALUES (NEXT VALUE FOR tarefa_nav_seq, @TAREFA_ATUAL, @PROX_TAREFA)\" + '\\n' + '\\n' +\n\n    \"   INSERT INTO @tarefas SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/nova/' + LTRIM(RTRIM(atribuir)) AS topico FROM tarefas WHERE id = @PROX_TAREFA\" + '\\n' + '\\n' +\n\n    \"   COMMIT TRANSACTION\" + '\\n' + '\\n' +\n\n    \"END TRY\" + '\\n' +\n    \"BEGIN CATCH\" + '\\n' + '\\n' +\n    \n    \"   DECLARE @ERR_ID INT\" + '\\n' +\n    \"   DECLARE @ERROR_NUMBER INT\" + '\\n' +\n    \"   DECLARE @ERROR_SEVERITY INT\" + '\\n' +\n    \"   DECLARE @ERROR_STATE INT\" + '\\n' +\n    \"   DECLARE @ERROR_PROCEDURE INT\" + '\\n' +\n    \"   DECLARE @ERROR_LINE INT\" + '\\n' +\n    \"   DECLARE @ERROR_MESSAGE INT\" + '\\n' + '\\n' +\n    \n    \"   SET @ERROR_NUMBER = ERROR_NUMBER()\" + '\\n' + '\\n' +\n    \"   SET @ERROR_SEVERITY = ERROR_SEVERITY()\" + '\\n' + '\\n' +\n    \"   SET @ERROR_STATE = ERROR_STATE()\" + '\\n' + '\\n' +\n    \"   SET @ERROR_PROCEDURE = ERROR_PROCEDURE()\" + '\\n' + '\\n' +\n    \"   SET @ERROR_LINE = ERROR_LINE()\" + '\\n' + '\\n' +\n    \"   SET @ERROR_MESSAGE = ERROR_MESSAGE()\" + '\\n' + '\\n' +\n    \n    \"   IF @@TRANCOUNT > 0\" + '\\n' +\n    \"       ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"   SET @ERR_ID = NEXT VALUE FOR err_log_seq\" + '\\n' + '\\n' +\n    \"   INSERT INTO err_log SELECT @ERR_ID AS id, @ERROR_NUMBER AS erro, @ERROR_SEVERITY AS nivel, @ERROR_STATE AS situacao, @ERROR_PROCEDURE AS procedimento, @ERROR_LINE AS linha, @ERROR_MESSAGE AS mensagem\" + '\\n' + '\\n' +\n    \n    \"   SELECT * FROM err_log WHERE id = @ERR_ID\" + '\\n' + '\\n' +\n    \n    \"   RETURN\" + '\\n' +\n    \"END CATCH\" + '\\n' + '\\n' +\n\n\n    \"SELECT * FROM @tarefas\" + '\\n'\n    \n\nreturn msg;","outputs":"1","noerr":0,"x":328.1999969482422,"y":988,"wires":[["206e8167.befd7e"]]},{"id":"206e8167.befd7e","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"MSSQL","query":"","outField":"payload","x":558.1999969482422,"y":988,"wires":[["e892296c.3b10a8"]]},{"id":"b6f7738.00c899","type":"http in","z":"e6097cee.8df04","name":"retorno","url":"/api/financeiro/recebiveis/retorno/tarefa/:tarefa","method":"post","swaggerDoc":"","x":88.19999694824219,"y":1048,"wires":[["ea69b5f4.ae9a78"]]},{"id":"ea69b5f4.ae9a78","type":"function","z":"e6097cee.8df04","name":"SQL","func":"\nmsg.payload = \n    \"SET NOCOUNT ON\" + '\\n' + '\\n' +\n    \n    \"DECLARE @RETORNO INT\" + '\\n' +\n    \"DECLARE @NOSSO_NUMERO INT\" + '\\n' +\n    \"DECLARE @PARCELA INT\" + '\\n' +\n    \"DECLARE @CARTEIRA INT\" + '\\n' +\n\n    \"DECLARE @DATA AS DATE\" + '\\n' +\n    \"DECLARE @VALOR_TITULOS MONEY\" + '\\n' +\n    \"DECLARE @VALOR_LIQUIDO MONEY\" + '\\n' +\n    \"DECLARE @VALOR_OPERACAO MONEY\" + '\\n' +\n    \"DECLARE @VALOR_TARIFA MONEY\" + '\\n' +\n    \"DECLARE @VALOR_JUROS MONEY\" + '\\n' +\n    \"DECLARE @VALOR_IOF MONEY\" + '\\n' +\n    \"DECLARE @TAXA_JUROS DECIMAL(18,2)\" + '\\n' + '\\n' +\n\n    \"DECLARE @FORMA_PAGTO VARCHAR(10)\" + '\\n' +\n    \"DECLARE @TIPO_VENCTO VARCHAR(3)\" + '\\n' +\n    \"DECLARE @VENCTO DATE\" + '\\n' +\n    \"DECLARE @PRAZO INT\" + '\\n' +\n    \"DECLARE @VALOR MONEY\" + '\\n' +\n    \"DECLARE @ACEITO BIT\" + '\\n' + '\\n' +\n\n    \"DECLARE @TAREFA_ATUAL INT\" + '\\n' +\n    \"DECLARE @VERSAO INT\" + '\\n' + '\\n' +\n\n    \"DECLARE @NOVA_TAREFA INT\" + '\\n' +\n\n    \"DECLARE @ULTIMA_VERSAO INT\" + '\\n' +\n    \"DECLARE @CONCLUIDO DATETIME\" + '\\n' + '\\n' +\n\n    \"DECLARE @PROX_TAREFA INT\" + '\\n' +\n    \"DECLARE @PROX_TAREFA_VERSAO INT\" + '\\n' + '\\n' +\n\n    \"DECLARE @NOVA_NAV INT\" + '\\n' + '\\n' +\n    \n    \"DECLARE @tarefas TABLE (\" + '\\n' +\n\t\"\t[id] [int] NOT NULL,\" + '\\n' +\n\t\"\t[nome] [nvarchar](100) NOT NULL,\" + '\\n' +\n\t\"\t[titulo] [nvarchar](50) NULL,\" + '\\n' +\n\t\"\t[descricao] [nvarchar](50) NULL,\" + '\\n' +\n\t\"\t[atribuir] [nvarchar](50) NULL,\" + '\\n' +\n\t\"\t[form] [nvarchar](100) NOT NULL,\" + '\\n' +\n\t\"\t[parametros] [nvarchar](max) NULL,\" + '\\n' +\n\t\"\t[prazo] [datetime] NULL,\" + '\\n' +\n\t\"\t[criado] [datetime] NOT NULL,\" + '\\n' +\n\t\"\t[concluido] [datetime] NULL,\" + '\\n' +\n\t\"\t[versao] [int],\" + '\\n' +\n\t\"\t[topico] [nvarchar](100) NOT NULL)\" + '\\n' + '\\n' +\n\t\t\n    \"BEGIN TRY\" + '\\n' +\n    \"   BEGIN TRANSACTION\" + '\\n' + '\\n' +\n\n    \"   -------------------------------------- ATUALIZACAO DAS TAREFAS ----------------------------------------------\" + '\\n' +\n    \"   SET @TAREFA_ATUAL = \" + (parseInt(msg.req.params.tarefa) || 'NULL') + \"\" + '\\n' +\n    \"   SET @VERSAO = CAST('\" + (msg.payload.versao || 'NULL') + \"' AS INT)\" + '\\n' + '\\n' +\n\n    \"   UPDATE tarefas SET\" + '\\n' +\n    \"\t    concluido = GETDATE()\" + '\\n' +\n    \"   WHERE\" + '\\n' +\n    \"       id = @TAREFA_ATUAL\" + '\\n' +\n    \"       AND concluido IS NULL\" + '\\n' + '\\n' +\n    \"       AND versao = @VERSAO\" + '\\n' + '\\n' +\n    \n    \"   IF @@ROWCOUNT != 1\" + '\\n' +\n    \"   BEGIN\" + '\\n' +\n    \n    \"       ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"       SELECT TOP 1 @ULTIMA_VERSAO = versao, @CONCLUIDO = concluido FROM tarefas WHERE id = @TAREFA_ATUAL\" + '\\n' + '\\n' +\n    \n    \"       IF (NOT @CONCLUIDO IS NULL)\" + '\\n' +\n    \"       BEGIN\" + '\\n' +\n    \"           INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7010\" + '\\n' +\n    \"           SELECT * FROM ERR WHERE erro = 7010\" + '\\n' +\n    \"       END\" + '\\n' +\n    \"       ELSE IF (@ULTIMA_VERSAO <> @VERSAO)\" + '\\n' +\n    \"       BEGIN\" + '\\n' +\n    \"           INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7450\" + '\\n' +\n    \"           SELECT * FROM ERR WHERE erro = 7450\" + '\\n' + '\\n' +\n    \"       END\" + '\\n' + '\\n' +\n    \n    \"       RETURN\" + '\\n' +\n    \"   END\" + '\\n' + '\\n' +\n\n    \"   INSERT INTO @tarefas SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/concluida/' + LTRIM(RTRIM(atribuir)) AS topico FROM tarefas WHERE id = @TAREFA_ATUAL\" + '\\n' + '\\n' +\n\n    //---------------------------------------------------- cabecalho do retorno ----------------------------------------------------\n    \"   SET @VALOR_TITULOS = CAST(\" +   (\"'\" + msg.payload.documento.bordero.valor_titulos + \"'\"      || \"NULL\") + \" AS MONEY)\" + '\\n' + \n    \"   SET @VALOR_LIQUIDO = CAST(\" +   (\"'\" + msg.payload.documento.bordero.valor_liquido + \"'\"    || \"NULL\") + \" AS MONEY)\" + '\\n' +\n    \"   SET @VALOR_OPERACAO = CAST(\" +  (\"'\" + msg.payload.documento.bordero.valor_operacao + \"'\"   || \"NULL\") + \" AS MONEY)\" + '\\n' +\n    \"   SET @VALOR_TARIFA = CAST(\" +    (\"'\" + msg.payload.documento.bordero.valor_tarifa + \"'\"     || \"NULL\") + \" AS MONEY)\" + '\\n' +\n    \"   SET @VALOR_JUROS = CAST(\" +     (\"'\" + msg.payload.documento.bordero.valor_juros + \"'\"      || \"NULL\") + \" AS MONEY)\" + '\\n' +\n    \"   SET @VALOR_IOF = CAST(\" +       (\"'\" + msg.payload.documento.bordero.valor_iof + \"'\"        || \"NULL\") + \" AS MONEY)\" + '\\n' +\n    \"   SET @TAXA_JUROS = CAST(\" +      (\"'\" + msg.payload.documento.bordero.taxa_juros + \"'\"       || \"NULL\") + \" AS DECIMAL(18,2))\" + '\\n' + '\\n' +\n    \n    \"   SET @RETORNO = NEXT VALUE FOR retorno_seq\" + '\\n' + '\\n' +\n    \n    \"   INSERT INTO RET (\" + '\\n' +\n    \"       retorno,\" + '\\n' +\n    \"       valor_titulos,\" + '\\n' +\n    \"       valor_liquido,\" + '\\n' +\n    \"       valor_operacao,\" + '\\n' +\n    \"       valor_tarifa,\" + '\\n' +\n    \"       valor_iof,\" + '\\n' +\n    \"       valor_juros,\" + '\\n' +\n    \"       taxa_juros)\" + '\\n' +\n    \"   VALUES (\" + '\\n' +\n    \"       @RETORNO,\" + '\\n' +\n    \"       @VALOR_TITULOS,\" + '\\n' +\n    \"       @VALOR_LIQUIDO,\" + '\\n' +\n    \"       @VALOR_OPERACAO,\" + '\\n' +\n    \"       @VALOR_TARIFA,\" + '\\n' +\n    \"       @VALOR_IOF,\" + '\\n' +\n    \"       @VALOR_JUROS,\" + '\\n' +\n    \"       @TAXA_JUROS)\" + '\\n' + '\\n' +\n    \n    \"   SET @CARTEIRA = CAST(\" +       (\"'\" + msg.payload.documento.carteira.id + \"'\"        || \"NULL\") + \" AS INT)\" + '\\n' + '\\n' +\n\n    \"   UPDATE CRT SET\" + '\\n' +\n    \"       utilizado = utilizado - @VALOR_TITULOS,\" + '\\n' +\n    \"       retorno = retorno - @VALOR_TITULOS,\" + '\\n' +\n    \"       total_iof = total_iof + @VALOR_IOF,\" + '\\n' +\n    \"       total_juros = total_juros + @VALOR_JUROS,\" + '\\n' +\n    \"       total_tarifas = total_tarifas + @VALOR_TARIFA + @VALOR_OPERACAO,\" + '\\n' +\n    \"       taxa_juros = @TAXA_JUROS\" + '\\n' +\n    \"   WHERE id = @CARTEIRA\" + '\\n' + '\\n' +\n\n    //---------------------------------------------------- grava as parcelas ----------------------------------------------------\n    msg.payload.documento.retorno.reduce( (sql, r) => \n    \n        sql + r.parcelas.reduce( (sql, p) => \n        \n            sql + \n            \"   ----------------------------------------------------------------------------------------------------------\" + '\\n' +\n            \"   -- insere nova parcela => nosso_numero: \" + r.nosso_numero + ', parcela: ' + p.parcela + ', carteira: ' + msg.payload.documento.carteira.id + '\\n' +\n            \"   ----------------------------------------------------------------------------------------------------------\" + '\\n' +\n            \"   SET @NOSSO_NUMERO = CAST(\" +   (\"'\" + r.nosso_numero + \"'\" || \"NULL\") + \" AS INT)\" + '\\n' +\n            \"   SET @PARCELA = CAST(\" +        (\"'\" + p.parcela + \"'\"      || \"NULL\") + \" AS INT)\" + '\\n' + '\\n' +\n        \n            \"   IF EXISTS(SELECT NOSSO_NUMERO FROM RETD WHERE nosso_numero = @NOSSO_NUMERO AND parcela = @PARCELA AND carteira = @CARTEIRA)\" + '\\n' +\n            \"   BEGIN\" + '\\n' + '\\n' +\n            \n            \"       ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n            \n            \"       INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7010\" + '\\n' +\n            \"       SELECT * FROM ERR WHERE erro = 1123\" + '\\n' + '\\n' +\n            \n            \"       RETURN\" + '\\n' +\n            \"   END\" + '\\n' + '\\n' +\n    \n            \"   SET @NOSSO_NUMERO = CAST(\" +   (\"'\" + r.nosso_numero + \"'\" || \"NULL\") + \" AS INT)\" + '\\n' +\n            \"   SET @PARCELA = CAST(\" +        (\"'\" + p.parcela + \"'\"      || \"NULL\") + \" AS INT)\" + '\\n' +\n            \"   SET @CARTEIRA = CAST(\" +       (\"'\" + msg.payload.documento.carteira.id + \"'\"        || \"NULL\") + \" AS INT)\" + '\\n' + '\\n' +\n\n            \"   SET @FORMA_PAGTO = CAST(\" +    (\"'\" + p.forma_pagto + \"'\"    || \"NULL\") + \" AS VARCHAR(10))\" + '\\n' +\n            \"   SET @TIPO_VENCTO = CAST(\" +    (\"'\" + p.tipo_vencto + \"'\"    || \"NULL\") + \" AS VARCHAR(3))\" + '\\n' +\n            \"   SET @VENCTO = CAST(\" +         (\"'\" + p.vencto + \"'\"         || \"NULL\") + \" AS DATE)\" + '\\n' +\n            \"   SET @PRAZO = CAST(\" +          (\"'\" + p.prazo + \"'\"          || \"NULL\") + \" AS INT)\" + '\\n' +\n            \"   SET @VALOR = CAST(\" +          (\"'\" + p.valor + \"'\"          || \"NULL\") + \" AS MONEY)\" + '\\n' +\n            \"   SET @ACEITO = CAST(\" +       (\"'\" + p.aceito + \"'\"        || \"NULL\") + \" AS BIT)\" + '\\n' + '\\n' +\n            \n            \"   INSERT INTO RETD (retorno, nosso_numero, parcela, carteira, forma_pagto, tipo_vencto, vencto, prazo, valor, aceito)\" + '\\n' +\n            \"   VALUES (@RETORNO, @NOSSO_NUMERO, @PARCELA, @CARTEIRA, @FORMA_PAGTO, @TIPO_VENCTO, @VENCTO, @PRAZO, @VALOR, @ACEITO)\" + '\\n' + '\\n'\n        \n        , '')\n    \n    , '') +\n    \n/*\n    \"   -------------------------- PROXIMA TAREFA - RETORNO -----------------------\" + '\\n' +\n\n    \"   SET @PROX_TAREFA = NEXT VALUE FOR tarefa_seq\" + '\\n' + '\\n' +\n    \n    \"   INSERT INTO tarefas\" + '\\n' +\n    \"       (id,\" + '\\n' +\n    \"       nome,\" + '\\n' +\n    \"       titulo,\" + '\\n' +\n    \"       descricao,\" + '\\n' +\n    \"       detalhes,\" + '\\n' +\n    \"       documento,\" + '\\n' +\n    \"       atribuir,\" + '\\n' +\n    \"       form,\" + '\\n' +\n    \"       parametros,\" + '\\n' +\n    \"       prazo,\" + '\\n' +\n    \"       criado,\" + '\\n' +\n    \"       concluido)\" + '\\n' +\n    \"   VALUES\" + '\\n' +\n    \"       (@PROX_TAREFA,\" + '\\n' +\n    \"       '\" + tarefa_retorno.nome + \"',\" + '\\n' +\n    \"       '\" + tarefa_retorno.titulo + \"',\" + '\\n' +\n    \"       '\" + tarefa_retorno.descricao + \"',\" + '\\n' +\n    \"       '',\" + '\\n' +\n    \"       '\" + tarefa_retorno.documento + \"',\" + '\\n' +\n    \"       '\" + tarefa_retorno.atribuir + \"',\" + '\\n' +\n    \"       '\" + tarefa_retorno.form + \"',\" + '\\n' +\n    \"       NULL,\" + '\\n' +\n    \"       NULL,\" + '\\n' +\n    \"       GETDATE(),\" + '\\n' +\n    \"       NULL)\" + '\\n' + '\\n' +\n    \n    \"   SET @NOVA_NAV = NEXT VALUE FOR tarefa_nav_seq\" + '\\n' + '\\n' +\n    \n    \"   INSERT TAREFA_NAV (transacao, tarefa_origem, tarefa_destino) VALUES (NEXT VALUE FOR tarefa_nav_seq, @TAREFA_ATUAL, @PROX_TAREFA)\" + '\\n' + '\\n' +\n\n    \"   INSERT INTO @tarefas SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/nova/' + LTRIM(RTRIM(atribuir)) AS topico FROM tarefas WHERE id = @PROX_TAREFA\" + '\\n' + '\\n' +\n*/\n    \n    \"   COMMIT TRANSACTION\" + '\\n' + '\\n' +\n\n    \"END TRY\" + '\\n' +\n    \"BEGIN CATCH\" + '\\n' + '\\n' +\n    \n    \"   DECLARE @ERR_ID INT\" + '\\n' +\n    \"   DECLARE @ERROR_NUMBER INT\" + '\\n' +\n    \"   DECLARE @ERROR_SEVERITY INT\" + '\\n' +\n    \"   DECLARE @ERROR_STATE INT\" + '\\n' +\n    \"   DECLARE @ERROR_PROCEDURE INT\" + '\\n' +\n    \"   DECLARE @ERROR_LINE INT\" + '\\n' +\n    \"   DECLARE @ERROR_MESSAGE INT\" + '\\n' + '\\n' +\n    \n    \"   SET @ERROR_NUMBER = ERROR_NUMBER()\" + '\\n' + '\\n' +\n    \"   SET @ERROR_SEVERITY = ERROR_SEVERITY()\" + '\\n' + '\\n' +\n    \"   SET @ERROR_STATE = ERROR_STATE()\" + '\\n' + '\\n' +\n    \"   SET @ERROR_PROCEDURE = ERROR_PROCEDURE()\" + '\\n' + '\\n' +\n    \"   SET @ERROR_LINE = ERROR_LINE()\" + '\\n' + '\\n' +\n    \"   SET @ERROR_MESSAGE = ERROR_MESSAGE()\" + '\\n' + '\\n' +\n    \n    \"   IF @@TRANCOUNT > 0\" + '\\n' +\n    \"       ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"   SET @ERR_ID = NEXT VALUE FOR err_log_seq\" + '\\n' + '\\n' +\n    \"   INSERT INTO err_log SELECT @ERR_ID AS id, @ERROR_NUMBER AS erro, @ERROR_SEVERITY AS nivel, @ERROR_STATE AS situacao, @ERROR_PROCEDURE AS procedimento, @ERROR_LINE AS linha, @ERROR_MESSAGE AS mensagem\" + '\\n' + '\\n' +\n    \n    \"   SELECT * FROM err_log WHERE id = @ERR_ID\" + '\\n' + '\\n' +\n    \n    \"   RETURN\" + '\\n' +\n    \"END CATCH\" + '\\n' + '\\n' +\n\n\n    \"SELECT * FROM @tarefas\" + '\\n'\n    \n\nreturn msg;","outputs":"1","noerr":0,"x":328.1999969482422,"y":1048,"wires":[["5e7cc0f8.b35d1"]]},{"id":"5e7cc0f8.b35d1","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"MSSQL","query":"","outField":"payload","x":558.1999969482422,"y":1048,"wires":[["e892296c.3b10a8"]]},{"id":"9406223d.652f2","type":"http in","z":"e6097cee.8df04","name":"remessa","url":"/api/financeiro/remessa","method":"get","swaggerDoc":"","x":98.19999694824219,"y":448,"wires":[["6ca131c3.7be99"]]},{"id":"337b4805.c064b8","type":"http response","z":"e6097cee.8df04","name":"","x":888.1999969482422,"y":448,"wires":[]},{"id":"7c4ca71a.f2a7f8","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":738.1999969482422,"y":448,"wires":[["337b4805.c064b8"]]},{"id":"6ca131c3.7be99","type":"function","z":"e6097cee.8df04","name":"SQL","func":"\nmsg.payload = \"SELECT * FROM REM WHERE NOT EXISTS (SELECT * FROM REMD INNER JOIN RETD ON REMD.nosso_numero = RETD.nosso_numero AND REMD.parcela = RETD.parcela AND REMD.carteira = RETD.carteira WHERE REMD.remessa = REM.remessa) ORDER BY data DESC\"; \n\nreturn msg;","outputs":1,"noerr":0,"x":328.1999969482422,"y":448,"wires":[["cb8233f0.4703"]]},{"id":"cb8233f0.4703","type":"delay","z":"e6097cee.8df04","name":"delay","pauseType":"delay","timeout":"750","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":548.1999969482422,"y":448,"wires":[["7c4ca71a.f2a7f8"]]},{"id":"b532b85b.985de8","type":"http in","z":"e6097cee.8df04","name":"retorno","url":"/api/financeiro/retorno","method":"get","swaggerDoc":"","x":88.19999694824219,"y":488,"wires":[["9219c1ef.5fdad"]]},{"id":"b02c0965.d26b58","type":"http response","z":"e6097cee.8df04","name":"","x":888.1999969482422,"y":488,"wires":[]},{"id":"39e0327c.debe1e","type":"MSSQL","z":"e6097cee.8df04","mssqlCN":"9919c819.fad628","name":"","query":"","outField":"payload","x":738.1999969482422,"y":488,"wires":[["b02c0965.d26b58"]]},{"id":"9219c1ef.5fdad","type":"function","z":"e6097cee.8df04","name":"SQL","func":"\nmsg.payload = \"SELECT TOP 5 * FROM RET ORDER BY data DESC\"; \n\nreturn msg;","outputs":1,"noerr":0,"x":328.1999969482422,"y":488,"wires":[["c0cb971f.32cfb8"]]},{"id":"c0cb971f.32cfb8","type":"delay","z":"e6097cee.8df04","name":"delay","pauseType":"delay","timeout":"1000","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":548.1999969482422,"y":488,"wires":[["39e0327c.debe1e"]]},{"id":"fe2eccea.fe5bf","type":"MSSQL-CN","z":"","name":"gpimac","server":"127.0.0.1","encyption":true,"database":"GPIMAC_Altamira"},{"id":"9919c819.fad628","type":"MSSQL-CN","z":"","name":"financeiro","server":"localhost","encyption":false,"database":"FINANCEIRO"},{"id":"f5e250ce.bf20e","type":"MSSQL-CN","z":"","name":"BPM","server":"192.168.0.1","encyption":false,"database":"BPM"},{"id":"42731854.d5b6a8","type":"mqtt-broker","z":"","broker":"192.168.0.1","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willPayload":"","birthTopic":"","birthQos":"0","birthPayload":""}]