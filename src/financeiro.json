[{"id":"bd7cc7ec.84f238","type":"http in","z":"8364cdd3.e51ef","name":"busca","url":"/api/financeiro/duplicata/emissao/busca","method":"get","swaggerDoc":"","x":90,"y":500,"wires":[["ea3899e6.a96d98"]]},{"id":"ea3899e6.a96d98","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"msg.payload = \n    \"DECLARE @PEDIDO INT\\n\" +\n    \"DECLARE @CNPJ NVARCHAR(14)\\n\" +\n    \"DECLARE @NOME NVARCHAR(100)\\n\" +\n    \"SET @PEDIDO = \" + (msg.req.query.pedido || 'NULL') + \"\\n\" +\n    \"SET @CNPJ = \" + (\"'\" + msg.req.query.cnpj + \"'\" || 'NULL') + \"\\n\" +\n    \"SET @NOME = \" + (\"'\" + msg.req.query.nome + \"'\" || 'NULL') + \"\\n\" +\n    \"SELECT top 10 \" +\n    \"\tLTRIM(RTRIM(LPV.LPEMP)) AS empresa, \\n\" +\n    \"\tCAST(LPV.LPPED AS INT) AS pedido, \\n\" +\n    \"\tCAST(LPV.LPENT AS DATE) AS emissao, \\n\" +\n    \"\tLPV.Lp0SaiRed AS entrega, \\n\" +\n    \"\tLTRIM(RTRIM(CACLI.CCCGC)) AS cnpj, \\n\" +\n    \"\tLTRIM(RTRIM(CACLI.CCFAN)) AS fantasia, \\n\" +\n    \"\tLTRIM(RTRIM(CACLI.CCNOM)) AS nome \\n\" +\n    \"FROM \\n\" +\n    \"\tGPIMAC_Altamira.dbo.LPV AS LPV INNER JOIN \\n\" +\n    \"   GPIMAC_Altamira.dbo.CACLI ON LPV.CCCGC = GPIMAC_Altamira.dbo.CACLI.CCCGC \\n\" +\n    \"WHERE \\n\" +\n    \"   (@PEDIDO IS NULL OR LPV.LPPED LIKE '%' + CAST(@PEDIDO AS NVARCHAR(10)) + '%') AND \\n\" +\n    \"   (@CNPJ IS NULL OR CACLI.CCCGC LIKE '%' + @CNPJ + '%') AND \\n\" +\n    \"   (@NOME IS NULL OR CACLI.CCFAN LIKE '%' + @NOME + '%') AND \\n\" +\n    \"   (@NOME IS NULL OR CACLI.CCNOM LIKE '%' + @NOME + '%') \\n\" +\n    \"ORDER BY \\n\" +\n    \"   LPV.LPPED DESC\"\n\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":500,"wires":[["8aaf8e5.93a867"]]},{"id":"60790765.817b98","type":"http response","z":"8364cdd3.e51ef","name":"","x":1050,"y":500,"wires":[]},{"id":"8aaf8e5.93a867","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"6320d365.b00b9c","name":"MSSQL","query":"","outField":"payload","x":820,"y":500,"wires":[["60790765.817b98"]]},{"id":"7725f43.0bf330c","type":"http in","z":"8364cdd3.e51ef","name":"lancamento","url":"/api/financeiro/recebiveis/lancamento/tarefa/:tarefa","method":"post","swaggerDoc":"","x":110,"y":700,"wires":[["151471f0.f2471e"]]},{"id":"151471f0.f2471e","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"var tarefa_cobranca = \n{\n    nome: 'Cobrança Bancária',\n    titulo: 'Gerar Remessa de Cobrança',\n    descricao: 'Saldo R$ ' + msg.payload.documento.parcelas.reduce( (total, parcela) => total + parcela.valor, 0).toFixed(2).replace('.', ','), \n    documento: JSON.stringify(\n        {\n            nosso_numero: msg.payload.documento.nosso_numero,\n            pedido: msg.payload.documento.numero,\n            cliente: msg.payload.documento.cliente,\n            parcelas: msg.payload.documento.parcelas\n        }),\n    atribuir: 'financeiro',\n    form: '/recebiveis/cobranca/'\n}\n\nmsg.payload = `\nSET NOCOUNT ON\n\n------------------------------------- DECLARACAO DE VARIAVEIS ----------------------------------------------\nDECLARE @NOSSO_NUMERO INT\nDECLARE @CONTA_CONTABIL VARCHAR(20)\nDECLARE @CNPJ VARCHAR(20)\nDECLARE @INSCRICAO VARCHAR(12)\nDECLARE @FANTASIA VARCHAR(30)\nDECLARE @NOME VARCHAR(100)\nDECLARE @LOGRADOURO VARCHAR(5)\nDECLARE @ENDERECO VARCHAR(50)\nDECLARE @NUMERO VARCHAR(10)\nDECLARE @COMPLEMENTO VARCHAR(20)\nDECLARE @BAIRRO VARCHAR(30)\nDECLARE @MUNICIPIO INT\nDECLARE @CIDADE VARCHAR(20)\nDECLARE @CEP CHAR(9)\nDECLARE @UF CHAR(2)\nDECLARE @DDD VARCHAR(3)\nDECLARE @TELEFONE VARCHAR(15)\nDECLARE @CONTATO VARCHAR(20)\n\nDECLARE @PARCELA INT\nDECLARE @FORMA_PAGTO VARCHAR(10)\nDECLARE @TIPO_VENCTO VARCHAR(3)\nDECLARE @VENCTO DATE\nDECLARE @PRAZO INT\nDECLARE @PORCENTAGEM DECIMAL(18, 3)\nDECLARE @VALOR MONEY\nDECLARE @DESCRICAO VARCHAR(50)\nDECLARE @ORIGEM VARCHAR(10)\n\nDECLARE @TAREFA_ATUAL INT\nDECLARE @VERSAO INT\n\nDECLARE @ULTIMA_VERSAO INT\nDECLARE @CONCLUIDO DATETIME\n\nDECLARE @PROX_TAREFA INT\nDECLARE @PROX_TAREFA_VERSAO INT\n\nDECLARE @NOVA_NAV INT\n\nDECLARE @TRF TABLE (\n    [id] [int] NOT NULL,\n\t[nome] [nvarchar](100) NOT NULL,\n\t[titulo] [nvarchar](50) NULL,\n\t[descricao] [nvarchar](50) NULL,\n\t[atribuir] [nvarchar](50) NULL,\n\t[form] [nvarchar](100) NOT NULL,\n\t[parametros] [nvarchar](max) NULL,\n\t[prazo] [datetime] NULL,\n\t[criado] [datetime] NOT NULL,\n\t[concluido] [datetime] NULL,\n\t[versao] [int],\n\t[topico] [nvarchar](100) NOT NULL)\n\nIF @@TRANCOUNT > 0\n        ROLLBACK TRANSACTION\n        \nBEGIN TRY\n    BEGIN TRANSACTION\n\n    -------------------------------------- ATUALIZACAO DAS TAREFAS ----------------------------------------------\n    SET @TAREFA_ATUAL = CAST('${msg.req.params.tarefa || '0'}' AS INT) \n    SET @VERSAO = CAST('${msg.payload.versao || '0'}' AS INT) \n\n    UPDATE TRF SET\n\t    concluido = GETDATE()\n    WHERE\n        id = @TAREFA_ATUAL\n        AND concluido IS NULL\n        AND versao = @VERSAO\n\n    IF @@ROWCOUNT != 1\n    BEGIN\n\n        ROLLBACK TRANSACTION\n\n        SELECT TOP 1 @ULTIMA_VERSAO = versao, @CONCLUIDO = concluido FROM TRF WHERE id = @TAREFA_ATUAL\n\n        IF (NOT @CONCLUIDO IS NULL)\n        BEGIN\n            INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7010\n            SELECT * FROM ERR WHERE erro = 7010\n        END\n        ELSE IF (@ULTIMA_VERSAO <> @VERSAO)\n        BEGIN\n            INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7450\n            SELECT * FROM ERR WHERE erro = 7450\n        END\n\n        RETURN\n    END\n\n    INSERT INTO @TRF SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/concluida/' + LTRIM(RTRIM(atribuir)) AS topico FROM TRF WHERE id = @TAREFA_ATUAL\n\n` +\n\n(msg.payload.documento.parcelas.find( p => p.forma_pagto === 'COBRANCA') ?\n\n`\n    SELECT TOP 1 @PROX_TAREFA = id, @PROX_TAREFA_VERSAO = versao FROM TRF WHERE nome = '${tarefa_cobranca.nome}' AND concluido IS NULL\n\n    IF @PROX_TAREFA IS NULL\n    BEGIN\n\n        SET @PROX_TAREFA = NEXT VALUE FOR tarefa_seq\n\n        INSERT INTO TRF\n            (id,\n            nome,\n            titulo,\n            descricao,\n            documento,\n            atribuir,\n            form,\n            parametros,\n            prazo,\n            criado,\n            concluido)\n        VALUES\n            (@PROX_TAREFA,\n            '${tarefa_cobranca.nome}',\n            '${tarefa_cobranca.titulo}',\n            '${tarefa_cobranca.descricao}',\n            '[${tarefa_cobranca.documento}]', \n            '${tarefa_cobranca.atribuir}',\n            '${tarefa_cobranca.form}',\n            NULL,\n            NULL,\n            GETDATE(),\n            NULL)\n\n        INSERT INTO @TRF SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/nova/' + LTRIM(RTRIM(atribuir)) AS topico FROM TRF WHERE id = @PROX_TAREFA\n\n        SET @NOVA_NAV = NEXT VALUE FOR tarefa_nav_seq\n\n        INSERT TRFN (transacao, tarefa_origem, tarefa_destino) VALUES (NEXT VALUE FOR tarefa_nav_seq, @TAREFA_ATUAL, @PROX_TAREFA)\n\n    END\n    ELSE\n    BEGIN\n\n        UPDATE TRF SET\n            descricao = 'Saldo R$ ${msg.payload.documento.parcelas.reduce( (total, parcela) => total + parcela.valor, 0).toFixed(2).replace('.', ',')}',\n            documento = STUFF(documento, LEN(documento), 1, ', ${tarefa_cobranca.documento}' + ']')\n        WHERE\n            id = @PROX_TAREFA\n            AND versao = @PROX_TAREFA_VERSAO\n\n        IF @@ROWCOUNT != 1\n        BEGIN\n\n            ROLLBACK TRANSACTION\n\n            SELECT TOP 1 @ULTIMA_VERSAO = versao, @CONCLUIDO = concluido FROM TRF WHERE id = @TAREFA_ATUAL\n\n            IF (NOT @CONCLUIDO IS NULL)\n            BEGIN\n                INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7010\n                SELECT * FROM ERR WHERE erro = 7010\n            END\n            ELSE IF (@ULTIMA_VERSAO <> @VERSAO)\n            BEGIN\n                INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7450\n                SELECT * FROM ERR WHERE erro = 7450\n            END\n\n            RETURN\n        END\n\n        INSERT INTO @TRF SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/atualizada/' + LTRIM(RTRIM(atribuir)) AS topico FROM TRF WHERE id = @PROX_TAREFA\n\n     END\n`\n\n:\n\n`\n   -- nenhuma tarefa nova será criada porque em nenhuma parcela a forma de pagto é COBRANCA --\n`\n\n) +\n\n`\n    ------------------------------------ VALIDACAO DE DADOS ----------------------------------------------\n\n    SET @NOSSO_NUMERO = CAST('${msg.payload.documento.nosso_numero || '0'}' AS INT)\n\n    IF EXISTS(SELECT NOSSO_NUMERO FROM RCB WHERE nosso_numero = @NOSSO_NUMERO)\n    BEGIN\n\n        ROLLBACK TRANSACTION\n\n        INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 1234\n        SELECT * FROM ERR WHERE erro = 1234\n\n        RETURN\n    END\n\n    ----------------------------------------- ATRIBUICAO DE VALORES DE PARAMETROS --------------------------------------------\n    SET @CONTA_CONTABIL = CAST('${msg.payload.documento.cliente.conta_contabil || 'NULL'}' AS VARCHAR(20))\n    SET @CNPJ = CAST('${msg.payload.documento.cliente.cnpj || 'NULL'}' AS VARCHAR(20))\n    SET @INSCRICAO = CAST('${msg.payload.documento.cliente.inscricao || 'NULL'}' AS VARCHAR(14))\n    SET @FANTASIA = CAST('${msg.payload.documento.cliente.fantasia || 'NULL'}' AS VARCHAR(30))\n    SET @NOME = CAST('${msg.payload.documento.cliente.nome || 'NULL'}' AS VARCHAR(100))\n    SET @LOGRADOURO = CAST('${msg.payload.documento.cliente.logradouro || 'NULL'}' AS VARCHAR(5))\n    SET @ENDERECO = CAST('${msg.payload.documento.cliente.endereco || 'NULL'}' AS VARCHAR(50))\n    SET @NUMERO = CAST('${msg.payload.documento.cliente.numero || 'NULL'}' AS VARCHAR(10))\n    SET @COMPLEMENTO = CAST('${msg.payload.documento.cliente.complemento || 'NULL'}' AS VARCHAR(20))\n    SET @BAIRRO = CAST('${msg.payload.documento.cliente.bairro || 'NULL'}' AS VARCHAR(30))\n    SET @MUNICIPIO = CAST('${msg.payload.documento.cliente.municipio || '0'}' AS INT)\n    SET @CIDADE = CAST('${msg.payload.documento.cliente.cidade || 'NULL'}' AS VARCHAR(20))\n    SET @CEP = CAST('${msg.payload.documento.cliente.CEP || 'NULL'}' AS CHAR(9))\n    SET @UF = CAST('${msg.payload.documento.cliente.UF || 'NULL'}' AS CHAR(2))\n    SET @DDD = CAST('${msg.payload.documento.cliente.ddd || 'NULL'}' AS VARCHAR(3))\n    SET @TELEFONE = CAST('${msg.payload.documento.cliente.telefone || 'NULL'}' AS VARCHAR(15))\n    SET @CONTATO = CAST('${msg.payload.documento.cliente.contato || 'NULL'}' AS VARCHAR(20))\n\n    INSERT INTO RCB (nosso_numero, conta_contabil, cnpj, inscricao, fantasia, nome, logradouro, endereco, numero, complemento, bairro, municipio, cidade, cep, uf, ddd, telefone, contato)\n    VALUES (@NOSSO_NUMERO, @CONTA_CONTABIL, @CNPJ, @INSCRICAO, @FANTASIA, @NOME, @LOGRADOURO, @ENDERECO, @NUMERO, @COMPLEMENTO, @BAIRRO, @MUNICIPIO, @CIDADE, @CEP, @UF, @DDD, @TELEFONE, @CONTATO)\n\n    DECLARE @PEDIDO_NUMERO INT\n\n    SET @PEDIDO_NUMERO = CAST('${msg.payload.documento.numero || 'NULL'}' AS INT)\n\n    INSERT INTO RCB_PED (nosso_numero, numero) VALUES (@NOSSO_NUMERO, @PEDIDO_NUMERO)\n` +\n\nmsg.payload.documento.parcelas.reduce ( (sql, parcela) =>\n    \n    sql + \n`\n    SET @PARCELA = CAST('${parcela.parcela || '0'}' AS INT)\n    SET @FORMA_PAGTO = CAST('${parcela.forma_pagto || 'NULL'}' AS VARCHAR(10))\n    SET @TIPO_VENCTO = CAST('${parcela.tipo_vencto || 'NULL'}' AS VARCHAR(3))\n    SET @VENCTO = CAST('${parcela.vencto || 'NULL'}' AS DATE)\n    SET @PRAZO = CAST('${parcela.prazo || '0'}' AS INT)\n    SET @VALOR = CAST('${parcela.valor || '0'}' AS MONEY)\n    SET @ORIGEM = CAST('${parcela.origem || 'NULL'}' AS VARCHAR(10))\n    \n    INSERT INTO RCBD (NOSSO_NUMERO, PARCELA, FORMA_PAGTO, TIPO_VENCTO, VENCTO, PRAZO, VALOR, ORIGEM)\n    VALUES (@NOSSO_NUMERO, @PARCELA, @FORMA_PAGTO, @TIPO_VENCTO, @VENCTO, @PRAZO, @VALOR, @ORIGEM)\n\n`\n, '') +\n\n`\n    COMMIT TRANSACTION\n\nEND TRY\nBEGIN CATCH\n\n    DECLARE @ERR_ID INT\n    DECLARE @ERROR_NUMBER INT\n    DECLARE @ERROR_SEVERITY INT\n    DECLARE @ERROR_STATE INT\n    DECLARE @ERROR_PROCEDURE INT\n    DECLARE @ERROR_LINE INT\n    DECLARE @ERROR_MESSAGE INT\n\n    SET @ERROR_NUMBER = ERROR_NUMBER()\n    SET @ERROR_SEVERITY = ERROR_SEVERITY()\n    SET @ERROR_STATE = ERROR_STATE()\n    SET @ERROR_PROCEDURE = ERROR_PROCEDURE()\n    SET @ERROR_LINE = ERROR_LINE()\n    SET @ERROR_MESSAGE = ERROR_MESSAGE()\n\n    ROLLBACK TRANSACTION\n\n    SET @ERR_ID = NEXT VALUE FOR err_log_seq\n    INSERT INTO err_log SELECT @ERR_ID AS id, @ERROR_NUMBER AS erro, @ERROR_SEVERITY AS nivel, @ERROR_STATE AS situacao, @ERROR_PROCEDURE AS procedimento, @ERROR_LINE AS linha, @ERROR_MESSAGE AS mensagem\n\n    SELECT * FROM err_log WHERE id = @ERR_ID\n\n    RETURN\nEND CATCH\n\nSELECT * FROM @TRF\n`\n\nreturn msg;","outputs":"1","noerr":0,"x":350,"y":700,"wires":[["12338a0d.45e9d6"]]},{"id":"12338a0d.45e9d6","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"MSSQL","query":"","outField":"payload","x":580,"y":700,"wires":[["3c3c527e.2f99ee"]]},{"id":"83febb09.ca2cf8","type":"http in","z":"8364cdd3.e51ef","name":"","url":"/api/financeiro/duplicata/cobranca/concluir/:tarefa","method":"post","swaggerDoc":"","x":280,"y":2860,"wires":[["e9b9d82.5a04a28","31ce9567.be4d9a"]]},{"id":"4891fe6c.ab68a","type":"function","z":"8364cdd3.e51ef","name":"TAREFA","func":"msg.payload = \n\"DECLARE @ID INT \" +\n\"SET @ID = \" + (parseInt(msg.req.params.tarefa) || 'NULL') + \" \" +\n\"UPDATE tarefas SET \" +\n\"\tconcluido = GETDATE() \" +\n\"WHERE \" +\n\"   id = @ID; \" +\n\"SELECT * FROM tarefas WHERE id = @ID;\"\n\nvar remessas = msg.pedido.cobrancas.filter( cobranca => !cobranca.carteira && cobranca.selected ).map( cobranca => {\n    cobranca.carteira = msg.pedido.carteira;\n    cobranca.envio = new Date().toISOString();\n    return cobranca;\n}); // deep clone\n\nmsg.pedido.remessas = JSON.parse(JSON.stringify(remessas)).map( remessa => {\n    remessa.envio = null;\n    remessa.selected = false;\n    return remessa;\n});\n\nif (msg.pedido.cobrancas.find( cob => !cob.selected)) {\n\n    msg.retryTask = \n            \"DECLARE @ID INT \" +\n            \"SET @ID = NEXT VALUE FOR tarefa_sequencia \" +\n            \"INSERT INTO BPM.dbo.tarefas \" +\n            \"   (id, \" +\n            \"   nome, \" +\n            \"   titulo, \" +\n            \"   descricao, \" +\n            \"   conteudo, \" +\n            \"   atribuir, \" +\n            \"   form, \" +\n            \"   parametros, \" +\n            \"   prazo, \" +\n            \"   criado, \" +\n            \"   concluido) \" +\n            \"VALUES \" +\n            \"   (@ID, \" +\n            \"   'Envio de Cobrança', \" +\n            \"   'Pedido \" + msg.pedido.numero + \"', \" +\n            \"   '\" + msg.pedido.cliente.nome + \"', \" +\n            \"   '\" + JSON.stringify(msg.pedido) + \"', \" + \n            \"   'rita', \" +\n            \"   '/duplicata/cobranca/' + CAST(@ID AS NVARCHAR(10)), \" +\n            \"   NULL, \" +\n            \"   NULL, \" +\n            \"   GETDATE(), \" +\n            \"   NULL); \" +\n            \"SELECT * FROM tarefas WHERE id = @ID;\"\n\n}\n\nmsg.nextTask = \n    \"DECLARE @ID INT \" +\n    \"SET @ID = NEXT VALUE FOR tarefa_sequencia \" +\n    \"INSERT INTO BPM.dbo.tarefas \" +\n    \"   (id, \" +\n    \"   nome, \" +\n    \"   titulo, \" +\n    \"   descricao, \" +\n    \"   conteudo, \" +\n    \"   atribuir, \" +\n    \"   form, \" +\n    \"   parametros, \" +\n    \"   prazo, \" +\n    \"   criado, \" +\n    \"   concluido) \" +\n    \"VALUES \" +\n    \"   (@ID, \" +\n    \"   'Remessa de Cobrança', \" +\n    \"   'Pedido \" + msg.pedido.numero + \"', \" +\n    \"   '\" + msg.pedido.cliente.nome + \"', \" +\n    \"   '\" + JSON.stringify(msg.pedido) + \"', \" + \n    \"   'marisa', \" +\n    \"   '/duplicata/remessa/' + CAST(@ID AS NVARCHAR(10)), \" +\n    \"   NULL, \" +\n    \"   NULL, \" +\n    \"   GETDATE(), \" +\n    \"   NULL); \" +\n    \"SELECT * FROM tarefas WHERE id = @ID;\"  \n\nreturn msg;","outputs":"1","noerr":0,"x":190,"y":3400,"wires":[["6561a241.0e549c"]]},{"id":"929dd25d.7c2cb","type":"http response","z":"8364cdd3.e51ef","name":"","x":500,"y":3400,"wires":[]},{"id":"6561a241.0e549c","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"89c0ceb0.f2811","name":"","query":"","outField":"payload","x":330,"y":3400,"wires":[["929dd25d.7c2cb","4262493.77e72b8","2dfe6518.290f5a"]]},{"id":"2ced1534.74ba6a","type":"mqtt out","z":"8364cdd3.e51ef","name":"","topic":"","qos":"","retain":"","broker":"404ac8f7.f80bb8","x":600,"y":3500,"wires":[]},{"id":"4262493.77e72b8","type":"function","z":"8364cdd3.e51ef","name":"CONCLUIDA","func":"msg.payload = msg.payload[0]\nmsg.topic = '/tarefas/concluida/' + msg.payload.atribuir\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":3460,"wires":[["2ced1534.74ba6a","4ed01f14.1f11e"]]},{"id":"4ed01f14.1f11e","type":"debug","z":"8364cdd3.e51ef","name":"","active":false,"console":"false","complete":"topic","x":610,"y":3460,"wires":[]},{"id":"e9b9d82.5a04a28","type":"debug","z":"8364cdd3.e51ef","name":"","active":true,"console":"false","complete":"payload","x":190,"y":2900,"wires":[]},{"id":"31ce9567.be4d9a","type":"function","z":"8364cdd3.e51ef","name":"PEDIDO","func":"msg.pedido = msg.payload;\nmsg.payload = \n//\"DECLARE @EMPRESA INT \" +\n\"DECLARE @NUMERO INT \" +\n\"DECLARE @EMISSAO DATE \" +\n\"DECLARE @ENTREGA DATE \" +\n\"DECLARE @CONDICAO VARCHAR(3) \" +\n\"DECLARE @COMISSAO DECIMAL(18, 3) \" +\n\n//\"SET @EMPRESA = CAST(\" + (msg.pedido.empresa || 'NULL') + \" AS INT) \" +\n\"SET @NUMERO = CAST(\" + (msg.pedido.numero || 'NULL') + \" AS INT) \" +\n\"SET @EMISSAO = CAST('\" + (msg.pedido.emissao || 'NULL') + \"' AS DATE) \" +\n\"SET @ENTREGA = CAST('\" + (msg.pedido.entrega || 'NULL') + \"' AS DATE) \" +\n\"SET @CONDICAO = CAST('\" + (msg.pedido.condicao || 'NULL') + \"' AS VARCHAR(3)) \" +\n\"SET @COMISSAO = CAST(\" + (msg.pedido.comissao || 'NULL') + \" AS DECIMAL(18, 3)) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED] AS target \" +\n\"    USING (SELECT @NUMERO, @EMISSAO, @ENTREGA, @CONDICAO, @COMISSAO) AS source (NUMERO, EMISSAO, ENTREGA, CONDICAO, COMISSAO) \" +\n\"    ON (target.NUMERO = source.NUMERO) \" +\n\"WHEN MATCHED THEN \" +\n\"    UPDATE SET EMISSAO = source.EMISSAO, ENTREGA = source.ENTREGA, CONDICAO = source.CONDICAO, COMISSAO = source.COMISSAO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (NUMERO, EMISSAO, ENTREGA, CONDICAO, COMISSAO) \" +\n\"\tVALUES (source.NUMERO, source.EMISSAO, source.ENTREGA, source.CONDICAO, source.COMISSAO); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":2960,"wires":[["69921c2.8bf57e4","f87ad6fa.2a73d8"]]},{"id":"69921c2.8bf57e4","type":"debug","z":"8364cdd3.e51ef","name":"","active":false,"console":"false","complete":"payload","x":360,"y":2960,"wires":[]},{"id":"497c911d.b420f","type":"function","z":"8364cdd3.e51ef","name":"DUPL","func":"msg.payload = \n\"DECLARE @NOSSO_NUMERO INT \" +\n\"DECLARE @PARCELA INT \" +\n\"DECLARE @TIPO VARCHAR(3) \" +\n\"DECLARE @VENCTO DATE \" +\n\"DECLARE @PRAZO INT \" +\n\"DECLARE @PORCENTAGEM DECIMAL(18, 3) \" +\n\"DECLARE @VALOR MONEY \" +\n\"DECLARE @DESCRICAO VARCHAR(50) \" +\n\"DECLARE @ORIGEM VARCHAR(10) \" +\n\n\"SET @NOSSO_NUMERO = CAST(\" +   (\"'\" + (msg.payload.nosso_numero || msg.pedido.numero) + \"'\"   || \"NULL\") + \" AS INT) \" +\n\"SET @PARCELA = CAST(\" +        (\"'\" + msg.payload.parcela + \"'\"        || \"NULL\") + \" AS INT) \" +\n\"SET @TIPO = CAST(\" +           (\"'\" + msg.payload.tipo + \"'\"           || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @VENCTO = CAST(\" +         (\"'\" + msg.payload.vencto + \"'\"         || \"NULL\") + \" AS DATE) \" +\n\"SET @PRAZO = CAST(\" +          (\"'\" + msg.payload.prazo + \"'\"          || \"NULL\") + \" AS INT) \" +\n\"SET @PORCENTAGEM = CAST(\" +    (\"'\" + msg.payload.porcentagem + \"'\"    || \"NULL\") + \" AS DECIMAL(18, 3)) \" +\n\"SET @VALOR = CAST(\" +          (\"'\" + msg.payload.valor + \"'\"          || \"NULL\") + \" AS MONEY) \" +\n\"SET @DESCRICAO = CAST(\" +      (\"'\" + msg.payload.descricao + \"'\"      || \"NULL\") + \" AS VARCHAR(50)) \" +\n\"SET @ORIGEM = 'PEDIDO' \" +\n\n\"MERGE [FINANCEIRO].[dbo].[DUP] AS target \" +\n\"   USING (SELECT @NOSSO_NUMERO, @PARCELA, @TIPO, @VENCTO, @PRAZO, @PORCENTAGEM, @VALOR, @DESCRICAO, @ORIGEM) AS source \" +\n\"   (NOSSO_NUMERO, PARCELA, TIPO, VENCTO, PRAZO, PORCENTAGEM, VALOR, DESCRICAO, ORIGEM) \" +\n\"   ON (target.NOSSO_NUMERO = source.NOSSO_NUMERO AND target.PARCELA = source.PARCELA) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET NOSSO_NUMERO = source.NOSSO_NUMERO, PARCELA = source.PARCELA, TIPO = source.TIPO, VENCTO = source.VENCTO, PRAZO = source.PRAZO, PORCENTAGEM = source.PORCENTAGEM, VALOR = source.VALOR, DESCRICAO = source.DESCRICAO, ORIGEM = source.ORIGEM \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (NOSSO_NUMERO, PARCELA, TIPO, VENCTO, PRAZO, PORCENTAGEM, VALOR, DESCRICAO, ORIGEM) \" +\n\"\tVALUES (source.NOSSO_NUMERO, source.PARCELA, source.TIPO, source.VENCTO, source.PRAZO, source.PORCENTAGEM, source.VALOR, source.DESCRICAO, source.ORIGEM); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_DUP] AS target \" +\n\"   USING (SELECT @PEDIDO, @NOSSO_NUMERO, @PARCELA) AS source \" +\n\"   (PED_NUMERO, DUP_NOSSO_NUMERO, DUP_PARCELA) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.DUP_NOSSO_NUMERO = source.DUP_NOSSO_NUMERO AND target.DUP_PARCELA = source.DUP_PARCELA) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET DUP_NOSSO_NUMERO = source.DUP_NOSSO_NUMERO, DUP_PARCELA = source.DUP_PARCELA \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, DUP_NOSSO_NUMERO, DUP_PARCELA) \" +\n\"\tVALUES (source.PED_NUMERO, source.DUP_NOSSO_NUMERO, source.DUP_PARCELA); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":3300,"wires":[["acc2b454.b7d988","c3f738c2.2d61e8"]]},{"id":"acc2b454.b7d988","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"","query":"","outField":"payload","x":490,"y":3360,"wires":[["3bd0bbbe.62b6c4"]]},{"id":"c3f738c2.2d61e8","type":"debug","z":"8364cdd3.e51ef","name":"","active":false,"console":"false","complete":"payload","x":500,"y":3300,"wires":[]},{"id":"3bd0bbbe.62b6c4","type":"function","z":"8364cdd3.e51ef","name":"LOOP","func":"if (msg.parcela === undefined) {\n    msg.parcela = 0;\n    msg.payload = msg.pedido.parcelas[0]\n    return [msg, null];\n} else {\n    msg.parcela++\n    if (msg.parcela < msg.pedido.parcelas.length) {\n        msg.payload = msg.pedido.parcelas[msg.parcela];\n        return [msg, null];\n    } else {\n        return [null, msg];\n    }\n}","outputs":"2","noerr":0,"x":180,"y":3340,"wires":[["497c911d.b420f"],["4891fe6c.ab68a"]]},{"id":"5cf3493f.8f4a28","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"89c0ceb0.f2811","name":"","query":"","outField":"payload","x":330,"y":3620,"wires":[["6d2eebec.0ffef4","caeacef2.e3cb1"]]},{"id":"1192d9a5.031036","type":"mqtt out","z":"8364cdd3.e51ef","name":"","topic":"","qos":"","retain":"","broker":"404ac8f7.f80bb8","x":560,"y":3680,"wires":[]},{"id":"2dfe6518.290f5a","type":"function","z":"8364cdd3.e51ef","name":"NOVA","func":"msg.payload = msg.nextTask;\nreturn msg;\n","outputs":1,"noerr":0,"x":300,"y":3560,"wires":[["5cf3493f.8f4a28"]]},{"id":"a4f4bf2e.a6dee","type":"debug","z":"8364cdd3.e51ef","name":"","active":true,"console":"false","complete":"topic","x":550,"y":3620,"wires":[]},{"id":"6d2eebec.0ffef4","type":"function","z":"8364cdd3.e51ef","name":"NOTIFY","func":"msg.payload = msg.payload[0]\nmsg.topic = '/tarefas/nova/' + msg.payload.atribuir\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":3680,"wires":[["a4f4bf2e.a6dee","1192d9a5.031036"]]},{"id":"9bd553cd.dbccc","type":"http in","z":"8364cdd3.e51ef","name":"carteira","url":"/api/financeiro/carteira","method":"get","swaggerDoc":"","x":90,"y":280,"wires":[["b106371c.e17968"]]},{"id":"f3174d4c.ef15f","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"MSSQL","query":"","outField":"payload","x":2480,"y":1220,"wires":[["8f679e7.dddf76","d0f7e826.5129e8"]]},{"id":"5befa2a3.3faa1c","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"\nmsg.payload = \"SELECT * FROM CRT\"; \n\nreturn msg;","outputs":1,"noerr":0,"x":2250,"y":1220,"wires":[["f3174d4c.ef15f"]]},{"id":"fc433f2b.d9c08","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"89c0ceb0.f2811","name":"","query":"","outField":"payload","x":300,"y":3900,"wires":[["5e8cd141.d11b2"]]},{"id":"6a227c93.5edd74","type":"mqtt out","z":"8364cdd3.e51ef","name":"","topic":"","qos":"","retain":"","broker":"404ac8f7.f80bb8","x":530,"y":3960,"wires":[]},{"id":"caeacef2.e3cb1","type":"function","z":"8364cdd3.e51ef","name":"NOVA","func":"if (msg.retryTask) {\n    msg.payload = msg.retryTask;\n    return msg;\n}","outputs":1,"noerr":0,"x":290,"y":3840,"wires":[["fc433f2b.d9c08"]]},{"id":"47ab6b58.31ef14","type":"debug","z":"8364cdd3.e51ef","name":"","active":true,"console":"false","complete":"topic","x":520,"y":3900,"wires":[]},{"id":"5e8cd141.d11b2","type":"function","z":"8364cdd3.e51ef","name":"NOTIFY","func":"msg.payload = msg.payload[0]\nmsg.topic = '/tarefas/nova/' + msg.payload.atribuir\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":3960,"wires":[["47ab6b58.31ef14","6a227c93.5edd74"]]},{"id":"38e4c43c.fe103c","type":"http in","z":"8364cdd3.e51ef","name":"","url":"/api/financeiro/duplicata/remessa/concluir/:tarefa","method":"post","swaggerDoc":"","x":920,"y":2860,"wires":[["7725b88d.9795f8","23ae923f.8dca0e"]]},{"id":"d97d51f6.fbf2e","type":"function","z":"8364cdd3.e51ef","name":"TAREFA","func":"msg.payload = \n\"DECLARE @ID INT \" +\n\"SET @ID = \" + (parseInt(msg.req.params.tarefa) || 'NULL') + \" \" +\n\"UPDATE tarefas SET \" +\n\"\tconcluido = GETDATE() \" +\n\"WHERE \" +\n\"   id = @ID; \" +\n\"SELECT * FROM tarefas WHERE id = @ID;\"\n\nvar retornos = JSON.parse(JSON.stringify(msg.pedido.remessas.filter( remessa => !remessa.carteira && remessa.selected ).map( remessa => {\n    remessa.envio = new Date().toISOString();\n}))); // deep clone\n\nmsg.pedido.retornos = retornos.map( ret => {\n    ret.retorno = null;\n    ret.selected = false;\n    return ret;\n})\n\nif (msg.pedido.remessas.find( r => !r.selected)) {\n\n    msg.retryTask = \n            \"DECLARE @ID INT \" +\n            \"SET @ID = NEXT VALUE FOR tarefa_sequencia \" +\n            \"INSERT INTO BPM.dbo.tarefas \" +\n            \"   (id, \" +\n            \"   nome, \" +\n            \"   titulo, \" +\n            \"   descricao, \" +\n            \"   conteudo, \" +\n            \"   atribuir, \" +\n            \"   form, \" +\n            \"   parametros, \" +\n            \"   prazo, \" +\n            \"   criado, \" +\n            \"   concluido) \" +\n            \"VALUES \" +\n            \"   (@ID, \" +\n            \"   'Remessa de Cobrança', \" +\n            \"   'Pedido \" + msg.pedido.numero + \"', \" +\n            \"   '\" + msg.pedido.cliente.nome + \"', \" +\n            \"   '\" + JSON.stringify(msg.pedido) + \"', \" + \n            \"   'marisa', \" +\n            \"   '/duplicata/remessa/' + CAST(@ID AS NVARCHAR(10)), \" +\n            \"   NULL, \" +\n            \"   NULL, \" +\n            \"   GETDATE(), \" +\n            \"   NULL); \" +\n            \"SELECT * FROM tarefas WHERE id = @ID;\"\n\n}\n\nmsg.nextTask = \n    \"DECLARE @ID INT \" +\n    \"SET @ID = NEXT VALUE FOR tarefa_sequencia \" +\n    \"INSERT INTO BPM.dbo.tarefas \" +\n    \"   (id, \" +\n    \"   nome, \" +\n    \"   titulo, \" +\n    \"   descricao, \" +\n    \"   conteudo, \" +\n    \"   atribuir, \" +\n    \"   form, \" +\n    \"   parametros, \" +\n    \"   prazo, \" +\n    \"   criado, \" +\n    \"   concluido) \" +\n    \"VALUES \" +\n    \"   (@ID, \" +\n    \"   'Retorno de Cobrança', \" +\n    \"   'Pedido \" + msg.pedido.numero + \"', \" +\n    \"   '\" + msg.pedido.cliente.nome + \"', \" +\n    \"   '\" + JSON.stringify(msg.pedido) + \"', \" + \n    \"   'marisa', \" +\n    \"   '/duplicata/retorno/' + CAST(@ID AS NVARCHAR(10)), \" +\n    \"   NULL, \" +\n    \"   NULL, \" +\n    \"   GETDATE(), \" +\n    \"   NULL); \" +\n    \"SELECT * FROM tarefas WHERE ID = @ID;\"\n\n\nreturn msg;","outputs":"1","noerr":0,"x":830,"y":3400,"wires":[["164e9806.4a7fd8"]]},{"id":"e6e371c6.bc0bb","type":"http response","z":"8364cdd3.e51ef","name":"","x":1140,"y":3400,"wires":[]},{"id":"164e9806.4a7fd8","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"89c0ceb0.f2811","name":"","query":"","outField":"payload","x":990,"y":3400,"wires":[["e6e371c6.bc0bb","ee9192a1.ed107","e235edb1.12209"]]},{"id":"d7d8c28d.467c8","type":"mqtt out","z":"8364cdd3.e51ef","name":"","topic":"","qos":"","retain":"","broker":"404ac8f7.f80bb8","x":1240,"y":3500,"wires":[]},{"id":"ee9192a1.ed107","type":"function","z":"8364cdd3.e51ef","name":"CONCLUIDA","func":"msg.payload = msg.payload[0]\nmsg.topic = '/tarefas/concluida/' + msg.payload.atribuir\nreturn msg;","outputs":1,"noerr":0,"x":1100,"y":3460,"wires":[["d7d8c28d.467c8","30f037cd.1959f8"]]},{"id":"30f037cd.1959f8","type":"debug","z":"8364cdd3.e51ef","name":"","active":false,"console":"false","complete":"topic","x":1250,"y":3460,"wires":[]},{"id":"7725b88d.9795f8","type":"debug","z":"8364cdd3.e51ef","name":"","active":true,"console":"false","complete":"payload.conta","x":860,"y":2900,"wires":[]},{"id":"23ae923f.8dca0e","type":"function","z":"8364cdd3.e51ef","name":"PEDIDO","func":"msg.pedido = msg.payload;\nmsg.payload = \n//\"DECLARE @EMPRESA INT \" +\n\"DECLARE @NUMERO INT \" +\n\"DECLARE @EMISSAO DATE \" +\n\"DECLARE @ENTREGA DATE \" +\n\"DECLARE @CONDICAO VARCHAR(3) \" +\n\"DECLARE @COMISSAO DECIMAL(18, 3) \" +\n\n//\"SET @EMPRESA = CAST(\" + (msg.pedido.empresa || 'NULL') + \" AS INT) \" +\n\"SET @NUMERO = CAST(\" + (msg.pedido.numero || 'NULL') + \" AS INT) \" +\n\"SET @EMISSAO = CAST('\" + (msg.pedido.emissao || 'NULL') + \"' AS DATE) \" +\n\"SET @ENTREGA = CAST('\" + (msg.pedido.entrega || 'NULL') + \"' AS DATE) \" +\n\"SET @CONDICAO = CAST('\" + (msg.pedido.condicao || 'NULL') + \"' AS VARCHAR(3)) \" +\n\"SET @COMISSAO = CAST(\" + (msg.pedido.comissao || 'NULL') + \" AS DECIMAL(18, 3)) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED] AS target \" +\n\"    USING (SELECT @NUMERO, @EMISSAO, @ENTREGA, @CONDICAO, @COMISSAO) AS source (NUMERO, EMISSAO, ENTREGA, CONDICAO, COMISSAO) \" +\n\"    ON (target.NUMERO = source.NUMERO) \" +\n\"WHEN MATCHED THEN \" +\n\"    UPDATE SET EMISSAO = source.EMISSAO, ENTREGA = source.ENTREGA, CONDICAO = source.CONDICAO, COMISSAO = source.COMISSAO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (NUMERO, EMISSAO, ENTREGA, CONDICAO, COMISSAO) \" +\n\"\tVALUES (source.NUMERO, source.EMISSAO, source.ENTREGA, source.CONDICAO, source.COMISSAO); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":830,"y":2960,"wires":[["28de2b3.bac4bd4","52f3e6f3.3ac788"]]},{"id":"28de2b3.bac4bd4","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"","query":"","outField":"payload","x":830,"y":3020,"wires":[["2625b5b2.227a9a"]]},{"id":"52f3e6f3.3ac788","type":"debug","z":"8364cdd3.e51ef","name":"","active":false,"console":"false","complete":"payload","x":1000,"y":2960,"wires":[]},{"id":"2625b5b2.227a9a","type":"function","z":"8364cdd3.e51ef","name":"CLIENTE","func":"msg.payload = \n\"DECLARE @CNPJ VARCHAR(20) \" +\n\"DECLARE @INSCRICAO VARCHAR(12) \" +\n\"DECLARE @FANTASIA VARCHAR(30) \" +\n\"DECLARE @NOME VARCHAR(100) \" +\n\"DECLARE @LOGRADOURO VARCHAR(5) \" +\n\"DECLARE @ENDERECO VARCHAR(50) \" +\n\"DECLARE @NUMERO VARCHAR(10) \" +\n\"DECLARE @COMPLEMENTO VARCHAR(20) \" +\n\"DECLARE @BAIRRO VARCHAR(30) \" +\n\"DECLARE @MUNICIPIO INT \" +\n\"DECLARE @CIDADE VARCHAR(20) \" +\n\"DECLARE @CEP CHAR(9) \" +\n\"DECLARE @UF CHAR(2)\" +\n\"DECLARE @DDD VARCHAR(3) \" +\n\"DECLARE @TELEFONE VARCHAR(15) \" +\n\"DECLARE @CONTATO VARCHAR(20) \" +\n\"DECLARE @DESCONTO BIT \" +\n\n\"SET @CNPJ = CAST(\" +           (\"'\" + msg.pedido.cliente.cnpj + \"'\"            || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @INSCRICAO = CAST(\" +      (\"'\" + msg.pedido.cliente.inscricao + \"'\"       || \"NULL\") + \" AS VARCHAR(14)) \" +\n\"SET @FANTASIA = CAST(\" +       (\"'\" + msg.pedido.cliente.fantasia + \"'\"        || \"NULL\") + \" AS VARCHAR(30)) \" +\n\"SET @NOME = CAST(\" +           (\"'\" + msg.pedido.cliente.nome + \"'\"            || \"NULL\") + \" AS VARCHAR(100)) \" +\n\"SET @LOGRADOURO = CAST(\" +     (\"'\" + msg.pedido.cliente.logradouro + \"'\"      || \"NULL\") + \" AS VARCHAR(5)) \" +\n\"SET @ENDERECO = CAST(\" +       (\"'\" + msg.pedido.cliente.endereco + \"'\"        || \"NULL\") + \" AS VARCHAR(50)) \" +\n\"SET @NUMERO = CAST(\" +         (\"'\" + msg.pedido.cliente.numero + \"'\"          || \"NULL\") + \" AS VARCHAR(10)) \" +\n\"SET @COMPLEMENTO = CAST(\" +    (\"'\" + msg.pedido.cliente.complemento + \"'\"     || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @BAIRRO = CAST(\" +         (\"'\" + msg.pedido.cliente.bairro + \"'\"          || \"NULL\") + \" AS VARCHAR(30)) \" +\n\"SET @MUNICIPIO = CAST(\" +      (msg.pedido.cliente.municipio                   || \"NULL\") + \" AS INT) \" +\n\"SET @CIDADE = CAST(\" +         (\"'\" + msg.pedido.cliente.cidade + \"'\"          || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @CEP = CAST(\" +            (\"'\" + msg.pedido.cliente.CEP + \"'\"             || \"NULL\") + \" AS CHAR(9)) \" +\n\"SET @UF = CAST(\" +             (\"'\" + msg.pedido.cliente.UF + \"'\"              || \"NULL\") + \" AS CHAR(2)) \" +\n\"SET @DDD = CAST(\" +            (\"'\" + msg.pedido.cliente.ddd + \"'\"             || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @TELEFONE = CAST(\" +       (\"'\" + msg.pedido.cliente.telefone + \"'\"        || \"NULL\") + \" AS VARCHAR(15)) \" +\n\"SET @CONTATO = CAST(\" +        (\"'\" + msg.pedido.cliente.contato + \"'\"         || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @DESCONTO = CAST(\" +        (\"'\" + msg.pedido.cliente.desconto + \"'\"         || \"NULL\") + \" AS BIT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[CLI] AS target \" +\n\"   USING (SELECT @CNPJ, @INSCRICAO, @FANTASIA, @NOME, @LOGRADOURO, @ENDERECO, @NUMERO, @COMPLEMENTO, @BAIRRO, @MUNICIPIO, @CIDADE, @CEP, @UF, @DDD, @TELEFONE, @CONTATO, @DESCONTO) AS source \" +\n\"   (CNPJ, INSCRICAO, FANTASIA, NOME, LOGRADOURO, ENDERECO, NUMERO, COMPLEMENTO, BAIRRO, MUNICIPIO, CIDADE, CEP, UF, DDD, TELEFONE, CONTATO, DESCONTO) \" +\n\"   ON (target.CNPJ = source.CNPJ) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET INSCRICAO = source.INSCRICAO, FANTASIA = source.FANTASIA, NOME = source.NOME, \" +\n\"   LOGRADOURO = source.LOGRADOURO, ENDERECO = source.ENDERECO, NUMERO = source.NUMERO, COMPLEMENTO = source.COMPLEMENTO, \" +\n\"   BAIRRO = source.BAIRRO, MUNICIPIO = source.MUNICIPIO, CIDADE = source.CIDADE, CEP = source.CEP, UF = source.UF, DDD = source.DDD, TELEFONE = source.TELEFONE, CONTATO = source.CONTATO, DESCONTO = source.DESCONTO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (CNPJ, INSCRICAO, FANTASIA, NOME, LOGRADOURO, ENDERECO, NUMERO, COMPLEMENTO, BAIRRO, MUNICIPIO, CIDADE, CEP, UF, DDD, TELEFONE, CONTATO, DESCONTO) \" +\n\"\tVALUES (source.CNPJ, source.INSCRICAO, source.FANTASIA, source.NOME, source.LOGRADOURO, source.ENDERECO, source.NUMERO, source.COMPLEMENTO, source.BAIRRO, source.MUNICIPIO, source.CIDADE, source.CEP, source.UF, source.DDD, source.TELEFONE, source.CONTATO, source.DESCONTO); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_CLI] AS target \" +\n\"   USING (SELECT @PEDIDO, @CNPJ) AS source \" +\n\"   (PED_NUMERO, CLI_CNPJ) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.CLI_CNPJ = source.CLI_CNPJ) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET CLI_CNPJ = source.CLI_CNPJ \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, CLI_CNPJ) \" +\n\"\tVALUES (source.PED_NUMERO, source.CLI_CNPJ); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":830,"y":3080,"wires":[["6ce6072.3d5a2f8","9eaf8381.ed862"]]},{"id":"6ce6072.3d5a2f8","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"","query":"","outField":"payload","x":830,"y":3140,"wires":[["b56b3648.d1c498"]]},{"id":"9eaf8381.ed862","type":"debug","z":"8364cdd3.e51ef","name":"","active":false,"console":"false","complete":"payload","x":1000,"y":3080,"wires":[]},{"id":"b56b3648.d1c498","type":"function","z":"8364cdd3.e51ef","name":"REPR.","func":"msg.payload = \n\"DECLARE @CODIGO VARCHAR(3) \" +\n\"DECLARE @NOME VARCHAR(50) \" +\n\n\"SET @CODIGO = CAST(\" +           (\"'\" + msg.pedido.representante.codigo + \"'\"            || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @NOME = CAST(\" +      (\"'\" + msg.pedido.representante.nome + \"'\"       || \"NULL\") + \" AS VARCHAR(50)) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[REP] AS target \" +\n\"   USING (SELECT @CODIGO, @NOME) AS source \" +\n\"   (CODIGO, NOME) \" +\n\"   ON (target.CODIGO = source.CODIGO) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET NOME = source.NOME \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (CODIGO, NOME) \" +\n\"\tVALUES (source.CODIGO, source.NOME); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_REP] AS target \" +\n\"   USING (SELECT @PEDIDO, @CODIGO) AS source \" +\n\"   (PED_NUMERO, REP_CODIGO) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.REP_CODIGO = source.REP_CODIGO) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET REP_CODIGO = source.REP_CODIGO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, REP_CODIGO) \" +\n\"\tVALUES (source.PED_NUMERO, source.REP_CODIGO); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":820,"y":3200,"wires":[["2ce97cab.e2d754","bbf61f53.8e8ea"]]},{"id":"bbf61f53.8e8ea","type":"debug","z":"8364cdd3.e51ef","name":"","active":false,"console":"false","complete":"payload","x":1000,"y":3200,"wires":[]},{"id":"2ce97cab.e2d754","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"","query":"","outField":"payload","x":830,"y":3260,"wires":[["e658f931.c184c8"]]},{"id":"788793f3.9e2fac","type":"function","z":"8364cdd3.e51ef","name":"DUPL","func":"msg.payload = \n\"DECLARE @NOSSO_NUMERO INT \" +\n\"DECLARE @PARCELA INT \" +\n\"DECLARE @TIPO VARCHAR(3) \" +\n\"DECLARE @VENCTO DATE \" +\n\"DECLARE @PRAZO INT \" +\n\"DECLARE @PORCENTAGEM DECIMAL(18, 3) \" +\n\"DECLARE @VALOR MONEY \" +\n\"DECLARE @DESCRICAO VARCHAR(50) \" +\n\"DECLARE @ORIGEM VARCHAR(10) \" +\n\n\"SET @NOSSO_NUMERO = CAST(\" +   (\"'\" + (msg.payload.nosso_numero || msg.pedido.numero) + \"'\"   || \"NULL\") + \" AS INT) \" +\n\"SET @PARCELA = CAST(\" +        (\"'\" + msg.payload.parcela + \"'\"        || \"NULL\") + \" AS INT) \" +\n\"SET @TIPO = CAST(\" +           (\"'\" + msg.payload.tipo + \"'\"           || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @VENCTO = CAST(\" +         (\"'\" + msg.payload.vencto + \"'\"         || \"NULL\") + \" AS DATE) \" +\n\"SET @PRAZO = CAST(\" +          (\"'\" + msg.payload.prazo + \"'\"          || \"NULL\") + \" AS INT) \" +\n\"SET @PORCENTAGEM = CAST(\" +    (\"'\" + msg.payload.porcentagem + \"'\"    || \"NULL\") + \" AS DECIMAL(18, 3)) \" +\n\"SET @VALOR = CAST(\" +          (\"'\" + msg.payload.valor + \"'\"          || \"NULL\") + \" AS MONEY) \" +\n\"SET @DESCRICAO = CAST(\" +      (\"'\" + msg.payload.descricao + \"'\"      || \"NULL\") + \" AS VARCHAR(50)) \" +\n\"SET @ORIGEM = 'PEDIDO' \" +\n\n\"MERGE [FINANCEIRO].[dbo].[DUP] AS target \" +\n\"   USING (SELECT @NOSSO_NUMERO, @PARCELA, @TIPO, @VENCTO, @PRAZO, @PORCENTAGEM, @VALOR, @DESCRICAO, @ORIGEM) AS source \" +\n\"   (NOSSO_NUMERO, PARCELA, TIPO, VENCTO, PRAZO, PORCENTAGEM, VALOR, DESCRICAO, ORIGEM) \" +\n\"   ON (target.NOSSO_NUMERO = source.NOSSO_NUMERO AND target.PARCELA = source.PARCELA) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET NOSSO_NUMERO = source.NOSSO_NUMERO, PARCELA = source.PARCELA, TIPO = source.TIPO, VENCTO = source.VENCTO, PRAZO = source.PRAZO, PORCENTAGEM = source.PORCENTAGEM, VALOR = source.VALOR, DESCRICAO = source.DESCRICAO, ORIGEM = source.ORIGEM \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (NOSSO_NUMERO, PARCELA, TIPO, VENCTO, PRAZO, PORCENTAGEM, VALOR, DESCRICAO, ORIGEM) \" +\n\"\tVALUES (source.NOSSO_NUMERO, source.PARCELA, source.TIPO, source.VENCTO, source.PRAZO, source.PORCENTAGEM, source.VALOR, source.DESCRICAO, source.ORIGEM); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_DUP] AS target \" +\n\"   USING (SELECT @PEDIDO, @NOSSO_NUMERO, @PARCELA) AS source \" +\n\"   (PED_NUMERO, DUP_NOSSO_NUMERO, DUP_PARCELA) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.DUP_NOSSO_NUMERO = source.DUP_NOSSO_NUMERO AND target.DUP_PARCELA = source.DUP_PARCELA) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET DUP_NOSSO_NUMERO = source.DUP_NOSSO_NUMERO, DUP_PARCELA = source.DUP_PARCELA \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, DUP_NOSSO_NUMERO, DUP_PARCELA) \" +\n\"\tVALUES (source.PED_NUMERO, source.DUP_NOSSO_NUMERO, source.DUP_PARCELA); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":980,"y":3300,"wires":[["ea3036c1.745808","3ac71b87.08cbe4"]]},{"id":"ea3036c1.745808","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"","query":"","outField":"payload","x":1130,"y":3360,"wires":[["e658f931.c184c8"]]},{"id":"3ac71b87.08cbe4","type":"debug","z":"8364cdd3.e51ef","name":"","active":false,"console":"false","complete":"payload","x":1140,"y":3300,"wires":[]},{"id":"e658f931.c184c8","type":"function","z":"8364cdd3.e51ef","name":"LOOP","func":"if (msg.parcela === undefined) {\n    msg.parcela = 0;\n    msg.payload = msg.pedido.parcelas[0]\n    return [msg, null];\n} else {\n    msg.parcela++\n    if (msg.parcela < msg.pedido.parcelas.length) {\n        msg.payload = msg.pedido.parcelas[msg.parcela];\n        return [msg, null];\n    } else {\n        return [null, msg];\n    }\n}","outputs":"2","noerr":0,"x":820,"y":3340,"wires":[["788793f3.9e2fac"],["d97d51f6.fbf2e"]]},{"id":"f20a0a91.7541c8","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"89c0ceb0.f2811","name":"","query":"","outField":"payload","x":970,"y":3620,"wires":[["37c033d7.24c50c","adba379a.d914a8"]]},{"id":"acdf98b9.241768","type":"mqtt out","z":"8364cdd3.e51ef","name":"","topic":"","qos":"","retain":"","broker":"404ac8f7.f80bb8","x":1200,"y":3680,"wires":[]},{"id":"e235edb1.12209","type":"function","z":"8364cdd3.e51ef","name":"NOVA","func":"msg.payload = msg.nextTask;\nreturn msg;\n","outputs":1,"noerr":0,"x":960,"y":3560,"wires":[["f20a0a91.7541c8"]]},{"id":"dd2f1ce.c14d4e","type":"debug","z":"8364cdd3.e51ef","name":"","active":true,"console":"false","complete":"topic","x":1190,"y":3620,"wires":[]},{"id":"37c033d7.24c50c","type":"function","z":"8364cdd3.e51ef","name":"NOTIFY","func":"msg.payload = msg.payload[0]\nmsg.topic = '/tarefas/nova/' + msg.payload.atribuir\nreturn msg;","outputs":1,"noerr":0,"x":1050,"y":3680,"wires":[["dd2f1ce.c14d4e","acdf98b9.241768"]]},{"id":"bd464f20.0441e","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"89c0ceb0.f2811","name":"","query":"","outField":"payload","x":970,"y":3800,"wires":[["dc2d7566.6380e8"]]},{"id":"c7e8c499.c9edd8","type":"mqtt out","z":"8364cdd3.e51ef","name":"","topic":"","qos":"","retain":"","broker":"404ac8f7.f80bb8","x":1200,"y":3860,"wires":[]},{"id":"adba379a.d914a8","type":"function","z":"8364cdd3.e51ef","name":"NOVA","func":"if (msg.retryTask) {\n    msg.payload = msg.retryTask;\n    return msg;\n}","outputs":1,"noerr":0,"x":960,"y":3740,"wires":[["bd464f20.0441e"]]},{"id":"d6d7a5df.3f8968","type":"debug","z":"8364cdd3.e51ef","name":"","active":true,"console":"false","complete":"topic","x":1190,"y":3800,"wires":[]},{"id":"dc2d7566.6380e8","type":"function","z":"8364cdd3.e51ef","name":"NOTIFY","func":"msg.payload = msg.payload[0]\nmsg.topic = '/tarefas/nova/' + msg.payload.atribuir\nreturn msg;","outputs":1,"noerr":0,"x":1050,"y":3860,"wires":[["d6d7a5df.3f8968","c7e8c499.c9edd8"]]},{"id":"3f32bc0f.cb2b14","type":"http in","z":"8364cdd3.e51ef","name":"","url":"/api/financeiro/duplicata/retorno/concluir/:tarefa","method":"post","swaggerDoc":"","x":1560,"y":2860,"wires":[["f414c8bd.089c28","c62e9c4e.2a4f8"]]},{"id":"9c12e493.b52178","type":"function","z":"8364cdd3.e51ef","name":"TAREFA","func":"msg.payload = \n\"DECLARE @ID INT \" +\n\"SET @ID = \" + (parseInt(msg.req.params.tarefa) || 'NULL') + \" \" +\n\"UPDATE tarefas SET \" +\n\"\tconcluido = GETDATE() \" +\n\"WHERE \" +\n\"   id = @ID; \" +\n\"SELECT * FROM tarefas WHERE id = @ID;\"\n\nreturn msg;","outputs":"1","noerr":0,"x":1470,"y":3400,"wires":[["6f3b5d7d.49b764"]]},{"id":"46cbf3db.733d6c","type":"http response","z":"8364cdd3.e51ef","name":"","x":1780,"y":3400,"wires":[]},{"id":"6f3b5d7d.49b764","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"89c0ceb0.f2811","name":"","query":"","outField":"payload","x":1630,"y":3400,"wires":[["46cbf3db.733d6c","58e56d4c.6f51f4"]]},{"id":"11671a29.4a2456","type":"mqtt out","z":"8364cdd3.e51ef","name":"","topic":"","qos":"","retain":"","broker":"404ac8f7.f80bb8","x":1880,"y":3500,"wires":[]},{"id":"58e56d4c.6f51f4","type":"function","z":"8364cdd3.e51ef","name":"CONCLUIDA","func":"msg.payload = msg.payload[0]\nmsg.topic = '/tarefas/concluida/' + msg.payload.atribuir\nreturn msg;","outputs":1,"noerr":0,"x":1740,"y":3460,"wires":[["11671a29.4a2456","ea694041.894ba"]]},{"id":"ea694041.894ba","type":"debug","z":"8364cdd3.e51ef","name":"","active":true,"console":"false","complete":"topic","x":1890,"y":3460,"wires":[]},{"id":"f414c8bd.089c28","type":"debug","z":"8364cdd3.e51ef","name":"","active":true,"console":"false","complete":"payload.conta","x":1500,"y":2920,"wires":[]},{"id":"c62e9c4e.2a4f8","type":"function","z":"8364cdd3.e51ef","name":"PEDIDO","func":"msg.pedido = msg.payload;\nmsg.payload = \n//\"DECLARE @EMPRESA INT \" +\n\"DECLARE @NUMERO INT \" +\n\"DECLARE @EMISSAO DATE \" +\n\"DECLARE @ENTREGA DATE \" +\n\"DECLARE @CONDICAO VARCHAR(3) \" +\n\"DECLARE @COMISSAO DECIMAL(18, 3) \" +\n\n//\"SET @EMPRESA = CAST(\" + (msg.pedido.empresa || 'NULL') + \" AS INT) \" +\n\"SET @NUMERO = CAST(\" + (msg.pedido.numero || 'NULL') + \" AS INT) \" +\n\"SET @EMISSAO = CAST('\" + (msg.pedido.emissao || 'NULL') + \"' AS DATE) \" +\n\"SET @ENTREGA = CAST('\" + (msg.pedido.entrega || 'NULL') + \"' AS DATE) \" +\n\"SET @CONDICAO = CAST('\" + (msg.pedido.condicao || 'NULL') + \"' AS VARCHAR(3)) \" +\n\"SET @COMISSAO = CAST(\" + (msg.pedido.comissao || 'NULL') + \" AS DECIMAL(18, 3)) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED] AS target \" +\n\"    USING (SELECT @NUMERO, @EMISSAO, @ENTREGA, @CONDICAO, @COMISSAO) AS source (NUMERO, EMISSAO, ENTREGA, CONDICAO, COMISSAO) \" +\n\"    ON (target.NUMERO = source.NUMERO) \" +\n\"WHEN MATCHED THEN \" +\n\"    UPDATE SET EMISSAO = source.EMISSAO, ENTREGA = source.ENTREGA, CONDICAO = source.CONDICAO, COMISSAO = source.COMISSAO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (NUMERO, EMISSAO, ENTREGA, CONDICAO, COMISSAO) \" +\n\"\tVALUES (source.NUMERO, source.EMISSAO, source.ENTREGA, source.CONDICAO, source.COMISSAO); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":1470,"y":2960,"wires":[["1c65a871.0f5c08","c943e0e7.6f4c9"]]},{"id":"1c65a871.0f5c08","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"","query":"","outField":"payload","x":1470,"y":3020,"wires":[["c6913df8.fb043"]]},{"id":"c943e0e7.6f4c9","type":"debug","z":"8364cdd3.e51ef","name":"","active":true,"console":"false","complete":"payload","x":1640,"y":2960,"wires":[]},{"id":"c6913df8.fb043","type":"function","z":"8364cdd3.e51ef","name":"CLIENTE","func":"msg.payload = \n\"DECLARE @CNPJ VARCHAR(20) \" +\n\"DECLARE @INSCRICAO VARCHAR(12) \" +\n\"DECLARE @FANTASIA VARCHAR(30) \" +\n\"DECLARE @NOME VARCHAR(100) \" +\n\"DECLARE @LOGRADOURO VARCHAR(5) \" +\n\"DECLARE @ENDERECO VARCHAR(50) \" +\n\"DECLARE @NUMERO VARCHAR(10) \" +\n\"DECLARE @COMPLEMENTO VARCHAR(20) \" +\n\"DECLARE @BAIRRO VARCHAR(30) \" +\n\"DECLARE @MUNICIPIO INT \" +\n\"DECLARE @CIDADE VARCHAR(20) \" +\n\"DECLARE @CEP CHAR(9) \" +\n\"DECLARE @UF CHAR(2)\" +\n\"DECLARE @DDD VARCHAR(3) \" +\n\"DECLARE @TELEFONE VARCHAR(15) \" +\n\"DECLARE @CONTATO VARCHAR(20) \" +\n\"DECLARE @DESCONTO BIT \" +\n\n\"SET @CNPJ = CAST(\" +           (\"'\" + msg.pedido.cliente.cnpj + \"'\"            || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @INSCRICAO = CAST(\" +      (\"'\" + msg.pedido.cliente.inscricao + \"'\"       || \"NULL\") + \" AS VARCHAR(14)) \" +\n\"SET @FANTASIA = CAST(\" +       (\"'\" + msg.pedido.cliente.fantasia + \"'\"        || \"NULL\") + \" AS VARCHAR(30)) \" +\n\"SET @NOME = CAST(\" +           (\"'\" + msg.pedido.cliente.nome + \"'\"            || \"NULL\") + \" AS VARCHAR(100)) \" +\n\"SET @LOGRADOURO = CAST(\" +     (\"'\" + msg.pedido.cliente.logradouro + \"'\"      || \"NULL\") + \" AS VARCHAR(5)) \" +\n\"SET @ENDERECO = CAST(\" +       (\"'\" + msg.pedido.cliente.endereco + \"'\"        || \"NULL\") + \" AS VARCHAR(50)) \" +\n\"SET @NUMERO = CAST(\" +         (\"'\" + msg.pedido.cliente.numero + \"'\"          || \"NULL\") + \" AS VARCHAR(10)) \" +\n\"SET @COMPLEMENTO = CAST(\" +    (\"'\" + msg.pedido.cliente.complemento + \"'\"     || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @BAIRRO = CAST(\" +         (\"'\" + msg.pedido.cliente.bairro + \"'\"          || \"NULL\") + \" AS VARCHAR(30)) \" +\n\"SET @MUNICIPIO = CAST(\" +      (msg.pedido.cliente.municipio                   || \"NULL\") + \" AS INT) \" +\n\"SET @CIDADE = CAST(\" +         (\"'\" + msg.pedido.cliente.cidade + \"'\"          || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @CEP = CAST(\" +            (\"'\" + msg.pedido.cliente.CEP + \"'\"             || \"NULL\") + \" AS CHAR(9)) \" +\n\"SET @UF = CAST(\" +             (\"'\" + msg.pedido.cliente.UF + \"'\"              || \"NULL\") + \" AS CHAR(2)) \" +\n\"SET @DDD = CAST(\" +            (\"'\" + msg.pedido.cliente.ddd + \"'\"             || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @TELEFONE = CAST(\" +       (\"'\" + msg.pedido.cliente.telefone + \"'\"        || \"NULL\") + \" AS VARCHAR(15)) \" +\n\"SET @CONTATO = CAST(\" +        (\"'\" + msg.pedido.cliente.contato + \"'\"         || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @DESCONTO = CAST(\" +        (\"'\" + msg.pedido.cliente.desconto + \"'\"         || \"NULL\") + \" AS BIT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[CLI] AS target \" +\n\"   USING (SELECT @CNPJ, @INSCRICAO, @FANTASIA, @NOME, @LOGRADOURO, @ENDERECO, @NUMERO, @COMPLEMENTO, @BAIRRO, @MUNICIPIO, @CIDADE, @CEP, @UF, @DDD, @TELEFONE, @CONTATO, @DESCONTO) AS source \" +\n\"   (CNPJ, INSCRICAO, FANTASIA, NOME, LOGRADOURO, ENDERECO, NUMERO, COMPLEMENTO, BAIRRO, MUNICIPIO, CIDADE, CEP, UF, DDD, TELEFONE, CONTATO, DESCONTO) \" +\n\"   ON (target.CNPJ = source.CNPJ) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET INSCRICAO = source.INSCRICAO, FANTASIA = source.FANTASIA, NOME = source.NOME, \" +\n\"   LOGRADOURO = source.LOGRADOURO, ENDERECO = source.ENDERECO, NUMERO = source.NUMERO, COMPLEMENTO = source.COMPLEMENTO, \" +\n\"   BAIRRO = source.BAIRRO, MUNICIPIO = source.MUNICIPIO, CIDADE = source.CIDADE, CEP = source.CEP, UF = source.UF, DDD = source.DDD, TELEFONE = source.TELEFONE, CONTATO = source.CONTATO, DESCONTO = source.DESCONTO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (CNPJ, INSCRICAO, FANTASIA, NOME, LOGRADOURO, ENDERECO, NUMERO, COMPLEMENTO, BAIRRO, MUNICIPIO, CIDADE, CEP, UF, DDD, TELEFONE, CONTATO, DESCONTO) \" +\n\"\tVALUES (source.CNPJ, source.INSCRICAO, source.FANTASIA, source.NOME, source.LOGRADOURO, source.ENDERECO, source.NUMERO, source.COMPLEMENTO, source.BAIRRO, source.MUNICIPIO, source.CIDADE, source.CEP, source.UF, source.DDD, source.TELEFONE, source.CONTATO, source.DESCONTO); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_CLI] AS target \" +\n\"   USING (SELECT @PEDIDO, @CNPJ) AS source \" +\n\"   (PED_NUMERO, CLI_CNPJ) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.CLI_CNPJ = source.CLI_CNPJ) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET CLI_CNPJ = source.CLI_CNPJ \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, CLI_CNPJ) \" +\n\"\tVALUES (source.PED_NUMERO, source.CLI_CNPJ); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":1470,"y":3080,"wires":[["239ad1d4.b7240e","7cd77940.e37cb8"]]},{"id":"239ad1d4.b7240e","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"","query":"","outField":"payload","x":1470,"y":3140,"wires":[["2221626e.940a3e"]]},{"id":"7cd77940.e37cb8","type":"debug","z":"8364cdd3.e51ef","name":"","active":true,"console":"false","complete":"payload","x":1640,"y":3080,"wires":[]},{"id":"2221626e.940a3e","type":"function","z":"8364cdd3.e51ef","name":"REPR.","func":"msg.payload = \n\"DECLARE @CODIGO VARCHAR(3) \" +\n\"DECLARE @NOME VARCHAR(50) \" +\n\n\"SET @CODIGO = CAST(\" +           (\"'\" + msg.pedido.representante.codigo + \"'\"            || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @NOME = CAST(\" +      (\"'\" + msg.pedido.representante.nome + \"'\"       || \"NULL\") + \" AS VARCHAR(50)) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[REP] AS target \" +\n\"   USING (SELECT @CODIGO, @NOME) AS source \" +\n\"   (CODIGO, NOME) \" +\n\"   ON (target.CODIGO = source.CODIGO) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET NOME = source.NOME \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (CODIGO, NOME) \" +\n\"\tVALUES (source.CODIGO, source.NOME); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_REP] AS target \" +\n\"   USING (SELECT @PEDIDO, @CODIGO) AS source \" +\n\"   (PED_NUMERO, REP_CODIGO) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.REP_CODIGO = source.REP_CODIGO) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET REP_CODIGO = source.REP_CODIGO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, REP_CODIGO) \" +\n\"\tVALUES (source.PED_NUMERO, source.REP_CODIGO); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":1460,"y":3200,"wires":[["c7a9a4b8.0230c8","cb54b42d.1afe18"]]},{"id":"cb54b42d.1afe18","type":"debug","z":"8364cdd3.e51ef","name":"","active":true,"console":"false","complete":"payload","x":1640,"y":3200,"wires":[]},{"id":"c7a9a4b8.0230c8","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"","query":"","outField":"payload","x":1470,"y":3260,"wires":[["b570d524.81bec8"]]},{"id":"68658345.529bac","type":"function","z":"8364cdd3.e51ef","name":"DUPL","func":"msg.payload = \n\"DECLARE @NOSSO_NUMERO INT \" +\n\"DECLARE @PARCELA INT \" +\n\"DECLARE @TIPO VARCHAR(3) \" +\n\"DECLARE @VENCTO DATE \" +\n\"DECLARE @PRAZO INT \" +\n\"DECLARE @PORCENTAGEM DECIMAL(18, 3) \" +\n\"DECLARE @VALOR MONEY \" +\n\"DECLARE @DESCRICAO VARCHAR(50) \" +\n\"DECLARE @ORIGEM VARCHAR(10) \" +\n\n\"SET @NOSSO_NUMERO = CAST(\" +   (\"'\" + msg.payload.nosso_numero + \"'\"   || \"NULL\") + \" AS INT) \" +\n\"SET @PARCELA = CAST(\" +        (\"'\" + msg.payload.parcela + \"'\"        || \"NULL\") + \" AS INT) \" +\n\"SET @TIPO = CAST(\" +           (\"'\" + msg.payload.tipo + \"'\"           || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @VENCTO = CAST(\" +         (\"'\" + msg.payload.vencto + \"'\"         || \"NULL\") + \" AS DATE) \" +\n\"SET @PRAZO = CAST(\" +          (\"'\" + msg.payload.prazo + \"'\"          || \"NULL\") + \" AS INT) \" +\n\"SET @PORCENTAGEM = CAST(\" +    (\"'\" + msg.payload.porcentagem + \"'\"    || \"NULL\") + \" AS DECIMAL(18, 3)) \" +\n\"SET @VALOR = CAST(\" +          (\"'\" + msg.payload.valor + \"'\"          || \"NULL\") + \" AS MONEY) \" +\n\"SET @DESCRICAO = CAST(\" +      (\"'\" + msg.payload.descricao + \"'\"      || \"NULL\") + \" AS VARCHAR(50)) \" +\n\"SET @ORIGEM = 'PEDIDO' \" +\n\n\"MERGE [FINANCEIRO].[dbo].[DUP] AS target \" +\n\"   USING (SELECT @NOSSO_NUMERO, @PARCELA, @TIPO, @VENCTO, @PRAZO, @PORCENTAGEM, @VALOR, @DESCRICAO, @ORIGEM) AS source \" +\n\"   (NOSSO_NUMERO, PARCELA, TIPO, VENCTO, PRAZO, PORCENTAGEM, VALOR, DESCRICAO, ORIGEM) \" +\n\"   ON (target.NOSSO_NUMERO = source.NOSSO_NUMERO AND target.PARCELA = source.PARCELA) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET NOSSO_NUMERO = source.NOSSO_NUMERO, PARCELA = source.PARCELA, TIPO = source.TIPO, VENCTO = source.VENCTO, PRAZO = source.PRAZO, PORCENTAGEM = source.PORCENTAGEM, VALOR = source.VALOR, DESCRICAO = source.DESCRICAO, ORIGEM = source.ORIGEM \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (NOSSO_NUMERO, PARCELA, TIPO, VENCTO, PRAZO, PORCENTAGEM, VALOR, DESCRICAO, ORIGEM) \" +\n\"\tVALUES (source.NOSSO_NUMERO, source.PARCELA, source.TIPO, source.VENCTO, source.PRAZO, source.PORCENTAGEM, source.VALOR, source.DESCRICAO, source.ORIGEM); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_DUP] AS target \" +\n\"   USING (SELECT @PEDIDO, @NOSSO_NUMERO, @PARCELA) AS source \" +\n\"   (PED_NUMERO, DUP_NOSSO_NUMERO, DUP_PARCELA) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.DUP_NOSSO_NUMERO = source.DUP_NOSSO_NUMERO AND target.DUP_PARCELA = source.DUP_PARCELA) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET DUP_NOSSO_NUMERO = source.DUP_NOSSO_NUMERO, DUP_PARCELA = source.DUP_PARCELA \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, DUP_NOSSO_NUMERO, DUP_PARCELA) \" +\n\"\tVALUES (source.PED_NUMERO, source.DUP_NOSSO_NUMERO, source.DUP_PARCELA); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":1620,"y":3300,"wires":[["f8f7c7e4.4ac9a8","3f17dadb.8f3236"]]},{"id":"f8f7c7e4.4ac9a8","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"","query":"","outField":"payload","x":1770,"y":3360,"wires":[["b570d524.81bec8"]]},{"id":"3f17dadb.8f3236","type":"debug","z":"8364cdd3.e51ef","name":"","active":true,"console":"false","complete":"payload","x":1780,"y":3300,"wires":[]},{"id":"b570d524.81bec8","type":"function","z":"8364cdd3.e51ef","name":"LOOP","func":"if (msg.parcela === undefined) {\n    msg.parcela = 0;\n    msg.payload = msg.pedido.parcelas[0]\n    return [msg, null];\n} else {\n    msg.parcela++\n    if (msg.parcela < msg.pedido.parcelas.length) {\n        msg.payload = msg.pedido.parcelas[msg.parcela];\n        return [msg, null];\n    } else {\n        return [null, msg];\n    }\n}","outputs":"2","noerr":0,"x":1460,"y":3340,"wires":[["68658345.529bac"],["9c12e493.b52178"]]},{"id":"5d5b374b.fae418","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"","query":"","outField":"payload","x":190,"y":3260,"wires":[["3bd0bbbe.62b6c4"]]},{"id":"16180a99.3b58f5","type":"debug","z":"8364cdd3.e51ef","name":"","active":false,"console":"false","complete":"payload","x":360,"y":3200,"wires":[]},{"id":"6d7ce475.afa66c","type":"function","z":"8364cdd3.e51ef","name":"REPR.","func":"msg.payload = \n\"DECLARE @CODIGO VARCHAR(3) \" +\n\"DECLARE @NOME VARCHAR(50) \" +\n\n\"SET @CODIGO = CAST(\" +           (\"'\" + msg.pedido.representante.codigo + \"'\"            || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @NOME = CAST(\" +      (\"'\" + msg.pedido.representante.nome + \"'\"       || \"NULL\") + \" AS VARCHAR(50)) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[REP] AS target \" +\n\"   USING (SELECT @CODIGO, @NOME) AS source \" +\n\"   (CODIGO, NOME) \" +\n\"   ON (target.CODIGO = source.CODIGO) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET NOME = source.NOME \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (CODIGO, NOME) \" +\n\"\tVALUES (source.CODIGO, source.NOME); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_REP] AS target \" +\n\"   USING (SELECT @PEDIDO, @CODIGO) AS source \" +\n\"   (PED_NUMERO, REP_CODIGO) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.REP_CODIGO = source.REP_CODIGO) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET REP_CODIGO = source.REP_CODIGO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, REP_CODIGO) \" +\n\"\tVALUES (source.PED_NUMERO, source.REP_CODIGO); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":180,"y":3200,"wires":[["5d5b374b.fae418","16180a99.3b58f5"]]},{"id":"f7f76f42.30aff","type":"debug","z":"8364cdd3.e51ef","name":"","active":false,"console":"false","complete":"payload","x":360,"y":3080,"wires":[]},{"id":"65057840.730608","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"","query":"","outField":"payload","x":190,"y":3140,"wires":[["6d7ce475.afa66c"]]},{"id":"18e60ae7.022c55","type":"function","z":"8364cdd3.e51ef","name":"CLIENTE","func":"msg.payload = \n\"DECLARE @CNPJ VARCHAR(20) \" +\n\"DECLARE @INSCRICAO VARCHAR(12) \" +\n\"DECLARE @FANTASIA VARCHAR(30) \" +\n\"DECLARE @NOME VARCHAR(100) \" +\n\"DECLARE @LOGRADOURO VARCHAR(5) \" +\n\"DECLARE @ENDERECO VARCHAR(50) \" +\n\"DECLARE @NUMERO VARCHAR(10) \" +\n\"DECLARE @COMPLEMENTO VARCHAR(20) \" +\n\"DECLARE @BAIRRO VARCHAR(30) \" +\n\"DECLARE @MUNICIPIO INT \" +\n\"DECLARE @CIDADE VARCHAR(20) \" +\n\"DECLARE @CEP CHAR(9) \" +\n\"DECLARE @UF CHAR(2)\" +\n\"DECLARE @DDD VARCHAR(3) \" +\n\"DECLARE @TELEFONE VARCHAR(15) \" +\n\"DECLARE @CONTATO VARCHAR(20) \" +\n\"DECLARE @DESCONTO BIT \" +\n\n\"SET @CNPJ = CAST(\" +           (\"'\" + msg.pedido.cliente.cnpj + \"'\"            || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @INSCRICAO = CAST(\" +      (\"'\" + msg.pedido.cliente.inscricao + \"'\"       || \"NULL\") + \" AS VARCHAR(14)) \" +\n\"SET @FANTASIA = CAST(\" +       (\"'\" + msg.pedido.cliente.fantasia + \"'\"        || \"NULL\") + \" AS VARCHAR(30)) \" +\n\"SET @NOME = CAST(\" +           (\"'\" + msg.pedido.cliente.nome + \"'\"            || \"NULL\") + \" AS VARCHAR(100)) \" +\n\"SET @LOGRADOURO = CAST(\" +     (\"'\" + msg.pedido.cliente.logradouro + \"'\"      || \"NULL\") + \" AS VARCHAR(5)) \" +\n\"SET @ENDERECO = CAST(\" +       (\"'\" + msg.pedido.cliente.endereco + \"'\"        || \"NULL\") + \" AS VARCHAR(50)) \" +\n\"SET @NUMERO = CAST(\" +         (\"'\" + msg.pedido.cliente.numero + \"'\"          || \"NULL\") + \" AS VARCHAR(10)) \" +\n\"SET @COMPLEMENTO = CAST(\" +    (\"'\" + msg.pedido.cliente.complemento + \"'\"     || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @BAIRRO = CAST(\" +         (\"'\" + msg.pedido.cliente.bairro + \"'\"          || \"NULL\") + \" AS VARCHAR(30)) \" +\n\"SET @MUNICIPIO = CAST(\" +      (msg.pedido.cliente.municipio                   || \"NULL\") + \" AS INT) \" +\n\"SET @CIDADE = CAST(\" +         (\"'\" + msg.pedido.cliente.cidade + \"'\"          || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @CEP = CAST(\" +            (\"'\" + msg.pedido.cliente.CEP + \"'\"             || \"NULL\") + \" AS CHAR(9)) \" +\n\"SET @UF = CAST(\" +             (\"'\" + msg.pedido.cliente.UF + \"'\"              || \"NULL\") + \" AS CHAR(2)) \" +\n\"SET @DDD = CAST(\" +            (\"'\" + msg.pedido.cliente.ddd + \"'\"             || \"NULL\") + \" AS VARCHAR(3)) \" +\n\"SET @TELEFONE = CAST(\" +       (\"'\" + msg.pedido.cliente.telefone + \"'\"        || \"NULL\") + \" AS VARCHAR(15)) \" +\n\"SET @CONTATO = CAST(\" +        (\"'\" + msg.pedido.cliente.contato + \"'\"         || \"NULL\") + \" AS VARCHAR(20)) \" +\n\"SET @DESCONTO = CAST(\" +        (\"'\" + msg.pedido.cliente.desconto + \"'\"         || \"NULL\") + \" AS BIT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[CLI] AS target \" +\n\"   USING (SELECT @CNPJ, @INSCRICAO, @FANTASIA, @NOME, @LOGRADOURO, @ENDERECO, @NUMERO, @COMPLEMENTO, @BAIRRO, @MUNICIPIO, @CIDADE, @CEP, @UF, @DDD, @TELEFONE, @CONTATO, @DESCONTO) AS source \" +\n\"   (CNPJ, INSCRICAO, FANTASIA, NOME, LOGRADOURO, ENDERECO, NUMERO, COMPLEMENTO, BAIRRO, MUNICIPIO, CIDADE, CEP, UF, DDD, TELEFONE, CONTATO, DESCONTO) \" +\n\"   ON (target.CNPJ = source.CNPJ) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET INSCRICAO = source.INSCRICAO, FANTASIA = source.FANTASIA, NOME = source.NOME, \" +\n\"   LOGRADOURO = source.LOGRADOURO, ENDERECO = source.ENDERECO, NUMERO = source.NUMERO, COMPLEMENTO = source.COMPLEMENTO, \" +\n\"   BAIRRO = source.BAIRRO, MUNICIPIO = source.MUNICIPIO, CIDADE = source.CIDADE, CEP = source.CEP, UF = source.UF, DDD = source.DDD, TELEFONE = source.TELEFONE, CONTATO = source.CONTATO, DESCONTO = source.DESCONTO \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (CNPJ, INSCRICAO, FANTASIA, NOME, LOGRADOURO, ENDERECO, NUMERO, COMPLEMENTO, BAIRRO, MUNICIPIO, CIDADE, CEP, UF, DDD, TELEFONE, CONTATO, DESCONTO) \" +\n\"\tVALUES (source.CNPJ, source.INSCRICAO, source.FANTASIA, source.NOME, source.LOGRADOURO, source.ENDERECO, source.NUMERO, source.COMPLEMENTO, source.BAIRRO, source.MUNICIPIO, source.CIDADE, source.CEP, source.UF, source.DDD, source.TELEFONE, source.CONTATO, source.DESCONTO); \" +\n\n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = CAST(\" +         (\"'\" + msg.pedido.numero + \"'\"         || \"NULL\") + \" AS INT) \" +\n\n\"MERGE [FINANCEIRO].[dbo].[PED_CLI] AS target \" +\n\"   USING (SELECT @PEDIDO, @CNPJ) AS source \" +\n\"   (PED_NUMERO, CLI_CNPJ) \" +\n\"   ON (target.PED_NUMERO = source.PED_NUMERO AND target.CLI_CNPJ = source.CLI_CNPJ) \" +\n\"WHEN MATCHED THEN \" +\n\"   UPDATE SET CLI_CNPJ = source.CLI_CNPJ \" +\n\"WHEN NOT MATCHED THEN \" +\n\"\tINSERT (PED_NUMERO, CLI_CNPJ) \" +\n\"\tVALUES (source.PED_NUMERO, source.CLI_CNPJ); \"\n\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":3080,"wires":[["65057840.730608","f7f76f42.30aff"]]},{"id":"f87ad6fa.2a73d8","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"","query":"","outField":"payload","x":190,"y":3020,"wires":[["18e60ae7.022c55"]]},{"id":"6f29f4ef.2afddc","type":"http response","z":"8364cdd3.e51ef","name":"","x":1050,"y":740,"wires":[]},{"id":"3c3c527e.2f99ee","type":"function","z":"8364cdd3.e51ef","name":"NOTIFY","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0 && !msg.payload[0].erro) {\n    return [msg, msg, null];\n} else {\n    return [null, null, msg];\n}\n","outputs":"3","noerr":0,"x":820,"y":780,"wires":[["6f29f4ef.2afddc","d89f9d70.ae8ca"],["3029d409.f846ac"],["98448223.15c58"]]},{"id":"ed44d050.6c7bd","type":"mqtt out","z":"8364cdd3.e51ef","name":"","topic":"","qos":"","retain":"","broker":"404ac8f7.f80bb8","x":1370,"y":780,"wires":[]},{"id":"df6f75aa.71d018","type":"http in","z":"8364cdd3.e51ef","name":"nosso_numero 1","url":"/api/financeiro/recebiveis/lancamento/nosso_numero1","method":"get","swaggerDoc":"","x":120,"y":560,"wires":[["bdad0277.6347b"]]},{"id":"bdad0277.6347b","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"msg.payload = \n    \"BEGIN TRY\" + '\\n' + '\\n' +\n    \n    \"   SELECT ISNULL(MAX(RCB.nosso_numero), 0) AS nosso_numero FROM RCB INNER JOIN RCB_PED ON RCB.nosso_numero = RCB_PED.nosso_numero;\" + '\\n' + '\\n' +\n    \n    \"END TRY\" + '\\n' +\n    \"BEGIN CATCH\" + '\\n' + '\\n' +\n    \n    \"   DECLARE @ERR_ID INT\" + '\\n' +\n    \"   SET @ERR_ID = NEXT VALUE FOR err_log_seq\" + '\\n' +\n    \"   INSERT INTO err_log SELECT @ERR_ID AS id, ERROR_NUMBER() AS erro, ERROR_SEVERITY() AS nivel, ERROR_STATE() AS situacao, ERROR_PROCEDURE() AS procedimento, ERROR_LINE() AS linha, ERROR_MESSAGE() AS mensagem\" + '\\n' + '\\n' +\n    \n    \"   IF @@TRANCOUNT > 0\" + '\\n' +\n    \"       ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"END CATCH\" + '\\n'\n\nreturn msg;","outputs":"1","noerr":0,"x":350,"y":560,"wires":[["80f1775e.d0ca68"]]},{"id":"80f1775e.d0ca68","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"MSSQL","query":"","outField":"payload","x":580,"y":560,"wires":[["aa019044.635c6"]]},{"id":"aa019044.635c6","type":"function","z":"8364cdd3.e51ef","name":"NOTIFY","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0 && msg.payload[0].erro === undefined) {\n    \n    msg.payload = msg.payload[0];\n    return msg;\n    \n} else {\n    msg.statusCode = 500;\n    msg.payload = msg.payload[0];\n    return msg\n}\n","outputs":"1","noerr":0,"x":820,"y":560,"wires":[["60d872e8.03385c"]]},{"id":"60d872e8.03385c","type":"http response","z":"8364cdd3.e51ef","name":"","x":1050,"y":560,"wires":[]},{"id":"f864e57a.422708","type":"http in","z":"8364cdd3.e51ef","name":"nosso_numero 2","url":"/api/financeiro/recebiveis/lancamento/nosso_numero2","method":"get","swaggerDoc":"","x":120,"y":600,"wires":[["3f31c851.0c6ae8"]]},{"id":"3f31c851.0c6ae8","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"msg.payload = \n    \"BEGIN TRY\" + '\\n' + '\\n' +\n\n    \"   SELECT ISNULL(MAX(RCB.nosso_numero), 0) AS nosso_numero FROM RCB WHERE NOT EXISTS(SELECT * FROM RCB_PED WHERE RCB.nosso_numero = RCB_PED.nosso_numero); \" + '\\n' + '\\n' +\n\n    \"END TRY\" + '\\n' +\n    \"BEGIN CATCH\" + '\\n' + '\\n' +\n    \n    \"   DECLARE @ERR_ID INT\" + '\\n' +\n    \"   SET @ERR_ID = NEXT VALUE FOR err_log_seq\" + '\\n' +\n    \"   INSERT INTO err_log SELECT @ERR_ID AS id, ERROR_NUMBER() AS erro, ERROR_SEVERITY() AS nivel, ERROR_STATE() AS situacao, ERROR_PROCEDURE() AS procedimento, ERROR_LINE() AS linha, ERROR_MESSAGE() AS mensagem\" + '\\n' + '\\n' +\n    \n    \"   IF @@TRANCOUNT > 0\" + '\\n' +\n    \"       ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"END CATCH\"\n\nreturn msg;","outputs":"1","noerr":0,"x":350,"y":600,"wires":[["8d26686a.143c48"]]},{"id":"8d26686a.143c48","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"MSSQL","query":"","outField":"payload","x":580,"y":600,"wires":[["4c3881c8.aa7c9"]]},{"id":"4c3881c8.aa7c9","type":"function","z":"8364cdd3.e51ef","name":"NOTIFY","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0 && msg.payload[0].erro === undefined) {\n    \n    msg.payload = msg.payload[0];\n    return msg;\n    \n} else {\n    msg.statusCode = 500;\n    msg.payload = msg.payload[0];\n    return msg\n}\n","outputs":"1","noerr":0,"x":820,"y":600,"wires":[["301f8ef0.bda732"]]},{"id":"301f8ef0.bda732","type":"http response","z":"8364cdd3.e51ef","name":"","x":1050,"y":600,"wires":[]},{"id":"6e32c2ee.90508c","type":"comment","z":"8364cdd3.e51ef","name":"IMPORTAR PEDIDOS LIBERADOS","info":"GERA TAREFAS DE TESTE PARA CONFERIR DUPLICATA","x":220,"y":2800,"wires":[]},{"id":"b2490ce3.e40ff","type":"inject","z":"8364cdd3.e51ef","name":"","topic":"","payload":"","payloadType":"num","repeat":"","crontab":"","once":false,"x":130,"y":3020,"wires":[[]]},{"id":"2de838e.4b7b6c8","type":"function","z":"8364cdd3.e51ef","name":"EVENTO","func":"msg.message = 'Importar Pedidos Liberados começou.'\nmsg.payload = \n\"SELECT * \" +\n\"FROM \" +\n\"\tGPIMAC_Altamira.dbo.INTEGRACAO_EVENTO WITH (NOLOCK) \" +\n\"WHERE \" +\n\"   evento = 'PEDIDO_LIBERADO' AND reconhecido = 0 AND antes = 'N' AND depois = 'S'\"\n\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":3020,"wires":[[]]},{"id":"cf938503.2d8d68","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"6320d365.b00b9c","name":"","query":"","outField":"payload","x":140,"y":3080,"wires":[[]]},{"id":"43091105.baa25","type":"function","z":"8364cdd3.e51ef","name":"LOOP","func":"if (msg.evento === undefined) {\n    msg.evento = 0;\n    msg.eventos = msg.payload\n    msg.payload = msg.payload[0].id\n    return [null, msg];\n} else {\n    msg.evento++\n    if (msg.evento < msg.eventos.length) {\n        msg.payload = msg.eventos[msg.evento].id;\n        return [null, msg];\n    } else {\n        msg.payload = 'Importar Pedidos Liberados terminou. ' + msg.evento + ' Pedidos encontrados.';\n        return [msg, null];\n    }\n}\n","outputs":"2","noerr":0,"x":310,"y":3140,"wires":[[],[]]},{"id":"826abe20.8603a","type":"function","z":"8364cdd3.e51ef","name":"EXISTE ?","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0) {\n    return [null, msg];\n} else {\n    msg.payload = 'Importar Pedidos Liberados terminou.';\n    return [msg, null];\n}","outputs":"2","noerr":0,"x":320,"y":3080,"wires":[[],[]]},{"id":"5b73da41.f50504","type":"function","z":"8364cdd3.e51ef","name":"EVENTO","func":"\nmsg.payload = \n\"DECLARE @ID INT \" +\n\"SET @ID = \" + (msg.eventos[msg.evento].sequencial || 'NULL') + \" \" +\n\"UPDATE GPIMAC_Altamira.dbo.INTEGRACAO_EVENTO \" +\n\"   SET reconhecido = 1 \" +\n\"WHERE sequencial = @ID\"\nreturn msg;","outputs":1,"noerr":0,"x":320,"y":3380,"wires":[[]]},{"id":"f019ae44.ce0e","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"6320d365.b00b9c","name":"","query":"","outField":"payload","x":320,"y":3440,"wires":[[]]},{"id":"74de13bd.786d7c","type":"comment","z":"8364cdd3.e51ef","name":"IMPORTAR PEDIDOS LIBERADOS","info":"GERA TAREFAS DE TESTE PARA CONFERIR DUPLICATA","x":1200,"y":40,"wires":[]},{"id":"ddcb4a8a.eb1a28","type":"inject","z":"8364cdd3.e51ef","name":"","topic":"","payload":"","payloadType":"num","repeat":"","crontab":"","once":false,"x":1130,"y":100,"wires":[["35dabb8d.18f764"]]},{"id":"35dabb8d.18f764","type":"function","z":"8364cdd3.e51ef","name":"EVENTO","func":"msg.message = 'Importar Pedidos Liberados começou.'\nmsg.payload = \n\"SELECT * \" +\n\"FROM \" +\n\"\tGPIMAC_Altamira.dbo.INTEGRACAO_EVENTO WITH (NOLOCK) \" +\n\"WHERE \" +\n\"   evento = 'PEDIDO_LIBERADO' AND reconhecido = 0 AND antes = 'N' AND depois = 'S'\"\n\nreturn msg;","outputs":1,"noerr":0,"x":1300,"y":100,"wires":[["31e10f91.a04e"]]},{"id":"31e10f91.a04e","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"6320d365.b00b9c","name":"MSSQL","query":"","outField":"payload","x":1490,"y":100,"wires":[["dd6f7ee6.4081a"]]},{"id":"93b5b708.034c48","type":"function","z":"8364cdd3.e51ef","name":"LOOP","func":"if (msg.evento === undefined) {\n    msg.evento = 0;\n    msg.eventos = msg.payload\n    msg.payload = msg.payload[0].id\n    return [null, msg];\n} else {\n    msg.evento++\n    if (msg.evento < msg.eventos.length) {\n        msg.payload = msg.eventos[msg.evento].id;\n        return [null, msg];\n    } else {\n        msg.payload = 'Importar Pedidos Liberados terminou. ' + msg.evento + ' Pedidos encontrados.';\n        return [msg, null];\n    }\n}\n","outputs":"2","noerr":0,"x":1850,"y":100,"wires":[["fb6c0f35.2229a","415a4739.6703b8"],["c11a0be3.fe6518"]]},{"id":"dd6f7ee6.4081a","type":"function","z":"8364cdd3.e51ef","name":"EXISTE ?","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0) {\n    return [null, msg];\n} else {\n    msg.payload = 'Importar Pedidos Liberados terminou.';\n    return [msg, null];\n}","outputs":"2","noerr":0,"x":1660,"y":100,"wires":[["fb6c0f35.2229a","415a4739.6703b8"],["93b5b708.034c48"]]},{"id":"8819777.8a8d688","type":"function","z":"8364cdd3.e51ef","name":"EVENTO","func":"\nmsg.payload = \n\"DECLARE @ID INT \" +\n\"SET @ID = \" + (msg.eventos[msg.evento].sequencial || 'NULL') + \" \" +\n\"UPDATE GPIMAC_Altamira.dbo.INTEGRACAO_EVENTO \" +\n\"   SET reconhecido = 1 \" +\n\"WHERE sequencial = @ID\"\nreturn msg;","outputs":1,"noerr":0,"x":2040,"y":1020,"wires":[["a2ed8bc.3aeba78"]]},{"id":"a2ed8bc.3aeba78","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"6320d365.b00b9c","name":"MSSQL","query":"","outField":"payload","x":1850,"y":820,"wires":[["93b5b708.034c48"]]},{"id":"14d85b68.42fa15","type":"function","z":"8364cdd3.e51ef","name":"TAREFA++","func":"msg.payload = {\n    nome: 'Lançamentos a Receber',\n    titulo: 'Pedido ' + msg.payload.numero,\n    descricao: msg.payload.cliente.nome,\n    documento: JSON.stringify(msg.payload),\n    atribuir: 'faturamento',\n    form: '/recebiveis/lancamento/',\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2050,"y":820,"wires":[["31532b55.47ef94"]]},{"id":"32b03fd3.812fa","type":"http in","z":"8364cdd3.e51ef","name":"tarefas","url":"/api/tarefas/","method":"get","swaggerDoc":"","x":90,"y":40,"wires":[["612b703e.c16e2"]]},{"id":"829f8a8a.496e98","type":"http response","z":"8364cdd3.e51ef","name":"","x":950,"y":60,"wires":[]},{"id":"612b703e.c16e2","type":"function","z":"8364cdd3.e51ef","name":"filename","func":"msg.filename = 'tarefas/' + msg.req.query.perfil + '.json';\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":40,"wires":[["bc5b0a20.868eb8"]]},{"id":"857dd949.9b00b8","type":"http in","z":"8364cdd3.e51ef","name":"tarefa/:id","url":"/api/tarefa/:id","method":"get","swaggerDoc":"","x":100,"y":80,"wires":[["ef0a9a1b.51b318"]]},{"id":"a244e65d.dfaac8","type":"http in","z":"8364cdd3.e51ef","name":"login","url":"/api/usuario/login","method":"post","swaggerDoc":"","x":90,"y":200,"wires":[["7c964b17.f489d4"]]},{"id":"ce130a7.ed94ff8","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"MSSQL","query":"","outField":"payload","x":570,"y":200,"wires":[["dc1d356a.b2adf8"]]},{"id":"eec054ce.d02158","type":"http response","z":"8364cdd3.e51ef","name":"","x":950,"y":200,"wires":[]},{"id":"7c964b17.f489d4","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"msg.payload = \n`\n    DECLARE @LOGIN NVARCHAR(50)\n    DECLARE @SENHA NVARCHAR(50)\n\n    SET @LOGIN = '${msg.payload.login || 'NULL'}'\n    SET @SENHA = '${msg.payload.senha || 'NULL'}'\n    \n    SELECT *\n    FROM\n    \tUSR\n    WHERE\n       login = @LOGIN AND\n       senha = @SENHA\n`\n\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":200,"wires":[["ce130a7.ed94ff8"]]},{"id":"dc1d356a.b2adf8","type":"function","z":"8364cdd3.e51ef","name":"PARSE","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0) {\n    msg.payload = msg.payload[0];\n} else {\n    msg.payload = {};\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":760,"y":200,"wires":[["eec054ce.d02158"]]},{"id":"300d4f6f.467f4","type":"debug","z":"8364cdd3.e51ef","name":"NAO ENCONTROU","active":true,"console":"false","complete":"payload","x":2290,"y":220,"wires":[]},{"id":"fb6c0f35.2229a","type":"debug","z":"8364cdd3.e51ef","name":"TERMINOU","active":true,"console":"false","complete":"payload","x":1870,"y":40,"wires":[]},{"id":"f828705e.adae1","type":"http in","z":"8364cdd3.e51ef","name":"cobranca","url":"/api/financeiro/cobranca","method":"get","swaggerDoc":"","x":100,"y":320,"wires":[["648308ec.c80a68"]]},{"id":"a67ea55b.e59f08","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"MSSQL","query":"","outField":"payload","x":2270,"y":1320,"wires":[["5613af07.6df4d"]]},{"id":"d0f7e826.5129e8","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"\nmsg.payload = \"SELECT RCB.*, RCB_PED.numero AS pedido FROM RCB LEFT OUTER JOIN RCB_PED ON RCB.nosso_numero = RCB_PED.nosso_numero\"; \n\nreturn msg;","outputs":1,"noerr":0,"x":2030,"y":1320,"wires":[["a67ea55b.e59f08"]]},{"id":"1ebb2007.5d85c","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"\nmsg.payload = \n\n\"SELECT * FROM RCBD WHERE nosso_numero = \" + msg.payload.nosso_numero; \n\nreturn msg;","outputs":1,"noerr":0,"x":2870,"y":1320,"wires":[["fc519315.76d12"]]},{"id":"fc519315.76d12","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"MSSQL","query":"","outField":"payload","x":3080,"y":1320,"wires":[["478db373.e0a24c"]]},{"id":"5613af07.6df4d","type":"function","z":"8364cdd3.e51ef","name":"parse","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0) {\n    delete msg.index;\n    msg.cobranca = msg.payload;\n    return [msg, null];\n} else {\n    return [null, msg];    \n}","outputs":"2","noerr":0,"x":2470,"y":1320,"wires":[["c57ac4df.f8e9b8"],["324c3e70.69c2f2","abb32f13.b67f6"]]},{"id":"c57ac4df.f8e9b8","type":"function","z":"8364cdd3.e51ef","name":"loop","func":"if (msg.index === undefined) {\n    msg.index = 0;\n    msg.payload = msg.cobranca[msg.index];\n    return [msg, null];\n} else {\n    msg.index++;\n    if (msg.index < msg.cobranca.length) {\n        msg.payload = msg.cobranca[msg.index];    \n        return [msg, null]\n    }\n    msg.payload = msg.cobranca;\n    return [null, msg];\n}\n","outputs":"2","noerr":0,"x":2670,"y":1320,"wires":[["1ebb2007.5d85c"],["324c3e70.69c2f2","abb32f13.b67f6"]]},{"id":"478db373.e0a24c","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"msg.cobranca[msg.index].parcelas = msg.payload;\n\nreturn msg;","outputs":1,"noerr":0,"x":2870,"y":1440,"wires":[["c57ac4df.f8e9b8"]]},{"id":"63cbbc37.d0a5e4","type":"http in","z":"8364cdd3.e51ef","name":"tarefa/:id","url":"/api/tarefa/:id","method":"post","swaggerDoc":"","x":100,"y":120,"wires":[["57858d91.797074"]]},{"id":"cb6de89d.5fe078","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"MSSQL","query":"","outField":"payload","x":570,"y":120,"wires":[["4e798a21.4093d4"]]},{"id":"fa0c5725.d20448","type":"http response","z":"8364cdd3.e51ef","name":"","x":950,"y":120,"wires":[]},{"id":"57858d91.797074","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"msg.payload = \n    \"BEGIN TRY\" + '\\n' +\n    \"   BEGIN TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"   DECLARE @TAREFA INT\" + '\\n' +\n    \"   DECLARE @VERSAO INT\" + '\\n' + '\\n' +\n\n    \"   -------------------------------------- ATUALIZACAO DAS TRF ----------------------------------------------\" + '\\n' +\n    \"   SET @TAREFA = \" + (msg.req.params.id || 'NULL') + '\\n' +\n    \"   SET @VERSAO = CAST('\" + (msg.payload.versao || 'NULL') + \"' AS INT)\" + '\\n' + '\\n' +\n\n    \"   UPDATE TRF SET\" + '\\n' +\n    \"       documento = '\" + JSON.stringify(msg.payload.documento) + \"'\" + '\\n' +\n    \"   WHERE\" + '\\n' +\n    \"       id = @TAREFA\" + '\\n' +\n    \"       AND concluido IS NULL\" + '\\n' +\n    \"       AND versao = @VERSAO\" + '\\n' + '\\n' +\n    \n    \"   IF @@ROWCOUNT != 1\" + '\\n' +\n    \"   BEGIN\" + '\\n' + '\\n' +\n    \n    \"       DECLARE @ULTIMA_VERSAO INT\" + '\\n' +\n    \"       DECLARE @CONCLUIDO DATETIME\" + '\\n' + '\\n' +\n    \n    \"       SELECT TOP 1 @ULTIMA_VERSAO = versao, @CONCLUIDO = concluido FROM TRF WHERE id = @TAREFA\" + '\\n' + '\\n' +\n    \n    \"       IF (NOT @CONCLUIDO IS NULL)\" + '\\n' +\n    \"           SELECT * FROM ERR WHERE erro = 7010\" + '\\n' +\n    \"       ELSE IF (@ULTIMA_VERSAO <> @VERSAO)\" + '\\n' +\n    \"           SELECT * FROM ERR WHERE erro = 7451\" + '\\n' + '\\n' +\n    \n    \"       ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"       RETURN;\" + '\\n' +\n    \"   END\" + '\\n' + '\\n' +\n\n    \"   SELECT\" + '\\n' +\n    \"       id,\" + '\\n' +\n    \"       nome,\" + '\\n' +\n    \"       titulo,\" + '\\n' +\n    \"       descricao,\" + '\\n' +\n    //\"     documento,\" + '\\n' +\n    \"       atribuir,\" + '\\n' +\n    \"       form,\" + '\\n' +\n    \"       parametros,\" + '\\n' +\n    \"       prazo,\" + '\\n' +\n    \"       criado,\" + '\\n' +\n    \"       CAST(versao AS INT) AS versao\" + '\\n' +  \n    \"   FROM\" + '\\n' +\n    \"\t    TRF\" + '\\n' +\n    \"   WHERE\" + '\\n' +\n    \"       id = @TAREFA;\" + '\\n' + '\\n' +\n    \n    \"   COMMIT TRANSACTION;\" + '\\n' + '\\n' +\n\n    \"END TRY\" + '\\n' +\n    \"BEGIN CATCH\" + '\\n' + '\\n' +\n    \n    \"   DECLARE @ERR_ID INT\" + '\\n' +\n    \"   SET @ERR_ID = NEXT VALUE FOR err_log_seq\" + '\\n' +\n    \"   INSERT INTO err_log SELECT @ERR_ID AS id, ERROR_NUMBER() AS erro, ERROR_SEVERITY() AS nivel, ERROR_STATE() AS situacao, ERROR_PROCEDURE() AS procedimento, ERROR_LINE() AS linha, ERROR_MESSAGE() AS mensagem\" + '\\n' + '\\n' +\n    \n    \"   IF @@TRANCOUNT > 0\" + '\\n' +\n    \"       ROLLBACK TRANSACTION\" + '\\n' + '\\n' +\n    \n    \"END CATCH\" + '\\n'\n\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":120,"wires":[["cb6de89d.5fe078"]]},{"id":"4e798a21.4093d4","type":"function","z":"8364cdd3.e51ef","name":"PARSE","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0) {\n    msg.payload = msg.payload[0];    \n} else {\n    msg.payload = {erro: 9999, mensagem: 'Ocorreu um erro ao executar a sua solicitação.'}\n}\n\nif (msg.payload.erro) {\n    msg.statusCode = 500;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":760,"y":120,"wires":[["fa0c5725.d20448"]]},{"id":"c7a9e9a0.988268","type":"http in","z":"8364cdd3.e51ef","name":"cobranca","url":"/api/financeiro/recebiveis/cobranca/tarefa/:tarefa","method":"post","swaggerDoc":"","x":100,"y":760,"wires":[["62ec6214.acbf7c"]]},{"id":"62ec6214.acbf7c","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"var tarefa_atual = \n{\n    nome: 'Cobrança Bancária',\n    titulo: 'Gerar Remessa de Cobrança',\n    descricao: 'Saldo R$ ' + msg.payload.documento.cobranca.reduce( (total, c) => total + c.parcelas.filter( (p) => !p.selected && !p.carteira).reduce( (soma, p) => soma + p.valor, 0.0), 0.0).toFixed(2).replace('.', ','), \n    documento: JSON.stringify(\n        msg.payload.documento.cobranca.map( c => {\n            \n            var cobranca = {\n                nosso_numero: c.nosso_numero,\n                pedido: c.pedido,\n                cliente: c.cliente,\n                parcelas: c.parcelas.map( (p) => {\n                \n                    var parcela = {\n                        vencto: p.vencto,\n                        origem: p.origem,\n                        forma_pagto: p.forma_pagto,\n                        tipo_vencto: p.tipo_vencto,\n                        parcela: p.parcela,\n                        prazo: p.prazo,\n                        valor: p.valor\n                    }\n                    \n                    if (p.carteira) {\n                        parcela.carteira = p.carteira;\n                        parcela.remessa = p.remessa;\n                    } else if (p.selected) {\n                        parcela.carteira = msg.payload.documento.carteira.nome;\n                        parcela.remessa = new Date().toISOString();\n                    }\n                    \n                    return parcela;\n                    \n                })\n            };\n            \n            return cobranca;\n        })\n    ),\n    atribuir: 'financeiro',\n    form: '/recebiveis/cobranca/'\n}\n\nvar tarefa_remessa = \n{\n    nome: 'Remessa de Cobrança',\n    titulo: msg.payload.documento.carteira.nome,\n    descricao: 'Total R$ ' + msg.payload.documento.cobranca.reduce( (total, c) => total + c.parcelas.filter( (p) => p.selected && !p.carteira).reduce( (soma, p) => soma + p.valor, 0.0), 0.0).toFixed(2).replace('.', ','), \n    documento: JSON.stringify({ \n        \n        carteira: msg.payload.documento.carteira,\n        data: new Date().toISOString(),\n        \n        remessa: msg.payload.documento.cobranca.filter( c => c.parcelas.find( p => p.selected)).map( c => {\n            var cobranca = {\n                nosso_numero: c.nosso_numero,\n                pedido: c.pedido,\n                cliente: c.cliente,\n                parcelas: c.parcelas.filter( p => p.selected).map( (p) => {\n                \n                    var parcela = {\n                        vencto: p.vencto,\n                        origem: p.origem,\n                        forma_pagto: p.forma_pagto,\n                        tipo_vencto: p.tipo_vencto,\n                        parcela: p.parcela,\n                        prazo: p.prazo,\n                        valor: p.valor\n                    }\n                    \n                    parcela.carteira = msg.payload.documento.carteira.nome;\n                    parcela.remessa = new Date().toISOString();\n\n                    return parcela;\n                    \n                })\n            };\n            \n            return cobranca;\n        }),\n        \n        bordero: msg.payload.documento.bordero\n        \n    }),\n    atribuir: 'cobranca',\n    form: '/recebiveis/remessa/'\n}\n\nmsg.payload = `\n\nSET NOCOUNT ON\n\nDECLARE @NOSSO_NUMERO INT\nDECLARE @PARCELA INT\nDECLARE @CARTEIRA INT\n\nDECLARE @CONTA_CONTABIL VARCHAR(20)\nDECLARE @CNPJ VARCHAR(20)\nDECLARE @INSCRICAO VARCHAR(12)\nDECLARE @FANTASIA VARCHAR(30)\nDECLARE @NOME VARCHAR(100)\nDECLARE @LOGRADOURO VARCHAR(5)\nDECLARE @ENDERECO VARCHAR(50)\nDECLARE @NUMERO VARCHAR(10)\nDECLARE @COMPLEMENTO VARCHAR(20)\nDECLARE @BAIRRO VARCHAR(30)\nDECLARE @MUNICIPIO INT\nDECLARE @CIDADE VARCHAR(20)\nDECLARE @CEP CHAR(9)\nDECLARE @UF CHAR(2)\nDECLARE @DDD VARCHAR(3)\nDECLARE @TELEFONE VARCHAR(15)\nDECLARE @CONTATO VARCHAR(20)\n\nDECLARE @FORMA_PAGTO VARCHAR(10)\nDECLARE @TIPO_VENCTO VARCHAR(3)\nDECLARE @VENCTO DATE\nDECLARE @PRAZO INT\nDECLARE @PORCENTAGEM DECIMAL(18, 3)\nDECLARE @VALOR MONEY\nDECLARE @DESCRICAO VARCHAR(50)\nDECLARE @ORIGEM VARCHAR(10)\n\nDECLARE @TAREFA_ATUAL INT\nDECLARE @VERSAO INT\n\nDECLARE @NOVA_TAREFA INT\n\nDECLARE @ULTIMA_VERSAO INT\nDECLARE @CONCLUIDO DATETIME\n\nDECLARE @PROX_TAREFA INT\nDECLARE @PROX_TAREFA_VERSAO INT\n\nDECLARE @NOVA_NAV INT\n\nDECLARE @TRF TABLE (\n\t[id] [int] NOT NULL,\n\t[nome] [nvarchar](100) NOT NULL,\n\t[titulo] [nvarchar](50) NULL,\n\t[descricao] [nvarchar](50) NULL,\n\t[atribuir] [nvarchar](50) NULL,\n\t[form] [nvarchar](100) NOT NULL,\n\t[parametros] [nvarchar](max) NULL,\n\t[prazo] [datetime] NULL,\n\t[criado] [datetime] NOT NULL,\n\t[concluido] [datetime] NULL,\n\t[versao] [int],\n\t[topico] [nvarchar](100) NOT NULL)\n\t\nBEGIN TRY\n    BEGIN TRANSACTION\n\n    -------------------------------------- ATUALIZACAO DAS TAREFAS ----------------------------------------------\n    SET @TAREFA_ATUAL = CAST('${msg.req.params.tarefa || '0'}' AS INT) \n    SET @VERSAO = CAST('${msg.payload.versao || 'NULL'}' AS INT)\n\n    UPDATE TRF SET\n\t    concluido = GETDATE()\n    WHERE\n        id = @TAREFA_ATUAL\n        AND concluido IS NULL\n        AND versao = @VERSAO\n\n    IF @@ROWCOUNT != 1\n    BEGIN\n\n        ROLLBACK TRANSACTION\n\n        SELECT TOP 1 @ULTIMA_VERSAO = versao, @CONCLUIDO = concluido FROM TRF WHERE id = @TAREFA_ATUAL\n\n        IF (NOT @CONCLUIDO IS NULL)\n        BEGIN\n            INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7010\n            SELECT * FROM ERR WHERE erro = 7010\n        END\n        ELSE IF (@ULTIMA_VERSAO <> @VERSAO)\n        BEGIN\n            INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7450\n            SELECT * FROM ERR WHERE erro = 7450\n        END\n\n        RETURN\n    END\n\n    INSERT INTO @TRF SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/concluida/' + LTRIM(RTRIM(atribuir)) AS topico FROM TRF WHERE id = @TAREFA_ATUAL\n\n    ---------------------------------------------------- grava as parcelas ----------------------------------------------------\n` +\n\nmsg.payload.documento.cobranca.reduce( (sql, c) => \n\n    sql + c.parcelas.filter( p => p.selected).reduce( (sql, p) => \n    \n        sql + \n`\n        \n    ----------------------------------------------------------------------------------------------------------\n    -- insere nova parcela => nosso_numero:  + ${c.nosso_numero} + ', parcela: ' + ${p.parcela} + ', carteira: ' + ${msg.payload.documento.carteira.id}\n    ----------------------------------------------------------------------------------------------------------\n    SET @NOSSO_NUMERO = CAST('${c.nosso_numero || '0'}' AS INT)\n    SET @PARCELA = CAST('${p.parcela || '0'}' AS INT)\n    SET @CARTEIRA = CAST('${msg.payload.documento.carteira.id || '0'}' AS INT)\n    \n    IF EXISTS(SELECT NOSSO_NUMERO FROM COB WHERE nosso_numero = @NOSSO_NUMERO AND parcela = @PARCELA AND carteira = @CARTEIRA)\n    BEGIN\n    \n       ROLLBACK TRANSACTION\n    \n       INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 1123\n       SELECT * FROM ERR WHERE erro = 1123\n    \n       RETURN\n    END\n    \n    SET @NOSSO_NUMERO = CAST('${c.nosso_numero || '0'}' AS INT)\n    SET @PARCELA = CAST('${p.parcela || '0'}' AS INT)\n    SET @CARTEIRA = CAST('${msg.payload.documento.carteira.id || '0'}' AS INT)\n    \n    SET @CONTA_CONTABIL = CAST('${c.cliente.conta_contabil || 'NULL'}' AS VARCHAR(20)) \n    SET @CNPJ = CAST('${c.cliente.cnpj || 'NULL'}' AS VARCHAR(20))\n    SET @INSCRICAO = CAST('${c.cliente.inscricao || 'NULL'}' AS VARCHAR(14))\n    SET @FANTASIA = CAST('${c.cliente.fantasia || 'NULL'}' AS VARCHAR(30))\n    SET @NOME = CAST('${c.cliente.nome || 'NULL'}' AS VARCHAR(100))\n    SET @LOGRADOURO = CAST('${c.cliente.logradouro || 'NULL'}' AS VARCHAR(5))\n    SET @ENDERECO = CAST('${c.cliente.endereco || 'NULL'}' AS VARCHAR(50))\n    SET @NUMERO = CAST('${c.cliente.numero || 'NULL'}' AS VARCHAR(10))\n    SET @COMPLEMENTO = CAST('${c.cliente.complemento || 'NULL'}' AS VARCHAR(20))\n    SET @BAIRRO = CAST('${c.cliente.bairro || 'NULL'}' AS VARCHAR(30))\n    SET @MUNICIPIO = CAST('${c.cliente.municipio || '0'}' AS INT)\n    SET @CIDADE = CAST('${c.cliente.cidade || 'NULL'}' AS VARCHAR(20))\n    SET @CEP = CAST('${c.cliente.CEP || 'NULL'}' AS CHAR(9))\n    SET @UF = CAST('${c.cliente.UF || 'NULL'}' AS CHAR(2))\n    SET @DDD = CAST('${c.cliente.ddd || 'NULL'}' AS VARCHAR(3))\n    SET @TELEFONE = CAST('${c.cliente.telefone || 'NULL'}' AS VARCHAR(15))\n    SET @CONTATO = CAST('${c.cliente.contato || 'NULL'}' AS VARCHAR(20))\n    \n    SET @PARCELA = CAST('${p.parcela || '0'}' AS INT)\n    SET @FORMA_PAGTO = CAST('${p.forma_pagto || 'NULL'}' AS VARCHAR(10))\n    SET @TIPO_VENCTO = CAST('${p.tipo_vencto || 'NULL'}' AS VARCHAR(3))\n    SET @VENCTO = CAST('${p.vencto || 'NULL'}' AS DATE)\n    SET @PRAZO = CAST('${p.prazo || '0'}' AS INT)\n    SET @VALOR = CAST('${p.valor || '0'}' AS MONEY)\n    SET @ORIGEM = CAST('${p.origem || 'NULL'}' AS VARCHAR(10))\n    \n    INSERT INTO COB (nosso_numero, parcela, carteira, remessa, retorno, situacao, conta_contabil, forma_pagto, tipo_vencto, vencto, prazo, valor, origem, cnpj, inscricao, fantasia, nome, logradouro, endereco, numero, complemento, bairro, municipio, cidade, cep, uf, ddd, telefone, contato)\n    VALUES (@NOSSO_NUMERO, @PARCELA, @CARTEIRA, GETDATE(), NULL, NULL, @CONTA_CONTABIL, @FORMA_PAGTO, @TIPO_VENCTO, @VENCTO, @PRAZO, @VALOR, @ORIGEM, @CNPJ, @INSCRICAO, @FANTASIA, @NOME, @LOGRADOURO, @ENDERECO, @NUMERO, @COMPLEMENTO, @BAIRRO, @MUNICIPIO, @CIDADE, @CEP, @UF, @DDD, @TELEFONE, @CONTATO)\n    \n    UPDATE CRT SET\n       remessa = remessa + @VALOR\n    WHERE id = @CARTEIRA\n\n`\n    , '')\n\n, '') +\n\n(msg.payload.documento.cobranca.find( (c) => c.parcelas.find( (p) => !p.selected && !p.carteira) ) ?\n\n`\n    ----------------------- TAREFA AINDA PENDENTE, RECRIA A TAREFA -----------------------\n    SELECT TOP 1 @PROX_TAREFA = id, @PROX_TAREFA_VERSAO = versao FROM TRF WHERE nome = '${tarefa_atual.nome}' AND concluido IS NULL\n\n    IF @PROX_TAREFA IS NULL\n    BEGIN\n\n        SET @PROX_TAREFA = NEXT VALUE FOR tarefa_seq\n\n        INSERT INTO TRF\n            (id,\n            nome,\n            titulo,\n            descricao,\n            detalhes,\n            documento,\n            atribuir,\n            form,\n            parametros,\n            prazo,\n            criado,\n            concluido)\n        VALUES\n            (@PROX_TAREFA,\n            '${tarefa_atual.nome}',\n            '${tarefa_atual.titulo}',\n            'Saldo R$ ${msg.payload.documento.cobranca.reduce( (total, c) => total + c.parcelas.filter( (p) => !p.selected && !p.carteira).reduce( (soma, p) => soma + p.valor, 0.0), 0.0).toFixed(2).replace('.', ',')}',\n            '',\n            '${tarefa_atual.documento}',\n            '${tarefa_atual.atribuir}',\n            '${tarefa_atual.form}',\n            NULL,\n            NULL,\n            GETDATE(),\n            NULL)\n\n        SET @NOVA_NAV = NEXT VALUE FOR tarefa_nav_seq\n\n        INSERT TRFN (transacao, tarefa_origem, tarefa_destino) VALUES (NEXT VALUE FOR tarefa_nav_seq, @TAREFA_ATUAL, @PROX_TAREFA)\n\n        INSERT INTO @TRF SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/nova/' + LTRIM(RTRIM(atribuir)) AS topico FROM TRF WHERE id = @PROX_TAREFA\n\n    END\n    ELSE\n    BEGIN\n\n        UPDATE TRF SET\n            descricao = 'Saldo R$${msg.payload.documento.cobranca.reduce( (total, c) => total + c.parcelas.filter( (p) => !p.selected && !p.carteira).reduce( (soma, p) => soma + p.valor, 0.0), 0.0).toFixed(2).replace('.', ',')}',\n            documento = '${tarefa_atual.documento}'\n        WHERE\n            id = @PROX_TAREFA\n            AND versao = @PROX_TAREFA_VERSAO\n\n        IF @@ROWCOUNT != 1\n        BEGIN\n\n            ROLLBACK TRANSACTION\n\n            SELECT TOP 1 @ULTIMA_VERSAO = versao, @CONCLUIDO = concluido FROM TRF WHERE id = @TAREFA_ATUAL\n\n            IF (NOT @CONCLUIDO IS NULL)\n            BEGIN\n                INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7010\n                SELECT * FROM ERR WHERE erro = 7010\n            END\n            ELSE IF (@ULTIMA_VERSAO <> @VERSAO)\n            BEGIN\n                INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7450\n                SELECT * FROM ERR WHERE erro = 7450\n            END\n\n            RETURN\n        END\n\n        INSERT INTO @TRF SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/atualizada/' + LTRIM(RTRIM(atribuir)) AS topico FROM TRF WHERE id = @PROX_TAREFA\n\n    END\n`\n\n:\n\n`\n   -- tarefa finalizada e nenhuma tarefa nova criada --\n`\n\n) +\n\n(msg.payload.documento.cobranca.find( (c) => c.parcelas.find( (p) => p.selected && !p.carteira) ) ?\n\n`\n   -------------------------- PROXIMA TAREFA - REMESSA -----------------------\n\n    SET @PROX_TAREFA = NEXT VALUE FOR tarefa_seq\n\n    INSERT INTO TRF\n        (id,\n        nome,\n        titulo,\n        descricao,\n        detalhes,\n        documento,\n        atribuir,\n        form,\n        parametros,\n        prazo,\n        criado,\n        concluido)\n    VALUES\n        (@PROX_TAREFA,\n        '${tarefa_remessa.nome}',\n        '${tarefa_remessa.titulo}',\n        '${tarefa_remessa.descricao}',\n        '',\n        '${tarefa_remessa.documento}',\n        '${tarefa_remessa.atribuir}',\n        '${tarefa_remessa.form}',\n        NULL,\n        NULL,\n        GETDATE(),\n        NULL)\n\n    SET @NOVA_NAV = NEXT VALUE FOR tarefa_nav_seq\n\n    INSERT TRFN (transacao, tarefa_origem, tarefa_destino) VALUES (NEXT VALUE FOR tarefa_nav_seq, @TAREFA_ATUAL, @PROX_TAREFA)\n\n    INSERT INTO @TRF SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/nova/' + LTRIM(RTRIM(atribuir)) AS topico FROM TRF WHERE id = @PROX_TAREFA\n`\n\n:\n\n`\n    -- tarefa finalizada e nenhuma tarefa nova criada --\n`\n\n) +\n\n`\n    COMMIT TRANSACTION\n\nEND TRY\nBEGIN CATCH\n\n    DECLARE @ERR_ID INT\n    DECLARE @ERROR_NUMBER INT\n    DECLARE @ERROR_SEVERITY INT\n    DECLARE @ERROR_STATE INT\n    DECLARE @ERROR_PROCEDURE INT\n    DECLARE @ERROR_LINE INT\n    DECLARE @ERROR_MESSAGE INT\n\n    SET @ERROR_NUMBER = ERROR_NUMBER()\n    SET @ERROR_SEVERITY = ERROR_SEVERITY()\n    SET @ERROR_STATE = ERROR_STATE()\n    SET @ERROR_PROCEDURE = ERROR_PROCEDURE()\n    SET @ERROR_LINE = ERROR_LINE()\n    SET @ERROR_MESSAGE = ERROR_MESSAGE()\n\n    ROLLBACK TRANSACTION\n\n    SET @ERR_ID = NEXT VALUE FOR err_log_seq\n    INSERT INTO err_log SELECT @ERR_ID AS id, @ERROR_NUMBER AS erro, @ERROR_SEVERITY AS nivel, @ERROR_STATE AS situacao, @ERROR_PROCEDURE AS procedimento, @ERROR_LINE AS linha, @ERROR_MESSAGE AS mensagem\n\n    SELECT * FROM err_log WHERE id = @ERR_ID\n\n    RETURN\nEND CATCH\n\nSELECT * FROM @TRF\n`\n\nreturn msg;","outputs":"1","noerr":0,"x":350,"y":760,"wires":[["bc094448.4c3b98"]]},{"id":"bc094448.4c3b98","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"MSSQL","query":"","outField":"payload","x":580,"y":760,"wires":[["3c3c527e.2f99ee"]]},{"id":"868362a7.8380e","type":"function","z":"8364cdd3.e51ef","name":"","func":"msg.payload = [ { \"id\": 1339, \"nome\": \"Lançamentos a Receber\", \"titulo\": \"Pedido 74782\", \"descricao\": \"CERAMICA VELAS DE IGNICAO NGK BRASIL LTDA\", \"atribuir\": \"faturamento\", \"form\": \"/recebiveis/lancamento/\", \"parametros\": null, \"prazo\": null, \"criado\": \"2016-12-09T09:38:59.156Z\", \"concluido\": \"2016-12-09T09:39:21.036Z\" }, { \"id\": 1340, \"nome\": \"Cobrança Bancária\", \"titulo\": \"Gerar Remessa de Cobrança\", \"descricao\": \"\", \"atribuir\": \"financeiro\", \"form\": \"/recebiveis/cobranca/\", \"parametros\": null, \"prazo\": null, \"criado\": \"2016-12-09T09:39:21.036Z\", \"concluido\": null } ]\nif (Array.isArray(msg.payload) && msg.payload.length > 0 && msg.payload[0].erro === undefined) {\n    \n    var payload = msg.payload;\n    msg.payload = {erro: 0, mensagem: 'Tarefa concluida com sucesso !'};\n    \n    var msgs = []\n    \n    msgs.push(msg);\n    \n    msgs.push({\n        topic: '/tarefas/concluida/' + payload[0].atribuir,\n        payload: payload[0]\n    });\n\n    if (msg.payload.length > 1) {\n        msgs.push({\n            topic: '/tarefas/nova/' + payload[1].atribuir,\n            payload: payload[1]\n        })\n    }\n    \n    return msgs;\n    \n} else {\n    msg.statusCode = 500;\n    msg.payload = msg.payload[0];\n    return [msg, null, null]\n}\n","outputs":"3","noerr":0,"x":350,"y":1160,"wires":[["eac487c2.e4fd18"],["c6c0af7e.74a3b"],["8a232cb9.48858"]]},{"id":"eac487c2.e4fd18","type":"debug","z":"8364cdd3.e51ef","name":"","active":true,"console":"false","complete":"payload","x":550,"y":1120,"wires":[]},{"id":"73b8ee1b.e494f","type":"inject","z":"8364cdd3.e51ef","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":140,"y":1160,"wires":[["868362a7.8380e"]]},{"id":"c6c0af7e.74a3b","type":"debug","z":"8364cdd3.e51ef","name":"","active":true,"console":"false","complete":"payload","x":550,"y":1160,"wires":[]},{"id":"8a232cb9.48858","type":"debug","z":"8364cdd3.e51ef","name":"","active":true,"console":"false","complete":"payload","x":550,"y":1200,"wires":[]},{"id":"ad624c77.f90af","type":"function","z":"8364cdd3.e51ef","name":"tarefa","func":"msg.topic = msg.payload.topico;\n\nreturn msg;","outputs":1,"noerr":0,"x":1210,"y":780,"wires":[["ed44d050.6c7bd","aa2f6b5e.bfa938"]]},{"id":"3029d409.f846ac","type":"split","z":"8364cdd3.e51ef","name":"","splt":"\\n","x":1050,"y":780,"wires":[["ad624c77.f90af"]]},{"id":"98448223.15c58","type":"function","z":"8364cdd3.e51ef","name":"erro","func":"msg.statusCode = 500;\n\nif (Array.isArray(msg.payload) && msg.payload.length > 0) {\n    msg.payload = msg.payload[0];    \n} else {\n    msg.payload = {erro: 9999, mensagem: 'Ocorreu um erro ao executar a sua solicitação.'}\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1050,"y":820,"wires":[["f8c2fa62.c010c8","d228cf2c.9c552"]]},{"id":"f8c2fa62.c010c8","type":"http response","z":"8364cdd3.e51ef","name":"","x":1210,"y":820,"wires":[]},{"id":"aa2f6b5e.bfa938","type":"debug","z":"8364cdd3.e51ef","name":"","active":false,"console":"false","complete":"payload","x":1390,"y":840,"wires":[]},{"id":"bb43e898.60ca18","type":"function","z":"8364cdd3.e51ef","name":"","func":"msg.payload = {\n  \"id\": 1307,\n  \"nome\": \"Lançamentos a Receber\",\n  \"titulo\": \"Pedido 74749\",\n  \"concluido\": null,\n  \"versao\": {\n    \"type\": \"Buffer\",\n    \"data\": [\n      0,\n      0,\n      0,\n      0,\n      0,\n      0,\n      8,\n      10\n    ]\n  }\n}\nvar str = String.fromCharCode.apply(null, msg.payload.versao.data);\n    \nmsg.payload.buffer = str;\n\nreturn msg;\n","outputs":"1","noerr":0,"x":970,"y":1160,"wires":[["ef7a9db7.1cbc4"]]},{"id":"8b3d3c2f.2b4c2","type":"inject","z":"8364cdd3.e51ef","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":780,"y":1160,"wires":[["bb43e898.60ca18"]]},{"id":"ef7a9db7.1cbc4","type":"debug","z":"8364cdd3.e51ef","name":"","active":true,"console":"false","complete":"payload","x":1190,"y":1160,"wires":[]},{"id":"d228cf2c.9c552","type":"debug","z":"8364cdd3.e51ef","name":"","active":false,"console":"false","complete":"payload","x":1230,"y":880,"wires":[]},{"id":"d2429897.7a4338","type":"http response","z":"8364cdd3.e51ef","name":"","x":630,"y":960,"wires":[]},{"id":"391ac67e.88e51a","type":"catch","z":"8364cdd3.e51ef","name":"","scope":null,"x":240,"y":980,"wires":[["dfe50827.9aa608","c41d6a42.f218a8"]]},{"id":"dfe50827.9aa608","type":"debug","z":"8364cdd3.e51ef","name":"","active":true,"console":"false","complete":"payload.documento.cobranca","x":540,"y":1000,"wires":[]},{"id":"c41d6a42.f218a8","type":"function","z":"8364cdd3.e51ef","name":"erro","func":"msg.statusCode = 500;\n\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":960,"wires":[["d2429897.7a4338"]]},{"id":"429cad82.1813c4","type":"mqtt out","z":"8364cdd3.e51ef","name":"","topic":"","qos":"","retain":"","broker":"404ac8f7.f80bb8","x":2790,"y":820,"wires":[]},{"id":"55694903.217c88","type":"function","z":"8364cdd3.e51ef","name":"NOTIFY","func":"msg.payload = msg.payload[0]\nmsg.topic = '/tarefas/nova/' + msg.payload.atribuir\nreturn msg;","outputs":1,"noerr":0,"x":2600,"y":820,"wires":[["429cad82.1813c4","8819777.8a8d688"]]},{"id":"cc99817c.51d75","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"","query":"","outField":"payload","x":2420,"y":820,"wires":[["55694903.217c88"]]},{"id":"31532b55.47ef94","type":"function","z":"8364cdd3.e51ef","name":"TAREFA","func":"\nmsg.payload = \n\"DECLARE @ID INT \"+\n\"SET @ID = NEXT VALUE FOR tarefa_seq \" +\n\"INSERT INTO TRF \" +\n\"   (id, \" +\n\"   nome, \" +\n\"   titulo, \" +\n\"   descricao, \" +\n\"   documento, \" +\n\"   atribuir, \" +\n\"   form, \" +\n\"   parametros, \" +\n\"   prazo, \" +\n\"   criado, \" +\n\"   concluido) \" +\n\"VALUES \" +\n\"   (@ID, \" +\n\"   '\" + msg.payload.nome + \"', \" +\n\"   '\" + msg.payload.titulo + \"', \" +\n\"   '\" + msg.payload.descricao + \"', \" +\n\"   '\" + msg.payload.documento + \"', \" + \n\"   '\" + msg.payload.atribuir + \"', \" +\n\"   '\" + msg.payload.form + \"', \" +\n\"   NULL, \" +\n\"   NULL, \" +\n\"   GETDATE(), \" +\n\"   NULL);\" +\n\n\"SELECT \" +\n\"   id, \" +\n\"   nome, \" +\n\"   titulo, \" +\n\"   descricao, \" +\n//\"   conteudo, \" +\n\"   atribuir, \" +\n\"   form, \" +\n\"   parametros, \" +\n\"   prazo, \" +\n\"   criado, \" +\n\"   concluido \" +\n\"FROM TRF \" + \n\"WHERE id = @ID;\"\n\nreturn msg;","outputs":1,"noerr":0,"x":2240,"y":820,"wires":[["cc99817c.51d75"]]},{"id":"528a8fde.6e2a2","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"6320d365.b00b9c","name":"MSSQL","query":"","outField":"payload","x":2050,"y":700,"wires":[["ca1db524.1e7b48"]]},{"id":"9d0ee6fe.6521a8","type":"function","z":"8364cdd3.e51ef","name":"PARCELAS","func":"msg.local.representante = msg.payload[0];\nmsg.payload = \n\"SELECT \" +\n//\"   LPV.LPPED AS nosso_numero, \" +\n\"   DATEADD(d, CACPG1.CCPg1Dia, CASE WHEN CACPG1.CCPg1DiaTip = 'DDP' THEN CAST(LPV.LPENT AS DATE) ELSE CAST(LPV.Lp0SaiRed AS DATE) END) AS vencto, \" +\n\"   'VENDA' AS origem, \" +\n\"   'COBRANCA' AS forma_pagto, \" +\n\"   CACPG1.CCPg1DiaTip AS tipo_vencto, \" +\n\"   CACPG1.CCPg1Seq AS parcela, \" +\n\"   CACPG1.CCPg1Dia AS prazo, \" +\n//\"   CACPG1.CCPg1Por AS porcentagem, \" +\n//\"   CACPG1.CCPg1Cod AS descricao, \" +\n\"   CAST(LPV1.total * (CACPG1.CCPg1Por / 100) AS money) AS valor \" +\n\"FROM \" +\n\"   GPIMAC_Altamira.dbo.LPV AS LPV INNER JOIN GPIMAC_Altamira.dbo.CACPG1 ON LPV.LPPAG = GPIMAC_Altamira.dbo.CACPG1.CPCOD \" +\n\"   LEFT OUTER JOIN \" +\n\"   (SELECT \" +\n\"       LPPED,  \" +\n\"       CAST(SUM(LPQUA * LPPRE) AS MONEY) AS total_produtos, \" +\n\"       CAST(SUM((LPQUA * LPPRE) * (LPIPI / 100)) AS MONEY) AS total_ipi, \" +\n\"       CAST(SUM(LPQUA * LPPRE + (LPQUA * LPPRE) * (LPIPI / 100)) AS MONEY) AS total \" +\n\"   FROM \" +\n\"       GPIMAC_Altamira.dbo.LPV1 AS LPV1_1 \" +\n\"   GROUP BY \" +\n\"       LPPED) AS LPV1 ON LPV.LPPED = LPV1.LPPED \" +\n\"WHERE \" +\n\"   LPV.LPPED = \" + msg.local.numero + \" \" +\n\"ORDER BY CACPG1.CCPg1Seq\"\n\nreturn msg;","outputs":1,"noerr":0,"x":2050,"y":640,"wires":[["528a8fde.6e2a2"]]},{"id":"6908c249.eaed1c","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"6320d365.b00b9c","name":"MSSQL","query":"","outField":"payload","x":2050,"y":160,"wires":[["400f4b93.4482d4"]]},{"id":"c11a0be3.fe6518","type":"function","z":"8364cdd3.e51ef","name":"PEDIDO","func":"msg.params = msg.payload;\nmsg.payload = \n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = \" + (msg.params || 'NULL') + \" \" +\n\"SELECT \" +\n\"\tLTRIM(RTRIM(LPV.LPEMP))     AS empresa, \" +\n\"\tCAST(LPV.LPPED AS INT)      AS numero, \" +\n\"   LPV.LPENT                   AS emissao, \" +\n\"\tLPV.Lp0SaiRed               AS entrega, \" +\n\"   LTRIM(RTRIM(LPV.CCCGC))\t    AS cliente, \" +\n\"\tLPV.LPPAG\t                AS condicao, \" + \n\"\tLPV.LPVEN\t\t\t\t    AS representante, \" + \n\"\tLPV.LpCom / 100\t\t\t\tAS comissao \" +\n\"FROM \" +\n\"\tGPIMAC_Altamira.dbo.LPV WITH (NOLOCK) \" +\n\"   LEFT OUTER JOIN \" +\n\"   (SELECT \" +\n\"    \tLPPED, \" + \n\"\t\tCAST(SUM(LPQUA * LPPRE) AS MONEY) AS valor_produtos,  \" +\n\"\t\tCAST(SUM((LPQUA * LPPRE) * (LPIPI / 100)) AS MONEY) AS valor_ipi,  \" +\n\"\t\tCAST(SUM(LPQUA * LPPRE + (LPQUA * LPPRE) * (LPIPI / 100)) AS MONEY) AS valor_pedido \" +\n\"\tFROM \" +\n\"\t\tGPIMAC_Altamira.dbo.LPV1 AS LPV1_1 \" +\n\"\tGROUP BY \" +\n\"\t\tLPPED) AS LPV1 ON LPV.LPPED = LPV1.LPPED \" +\n\"WHERE \" +\n\"   LPV.LPPED = @PEDIDO\"\n\nreturn msg;","outputs":1,"noerr":0,"x":2040,"y":100,"wires":[["6908c249.eaed1c"]]},{"id":"26eb9963.ac0296","type":"function","z":"8364cdd3.e51ef","name":"CLIENTE","func":"msg.local.totais = msg.payload[0];\nmsg.payload = \n\"DECLARE @CLIENTE NVARCHAR(20) \" +\n\"SET @CLIENTE = \" + (\"'\" + msg.local.cliente + \"'\" || 'NULL') + \" \" +\n\"SELECT \" +\n\"\tLTRIM(RTRIM(CACLI.CCCGC))                               AS cnpj, \" +\n\"   LTRIM(RTRIM(CACLI.CCINS))                               AS inscricao, \" +\n\"\tREPLACE(LTRIM(RTRIM(CACLI.CCFAN)), '''', '')            AS fantasia, \" +\n\"\tREPLACE(LTRIM(RTRIM(CACLI.CCNOM)), '''', '')            AS nome, \" +\n\"   REPLACE(LTRIM(RTRIM(CACLI.CCLogTip0CodC)), '''', '')    AS logradouro, \" +\n\"   REPLACE(LTRIM(RTRIM(CACLI.CCCEN)), '''', '')            AS endereco, \" +\n\"   LTRIM(RTRIM(CACLI.CCCENNum))                            AS numero, \" +\n\"   REPLACE(LTRIM(RTRIM(CACLI.CCCENCpl)), '''', '')         AS complemento, \" +\n\"   LTRIM(RTRIM(CACLI.CCCBA))                               AS bairro, \" +\n\"   CACLI.CCCCIIBGECOD                                      AS municipio, \" +\n\"   LTRIM(RTRIM(CACLI.CCCCI))                               AS cidade, \" +\n\"   LTRIM(RTRIM(CACLI.CCCcEP))                              AS CEP, \" +\n\"   LTRIM(RTRIM(CACLI.CCCES))                               AS UF, \" +\n\"   LTRIM(RTRIM(CACLI.CCDD5))                               AS ddd, \" +\n\"   LTRIM(RTRIM(CACLI.CCtFO3))                              AS telefone, \" +\n\"   REPLACE(LTRIM(RTRIM(CACLI.CCCO1)), '''', '')            AS contato, \" +\n\"   LTRIM(RTRIM(CACLI.CCCL))                                AS conta_contabil \" +\n\"FROM \" +\n\"   GPIMAC_Altamira.dbo.CACLI WITH (NOLOCK) \" +\n\"WHERE \" +\n\"   CACLI.CCCGC = @CLIENTE;\"\n\nreturn msg;","outputs":1,"noerr":0,"x":2040,"y":400,"wires":[["408a5fb0.940d8"]]},{"id":"408a5fb0.940d8","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"6320d365.b00b9c","name":"MSSQL","query":"","outField":"payload","x":2050,"y":460,"wires":[["c6bfa49b.9fe458"]]},{"id":"c6bfa49b.9fe458","type":"function","z":"8364cdd3.e51ef","name":"REPRESENTANTE","func":"msg.local.cliente = msg.payload[0];\nmsg.payload = \n\"DECLARE @REPRESENTANTE NVARCHAR(20) \" +\n\"SET @REPRESENTANTE = \" + (\"'\" + msg.local.representante + \"'\" || 'NULL') + \" \" +\n\"SELECT \" +\n\"   LTRIM(RTRIM(CAREP.CVCOD)) AS codigo, \" +\n\"   LTRIM(RTRIM(CAREP.CVNOM)) AS nome \" +\n\"FROM \" +\n\"   GPIMAC_Altamira.dbo.CAREP WITH (NOLOCK) \" +\n\"WHERE \" +\n\"   CAREP.CVCOD = @REPRESENTANTE\"\n\nreturn msg;","outputs":1,"noerr":0,"x":2070,"y":520,"wires":[["6b412b14.283fd4"]]},{"id":"6b412b14.283fd4","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"6320d365.b00b9c","name":"MSSQL","query":"","outField":"payload","x":2050,"y":580,"wires":[["9d0ee6fe.6521a8"]]},{"id":"f3ad2a9d.fb8178","type":"function","z":"8364cdd3.e51ef","name":"TOTAIS","func":"msg.local = msg.payload;\nmsg.payload = \n\"DECLARE @PEDIDO INT \" +\n\"SET @PEDIDO = \" + (msg.local.numero || 'NULL') + \" \" +\n\"SELECT \" +\n\"\tLPV1.produtos, \" + \n\"\tLPV1.ipi, \" +\n\"\tLPV1.total \" +\n\"FROM \" +\n\"\tGPIMAC_Altamira.dbo.LPV WITH (NOLOCK) \" +\n\"   LEFT OUTER JOIN \" +\n\"   (SELECT \" +\n\"    \tLPPED, \" + \n\"\t\tCAST(SUM(LPQUA * LPPRE) AS MONEY) AS produtos,  \" +\n\"\t\tCAST(SUM((LPQUA * LPPRE) * (LPIPI / 100)) AS MONEY) AS ipi,  \" +\n\"\t\tCAST(SUM(LPQUA * LPPRE + (LPQUA * LPPRE) * (LPIPI / 100)) AS MONEY) AS total \" +\n\"\tFROM \" +\n\"\t\tGPIMAC_Altamira.dbo.LPV1 AS LPV1_1 \" +\n\"\tGROUP BY \" +\n\"\t\tLPPED) AS LPV1 ON LPV.LPPED = LPV1.LPPED \" +\n\"WHERE \" +\n\"   LPV.LPPED = @PEDIDO\"\n\nreturn msg;\n","outputs":1,"noerr":0,"x":2040,"y":280,"wires":[["1c3012e8.76649d"]]},{"id":"1c3012e8.76649d","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"6320d365.b00b9c","name":"MSSQL","query":"","outField":"payload","x":2050,"y":340,"wires":[["26eb9963.ac0296"]]},{"id":"ca1db524.1e7b48","type":"function","z":"8364cdd3.e51ef","name":"RETURN","func":"msg.local.parcelas = msg.payload;\n\nmsg.payload = msg.local;\n\n//delete msg.local;\n\nreturn msg;","outputs":1,"noerr":0,"x":2040,"y":760,"wires":[["14d85b68.42fa15"]]},{"id":"400f4b93.4482d4","type":"function","z":"8364cdd3.e51ef","name":"EXISTE ?","func":"if (!Array.isArray(msg.payload) || msg.payload.length === 0) {\n    msg.payload = 'PEDIDO NÃO ENCONTRADO: ' + msg.params;\n    return [msg, null]; // NAO EXISTE\n} else {\n    msg.payload = msg.payload[0];\n    return [null, msg]; // ENCONTRADO\n} ","outputs":"2","noerr":0,"x":2040,"y":220,"wires":[["300d4f6f.467f4"],["f3ad2a9d.fb8178"]]},{"id":"43ed355d.7525fc","type":"http in","z":"8364cdd3.e51ef","name":"remessa","url":"/api/financeiro/recebiveis/remessa/tarefa/:tarefa","method":"post","swaggerDoc":"","x":100,"y":820,"wires":[["7e5e3d00.919844"]]},{"id":"7e5e3d00.919844","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"var tarefa_retorno = \n{\n    nome: 'Retorno de Cobrança',\n    titulo: msg.payload.documento.carteira.nome,\n    descricao: 'Total R$ ' + msg.payload.documento.remessa.reduce( (total, c) => total + c.parcelas.reduce( (soma, p) => soma + p.valor, 0), 0).toFixed(2).replace('.', ','), \n    documento: JSON.stringify({ \n        \n        carteira: msg.payload.documento.carteira,\n        data: new Date().toISOString(),\n        \n        retorno: msg.payload.documento.remessa.map( c => {\n            var cobranca = {\n                nosso_numero: c.nosso_numero,\n                pedido: c.pedido,\n                cliente: c.cliente,\n                parcelas: c.parcelas.map( (p) => {\n                \n                    var parcela = {\n                        vencto: p.vencto,\n                        origem: p.origem,\n                        forma_pagto: p.forma_pagto,\n                        tipo_vencto: p.tipo_vencto,\n                        parcela: p.parcela,\n                        prazo: p.prazo,\n                        valor: p.valor\n                    }\n                    \n                    parcela.carteira = p.carteira;\n                    parcela.data = p.data;\n\n                    return parcela;\n                    \n                })\n            };\n            \n            return cobranca;\n        })\n        \n    }),\n    atribuir: 'cobranca',\n    form: '/recebiveis/retorno/'\n}\n\nmsg.payload = `\n\nSET NOCOUNT ON\n\nDECLARE @REMESSA INT\nDECLARE @NOSSO_NUMERO INT\nDECLARE @PARCELA INT\nDECLARE @CARTEIRA INT\n\nDECLARE @VALOR_TITULOS MONEY\nDECLARE @VALOR_LIQUIDO MONEY\nDECLARE @VALOR_OPERACAO MONEY\nDECLARE @VALOR_TARIFA MONEY\nDECLARE @VALOR_JUROS MONEY\nDECLARE @VALOR_IOF MONEY\nDECLARE @TAXA_JUROS DECIMAL(18,2)\n\nDECLARE @FORMA_PAGTO VARCHAR(10)\nDECLARE @TIPO_VENCTO VARCHAR(3)\nDECLARE @VENCTO DATE\nDECLARE @PRAZO INT\nDECLARE @VALOR MONEY\n\nDECLARE @TAREFA_ATUAL INT\nDECLARE @VERSAO INT\n\nDECLARE @NOVA_TAREFA INT\n\nDECLARE @ULTIMA_VERSAO INT\nDECLARE @CONCLUIDO DATETIME\n\nDECLARE @PROX_TAREFA INT\nDECLARE @PROX_TAREFA_VERSAO INT\n\nDECLARE @NOVA_NAV INT\n\nDECLARE @TRF TABLE (\n    [id] [int] NOT NULL,\n\t[nome] [nvarchar](100) NOT NULL,\n\t[titulo] [nvarchar](50) NULL,\n\t[descricao] [nvarchar](50) NULL,\n\t[atribuir] [nvarchar](50) NULL,\n\t[form] [nvarchar](100) NOT NULL,\n\t[parametros] [nvarchar](max) NULL,\n\t[prazo] [datetime] NULL,\n\t[criado] [datetime] NOT NULL,\n\t[concluido] [datetime] NULL,\n\t[versao] [int],\n\t[topico] [nvarchar](100) NOT NULL)\n\nBEGIN TRY\n    BEGIN TRANSACTION\n\n    -------------------------------------- ATUALIZACAO DAS TAREFAS ----------------------------------------------\n    SET @TAREFA_ATUAL =  CAST('${parseInt(msg.req.params.tarefa) || 'NULL'}' AS INT)\n    SET @VERSAO = CAST('${msg.payload.versao || 'NULL'}' AS INT)\n\n    UPDATE TRF SET\n\t    concluido = GETDATE()\n    WHERE\n        id = @TAREFA_ATUAL\n        AND concluido IS NULL\n        AND versao = @VERSAO\n\n    IF @@ROWCOUNT != 1\n    BEGIN\n\n        ROLLBACK TRANSACTION\n\n        SELECT TOP 1 @ULTIMA_VERSAO = versao, @CONCLUIDO = concluido FROM TRF WHERE id = @TAREFA_ATUAL\n\n        IF (NOT @CONCLUIDO IS NULL)\n        BEGIN\n            INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7010\n            SELECT * FROM ERR WHERE erro = 7010\n        END\n        ELSE IF (@ULTIMA_VERSAO <> @VERSAO)\n        BEGIN\n            INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7450\n            SELECT * FROM ERR WHERE erro = 7450\n        END\n\n        RETURN\n    END\n\n    INSERT INTO @TRF SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/concluida/' + LTRIM(RTRIM(atribuir)) AS topico FROM TRF WHERE id = @TAREFA_ATUAL\n\n    ---------------------------------------------------- cabecalho da remessa ----------------------------------------------------\n    SET @VALOR_TITULOS = CAST('${msg.payload.documento.bordero.valor_titulos || '0'}' AS MONEY) \n    SET @VALOR_LIQUIDO = CAST('${msg.payload.documento.bordero.valor_liquido || '0'}' AS MONEY)\n    SET @VALOR_OPERACAO = CAST('${msg.payload.documento.bordero.valor_operacao || '0'}' AS MONEY)\n    SET @VALOR_TARIFA = CAST('${msg.payload.documento.bordero.valor_tarifa || '0'}' AS MONEY)\n    SET @VALOR_JUROS = CAST('${msg.payload.documento.bordero.valor_juros || '0'}' AS MONEY)\n    SET @VALOR_IOF = CAST('${msg.payload.documento.bordero.valor_iof || '0'}' AS MONEY)\n    SET @TAXA_JUROS = CAST('${msg.payload.documento.bordero.taxa_juros || '0'}' AS DECIMAL(18,2))\n\n    SET @CARTEIRA = CAST('${msg.payload.documento.carteira.id || '0'}' AS INT)\n\n    SET @REMESSA = NEXT VALUE FOR remessa_seq\n\n    INSERT INTO REM (\n        remessa,\n        carteira,\n        valor_titulos,\n        valor_liquido,\n        valor_operacao,\n        valor_tarifa,\n        valor_iof,\n        valor_juros,\n        taxa_juros)\n    VALUES (\n        @REMESSA,\n        @CARTEIRA,\n        @VALOR_TITULOS,\n        @VALOR_LIQUIDO,\n        @VALOR_OPERACAO,\n        @VALOR_TARIFA,\n        @VALOR_IOF,\n        @VALOR_JUROS,\n        @TAXA_JUROS)\n\n    UPDATE CRT SET\n        utilizado = utilizado + @VALOR_TITULOS,\n        remessa = remessa - @VALOR_TITULOS,\n        retorno = retorno + @VALOR_TITULOS\n    WHERE id = @CARTEIRA\n\n    ---------------------------------------------------- grava as parcelas ----------------------------------------------------\n    ` +\n\nmsg.payload.documento.remessa.reduce( (sql, r) => \n\n    sql + r.parcelas.reduce( (sql, p) => \n    \n        sql + \n    `\n    ----------------------------------------------------------------------------------------------------------\n    -- insere nova parcela => nosso_numero:  + ${r.nosso_numero} + ', parcela: ' + ${p.parcela} + ', carteira: ' + ${msg.payload.documento.carteira.id}\n    ----------------------------------------------------------------------------------------------------------\n    SET @NOSSO_NUMERO = CAST('${r.nosso_numero || '0'}' AS INT)\n    SET @PARCELA = CAST('${p.parcela || '0'}' AS INT)\n    SET @CARTEIRA = CAST('${msg.payload.documento.carteira.id || '0'}' AS INT)\n\n    IF EXISTS(SELECT NOSSO_NUMERO FROM REMD WHERE nosso_numero = @NOSSO_NUMERO AND parcela = @PARCELA AND carteira = @CARTEIRA)\n    BEGIN\n\n        ROLLBACK TRANSACTION\n\n        INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 1123\n        SELECT * FROM ERR WHERE erro = 1123\n\n        RETURN\n    END\n\n    SET @FORMA_PAGTO = CAST('${p.forma_pagto || 'NULL'}' AS VARCHAR(10))\n    SET @TIPO_VENCTO = CAST('${p.tipo_vencto || 'NULL'}' AS VARCHAR(3))\n    SET @VENCTO = CAST('${p.vencto || 'NULL'}' AS DATE)\n    SET @PRAZO = CAST('${p.prazo || '0'}' AS INT)\n    SET @VALOR = CAST('${p.valor || '0'}' AS MONEY)\n\n    INSERT INTO REMD (remessa, nosso_numero, parcela, carteira, forma_pagto, tipo_vencto, vencto, prazo, valor)\n    VALUES (@REMESSA, @NOSSO_NUMERO, @PARCELA, @CARTEIRA, @FORMA_PAGTO, @TIPO_VENCTO, @VENCTO, @PRAZO, @VALOR) \n    \n    `\n    \n    , '')\n\n, '') +\n\n`\n    -------------------------- PROXIMA TAREFA - RETORNO -----------------------\n    \n    SET @PROX_TAREFA = NEXT VALUE FOR tarefa_seq\n    \n    INSERT INTO TRF\n        (id,\n        nome,\n        titulo,\n        descricao,\n        detalhes,\n        documento,\n        atribuir,\n        form,\n        parametros,\n        prazo,\n        criado,\n        concluido)\n    VALUES\n        (@PROX_TAREFA,\n        '${tarefa_retorno.nome}',\n        '${tarefa_retorno.titulo}',\n        '${tarefa_retorno.descricao}',\n        '',\n        '${tarefa_retorno.documento}',\n        '${tarefa_retorno.atribuir}',\n        '${tarefa_retorno.form}',\n        NULL,\n        NULL,\n        GETDATE(),\n        NULL)\n        \n    SET @NOVA_NAV = NEXT VALUE FOR tarefa_nav_seq\n    \n    INSERT TRFN (transacao, tarefa_origem, tarefa_destino) VALUES (NEXT VALUE FOR tarefa_nav_seq, @TAREFA_ATUAL, @PROX_TAREFA)\n    \n    INSERT INTO @TRF SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/nova/' + LTRIM(RTRIM(atribuir)) AS topico FROM TRF WHERE id = @PROX_TAREFA\n    \n    COMMIT TRANSACTION\n\nEND TRY\nBEGIN CATCH\n\n   DECLARE @ERR_ID INT\n   DECLARE @ERROR_NUMBER INT\n   DECLARE @ERROR_SEVERITY INT\n   DECLARE @ERROR_STATE INT\n   DECLARE @ERROR_PROCEDURE INT\n   DECLARE @ERROR_LINE INT\n   DECLARE @ERROR_MESSAGE INT\n\n   SET @ERROR_NUMBER = ERROR_NUMBER()\n   SET @ERROR_SEVERITY = ERROR_SEVERITY()\n   SET @ERROR_STATE = ERROR_STATE()\n   SET @ERROR_PROCEDURE = ERROR_PROCEDURE()\n   SET @ERROR_LINE = ERROR_LINE()\n   SET @ERROR_MESSAGE = ERROR_MESSAGE()\n\n   ROLLBACK TRANSACTION\n\n   SET @ERR_ID = NEXT VALUE FOR err_log_seq\n   INSERT INTO err_log SELECT @ERR_ID AS id, @ERROR_NUMBER AS erro, @ERROR_SEVERITY AS nivel, @ERROR_STATE AS situacao, @ERROR_PROCEDURE AS procedimento, @ERROR_LINE AS linha, @ERROR_MESSAGE AS mensagem\n\n   SELECT * FROM err_log WHERE id = @ERR_ID\n\n   RETURN\nEND CATCH\n\nSELECT * FROM @TRF\n`    \n\nreturn msg;","outputs":"1","noerr":0,"x":350,"y":820,"wires":[["a7389928.c61218"]]},{"id":"a7389928.c61218","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"MSSQL","query":"","outField":"payload","x":580,"y":820,"wires":[["3c3c527e.2f99ee"]]},{"id":"8e66428c.80a45","type":"http in","z":"8364cdd3.e51ef","name":"retorno","url":"/api/financeiro/recebiveis/retorno/tarefa/:tarefa","method":"post","swaggerDoc":"","x":90,"y":880,"wires":[["2bf23b9.7633ac4"]]},{"id":"2bf23b9.7633ac4","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"\nmsg.payload = \n`\nSET NOCOUNT ON\n\nDECLARE @RETORNO INT\nDECLARE @NOSSO_NUMERO INT\nDECLARE @PARCELA INT\nDECLARE @CARTEIRA INT\n\nDECLARE @DATA AS DATE\nDECLARE @VALOR_TITULOS MONEY\nDECLARE @VALOR_LIQUIDO MONEY\nDECLARE @VALOR_OPERACAO MONEY\nDECLARE @VALOR_TARIFA MONEY\nDECLARE @VALOR_JUROS MONEY\nDECLARE @VALOR_IOF MONEY\nDECLARE @TAXA_JUROS DECIMAL(18,2)\n\nDECLARE @FORMA_PAGTO VARCHAR(10)\nDECLARE @TIPO_VENCTO VARCHAR(3)\nDECLARE @VENCTO DATE\nDECLARE @PRAZO INT\nDECLARE @VALOR MONEY\nDECLARE @ACEITO BIT\n\nDECLARE @TAREFA_ATUAL INT\nDECLARE @VERSAO INT\n\nDECLARE @NOVA_TAREFA INT\n\nDECLARE @ULTIMA_VERSAO INT\nDECLARE @CONCLUIDO DATETIME\n\nDECLARE @PROX_TAREFA INT\nDECLARE @PROX_TAREFA_VERSAO INT\n\nDECLARE @NOVA_NAV INT\n\nDECLARE @TRF TABLE (\n    [id] [int] NOT NULL,\n\t[nome] [nvarchar](100) NOT NULL,\n\t[titulo] [nvarchar](50) NULL,\n\t[descricao] [nvarchar](50) NULL,\n\t[atribuir] [nvarchar](50) NULL,\n\t[form] [nvarchar](100) NOT NULL,\n\t[parametros] [nvarchar](max) NULL,\n\t[prazo] [datetime] NULL,\n\t[criado] [datetime] NOT NULL,\n\t[concluido] [datetime] NULL,\n\t[versao] [int],\n\t[topico] [nvarchar](100) NOT NULL)\n\t\nBEGIN TRY\n    BEGIN TRANSACTION\n\n    -------------------------------------- ATUALIZACAO DAS TAREFAS ----------------------------------------------\n    SET @TAREFA_ATUAL =  CAST('${msg.req.params.tarefa || '0'}' AS INT)\n    SET @VERSAO = CAST('${msg.payload.versao || '0'}' AS INT)\n\n    UPDATE TRF SET\n\t    concluido = GETDATE()\n    WHERE\n        id = @TAREFA_ATUAL\n        AND concluido IS NULL\n        AND versao = @VERSAO\n\n    IF @@ROWCOUNT != 1\n    BEGIN\n\n        ROLLBACK TRANSACTION\n\n        SELECT TOP 1 @ULTIMA_VERSAO = versao, @CONCLUIDO = concluido FROM TRF WHERE id = @TAREFA_ATUAL\n\n        IF (NOT @CONCLUIDO IS NULL)\n        BEGIN\n            INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7010\n            SELECT * FROM ERR WHERE erro = 7010\n        END\n        ELSE IF (@ULTIMA_VERSAO <> @VERSAO)\n        BEGIN\n            INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7450\n            SELECT * FROM ERR WHERE erro = 7450\n        END\n\n        RETURN\n    END\n\n    INSERT INTO @TRF SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/concluida/' + LTRIM(RTRIM(atribuir)) AS topico FROM TRF WHERE id = @TAREFA_ATUAL\n\n    ---------------------------------------------------- cabecalho do retorno ----------------------------------------------------\n    SET @VALOR_TITULOS = CAST('${msg.payload.documento.bordero.valor_titulos || '0'}' AS MONEY) \n    SET @VALOR_LIQUIDO = CAST('${msg.payload.documento.bordero.valor_liquido || '0'}' AS MONEY)\n    SET @VALOR_OPERACAO = CAST('${msg.payload.documento.bordero.valor_operacao || '0'}' AS MONEY)\n    SET @VALOR_TARIFA = CAST('${msg.payload.documento.bordero.valor_tarifa || '0'}' AS MONEY)\n    SET @VALOR_JUROS = CAST('${msg.payload.documento.bordero.valor_juros || '0'}' AS MONEY)\n    SET @VALOR_IOF = CAST('${msg.payload.documento.bordero.valor_iof || '0'}' AS MONEY)\n    SET @TAXA_JUROS = CAST('${msg.payload.documento.bordero.taxa_juros || '0'}' AS DECIMAL(18,2))\n\n    SET @CARTEIRA = CAST('${msg.payload.documento.carteira.id || '0'}' AS INT)\n\n    SET @RETORNO = NEXT VALUE FOR retorno_seq\n\n    INSERT INTO RET (\n        retorno,\n        carteira,\n        valor_titulos,\n        valor_liquido,\n        valor_operacao,\n        valor_tarifa,\n        valor_iof,\n        valor_juros,\n        taxa_juros)\n    VALUES (\n        @RETORNO,\n        @CARTEIRA,\n        @VALOR_TITULOS,\n        @VALOR_LIQUIDO,\n        @VALOR_OPERACAO,\n        @VALOR_TARIFA,\n        @VALOR_IOF,\n        @VALOR_JUROS,\n        @TAXA_JUROS)\n\n    SET @CARTEIRA = CAST('${msg.payload.documento.carteira.id || '0'}' AS INT)\n\n    UPDATE CRT SET\n        utilizado = utilizado - @VALOR_TITULOS,\n        retorno = retorno - @VALOR_TITULOS,\n        total_iof = total_iof + @VALOR_IOF,\n        total_juros = total_juros + @VALOR_JUROS,\n        total_tarifas = total_tarifas + @VALOR_TARIFA + @VALOR_OPERACAO,\n        taxa_juros = @TAXA_JUROS\n    WHERE id = @CARTEIRA\n\n    ---------------------------------------------------- grava as parcelas ---------------------------------------------------- \n` +\n    \nmsg.payload.documento.retorno.reduce( (sql, r) => \n\n    sql + r.parcelas.reduce( (sql, p) => \n    \n        sql + \n`\n    ----------------------------------------------------------------------------------------------------------\n    -- insere nova parcela => nosso_numero:  + r.nosso_numero + ', parcela: ' + p.parcela + ', carteira: ' + msg.payload.documento.carteira.id +\n    ----------------------------------------------------------------------------------------------------------\n    SET @NOSSO_NUMERO = CAST('${r.nosso_numero || '0'}' AS INT)\n    SET @PARCELA = CAST('${p.parcela || '0'}' AS INT)\n    SET @CARTEIRA = CAST('${msg.payload.documento.carteira.id || '0'}' AS INT)\n    \n    IF EXISTS(SELECT NOSSO_NUMERO FROM RETD WHERE nosso_numero = @NOSSO_NUMERO AND parcela = @PARCELA AND carteira = @CARTEIRA)\n    BEGIN\n    \n       ROLLBACK TRANSACTION\n    \n       INSERT INTO ERR_LOG (erro, mensagem) SELECT erro, mensagem FROM ERR WHERE erro = 7010\n       SELECT * FROM ERR WHERE erro = 1123\n    \n       RETURN\n    END\n    \n    SET @FORMA_PAGTO = CAST('${p.forma_pagto || 'NULL'}' AS VARCHAR(10))\n    SET @TIPO_VENCTO = CAST('${p.tipo_vencto || 'NULL'}' AS VARCHAR(3))\n    SET @VENCTO = CAST('${p.vencto || 'NULL'}' AS DATE)\n    SET @PRAZO = CAST('${p.prazo || '0'}' AS INT)\n    SET @VALOR = CAST('${p.valor || '0'}' AS MONEY)\n    SET @ACEITO = CAST('${p.aceito || '0'}' AS BIT)\n    \n    INSERT INTO RETD (retorno, nosso_numero, parcela, carteira, forma_pagto, tipo_vencto, vencto, prazo, valor, aceito)\n    VALUES (@RETORNO, @NOSSO_NUMERO, @PARCELA, @CARTEIRA, @FORMA_PAGTO, @TIPO_VENCTO, @VENCTO, @PRAZO, @VALOR, @ACEITO)\n\n`\n\n    , '')\n\n, '') +\n\n/*\n   -------------------------- PROXIMA TAREFA - RETORNO -----------------------\n\n   SET @PROX_TAREFA = NEXT VALUE FOR tarefa_seq\n\n   INSERT INTO TRF\n       (id,\n       nome,\n       titulo,\n       descricao,\n       detalhes,\n       documento,\n       atribuir,\n       form,\n       parametros,\n       prazo,\n       criado,\n       concluido)\n   VALUES\n       (@PROX_TAREFA,\n       ' + tarefa_retorno.nome + ',\n       ' + tarefa_retorno.titulo + ',\n       ' + tarefa_retorno.descricao + ',\n       '',\n       ' + tarefa_retorno.documento + ',\n       ' + tarefa_retorno.atribuir + ',\n       ' + tarefa_retorno.form + ',\n       NULL,\n       NULL,\n       GETDATE(),\n       NULL)\n\n   SET @NOVA_NAV = NEXT VALUE FOR TRFN_seq\n\n   INSERT TRFN (transacao, tarefa_origem, tarefa_destino) VALUES (NEXT VALUE FOR TRFN_seq, @TAREFA_ATUAL, @PROX_TAREFA)\n\n   INSERT INTO @TRF SELECT id, nome, titulo, descricao, atribuir, form, parametros, prazo, criado, concluido, versao, '/tarefas/nova/' + LTRIM(RTRIM(atribuir)) AS topico FROM TRF WHERE id = @PROX_TAREFA\n*/\n\n`\n   COMMIT TRANSACTION\n\nEND TRY\nBEGIN CATCH\n\n   DECLARE @ERR_ID INT\n   DECLARE @ERROR_NUMBER INT\n   DECLARE @ERROR_SEVERITY INT\n   DECLARE @ERROR_STATE INT\n   DECLARE @ERROR_PROCEDURE INT\n   DECLARE @ERROR_LINE INT\n   DECLARE @ERROR_MESSAGE INT\n\n   SET @ERROR_NUMBER = ERROR_NUMBER()\n   SET @ERROR_SEVERITY = ERROR_SEVERITY()\n   SET @ERROR_STATE = ERROR_STATE()\n   SET @ERROR_PROCEDURE = ERROR_PROCEDURE()\n   SET @ERROR_LINE = ERROR_LINE()\n   SET @ERROR_MESSAGE = ERROR_MESSAGE()\n\n   ROLLBACK TRANSACTION\n\n   SET @ERR_ID = NEXT VALUE FOR err_log_seq\n   INSERT INTO err_log SELECT @ERR_ID AS id, @ERROR_NUMBER AS erro, @ERROR_SEVERITY AS nivel, @ERROR_STATE AS situacao, @ERROR_PROCEDURE AS procedimento, @ERROR_LINE AS linha, @ERROR_MESSAGE AS mensagem\n\n   SELECT * FROM err_log WHERE id = @ERR_ID\n\n   RETURN\nEND CATCH\n\nSELECT * FROM @TRF\n\n`\n\nreturn msg;","outputs":"1","noerr":0,"x":350,"y":880,"wires":[["d73e2f31.f8bab"]]},{"id":"d73e2f31.f8bab","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"MSSQL","query":"","outField":"payload","x":580,"y":880,"wires":[["3c3c527e.2f99ee"]]},{"id":"71b73a21.c8ea84","type":"http in","z":"8364cdd3.e51ef","name":"remessa","url":"/api/financeiro/remessa","method":"get","swaggerDoc":"","x":100,"y":360,"wires":[["9bee8d4.771857"]]},{"id":"abb32f13.b67f6","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"\nmsg.payload = \"SELECT * FROM REM WHERE NOT EXISTS (SELECT * FROM REMD INNER JOIN RETD ON REMD.nosso_numero = RETD.nosso_numero AND REMD.parcela = RETD.parcela AND REMD.carteira = RETD.carteira WHERE REMD.remessa = REM.remessa) ORDER BY data DESC\"; \n\nreturn msg;","outputs":1,"noerr":0,"x":2030,"y":1500,"wires":[["40dbddbc.8c96b4"]]},{"id":"22d2a800.07ca28","type":"http in","z":"8364cdd3.e51ef","name":"retorno","url":"/api/financeiro/retorno","method":"get","swaggerDoc":"","x":90,"y":400,"wires":[["1b426e83.d06011"]]},{"id":"ead32cc4.ab04c","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"\nmsg.payload = \"SELECT TOP 5 * FROM RET ORDER BY data DESC\"; \n\nreturn msg;","outputs":1,"noerr":0,"x":2030,"y":1680,"wires":[["3497b1b9.4fef8e"]]},{"id":"40dbddbc.8c96b4","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"MSSQL","query":"","outField":"payload","x":2270,"y":1500,"wires":[["61b491b8.47a91"]]},{"id":"dfec34fc.e1bca8","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"\nmsg.payload = \n\n\"SELECT * FROM CRT WHERE id = \" + msg.payload.carteira; \n\nreturn msg;","outputs":1,"noerr":0,"x":2870,"y":1500,"wires":[["9ceb760a.3040b8"]]},{"id":"9ceb760a.3040b8","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"MSSQL","query":"","outField":"payload","x":3080,"y":1500,"wires":[["435a6d8.821d394"]]},{"id":"61b491b8.47a91","type":"function","z":"8364cdd3.e51ef","name":"parse","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0) {\n    delete msg.index;\n    msg.remessa = msg.payload;\n    return [msg, null];\n} else {\n    return [null, msg];    \n}","outputs":"2","noerr":0,"x":2470,"y":1500,"wires":[["16b4779d.113ea8"],["5db4e069.5689b","ead32cc4.ab04c"]]},{"id":"16b4779d.113ea8","type":"function","z":"8364cdd3.e51ef","name":"loop","func":"if (msg.index === undefined) {\n    msg.index = 0;\n    msg.payload = msg.remessa[msg.index];\n    return [msg, null];\n} else {\n    msg.index++;\n    if (msg.index < msg.remessa.length) {\n        msg.payload = msg.remessa[msg.index];    \n        return [msg, null]\n    }\n    msg.payload = msg.remessa;\n    return [null, msg];\n}\n","outputs":"2","noerr":0,"x":2670,"y":1500,"wires":[["dfec34fc.e1bca8"],["5db4e069.5689b","ead32cc4.ab04c"]]},{"id":"435a6d8.821d394","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0) {\n    msg.remessa[msg.index].carteira = msg.payload[0];\n} else {\n    msg.remessa[msg.index].carteira = {id: 0, nome: '?'};\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2870,"y":1620,"wires":[["16b4779d.113ea8"]]},{"id":"3497b1b9.4fef8e","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"MSSQL","query":"","outField":"payload","x":2270,"y":1680,"wires":[["47c980af.ca2fc"]]},{"id":"ac1a2a68.b3f738","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"\nmsg.payload = \n\n\"SELECT * FROM CRT WHERE id = \" + msg.payload.carteira; \n\nreturn msg;","outputs":1,"noerr":0,"x":2870,"y":1680,"wires":[["591841b2.a1f6c"]]},{"id":"591841b2.a1f6c","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"MSSQL","query":"","outField":"payload","x":3080,"y":1680,"wires":[["2267372a.8942a8"]]},{"id":"47c980af.ca2fc","type":"function","z":"8364cdd3.e51ef","name":"parse","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0) {\n    delete msg.index;\n    msg.retorno = msg.payload;\n    return [msg, null];\n} else {\n    return [null, msg];    \n}","outputs":"2","noerr":0,"x":2470,"y":1680,"wires":[["fc5139e8.ce8f48"],["5865b112.a1d77","d7ecd1a8.6f1c9"]]},{"id":"fc5139e8.ce8f48","type":"function","z":"8364cdd3.e51ef","name":"loop","func":"if (msg.index === undefined) {\n    msg.index = 0;\n    msg.payload = msg.retorno[msg.index];\n    return [msg, null];\n} else {\n    msg.index++;\n    if (msg.index < msg.retorno.length) {\n        msg.payload = msg.retorno[msg.index];    \n        return [msg, null]\n    }\n    msg.payload = msg.retorno;\n    return [null, msg];\n}\n","outputs":"2","noerr":0,"x":2670,"y":1680,"wires":[["ac1a2a68.b3f738"],["5865b112.a1d77","d7ecd1a8.6f1c9"]]},{"id":"2267372a.8942a8","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0) {\n    msg.retorno[msg.index].carteira = msg.payload[0];\n} else {\n    msg.retorno[msg.index].carteira = {id: 0, nome: '?'};\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2870,"y":1800,"wires":[["fc5139e8.ce8f48"]]},{"id":"5db4e069.5689b","type":"file","z":"8364cdd3.e51ef","name":"","filename":"remessa.json","appendNewline":false,"createDir":false,"overwriteFile":"true","x":2900,"y":1540,"wires":[]},{"id":"9bee8d4.771857","type":"file in","z":"8364cdd3.e51ef","name":"","filename":"remessa.json","format":"utf8","x":360,"y":360,"wires":[["50f04168.68ce4"]]},{"id":"50f04168.68ce4","type":"http response","z":"8364cdd3.e51ef","name":"","x":550,"y":360,"wires":[]},{"id":"1b426e83.d06011","type":"file in","z":"8364cdd3.e51ef","name":"","filename":"retorno.json","format":"utf8","x":350,"y":400,"wires":[["71b3f5f0.745c8c"]]},{"id":"71b3f5f0.745c8c","type":"http response","z":"8364cdd3.e51ef","name":"","x":550,"y":400,"wires":[]},{"id":"5865b112.a1d77","type":"file","z":"8364cdd3.e51ef","name":"","filename":"retorno.json","appendNewline":false,"createDir":false,"overwriteFile":"true","x":2890,"y":1720,"wires":[]},{"id":"648308ec.c80a68","type":"file in","z":"8364cdd3.e51ef","name":"","filename":"cobranca.json","format":"utf8","x":360,"y":320,"wires":[["4f3e416d.737ad"]]},{"id":"4f3e416d.737ad","type":"http response","z":"8364cdd3.e51ef","name":"","x":550,"y":320,"wires":[]},{"id":"324c3e70.69c2f2","type":"file","z":"8364cdd3.e51ef","name":"","filename":"cobranca.json","appendNewline":false,"createDir":false,"overwriteFile":"true","x":2900,"y":1360,"wires":[]},{"id":"b106371c.e17968","type":"file in","z":"8364cdd3.e51ef","name":"","filename":"carteira.json","format":"utf8","x":350,"y":280,"wires":[["8382a02b.de2a8"]]},{"id":"8382a02b.de2a8","type":"http response","z":"8364cdd3.e51ef","name":"","x":550,"y":280,"wires":[]},{"id":"8f679e7.dddf76","type":"file","z":"8364cdd3.e51ef","name":"","filename":"carteira.json","appendNewline":false,"createDir":false,"overwriteFile":"true","x":2690,"y":1220,"wires":[]},{"id":"c62a918e.69544","type":"inject","z":"8364cdd3.e51ef","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":1660,"y":1200,"wires":[["5befa2a3.3faa1c","38ed28a2.ce20e8"]]},{"id":"35837319.65fb1c","type":"mqtt in","z":"8364cdd3.e51ef","name":"","topic":"/event/carteira","qos":"0","broker":"404ac8f7.f80bb8","x":1650,"y":1280,"wires":[["38ed28a2.ce20e8","494c3337.642dac"]]},{"id":"d89f9d70.ae8ca","type":"mqtt out","z":"8364cdd3.e51ef","name":"","topic":"/event/carteira","qos":"","retain":"","broker":"404ac8f7.f80bb8","x":1080,"y":700,"wires":[]},{"id":"7f1cb0f1.6ad66","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"MSSQL","query":"","outField":"payload","x":2270,"y":1860,"wires":[["feed21ae.2a304"]]},{"id":"d7ecd1a8.6f1c9","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"msg.payload = \n`\n    SELECT DISTINCT\n       perfil\n    FROM\n        USR\n`\n\nreturn msg;","outputs":1,"noerr":0,"x":2030,"y":1860,"wires":[["7f1cb0f1.6ad66"]]},{"id":"6d91e631.a08348","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"\nmsg.payload = `\n    DECLARE @PERFIL NVARCHAR(50)\n    \n    SET @PERFIL = '${msg.payload.perfil}'\n    \n    SELECT\n       id,\n       nome,\n       titulo,\n       descricao,\n       atribuir,\n       form,\n       parametros,\n       prazo,\n       criado,\n       CAST(versao AS INT) AS versao\n    FROM\n    \tTRF\n    WHERE\n       concluido IS NULL AND\n       (atribuir IS NULL OR atribuir IN (@PERFIL))\n    ORDER BY\n       criado\n`\n\nreturn msg;","outputs":1,"noerr":0,"x":2870,"y":1860,"wires":[["b920d3ba.ae47"]]},{"id":"b920d3ba.ae47","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"MSSQL123456","query":"","outField":"payload","x":3100,"y":1860,"wires":[["d23bd86d.88ca28"]]},{"id":"feed21ae.2a304","type":"function","z":"8364cdd3.e51ef","name":"parse","func":"if (Array.isArray(msg.payload) && msg.payload.length > 0) {\n    delete msg.index;\n    msg.perfil = msg.payload;\n    return [msg, null];\n} else {\n    return [null, msg];    \n}","outputs":"2","noerr":0,"x":2470,"y":1860,"wires":[["92eeeb61.80a248"],["6bff048d.3162bc"]]},{"id":"92eeeb61.80a248","type":"function","z":"8364cdd3.e51ef","name":"loop","func":"if (msg.index === undefined) {\n    msg.index = 0;\n    msg.payload = msg.perfil[msg.index];\n    return [msg, null];\n} else {\n    msg.index++;\n    if (msg.index < msg.perfil.length) {\n        msg.payload = msg.perfil[msg.index];    \n        return [msg, null]\n    } else {\n        return [null, msg]\n    }\n}\n","outputs":"2","noerr":0,"x":2670,"y":1860,"wires":[["6d91e631.a08348"],["6bff048d.3162bc"]]},{"id":"d23bd86d.88ca28","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"msg.filename = 'tarefas/' + msg.perfil[msg.index].perfil + '.json'\n\nreturn msg;","outputs":1,"noerr":0,"x":2870,"y":1980,"wires":[["92eeeb61.80a248","1ee547b5.8266d8"]]},{"id":"1ee547b5.8266d8","type":"file","z":"8364cdd3.e51ef","name":"","filename":"","appendNewline":false,"createDir":true,"overwriteFile":"true","x":3050,"y":1980,"wires":[]},{"id":"ec170538.ff3028","type":"inject","z":"8364cdd3.e51ef","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":1820,"y":1860,"wires":[["d7ecd1a8.6f1c9"]]},{"id":"bc5b0a20.868eb8","type":"file in","z":"8364cdd3.e51ef","name":"","filename":"","format":"utf8","x":550,"y":40,"wires":[["3d4e9ee2.191d92"]]},{"id":"1cfd07f4.47b1d8","type":"mqtt in","z":"8364cdd3.e51ef","name":"","topic":"/event/tarefas","qos":"0","broker":"404ac8f7.f80bb8","x":1650,"y":1740,"wires":[["9adfce77.68c93"]]},{"id":"6bff048d.3162bc","type":"function","z":"8364cdd3.e51ef","name":"SQL","func":"msg.payload = \n`\nSELECT [id]\n    ,[nome]\n    ,[titulo]\n    ,[descricao]\n    ,[detalhes]\n    ,[documento]\n    ,[atribuir]\n    ,[atribuido]\n    ,[form]\n    ,[parametros]\n    ,[prazo]\n    ,[criado]\n    ,[concluido]\n    ,CAST([versao] AS INT) AS versao\nFROM \n    [dbo].[TRF]\nWHERE \n    concluido IS NULL\n`\n\nreturn msg;","outputs":1,"noerr":0,"x":2030,"y":2040,"wires":[["9acd9ef7.ec704"]]},{"id":"9acd9ef7.ec704","type":"MSSQL","z":"8364cdd3.e51ef","mssqlCN":"c060e377.7001d","name":"MSSQL","query":"","outField":"payload","x":2270,"y":2040,"wires":[["3f203e68.968fb2"]]},{"id":"3f203e68.968fb2","type":"split","z":"8364cdd3.e51ef","name":"","splt":"\\n","x":2470,"y":2040,"wires":[["5f92359d.e7d64c"]]},{"id":"5f92359d.e7d64c","type":"function","z":"8364cdd3.e51ef","name":"filename","func":"msg.payload.documento = JSON.parse(msg.payload.documento)\n\nmsg.filename = 'tarefas/' + msg.payload.id + '.json'\n\nreturn msg;","outputs":1,"noerr":0,"x":2680,"y":2040,"wires":[["cf434803.77a098"]]},{"id":"cf434803.77a098","type":"file","z":"8364cdd3.e51ef","name":"","filename":"","appendNewline":false,"createDir":true,"overwriteFile":"true","x":2870,"y":2040,"wires":[]},{"id":"935e16e9.cbeab8","type":"inject","z":"8364cdd3.e51ef","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":1820,"y":2040,"wires":[["6bff048d.3162bc"]]},{"id":"ef0a9a1b.51b318","type":"function","z":"8364cdd3.e51ef","name":"filename","func":"msg.filename = 'tarefas/' + msg.req.params.id + '.json';\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":80,"wires":[["98cef04d.5fa6d"]]},{"id":"98cef04d.5fa6d","type":"file in","z":"8364cdd3.e51ef","name":"","filename":"","format":"utf8","x":550,"y":80,"wires":[["3d4e9ee2.191d92"]]},{"id":"3d4e9ee2.191d92","type":"function","z":"8364cdd3.e51ef","name":"PARSE","func":"msg.payload = JSON.parse(msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":760,"y":60,"wires":[["829f8a8a.496e98"]]},{"id":"415a4739.6703b8","type":"mqtt out","z":"8364cdd3.e51ef","name":"","topic":"/event/carteira","qos":"","retain":"","broker":"404ac8f7.f80bb8","x":1880,"y":180,"wires":[]},{"id":"38ed28a2.ce20e8","type":"debug","z":"8364cdd3.e51ef","name":"ATUALIZAR CONSULTAS","active":false,"console":"false","complete":"payload","x":2090,"y":1160,"wires":[]},{"id":"494c3337.642dac","type":"delay","z":"8364cdd3.e51ef","name":"","pauseType":"timed","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":2080,"y":1260,"wires":[["5befa2a3.3faa1c"]]},{"id":"9adfce77.68c93","type":"delay","z":"8364cdd3.e51ef","name":"","pauseType":"timed","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1860,"y":1780,"wires":[["d7ecd1a8.6f1c9"]]},{"id":"6320d365.b00b9c","type":"MSSQL-CN","z":"","name":"gpimac","server":"127.0.0.1","encyption":true,"database":"GPIMAC_Altamira"},{"id":"c060e377.7001d","type":"MSSQL-CN","z":"","name":"financeiro","server":"localhost","port":"1433","encyption":false,"database":"FINANCEIRO","pool":"500"},{"id":"89c0ceb0.f2811","type":"MSSQL-CN","z":"","name":"BPM","server":"192.168.0.1","encyption":false,"database":"BPM"},{"id":"404ac8f7.f80bb8","type":"mqtt-broker","z":"","broker":"192.168.0.1","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willPayload":"","birthTopic":"","birthQos":"0","birthPayload":""}]